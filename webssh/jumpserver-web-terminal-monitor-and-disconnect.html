<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="applicable-device" content="pc,mobile">
  <meta name="keywords" content="WebSSH, å®æ—¶ç›‘æ§, ç”¨æˆ·æ“ä½œç›‘æ§, å¼ºåˆ¶ä¸‹çº¿, Django Channels, WebSocket" />
  <meta name="description" content="æœ¬æ–‡ä»‹ç»äº†å¦‚ä½•é€šè¿‡Django Channelså®ç°WebSSHçš„å®æ—¶ç”¨æˆ·æ“ä½œç›‘æ§åŠŸèƒ½ï¼ŒåŒ…æ‹¬å¦‚ä½•å®æ—¶æŸ¥çœ‹ç”¨æˆ·æ“ä½œå¹¶åœ¨å¿…è¦æ—¶å¼ºåˆ¶å°†ç”¨æˆ·è¸¢ä¸‹çº¿ã€‚æ–‡ç« è¯¦ç»†è®²è§£äº†å¦‚ä½•ä½¿ç”¨Channelsçš„layeråŠŸèƒ½å°†å¤šä¸ªchannelåˆå¹¶æˆä¸€ä¸ªgroupï¼Œå¹¶é€šè¿‡groupå‘é€æ¶ˆæ¯æ¥å®ç°ç›‘æ§åŠŸèƒ½ï¼ŒåŒæ—¶ä¹Ÿä»‹ç»äº†å¦‚ä½•é€šè¿‡åç«¯é€»è¾‘å®ç°å¼ºåˆ¶æ–­å¼€ç”¨æˆ·è¿æ¥ã€‚" />
  <link rel="alternate" type="application/rss+xml" title="è¿ç»´å’–å•¡å§" href="https://blog.ops-coffee.cn/feed.xml" />
  <link rel="stylesheet" href="https://blog.ops-coffee.cn/static/posts/css/ops-coffee.min.css" type="text/css" />

  <!-- Begin SEO tag -->
  <title>å ¡å’æœºWebSSHè¿›é˜¶ä¹‹å®æ—¶ç›‘æ§å’Œå¼ºåˆ¶ä¸‹çº¿</title>
  <meta property="og:locale" content="zh_CN" />
  <meta property="og:site_name" content="è¿ç»´å’–å•¡å§" />
  <meta property="og:url" content="https://blog.ops-coffee.cnwebssh/jumpserver-web-terminal-monitor-and-disconnect.html" />
  <meta property="og:title" content="å ¡å’æœºWebSSHè¿›é˜¶ä¹‹å®æ—¶ç›‘æ§å’Œå¼ºåˆ¶ä¸‹çº¿" />
  <meta property="og:description" content="æœ¬æ–‡ä»‹ç»äº†å¦‚ä½•é€šè¿‡Django Channelså®ç°WebSSHçš„å®æ—¶ç”¨æˆ·æ“ä½œç›‘æ§åŠŸèƒ½ï¼ŒåŒ…æ‹¬å¦‚ä½•å®æ—¶æŸ¥çœ‹ç”¨æˆ·æ“ä½œå¹¶åœ¨å¿…è¦æ—¶å¼ºåˆ¶å°†ç”¨æˆ·è¸¢ä¸‹çº¿ã€‚æ–‡ç« è¯¦ç»†è®²è§£äº†å¦‚ä½•ä½¿ç”¨Channelsçš„layeråŠŸèƒ½å°†å¤šä¸ªchannelåˆå¹¶æˆä¸€ä¸ªgroupï¼Œå¹¶é€šè¿‡groupå‘é€æ¶ˆæ¯æ¥å®ç°ç›‘æ§åŠŸèƒ½ï¼ŒåŒæ—¶ä¹Ÿä»‹ç»äº†å¦‚ä½•é€šè¿‡åç«¯é€»è¾‘å®ç°å¼ºåˆ¶æ–­å¼€ç”¨æˆ·è¿æ¥ã€‚" />
  <link rel="canonical" href="https://blog.ops-coffee.cnwebssh/jumpserver-web-terminal-monitor-and-disconnect.html" />

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "å ¡å’æœºWebSSHè¿›é˜¶ä¹‹å®æ—¶ç›‘æ§å’Œå¼ºåˆ¶ä¸‹çº¿",
    "description": "æœ¬æ–‡ä»‹ç»äº†å¦‚ä½•é€šè¿‡Django Channelså®ç°WebSSHçš„å®æ—¶ç”¨æˆ·æ“ä½œç›‘æ§åŠŸèƒ½ï¼ŒåŒ…æ‹¬å¦‚ä½•å®æ—¶æŸ¥çœ‹ç”¨æˆ·æ“ä½œå¹¶åœ¨å¿…è¦æ—¶å¼ºåˆ¶å°†ç”¨æˆ·è¸¢ä¸‹çº¿ã€‚æ–‡ç« è¯¦ç»†è®²è§£äº†å¦‚ä½•ä½¿ç”¨Channelsçš„layeråŠŸèƒ½å°†å¤šä¸ªchannelåˆå¹¶æˆä¸€ä¸ªgroupï¼Œå¹¶é€šè¿‡groupå‘é€æ¶ˆæ¯æ¥å®ç°ç›‘æ§åŠŸèƒ½ï¼ŒåŒæ—¶ä¹Ÿä»‹ç»äº†å¦‚ä½•é€šè¿‡åç«¯é€»è¾‘å®ç°å¼ºåˆ¶æ–­å¼€ç”¨æˆ·è¿æ¥ã€‚",
    "url": "https://blog.ops-coffee.cnwebssh/jumpserver-web-terminal-monitor-and-disconnect.html",
    "author": {
      "@type": "Person",
      "name": "è¿ç»´å’–å•¡å§"
    },
    "publisher": {
      "@type": "Organization",
      "name": "è¿ç»´å’–å•¡å§",
      "logo": {
        "@type": "ImageObject",
        "url": "https://blog.ops-coffee.cn/favicon.ico"
      }
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https://blog.ops-coffee.cnwebssh/jumpserver-web-terminal-monitor-and-disconnect.html"
    }
  }
  </script>
  <!-- End SEO tag -->
</head>

<body>
  <div class="header">
    <div class="menu-button">&#9776; 
        <span class="menu-title">è¿ç»´å’–å•¡å§</span>
    </div> 

    <div class="container">
      <nav class="header-site">
        <ul>
          <li><a href="/">é¦–é¡µ</a></li>
            <li class="has-submenu">
              <a href="#" target="_self">è¿ç»´</a>
              <ul class="sub-menu">
                <li><a href="/tag/ç³»ç»Ÿè¿ç»´/" target="_self">ç³»ç»Ÿè¿ç»´</a></li>
                <li><a href="/elk/index.html" target="_self">ELKç³»åˆ—</a></li>
                <li><a href="/ldap/index.html" target="_self">LDAPç³»åˆ—</a></li>
              </ul>
            </li>
            <li class="has-submenu">
              <a href="#" target="_self">å¼€å‘</a>
              <ul class="sub-menu">
                <li><a href="/tag/Devops/" target="_self">DevOps</a></li>
                <li><a href="/tag/Python/" target="_self">Python</a></li>
                <li><a href="/tag/Django/" target="_self">Django</a></li>
                <li><a href="/bpmn/index.html" target="_self">BPMNç³»åˆ—</a></li>
                <li><a href="/webssh/index.html" target="_self">WebSSHç³»åˆ—</a></li>
                <li><a href="/frontend/index.html" target="_self">å‰ç«¯å¼€å‘ç³»åˆ—</a></li>
              </ul>
            </li>
            <li><a href="/devops/index.html" target="_self">è¿ç»´å¹³å°</a></li>
            <li class="has-submenu">
              <a href="#" target="_self">è¿™æ˜¯ç”Ÿæ´»</a>
              <ul class="sub-menu">
                <li><a href="/life/chronicles.html" target="_self">æ—¶å…‰å°è®°</a></li>
                <li><a href="/life/money.html" target="_self">å‰¯ä¸šèµšé’±</a></li>
                <li><a href="/life/writing.html" target="_self">å†™ä½œç›¸å…³</a></li>
                <li><a href="/tag/è¿™æ˜¯ç”Ÿæ´»/" target="_self">ç”Ÿæ´»éšç¬”</a></li>
              </ul>
            </li>
            <li class="has-submenu">
              <a href="#" target="_self">æˆ¿è½¦æ—…è¡Œ</a>
              <ul class="sub-menu">
                <li><a href="/rv.html" target="_self">æˆ¿è½¦ä½“éªŒ</a></li>
                <li><a href="/travels.html" target="_self">æ—…è¡Œæ¸¸è®°</a></li>
                <li><a href="/travel/china.html" target="_self">æ—…è¡Œåœ°å›¾</a></li>
              </ul>
            </li>
            <li><a href="/tag/index.html" target="_self">æ ‡ç­¾</a></li>
            <li><a href="/archive.html" target="_self">å½’æ¡£</a></li>
          <li class="search"><a href="/search.html" target="_self" aria-label="æœç´¢">ğŸ”</a></li>
        </ul>
      </nav>
    </div>
  </div>

  <header>
    <div class="container">
      <a href="/">
        <div class="name">è¿ç»´å’–å•¡å§</div>
        <div class="slogan">äº«å—æŠ€æœ¯å¸¦æ¥çš„ä¹è¶£ï¼Œä½“éªŒç”Ÿæ´»ç»™äºˆçš„æ„ŸåŠ¨</div>
      </a>
    </div>
  </header>

  <div id="content-wrap">
    <div class="container">
        <h1 id="art-title">å ¡å’æœºWebSSHè¿›é˜¶ä¹‹å®æ—¶ç›‘æ§å’Œå¼ºåˆ¶ä¸‹çº¿</h1>

        <blockquote>
<p>è¿™ä¸ªåŠŸèƒ½æˆ‘å¯ä»¥ä¸ç”¨ï¼Œä½†ä½ ä¸èƒ½æ²¡æœ‰</p>
</blockquote>
<p>å‰å‡ ç¯‡æ–‡ç« å®ç°äº†å¯¹<strong>ç‰©ç†æœº</strong>ã€<strong>è™šæ‹Ÿæœº</strong>ä»¥åŠKubernetesä¸­<strong>Pod</strong>çš„WebSSHæ“ä½œï¼Œå¯ä»¥æ–¹ä¾¿çš„åœ¨webç«¯å¯¹ç³»ç»Ÿè¿›è¡Œç®¡ç†ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒå¯¹æ‰€æœ‰æ“ä½œè¿›è¡Œ<strong>å…¨ç¨‹å½•åƒ</strong>ï¼Œä»¥æ–¹ä¾¿åç»­çš„æŸ¥çœ‹ä¸å®¡è®¡</p>
<p>è¿™ä¸€ç¯‡æ–‡ç« æ¥ç€å®ç°ä¸€ä¸ªçœ‹èµ·æ¥å¾ˆç‚«é…·ï¼Œä½†å®é™…ä¸Šä½ å¯èƒ½ä¸ä¼šç»å¸¸ä½¿ç”¨ï¼Œåˆå¿…é¡»è¦å­˜åœ¨çš„åŠŸèƒ½ï¼šå®æ—¶ç›‘æ§ç”¨æˆ·æ“ä½œï¼Œåœ¨å¿…è¦çš„æ—¶å€™å°†ç”¨æˆ·è¸¢ä¸‹çº¿</p>
<h2 id="_1">å®æ—¶æŸ¥çœ‹æ“ä½œ</h2>
<p>djangoé€šè¿‡channelså®ç°websocketä¸­æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µå«layerï¼Œlayerå¯ä»¥å°†å¤šä¸ªchannelåˆå¹¶æˆä¸€ä¸ªgroupï¼Œæˆ‘ä»¬å¯ä»¥å‘é€æ¶ˆæ¯ç»™groupï¼Œé‚£ä¹ˆgroupé‡Œçš„æ¯ä¸ªchanneléƒ½èƒ½æ”¶åˆ°</p>
<p>å…³äºChannelæˆ‘æœ‰å†™è¿‡ä¸¤ç¯‡æ–‡ç« ç»“åˆ<strong>èŠå¤©å®¤</strong>å’Œ<strong>webç«¯å®ç°tail-fåŠŸèƒ½</strong>è¿™ä¸¤ä¸ªæ¡ˆä¾‹æ¥è¯¦ç»†ä»‹ç»ï¼Œä¸¤ç¯‡æ–‡ç« æ˜¯<a href="https://blog.ops-coffee.cn/s/django-channels-websocket-devops-01.html" target="_blank">ã€Djangoä½¿ç”¨Channelså®ç°WebSocket--ä¸Šç¯‡ã€</a>å’Œ<a href="https://blog.ops-coffee.cn/s/django-channels-websocket-devops-02.html" target="_blank">ã€Djangoä½¿ç”¨Channelså®ç°WebSocket--ä¸‹ç¯‡ã€</a>ï¼Œå¯¹ä¸Šè¾¹æåˆ°çš„åè¯ä¸€è„¸æ‡µé€¼çš„æœ‹å‹å¯ä»¥é€šè¿‡è¿™ä¸¤ç¯‡æ–‡ç« æ¥å­¦ä¹ </p>
<p>ä¹‹å‰çš„WebSSHä»…æ˜¯å•è¿æ¥ï¼Œåªéœ€è¦å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å»ºç«‹é•¿è¿æ¥ï¼Œç„¶åå¤„ç†æŒ‡ä»¤å°±okäº†ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰å¯ç”¨channelçš„layerï¼Œå®é™…ä¸Šä¹Ÿå¯ä»¥çœ‹ä½œæ˜¯å•channelï¼Œä½†è¦å®ç°ç›‘æ§çš„åŠŸèƒ½ï¼Œå°±éœ€è¦å°†æ“ä½œè€…å’Œç®¡ç†å‘˜(ç›‘æ§è€…)çš„å¤šä¸ªchannelåˆå¹¶åœ¨ä¸€èµ·ç»„æˆä¸€ä¸ªgroupï¼Œè¿™æ ·æ“ä½œè€…çš„æ‰€æœ‰æ“ä½œéƒ½å¯ä»¥å‘é€ç»™è¿™ä¸ªgroupï¼ŒåŒå¤„äºè¿™ä¸ªgroupå†…ç›‘æ§è€…å°±èƒ½å®æ—¶æ”¶åˆ°æ¶ˆæ¯äº†ï¼Œå¤§æ¦‚æµç¨‹å˜åŒ–å¦‚ä¸‹å›¾æ‰€ç¤º</p>
<p><img alt="" loading="lazy" src="/static/images/2019/1128.01.jpg" /></p>
<p>æ¥ä¸‹æ¥çœ‹ä¸‹å…·ä½“å®ç°ï¼Œä»¥ä¸‹æ‰€æœ‰ä»£ç å‡æ˜¯åœ¨è¿™ç¯‡æ–‡ç« çš„åŸºç¡€ä¸Šè¿›è¡Œè¯´æ˜è®²è§£ï¼š<a href="https://blog.ops-coffee.cn/webssh/jumpserver-web-terminal-ssh-paramiko-stream" target="_blank">ã€Djangoå®ç°WebSSHæ“ä½œç‰©ç†æœºæˆ–è™šæ‹Ÿæœºã€</a></p>
<p>é¦–å…ˆæˆ‘ä»¬è¦å¯ç”¨layerï¼Œè¿™ä¸ªéœ€è¦åœ¨settings.pyä¸­æ·»åŠ å¦‚ä¸‹é…ç½®</p>
<pre class="codehilite"><code>CHANNEL_LAYERS = {
    'default': {
        'BACKEND': 'channels_redis.core.RedisChannelLayer',
        'CONFIG': {
            &quot;hosts&quot;: [('ops-coffee.cn', 6379)],
        },
    },
}</code></pre>


<p>ç„¶åå°†å¤„ç†WebSSHè¿æ¥åä¸º<code>SSHConsumer</code>çš„Consumeråšæ”¹é€ ï¼Œä»¥ä½¿å…¶æ”¯æŒlayerï¼Œä»£ç å¦‚ä¸‹</p>
<pre class="codehilite"><code>class SSHConsumer(WebsocketConsumer):
    def connect(self):
        # æ ¼å¼åŒ–å‚æ•°
        ssh_connect_args = args(self.scope)

        # æ–°å»ºå½•åƒè®°å½•
        self.host = Host.objects.get(host=ssh_connect_args.get('host'))
        self.group_name = '%s-%s-%d' % (
            ssh_connect_args.get('host'), ssh_connect_args.get('username'), time.time())

        self.therecord = Record.objects.create(
            host=self.host,
            user=self.scope['user'],
            group=self.group_name,
            channel=self.channel_name,
            cols=ssh_connect_args.get('cols'),
            rows=ssh_connect_args.get('rows'),
            is_connecting=True
        )

        async_to_sync(self.channel_layer.group_add)(
            self.group_name,
            self.channel_name
        )

        self.accept()

        # WebSocketè¿æ¥æˆåŠŸåï¼Œè¿æ¥ssh
        self.ssh = SSHBridge(self.therecord, websocket=self)
        self.ssh.connect(**ssh_connect_args)

    def disconnect(self, close_code):
        # å°†è¿æ¥çŠ¶æ€ç½®ä¸ºFalse
        self.therecord.is_connecting = False
        self.therecord.save()

        async_to_sync(self.channel_layer.group_discard)(
            self.group_name,
            self.channel_name
        )

        self.ssh.close()

    def receive(self, text_data=None):
        text_data = json.loads(text_data)

        if text_data.get('flag') == 'resize':
            self.ssh.resize_pty(cols=text_data['cols'], rows=text_data['rows'])
        else:
            self.ssh.shell(data=text_data.get('data', ''))

    def ssh_message(self, event):
        self.send(text_data=json.dumps(
            event['message']
        ))</code></pre>


<p>åœ¨connectè¿æ¥å»ºç«‹æ—¶æ–°å»ºä¸€æ¡è®°å½•ï¼Œå­˜å‚¨ä¸»æœºã€ç”¨æˆ·ã€<code>group_name</code>ã€<code>channel_name</code>ä»¥åŠåˆå§‹çª—å£çš„<code>cols</code>ã€<code>rows</code>ä¿¡æ¯ï¼ŒåŒæ—¶æ ‡è®°<code>is_connecting</code>ä¸ºTrueï¼Œè¿™é‡Œçš„<code>group_name</code>å‘½åä¸æ–‡ç« <a href="https://blog.ops-coffee.cn/webssh/jumpserver-web-terminal-monitor-asciinema-audit" target="_blank">ã€å ¡å’æœºçš„æ ¸å¿ƒæ­¦å™¨ï¼šWebSSHå½•åƒå®ç°ã€</a>ä¸­æˆ‘ä»¬å®šä¹‰çš„å½•åƒæ–‡ä»¶åè§„åˆ™ä¸€è‡´ï¼Œå¦å¤–å°†è¿™ç¯‡æ–‡ç« ä¸­æ–°å»ºå½•åƒè®°å½•çš„æ“ä½œä»<code>SSHBridge.record</code>ä¸­ç»™è½¬åˆ°äº†è¿æ¥å»ºç«‹çš„connectä¸­æ¥ï¼Œæ›´åˆç†ä¹Ÿæ›´æ–¹ä¾¿</p>
<p>åœ¨disconnectè¿æ¥å…³é—­æ—¶ï¼Œå°†<code>is_connecting</code>æ ‡è®°ä¸ºFalseï¼Œè¿™æ ·æˆ‘ä»¬åœ¨å‰ç«¯é¡µé¢ä¸Šå°±å¯ä»¥æ ¹æ®è¿™ä¸ªæ ‡è®°æ¥åˆ¤æ–­WebSSHæ˜¯å¦æ­£åœ¨è¿æ¥ï¼Œå¦‚æœè¿æ¥åˆ™å±•ç¤º<strong>ç›‘æ§</strong>å’Œ<strong>å¼ºåˆ¶ç»“æŸ</strong>æŒ‰é’®ï¼Œå¦åˆ™å±•ç¤º<strong>æ’­æ”¾</strong>å’Œ<strong>å‘½ä»¤æå–</strong>æŒ‰é’®</p>
<p>åŒæ—¶æ·»åŠ ä¸ªssh_messageæ–¹æ³•ï¼Œç”¨æ¥æ¥æ”¶å‘é€åˆ°ç»„çš„æ•°æ®</p>
<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»å°†WebSSHæ”¹é€ æˆäº†æ”¯æŒlayerçš„æ¨¡å¼ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±æ˜¯è¦åœ¨ç”¨æˆ·ç‚¹å‡»ç›‘æ§çš„æ—¶å€™å°†ç”¨æˆ·ä¸æœåŠ¡ç«¯å»ºç«‹çš„è¿æ¥channelåŠ å…¥åˆ°ä¸Šè¿°groupä¸­</p>
<p>æ–°å»ºä¸€ä¸ªåä¸º<code>MonitorConsumer</code>çš„consumerï¼Œä¸»è¦ç”¨æ¥å¤„ç†ç›‘æ§è¿æ¥</p>
<pre class="codehilite"><code>class MonitorConsumer(WebsocketConsumer):
    def connect(self):
        pk = self.scope['url_route']['kwargs'].get('id')
        self.group_name = Record.objects.get(id=pk).group

        async_to_sync(self.channel_layer.group_add)(
            self.group_name,
            self.channel_name
        )

        self.accept()

        # åˆ¤æ–­ç”¨æˆ·å·²ç»ç»“æŸäº†è¿™ä¸ªwebsshè¿æ¥æ—¶å°±å…³é—­ç›‘æ§
        self.connecting = Record.objects.get(id=pk).is_connecting
        if not self.connecting:
            self.close()

    def disconnect(self, close_code):
        async_to_sync(self.channel_layer.group_discard)(
            self.group_name,
            self.channel_name
        )

        self.close()

    def receive(self, text_data=None):
        pass

    def ssh_message(self, event):
        self.send(text_data=json.dumps(
            event['message']
        ))</code></pre>


<p>MonitorConsumerä¸SSHConsumeræœ‰ä¸¤ä¸ªåœ°æ–¹ä¸ä¸€æ ·ï¼Œå…¶ä¸€æ˜¯<code>SSHConsumer</code>ä¸­æˆ‘ä»¬ç›´æ¥æ–°ç”Ÿæˆäº†ä¸ª<code>group_name</code>ï¼Œè€Œ<code>MonitorConsumer</code>ä¸­éœ€è¦åœ¨connectæ—¶è·å–åˆ°è¦ç›‘æ§çš„IDï¼Œç„¶åé€šè¿‡IDæ‹¿åˆ°<code>group_name</code>ï¼Œå°†monitorè¿æ¥åŠ å…¥åˆ°è¿™ä¸ªgroupï¼Œå…¶äºŒæ˜¯ç›‘æ§åªèƒ½çœ‹ï¼Œä¸èƒ½æ“ä½œï¼Œæ‰€ä»¥ä¹Ÿä¸éœ€è¦å‰ç«¯å‘é€æ•°æ®çš„<code>term.on</code>å’ŒConsumerçš„<code>receive</code>å¤„ç†æ•°æ®</p>
<p>æœ€åéœ€è¦ä¿®æ”¹<code>SSHBridge</code>æ–¹æ³•ä¸­å‘é€ç»™websocketçš„æŒ‡ä»¤ï¼Œä»<code>self.websocket.send</code>æ”¹ä¸ºå‘é€åˆ°groupçš„æ¨¡å¼ï¼Œå¦‚ä¸‹</p>
<pre class="codehilite"><code>async_to_sync(self.websocket.channel_layer.group_send)(
    self.group_name,
    {
        'type': 'ssh.message',
        'message': message
    }
)</code></pre>


<p>è‡³æ­¤ï¼Œç›‘æ§åŠŸèƒ½å°±ç®—å®Œæˆäº†ï¼Œä»€ä¹ˆï¼Ÿå‰ç«¯é¡µé¢æ€ä¹ˆå¼„ï¼Ÿå‚è€ƒä¸‹ä¹‹å‰çš„WebSSHç•Œé¢ï¼Œå‡ ä¹å¯ä»¥å®Œå…¨å¤åˆ¶</p>
<h2 id="_2">è¸¢ç”¨æˆ·ä¸‹çº¿</h2>
<p>è¸¢ç”¨æˆ·ä¸‹çº¿å°±æ¯”è¾ƒç®€å•äº†ï¼Œé€»è¾‘æ˜¯ç‚¹å‡»é¡µé¢ä¸Šçš„<strong>å¼ºåˆ¶ç»“æŸ</strong>æŒ‰é’®ï¼Œç»™åç«¯viewå‘é€ä¸ªè¯·æ±‚å¸¦ä¸Šè¿™æ¡è®°å½•çš„IDï¼Œviewæ‹¿åˆ°IDåï¼Œé€šè¿‡IDæ‰¾åˆ°group_nameï¼Œç„¶åå‘groupå‘é€<code>disconnect</code>æ¶ˆæ¯ï¼Œè¿™ä¸ªgroupé‡Œçš„æ‰€æœ‰channelåœ¨æ”¶åˆ°disconnectæ¶ˆæ¯åå°±ä¼šæ–­å¼€è¿æ¥äº†</p>
<pre class="codehilite"><code>from asgiref.sync import async_to_sync
from channels.layers import get_channel_layer

async_to_sync(get_channel_layer().group_send)(
    Record.objects.get(id=pk).group,
    {'type': 'disconnect'}
)</code></pre>


<h2 id="_3">æ¼”ç¤ºä¸è¯´æ˜</h2>
<p><img alt="" loading="lazy" src="/static/images/2019/1128.gif" /></p>
<p>æ‰€æœ‰å®ç°ç¯ç¯ç›¸æ‰£ï¼Œå•çœ‹è¿™ä¸€ç¯‡æ–‡ç« å¯èƒ½äº‘é‡Œé›¾é‡Œï¼Œä¸çŸ¥æ‰€äº‘ï¼Œä½†ä½ å¦‚æœèƒ½æŠŠè¿™ä¸ªç³»åˆ—æ–‡ç« éƒ½ç»™çœ‹ä¸‹çš„è¯ï¼Œæˆ‘æƒ³å®ç°ä¸ªç®€å•çš„å ¡å’æœºåº”è¯¥æ²¡æœ‰é—®é¢˜å§ï¼Œæ›´é‡è¦çš„æ˜¯ä½ ä¼šå¯¹websocketä»¥åŠdjangoä¸­çš„Channelsæœ‰ç€æ›´åŠ æ·±åˆ»çš„ç†è§£å’Œè¿ç”¨</p>
<p>åŸæœ¬åªæ˜¯æƒ³ç»™æˆ‘æœ€ç‰›Xçš„<a href="https://blog.ops-coffee.cn/s/create-test-environment-with-aloid-system.html" target="_blank">Alodiç³»ç»Ÿ</a>æ·»åŠ ä¸ªWebSSHï¼Œå¯ä»¥æ–¹ä¾¿å¼€å‘æˆ–æµ‹è¯•åœ¨é¡¹ç›®è¿è¡Œè¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜æ—¶æä¾›ä¸€ä¸ªå¿«é€Ÿçš„è°ƒè¯•é€”å¾„ï¼Œæ²¡æƒ³åˆ°è¿™ç«Ÿç„¶å†™äº†ä¸€ä¸ªç³»åˆ—ï¼Œå®ç°äº†è¿™ä¹ˆå¤šæœ‰è¶£å¥½ç©å„¿çš„åŠŸèƒ½</p>
<p>æœ€åæƒ³èµ·äº†è¿™å¥æˆè¯­ï¼šæœ‰æ„æ ½èŠ±èŠ±ä¸å¼€ï¼Œæ— å¿ƒæ’æŸ³æŸ³æˆè«ï¼ŒçœŸæ˜¯å¥‡å¦™~</p>

        <div>
          <ul style="display: inline-block;padding: 0;margin: 0 0 0.5em;color: #999;">
            <li style="display: inline-block;margin: 0 1em 0 0;"><a href="/webssh/jumpserver-web-terminal-monitor-and-disconnect.html">ğŸ“… 2019-11-29</a></li>
<li style="display: inline-block;margin: 0 1em 0 0;"><a href="/tag/ç›‘æ§/">ğŸ·ï¸ ç›‘æ§</a></li><li style="display: inline-block;margin: 0 1em 0 0;"><a href="/tag/å…³äºæŠ€æœ¯/">ğŸ·ï¸ å…³äºæŠ€æœ¯</a></li>          </ul>
        </div>

        <hr>

        <div class="pagination">
            <a href="https://blog.ops-coffee.cn/webssh/jumpserver-web-terminal-monitor-asciinema-audit.html" class="pagination-item prev-page">
                <span class="pagination-arrow">â†</span>
                <span class="pagination-text">ä¸Šä¸€ç¯‡ï¼š<br>å ¡å’æœºçš„æ ¸å¿ƒæ­¦å™¨ï¼šWebSSHå½•åƒå®ç°</span>
            </a>
            <a href="https://blog.ops-coffee.cn/webssh/jumpserver-web-terminal-lrzsz-file-scp-zmodem.html" class="pagination-item next-page">
                <span class="pagination-text">ä¸‹ä¸€ç¯‡ï¼š<br>WebSSHç”»é¾™ç‚¹ç›ä¹‹lrzszä¸Šä¼ ä¸‹è½½æ–‡ä»¶</span>
                <span class="pagination-arrow">â†’</span>
            </a>
        </div>

        <div class="nav-cell">
    <script async src="https://giscus.app/client.js"
            data-repo="ops-coffee/blog" data-repo-id="MDEwOlJlcG9zaXRvcnkxNDY4OTI0MTg="
            data-category="Announcements" data-category-id="DIC_kwDOCMFmgs4CQar3"
            data-mapping="pathname" data-strict="0" data-reactions-enabled="1"
            data-emit-metadata="0" data-input-position="top" data-theme="light"
            data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous">
    </script>
</div>

        <div>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8944257246828217"
         data-ad-slot="6731434232" data-ad-format="auto" data-full-width-responsive="true"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
</div>

        <div class="nav-cell">
            <p class="nav-list-title">èƒ½çœ‹åˆ°è¿™é‡Œä¸€å®šæ˜¯çœŸçˆ±ï¼Œè®¢é˜…ä¸€ä¸‹å§</p>
            <img alt="" loading="lazy" src="/static/images/wx.sou1.png" />
        </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="copy"> Â© ops-coffee</div>

      <div class="link">
        <a href="/comments.html" title="ç»™æˆ‘ç•™è¨€" target="_blank">ç•™è¨€</a>
        <a href="/friends.html" title="å‹æƒ…é“¾æ¥" target="_blank">å‹é“¾</a>
      </div>
    </div>
  </footer>
  
  <!-- Umami -->
<script defer src="https://umami.opendevops.cn/script.js" data-website-id="a4aabd8e-32c7-40e7-a81c-119b909f2d0f"></script>

<!-- Google Adsense -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8944257246828217" crossorigin="anonymous"></script>
</body>
</html>