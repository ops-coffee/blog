<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="applicable-device" content="pc,mobile">
  <meta name="keywords" content="ELK,MySQL,SQL,å…³äºæŠ€æœ¯" />
  <meta name="description" content="æ„å»ºå®ŒSQLå®¡æ ¸ç³»ç»Ÿï¼Œæˆ‘ä»¬å†æ¥èŠèŠMySQLçš„æ…¢æ—¥å¿—æ”¶é›†" />
  <link rel="alternate" type="application/rss+xml" title="è¿ç»´å’–å•¡å§" href="https://blog.ops-coffee.cn/feed.xml" />
  <link rel="stylesheet" href="https://blog.ops-coffee.cn/static/posts/css/ops-coffee.min.css" type="text/css" />

  <!-- Begin SEO tag -->
  <title>ELKæ„å»ºMySQLæ…¢æ—¥å¿—æ”¶é›†å¹³å°è¯¦è§£</title>
  <meta property="og:locale" content="zh_CN" />
  <meta property="og:site_name" content="è¿ç»´å’–å•¡å§" />
  <meta property="og:url" content="https://blog.ops-coffee.cn" />
  <meta property="og:title" content="ELKæ„å»ºMySQLæ…¢æ—¥å¿—æ”¶é›†å¹³å°è¯¦è§£" />
  <meta property="og:description" content="æ„å»ºå®ŒSQLå®¡æ ¸ç³»ç»Ÿï¼Œæˆ‘ä»¬å†æ¥èŠèŠMySQLçš„æ…¢æ—¥å¿—æ”¶é›†" />
  <link rel="canonical" href="https://blog.ops-coffee.cn" />
  <!-- End SEO tag -->
</head>

<body>
  <div class="header">
    <div class="container">
      <nav class="header-site">
        <ul>
          <li><a href="/">é¦–é¡µ</a></li>
            <li class="has-submenu">
              <a href="#" target="_self">è¿ç»´</a>
              <ul class="sub-menu">
                <li><a href="/tag/ç³»ç»Ÿè¿ç»´/" target="_self">ç³»ç»Ÿè¿ç»´</a></li>
                <li><a href="/elk/index.html" target="_self">ELKç³»åˆ—</a></li>
                <li><a href="/ldap/index.html" target="_self">LDAPç³»åˆ—</a></li>
              </ul>
            </li>
            <li class="has-submenu">
              <a href="#" target="_self">å¼€å‘</a>
              <ul class="sub-menu">
                <li><a href="/tag/Devops/" target="_self">DevOps</a></li>
                <li><a href="/tag/Python/" target="_self">Python</a></li>
                <li><a href="/tag/Django/" target="_self">Django</a></li>
                <li><a href="/bpmn/index.html" target="_self">BPMNç³»åˆ—</a></li>
                <li><a href="/webssh/index.html" target="_self">WebSSHç³»åˆ—</a></li>
                <li><a href="/frontend/index.html" target="_self">å‰ç«¯å¼€å‘ç³»åˆ—</a></li>
              </ul>
            </li>
            <li><a href="/devops.html" target="_self">è¿ç»´å¹³å°</a></li>
            <li><a href="/tag/è¿™æ˜¯ç”Ÿæ´»/" target="_self">è¿™æ˜¯ç”Ÿæ´»</a></li>
            <li class="has-submenu">
              <a href="#" target="_self">æˆ¿è½¦æ—…è¡Œ</a>
              <ul class="sub-menu">
                <li><a href="/r/index.html" target="_self">æˆ¿è½¦ä½“éªŒ</a></li>
                <li><a href="/travels.html" target="_self">æ—…è¡Œæ¸¸è®°</a></li>
              </ul>
            </li>
            <li><a href="/tag/index.html" target="_self">æ ‡ç­¾</a></li>
            <li><a href="/archive.html" target="_self">å½’æ¡£</a></li>
        </ul>
      </nav>
    </div>
  </div>

  <header>
    <div class="container">
      <a href="/">
        <h1>è¿ç»´å’–å•¡å§</h1>
        <h2>äº«å—æŠ€æœ¯å¸¦æ¥çš„ä¹è¶£ï¼Œä½“éªŒç”Ÿæ´»ç»™äºˆçš„æ„ŸåŠ¨</h2>
      </a>
    </div>
  </header>

  <div id="content-wrap">
    <div class="container">
        <h1 id="art-title">ELKæ„å»ºMySQLæ…¢æ—¥å¿—æ”¶é›†å¹³å°è¯¦è§£</h1>

        <blockquote>
<p>ä¸Šç¯‡æ–‡ç« <a href="/s/ZrrLUNRlAXVfVKvA1m0nsg" target="_blank">ã€Šä¸­å°å›¢é˜Ÿå¿«é€Ÿæ„å»ºSQLè‡ªåŠ¨å®¡æ ¸ç³»ç»Ÿã€‹</a>æˆ‘ä»¬å®Œæˆäº†SQLçš„è‡ªåŠ¨å®¡æ ¸ä¸æ‰§è¡Œï¼Œä¸ä»…æé«˜äº†æ•ˆç‡è¿˜å—åˆ°äº†åŒäº‹çš„è‚¯å®šï¼Œå¿ƒé‡Œç¾æ»‹æ»‹ã€‚ä½†å…³äºæ…¢æŸ¥è¯¢çš„æ”¶é›†åŠå¤„ç†ä¹Ÿè€—è´¹äº†æˆ‘ä»¬å¤ªå¤šçš„æ—¶é—´å’Œç²¾åŠ›ï¼Œå¦‚ä½•åœ¨è¿™ä¸€å—ä¹Ÿèƒ½æå‡æ•ˆç‡å‘¢ï¼Ÿä¸”çœ‹æœ¬æ–‡è®²è§£å¦‚ä½•åˆ©ç”¨ELKåšæ…¢æ—¥å¿—æ”¶é›†</p>
</blockquote>
<h1 id="elk">ELKä»‹ç»</h1>
<p>ELKæœ€æ—©æ˜¯Elasticsearchï¼ˆä»¥ä¸‹ç®€ç§°ESï¼‰ã€Logstashã€Kibanaä¸‰æ¬¾å¼€æºè½¯ä»¶çš„ç®€ç§°ï¼Œä¸‰æ¬¾è½¯ä»¶åæ¥è¢«åŒä¸€å…¬å¸æ”¶è´­ï¼Œå¹¶åŠ å…¥äº†Xparkã€Beatsç­‰ç»„ä»¶ï¼Œæ”¹åä¸ºElastic Stackï¼Œæˆä¸ºç°åœ¨æœ€æµè¡Œçš„å¼€æºæ—¥å¿—è§£å†³æ–¹æ¡ˆï¼Œè™½ç„¶æœ‰äº†æ–°åå­—ä½†å¤§å®¶ä¾ç„¶å–œæ¬¢å«å¥¹ELKï¼Œç°åœ¨æ‰€è¯´çš„ELKå°±æŒ‡çš„æ˜¯åŸºäºè¿™äº›å¼€æºè½¯ä»¶æ„å»ºçš„æ—¥å¿—ç³»ç»Ÿã€‚</p>
<p>æˆ‘ä»¬æ”¶é›†mysqlæ…¢æ—¥å¿—çš„æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p>
<p><img alt="" loading="lazy" src="/static/images/2018/0810.elk.png" /></p>
<ul>
<li>mysqlæœåŠ¡å™¨å®‰è£…Filebeatä½œä¸ºagentæ”¶é›†slowLog</li>
<li>Filebeatè¯»å–mysqlæ…¢æ—¥å¿—æ–‡ä»¶åšç®€å•è¿‡æ»¤ä¼ ç»™Kafkaé›†ç¾¤</li>
<li>Logstashè¯»å–Kafkaé›†ç¾¤æ•°æ®å¹¶æŒ‰å­—æ®µæ‹†åˆ†åè½¬æˆJSONæ ¼å¼å­˜å…¥ESé›†ç¾¤</li>
<li>Kibanaè¯»å–ESé›†ç¾¤æ•°æ®å±•ç¤ºåˆ°webé¡µé¢ä¸Š</li>
</ul>
<h1 id="_1">æ…¢æ—¥å¿—åˆ†ç±»</h1>
<p>ç›®å‰ä¸»è¦ä½¿ç”¨çš„mysqlç‰ˆæœ¬æœ‰5.5ã€5.6å’Œ5.7ï¼Œç»è¿‡ä»”ç»†å¯¹æ¯”å‘ç°æ¯ä¸ªç‰ˆæœ¬çš„æ…¢æŸ¥è¯¢æ—¥å¿—éƒ½ç¨æœ‰ä¸åŒï¼Œå¦‚ä¸‹ï¼š</p>
<p>5.5ç‰ˆæœ¬æ…¢æŸ¥è¯¢æ—¥å¿—</p>
<pre class="codehilite"><code># Time: 180810  8:45:12
# User@Host: select[select] @  [10.63.253.59]
# Query_time: 1.064555  Lock_time: 0.000054 Rows_sent: 1  Rows_examined: 319707
SET timestamp=1533861912;
SELECT COUNT(*) FROM hs_forum_thread t  WHERE t.`fid`='50' AND t.`displayorder`&gt;='0';</code></pre>


<p>5.6ç‰ˆæœ¬æ…¢æŸ¥è¯¢æ—¥å¿—</p>
<pre class="codehilite"><code># Time: 160928 18:36:08
# User@Host: root[root] @ localhost []  Id:  4922
# Query_time: 5.207662  Lock_time: 0.000085 Rows_sent: 1  Rows_examined: 526068
use db_name;
SET timestamp=1475058968;
select count(*) from redeem_item_consume where id&lt;=526083;</code></pre>


<p>5.7ç‰ˆæœ¬æ…¢æŸ¥è¯¢æ—¥å¿—</p>
<pre class="codehilite"><code># Time: 2018-07-09T10:04:14.666231Z
# User@Host: bbs_code[bbs_code] @  [10.82.9.220]  Id: 9304381
# Query_time: 5.274805  Lock_time: 0.000052 Rows_sent: 0  Rows_examined: 2
SET timestamp=1531130654;
SELECT * FROM pre_common_session WHERE  sid='Ba1cSC'  OR lastactivity&lt;1531129749;</code></pre>


<p>æ…¢æŸ¥è¯¢æ—¥å¿—å¼‚åŒç‚¹ï¼š</p>
<ol>
<li>æ¯ä¸ªç‰ˆæœ¬çš„Timeå­—æ®µæ ¼å¼éƒ½ä¸ä¸€æ ·</li>
<li>ç›¸è¾ƒäº5.6ã€5.7ç‰ˆæœ¬ï¼Œ5.5ç‰ˆæœ¬å°‘äº†Idå­—æ®µ</li>
<li><code>use db</code>è¯­å¥ä¸æ˜¯æ¯æ¡æ…¢æ—¥å¿—éƒ½æœ‰çš„</li>
<li>å¯èƒ½ä¼šå‡ºç°åƒä¸‹è¾¹è¿™æ ·çš„æƒ…å†µï¼Œæ…¢æŸ¥è¯¢å—<code># Timeï¼š</code>ä¸‹å¯èƒ½è·Ÿäº†å¤šä¸ªæ…¢æŸ¥è¯¢è¯­å¥</li>
</ol>
<pre class="codehilite"><code># Time: 160918  2:00:03
# User@Host: dba_monitor[dba_monitor] @  [10.63.144.82]  Id:   968
# Query_time: 0.007479  Lock_time: 0.000181 Rows_sent: 172  Rows_examined: 344
SET timestamp=1474135203;
SELECT table_schema as 'DB',table_name as 'TABLE',CONCAT(ROUND(( data_length + index_length ) / ( 1024 * 1024 *1024 ), 2), '') as 'TOTAL',TABLE_COMMENT  FROM information_schema.TABLES ORDER BY data_length + index_length DESC;
# User@Host: dba_monitor[dba_monitor] @  [10.63.144.82]  Id:   969
# Query_time: 0.003303  Lock_time: 0.000395 Rows_sent: 233  Rows_examined: 233
SET timestamp=1474135203;
select TABLE_SCHEMA,TABLE_NAME,COLUMN_NAME,ORDINAL_POSITION,COLUMN_TYPE,ifnull(COLUMN_COMMENT,0) from COLUMNS where table_schema not in ('mysql','information_schema','performance_schema','test');</code></pre>


<h1 id="_2">å¤„ç†æ€è·¯</h1>
<p>ä¸Šè¾¹æˆ‘ä»¬å·²ç»åˆ†æäº†å„ä¸ªç‰ˆæœ¬æ…¢æŸ¥è¯¢è¯­å¥çš„æ„æˆï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦å¼€å§‹æ”¶é›†è¿™äº›æ•°æ®äº†ï¼Œç©¶ç«Ÿåº”è¯¥æ€ä¹ˆæ”¶é›†å‘¢ï¼Ÿ</p>
<ol>
<li>æ‹¼è£…æ—¥å¿—è¡Œï¼šmysqlçš„æ…¢æŸ¥è¯¢æ—¥å¿—<strong>å¤šè¡Œ</strong>æ„æˆäº†ä¸€æ¡å®Œæ•´çš„æ—¥å¿—ï¼Œæ—¥å¿—æ”¶é›†æ—¶è¦æŠŠè¿™äº›è¡Œæ‹¼è£…æˆä¸€æ¡æ—¥å¿—ä¼ è¾“ä¸å­˜å‚¨ã€‚</li>
<li>Timeè¡Œå¤„ç†ï¼š<code># Time:</code>å¼€å¤´çš„è¡Œå¯èƒ½ä¸å­˜åœ¨ï¼Œä¸”æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>SET timestamp</code>è¿™ä¸ªå€¼æ¥ç¡®å®šSQLæ‰§è¡Œæ—¶é—´ï¼Œæ‰€ä»¥é€‰æ‹©è¿‡æ»¤ä¸¢å¼ƒTimeè¡Œ</li>
<li>ä¸€æ¡å®Œæ•´çš„æ—¥å¿—ï¼šæœ€ç»ˆå°†ä»¥<code># User@Host:</code>å¼€å§‹çš„è¡Œï¼Œå’Œä»¥SQLè¯­å¥ç»“å°¾çš„è¡Œåˆå¹¶ä¸ºä¸€æ¡å®Œæ•´çš„æ…¢æ—¥å¿—è¯­å¥</li>
<li>ç¡®å®šSQLå¯¹åº”çš„DBï¼š<code>use db</code>è¿™ä¸€è¡Œä¸æ˜¯æ‰€æœ‰æ…¢æ—¥å¿—SQLéƒ½å­˜åœ¨çš„ï¼Œæ‰€ä»¥ä¸èƒ½é€šè¿‡è¿™ä¸ªæ¥ç¡®å®šSQLå¯¹åº”çš„DBï¼Œæ…¢æ—¥å¿—ä¸­ä¹Ÿæ²¡æœ‰å­—æ®µè®°å½•DBï¼Œæ‰€ä»¥è¿™é‡Œå»ºè®®<strong>ä¸ºDBåˆ›å»ºè´¦å·æ—¶æ·»åŠ db nameæ ‡è¯†</strong>ï¼Œä¾‹å¦‚æˆ‘ä»¬çš„è´¦å·å‘½åæ–¹å¼ä¸ºï¼š<code>projectName_dbName</code>ï¼Œè¿™æ ·çœ‹åˆ°è´¦å·åå°±çŸ¥é“æ˜¯å“ªä¸ªDBäº†</li>
<li>ç¡®å®šSQLå¯¹åº”çš„ä¸»æœºï¼šæˆ‘æƒ³é€šè¿‡æ—¥å¿—çŸ¥é“è¿™æ¡SQLå¯¹åº”çš„æ˜¯å“ªå°æ•°æ®åº“æœåŠ¡å™¨æ€ä¹ˆåŠï¼Ÿæ…¢æ—¥å¿—ä¸­åŒæ ·æ²¡æœ‰å­—æ®µè®°å½•ä¸»æœºï¼Œå¯ä»¥é€šè¿‡filebeatæ³¨å…¥å­—æ®µæ¥è§£å†³ï¼Œä¾‹å¦‚æˆ‘ä»¬ç»™filebeatçš„nameå­—æ®µè®¾ç½®ä¸ºæœåŠ¡å™¨IPï¼Œè¿™æ ·æœ€ç»ˆé€šè¿‡<code>beat.name</code>è¿™ä¸ªå­—æ®µå°±å¯ä»¥ç¡®å®šSQLå¯¹åº”çš„ä¸»æœºäº†</li>
</ol>
<h1 id="filebeat">Filebeaté…ç½®</h1>
<p>filebeatå®Œæ•´çš„é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<pre class="codehilite"><code>filebeat.prospectors:

- input_type: log
  paths:
    - /home/opt/data/slow/mysql_slow.log

  exclude_lines: ['^\# Time']

  multiline.pattern: '^\# Time|^\# User'
  multiline.negate: true
  multiline.match: after

  tail_files: true

name: 10.82.9.89

output.kafka:
  hosts: [&quot;10.82.9.202:9092&quot;,&quot;10.82.9.203:9092&quot;,&quot;10.82.9.204:9092&quot;]
  topic: mysql_slowlog_v2</code></pre>


<h3 id="_3">é‡è¦å‚æ•°è§£é‡Šï¼š</h3>
<ul>
<li><strong>input_type</strong>ï¼šæŒ‡å®šè¾“å…¥çš„ç±»å‹æ˜¯logæˆ–è€…æ˜¯stdin</li>
<li><strong>paths</strong>ï¼šæ…¢æ—¥å¿—è·¯å¾„ï¼Œæ”¯æŒæ­£åˆ™æ¯”å¦‚/data/*.log</li>
<li><strong>exclude_lines</strong>ï¼šè¿‡æ»¤æ‰<code># Time</code>å¼€å¤´çš„è¡Œ</li>
<li><strong>multiline.pattern</strong>ï¼šåŒ¹é…å¤šè¡Œæ—¶æŒ‡å®šæ­£åˆ™è¡¨è¾¾å¼ï¼Œè¿™é‡ŒåŒ¹é…ä»¥<code># Time</code>æˆ–è€…<code># User</code>å¼€å¤´çš„è¡Œï¼ŒTimeè¡Œè¦å…ˆåŒ¹é…å†è¿‡æ»¤</li>
<li><strong>multiline.negate</strong>ï¼šå®šä¹‰ä¸Šè¾¹patternåŒ¹é…åˆ°çš„è¡Œæ˜¯å¦ç”¨äºå¤šè¡Œåˆå¹¶ï¼Œä¹Ÿå°±æ˜¯å®šä¹‰æ˜¯ä¸æ˜¯ä½œä¸ºæ—¥å¿—çš„ä¸€éƒ¨åˆ†</li>
<li><strong>multiline.match</strong>ï¼šå®šä¹‰å¦‚ä½•å°†çš®æ’è¡Œç»„åˆæˆæ—¶é—´ï¼Œåœ¨ä¹‹å‰æˆ–è€…ä¹‹å</li>
<li><strong>tail_files</strong>ï¼šå®šä¹‰æ˜¯ä»æ–‡ä»¶å¼€å¤´è¯»å–æ—¥å¿—è¿˜æ˜¯ç»“å°¾ï¼Œè¿™é‡Œå®šä¹‰ä¸ºtrueï¼Œä»ç°åœ¨å¼€å§‹æ”¶é›†ï¼Œä¹‹å‰å·²å­˜åœ¨çš„ä¸ç®¡</li>
<li><strong>name</strong>ï¼šè®¾ç½®filebeatçš„åå­—ï¼Œå¦‚æœä¸ºç©ºåˆ™ä¸ºæœåŠ¡å™¨çš„ä¸»æœºåï¼Œè¿™é‡Œæˆ‘ä»¬å®šä¹‰ä¸ºæœåŠ¡å™¨IP</li>
<li><strong>output.kafka</strong>ï¼šé…ç½®è¦æ¥æ”¶æ—¥å¿—çš„kafkaé›†ç¾¤åœ°å€å¯topicåç§°</li>
</ul>
<h3 id="kafka">Kafkaæ¥æ”¶åˆ°çš„æ—¥å¿—æ ¼å¼ï¼š</h3>
<pre class="codehilite"><code>{&quot;@timestamp&quot;:&quot;2018-08-07T09:36:00.140Z&quot;,&quot;beat&quot;:{&quot;hostname&quot;:&quot;db-7eb166d3&quot;,&quot;name&quot;:&quot;10.63.144.71&quot;,&quot;version&quot;:&quot;5.4.0&quot;},&quot;input_type&quot;:&quot;log&quot;,&quot;message&quot;:&quot;# User@Host: select[select] @  [10.63.144.16]  Id: 23460596\n# Query_time: 0.155956  Lock_time: 0.000079 Rows_sent: 112  Rows_examined: 366458\nSET timestamp=1533634557;\nSELECT DISTINCT(uid) FROM common_member WHERE hideforum=-1 AND uid != 0;&quot;,&quot;offset&quot;:1753219021,&quot;source&quot;:&quot;/data/slow/mysql_slow.log&quot;,&quot;type&quot;:&quot;log&quot;}</code></pre>


<h1 id="logstash">Logstashé…ç½®</h1>
<p>logstashå®Œæ•´çš„é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<pre class="codehilite"><code>input {
    kafka {
        bootstrap_servers =&gt; &quot;10.82.9.202:9092,10.82.9.203:9092,10.82.9.204:9092&quot;
        topics =&gt; [&quot;mysql_slowlog_v2&quot;]
    }
}

filter {
    json {
        source =&gt; &quot;message&quot;
    }

    grok {
        # æœ‰IDæœ‰use
        match =&gt; [ &quot;message&quot;, &quot;(?m)^# User@Host: %{USER:user}\[[^\]]+\] @ (?:(?&lt;clienthost&gt;\S*) )?\[(?:%{IP:clientip})?\]\s+Id:\s%{NUMBER:id:int}\n# Query_time: %{NUMBER:query_time:float}\s+Lock_time: %{NUMBER:lock_time:float}\s+Rows_sent: %{NUMBER:rows_sent:int}\s+Rows_examined: %{NUMBER:rows_examined:int}\nuse\s(?&lt;dbname&gt;\w+);\nSET\s+timestamp=%{NUMBER:timestamp_mysql:int};\n(?&lt;query&gt;.*)&quot; ]

        # æœ‰IDæ— use
        match =&gt; [ &quot;message&quot;, &quot;(?m)^# User@Host: %{USER:user}\[[^\]]+\] @ (?:(?&lt;clienthost&gt;\S*) )?\[(?:%{IP:clientip})?\]\s+Id:\s%{NUMBER:id:int}\n# Query_time: %{NUMBER:query_time:float}\s+Lock_time: %{NUMBER:lock_time:float}\s+Rows_sent: %{NUMBER:rows_sent:int}\s+Rows_examined: %{NUMBER:rows_examined:int}\nSET\s+timestamp=%{NUMBER:timestamp_mysql:int};\n(?&lt;query&gt;.*)&quot; ]

        # æ— IDæœ‰use
        match =&gt; [ &quot;message&quot;, &quot;(?m)^# User@Host: %{USER:user}\[[^\]]+\] @ (?:(?&lt;clienthost&gt;\S*) )?\[(?:%{IP:clientip})?\]\n# Query_time: %{NUMBER:query_time:float}\s+Lock_time: %{NUMBER:lock_time:float}\s+Rows_sent: %{NUMBER:rows_sent:int}\s+Rows_examined: %{NUMBER:rows_examined:int}\nuse\s(?&lt;dbname&gt;\w+);\nSET\s+timestamp=%{NUMBER:timestamp_mysql:int};\n(?&lt;query&gt;.*)&quot; ]

        # æ— IDæ— use
        match =&gt; [ &quot;message&quot;, &quot;(?m)^# User@Host: %{USER:user}\[[^\]]+\] @ (?:(?&lt;clienthost&gt;\S*) )?\[(?:%{IP:clientip})?\]\n# Query_time: %{NUMBER:query_time:float}\s+Lock_time: %{NUMBER:lock_time:float}\s+Rows_sent: %{NUMBER:rows_sent:int}\s+Rows_examined: %{NUMBER:rows_examined:int}\nSET\s+timestamp=%{NUMBER:timestamp_mysql:int};\n(?&lt;query&gt;.*)&quot; ]
    }

    date {
        match =&gt; [&quot;timestamp_mysql&quot;,&quot;UNIX&quot;]
        target =&gt; &quot;@timestamp&quot;
    }

}

output {
    elasticsearch {
        hosts =&gt; [&quot;10.82.9.208:9200&quot;,&quot;10.82.9.217:9200&quot;]
        index =&gt; &quot;mysql-slowlog-%{+YYYY.MM.dd}&quot;
    }
}</code></pre>


<h3 id="_4">é‡è¦å‚æ•°è§£é‡Šï¼š</h3>
<ul>
<li><strong>input</strong>ï¼šé…ç½®kafkaçš„é›†ç¾¤åœ°å€å’Œtopicåå­—</li>
<li><strong>filter</strong>ï¼šè¿‡æ»¤æ—¥å¿—æ–‡ä»¶ï¼Œä¸»è¦æ˜¯å¯¹messageä¿¡æ¯ï¼ˆçœ‹å‰æ–‡kafkaæ¥æ”¶åˆ°çš„æ—¥å¿—æ ¼å¼ï¼‰è¿›è¡Œæ‹†åˆ†ï¼Œæ‹†åˆ†æˆä¸€ä¸ªä¸€ä¸ªæ˜“è¯»çš„å­—æ®µï¼Œä¾‹å¦‚<code>User</code>ã€<code>Host</code>ã€<code>Query_time</code>ã€<code>Lock_time</code>ã€<code>timestamp</code>ç­‰ã€‚grokæ®µæ ¹æ®æˆ‘ä»¬å‰æ–‡å¯¹mysqlæ…¢æ—¥å¿—çš„åˆ†ç±»åˆ†åˆ«å†™ä¸é€šçš„æ­£åˆ™è¡¨è¾¾å¼å»åŒ¹é…ï¼Œå½“æœ‰å¤šæ¡æ­£åˆ™è¡¨è¾¾å¼å­˜åœ¨æ—¶ï¼Œlogstashä¼šä»ä¸Šåˆ°ä¸‹ä¾æ¬¡åŒ¹é…ï¼ŒåŒ¹é…åˆ°ä¸€æ¡åè¾¹çš„åˆ™ä¸å†åŒ¹é…ã€‚dateå­—æ®µå®šä¹‰äº†è®©SQLä¸­çš„timestamp_mysqlå­—æ®µä½œä¸ºè¿™æ¡æ—¥å¿—çš„æ—¶é—´å­—æ®µï¼Œkibanaä¸Šçœ‹åˆ°çš„å®è·µæ’åºçš„æ•°æ®ä¾èµ–çš„å°±æ˜¯è¿™ä¸ªæ—¶é—´</li>
<li><strong>output</strong>ï¼šé…ç½®ESæœåŠ¡å™¨é›†ç¾¤çš„åœ°å€å’Œindexï¼Œindexè‡ªåŠ¨æŒ‰å¤©åˆ†å‰²</li>
</ul>
<h1 id="kibana">kibanaæŸ¥è¯¢å±•ç¤º</h1>
<ul>
<li>æ‰“å¼€Kibanaæ·»åŠ <code>mysql-slowlog-*</code>çš„Indexï¼Œå¹¶é€‰æ‹©timestampï¼Œåˆ›å»ºIndex Pattern</li>
</ul>
<p><img alt="" loading="lazy" src="/static/images/2018/0810.00.png" /></p>
<ul>
<li>è¿›å…¥Discoveré¡µé¢ï¼Œå¯ä»¥å¾ˆç›´è§‚çš„çœ‹åˆ°å„ä¸ªæ—¶é—´ç‚¹æ…¢æ—¥å¿—çš„æ•°é‡å˜åŒ–ï¼Œå¯ä»¥æ ¹æ®å·¦ä¾§Fieldå®ç°ç®€å•è¿‡æ»¤ï¼Œæœç´¢æ¡†ä¹Ÿæ–¹ä¾¿æœç´¢æ…¢æ—¥å¿—ï¼Œä¾‹å¦‚æˆ‘è¦æ‰¾æŸ¥è¯¢æ—¶é—´å¤§äº2sçš„æ…¢æ—¥å¿—ï¼Œç›´æ¥åœ¨æœç´¢æ¡†è¾“å…¥<code>query_time: &gt; 2</code>å›è½¦å³å¯</li>
</ul>
<p><img alt="" loading="lazy" src="/static/images/2018/0810.01.png" /></p>
<ul>
<li>ç‚¹å‡»æ¯ä¸€æ¡æ—¥å¿—èµ·è¾¹çš„å¾ˆè‰²ç®­å¤´èƒ½æŸ¥çœ‹å…·ä½“æŸä¸€æ¡æ—¥å¿—çš„è¯¦æƒ…</li>
</ul>
<p><img alt="" loading="lazy" src="/static/images/2018/0810.02.png" /></p>
<ul>
<li>å¦‚æœä½ æƒ³åšä¸ªå¤§ç›˜ç»Ÿè®¡æ…¢æ—¥å¿—çš„æ•´ä½“æƒ…å†µï¼Œä¾‹å¦‚top 10 SQLç­‰ï¼Œä¹Ÿå¯ä»¥å¾ˆæ–¹ä¾¿çš„é€šè¿‡webç•Œé¢é…ç½®</li>
</ul>
<p><img alt="" loading="lazy" src="/static/images/2018/0810.03.png" /></p>
<h1 id="_5">æ€»ç»“</h1>
<ol>
<li>ä¸è¦æœ›è€Œå´æ­¥ï¼Œå½“ä½ å¼€å§‹å»åšå·²ç»æˆåŠŸä¸€åŠäº†</li>
<li>æœ¬ç¯‡æ–‡ç« è¯¦ç»†ä»‹ç»äº†å…³äºmysqlæ…¢æ—¥å¿—çš„æ”¶é›†ï¼Œæ”¶é›†ä¹‹åçš„å¤„ç†å‘¢ï¼Ÿæˆ‘ä»¬ç›®å‰æ˜¯DBAæ¯å¤©èŠ±æ—¶é—´å»Kibanaä¸ŠæŸ¥çœ‹åˆ†æï¼Œæœ‰ä¼˜åŒ–çš„ç©ºé—´å°±è·Ÿå¼€å‘ä¸€èµ·æ²Ÿé€šä¼˜åŒ–ï¼Œåè¾¹è¾¾æˆé»˜å¥‘ä¹‹åè€ƒè™‘åšæˆè‡ªåŠ¨æŠ¥è­¦æˆ–å¤„ç†</li>
<li>å…³äºæŠ¥è­¦ELKç”Ÿæ€çš„xparkå·²ç»æä¾›ï¼Œä¸”æœ€æ–°ç‰ˆæœ¬ä¹Ÿå¼€æºäº†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å…ˆç ”ç©¶èµ·æ¥ï¼Œæ¬¢è¿ä¸€èµ·äº¤æµ</li>
</ol>

        <div>
          <ul style="display: inline-block;padding: 0;margin: 0 0 0.5em;color: #999;">
            <li style="display: inline-block;margin: 0 1em 0 0;"><a href="/elk/elasticsearch-logstash-mysql-slowlog.html">ğŸ“… 2018-08-16</a></li>
<li style="display: inline-block;margin: 0 1em 0 0;"><a href="/tag/å…³äºæŠ€æœ¯/">ğŸ·ï¸ å…³äºæŠ€æœ¯</a></li>          </ul>
        </div>

        <hr>

        <div class="nav-cell">
            <script async src="https://giscus.app/client.js"
                    data-repo="ops-coffee/blog" data-repo-id="MDEwOlJlcG9zaXRvcnkxNDY4OTI0MTg="
                    data-category="Announcements" data-category-id="DIC_kwDOCMFmgs4CQar3"
                    data-mapping="pathname" data-strict="0" data-reactions-enabled="1"
                    data-emit-metadata="0" data-input-position="top" data-theme="light"
                    data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous">
            </script>
        </div>

        <div>
            <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
            <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8944257246828217"
                 data-ad-slot="6731434232" data-ad-format="auto" data-full-width-responsive="true"></ins>
            <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
        </div>

        <div class="nav-cell">
            <p class="nav-list-title">èƒ½çœ‹åˆ°è¿™é‡Œä¸€å®šæ˜¯çœŸçˆ±ï¼Œå…³æ³¨ä¸€ä¸‹å§</p>
            <img alt="" loading="lazy" src="/static/images/wx.sou1.png" />
        </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="copy"> Â© ops-coffee</div>

      <div class="link">
        <a href="/search.html" title="æœç´¢" target="_blank">æœç´¢</a>
        <a href="/questions.html" title="æé—®" target="_blank">æé—®</a>
        <a href="/friends.html" title="å‹æƒ…é“¾æ¥" target="_blank">å‹é“¾</a>
      </div>
    </div>
  </footer>
  
  <!-- Umami Cloud -->
<script async src="https://umami.ops-coffee.cn/script.js" data-website-id="a4aabd8e-32c7-40e7-a81c-119b909f2d0f"></script>

<!-- Google Adsense -->
<script data-ad-client="ca-pub-8944257246828217" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</body>

</html>