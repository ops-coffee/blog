<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="applicable-device" content="pc,mobile">
  <meta name="keywords" content="Logstash, HDFS, æ•°æ®å¤„ç†, ELK, Kafka, Elasticsearch, æ•°æ®æ”¶é›†, æ’ä»¶, webhdfs, æ—¶åŒºé—®é¢˜" />
  <meta name="description" content="æœ¬æ–‡è¯¦è§£å¦‚ä½•åˆ©ç”¨Logstashå°†æ—¥å¿—æ•°æ®ä»Kafkaå†™å…¥HDFSï¼ŒåŒ…æ‹¬æ’ä»¶å®‰è£…ã€é…ç½®hostsã€logstashé…ç½®ã€å¯åŠ¨logstashåŠå¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆï¼Œç‰¹åˆ«é’ˆå¯¹æ—¶åŒºé—®é¢˜æä¾›äº†è§£å†³æ–¹æ¡ˆï¼Œå¹¶å±•ç¤ºäº†å¦‚ä½•åŒæ—¶è¾“å‡ºæ•°æ®åˆ°ESå’ŒHDFSã€‚" />
  <link rel="alternate" type="application/rss+xml" title="è¿ç»´å’–å•¡å§" href="https://blog.ops-coffee.cn/feed.xml" />
  <link rel="stylesheet" href="https://blog.ops-coffee.cn/static/posts/css/ops-coffee.min.css" type="text/css" />

  <!-- Begin SEO tag -->
  <title>Logstashè¯»å–Kafkaæ•°æ®å†™å…¥HDFSè¯¦è§£</title>
  <meta property="og:locale" content="zh_CN" />
  <meta property="og:site_name" content="è¿ç»´å’–å•¡å§" />
  <meta property="og:url" content="https://blog.ops-coffee.cn" />
  <meta property="og:title" content="Logstashè¯»å–Kafkaæ•°æ®å†™å…¥HDFSè¯¦è§£" />
  <meta property="og:description" content="æœ¬æ–‡è¯¦è§£å¦‚ä½•åˆ©ç”¨Logstashå°†æ—¥å¿—æ•°æ®ä»Kafkaå†™å…¥HDFSï¼ŒåŒ…æ‹¬æ’ä»¶å®‰è£…ã€é…ç½®hostsã€logstashé…ç½®ã€å¯åŠ¨logstashåŠå¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆï¼Œç‰¹åˆ«é’ˆå¯¹æ—¶åŒºé—®é¢˜æä¾›äº†è§£å†³æ–¹æ¡ˆï¼Œå¹¶å±•ç¤ºäº†å¦‚ä½•åŒæ—¶è¾“å‡ºæ•°æ®åˆ°ESå’ŒHDFSã€‚" />
  <link rel="canonical" href="https://blog.ops-coffee.cn" />
  <!-- End SEO tag -->
</head>

<body>
  <div class="header">
    <div class="menu-button">&#9776; 
        <span class="menu-title">è¿ç»´å’–å•¡å§</span>
    </div> 

    <div class="container">
      <nav class="header-site">
        <ul>
          <li><a href="/">é¦–é¡µ</a></li>
            <li class="has-submenu">
              <a href="#" target="_self">è¿ç»´</a>
              <ul class="sub-menu">
                <li><a href="/tag/ç³»ç»Ÿè¿ç»´/" target="_self">ç³»ç»Ÿè¿ç»´</a></li>
                <li><a href="/elk/index.html" target="_self">ELKç³»åˆ—</a></li>
                <li><a href="/ldap/index.html" target="_self">LDAPç³»åˆ—</a></li>
              </ul>
            </li>
            <li class="has-submenu">
              <a href="#" target="_self">å¼€å‘</a>
              <ul class="sub-menu">
                <li><a href="/tag/Devops/" target="_self">DevOps</a></li>
                <li><a href="/tag/Python/" target="_self">Python</a></li>
                <li><a href="/tag/Django/" target="_self">Django</a></li>
                <li><a href="/bpmn/index.html" target="_self">BPMNç³»åˆ—</a></li>
                <li><a href="/webssh/index.html" target="_self">WebSSHç³»åˆ—</a></li>
                <li><a href="/frontend/index.html" target="_self">å‰ç«¯å¼€å‘ç³»åˆ—</a></li>
              </ul>
            </li>
            <li><a href="/devops/index.html" target="_self">è¿ç»´å¹³å°</a></li>
            <li class="has-submenu">
              <a href="#" target="_self">è¿™æ˜¯ç”Ÿæ´»</a>
              <ul class="sub-menu">
                <li><a href="/life/chronicles.html" target="_self">æ—¶å…‰å°è®°</a></li>
                <li><a href="/life/money.html" target="_self">å‰¯ä¸šèµšé’±</a></li>
                <li><a href="/life/writing.html" target="_self">å†™ä½œç›¸å…³</a></li>
                <li><a href="/tag/è¿™æ˜¯ç”Ÿæ´»/" target="_self">ç”Ÿæ´»éšç¬”</a></li>
              </ul>
            </li>
            <li class="has-submenu">
              <a href="#" target="_self">æˆ¿è½¦æ—…è¡Œ</a>
              <ul class="sub-menu">
                <li><a href="/rv.html" target="_self">æˆ¿è½¦ä½“éªŒ</a></li>
                <li><a href="/travels.html" target="_self">æ—…è¡Œæ¸¸è®°</a></li>
                <li><a href="/travel/china.html" target="_self">æ—…è¡Œåœ°å›¾</a></li>
              </ul>
            </li>
            <li><a href="/tag/index.html" target="_self">æ ‡ç­¾</a></li>
            <li><a href="/archive.html" target="_self">å½’æ¡£</a></li>
          <li class="search"><a href="/search.html" target="_self">ğŸ”</a></li>
        </ul>
      </nav>
    </div>
  </div>

  <header>
    <div class="container">
      <a href="/">
        <div class="name">è¿ç»´å’–å•¡å§</div>
        <div class="slogan">äº«å—æŠ€æœ¯å¸¦æ¥çš„ä¹è¶£ï¼Œä½“éªŒç”Ÿæ´»ç»™äºˆçš„æ„ŸåŠ¨</div>
      </a>
    </div>
  </header>

  <div id="content-wrap">
    <div class="container">
        <h1 id="art-title">Logstashè¯»å–Kafkaæ•°æ®å†™å…¥HDFSè¯¦è§£</h1>

        <blockquote>
<p>å¼ºå¤§çš„åŠŸèƒ½ï¼Œä¸°å¯Œçš„æ’ä»¶ï¼Œè®©logstashåœ¨æ•°æ®å¤„ç†çš„è¡Œåˆ—ä¸­å‡ºç±»æ‹”èƒ</p>
</blockquote>
<p>é€šå¸¸æ—¥å¿—æ•°æ®é™¤äº†è¦å…¥ESæä¾›å®æ—¶å±•ç¤ºå’Œç®€å•ç»Ÿè®¡å¤–ï¼Œè¿˜éœ€è¦å†™å…¥å¤§æ•°æ®é›†ç¾¤æ¥æä¾›æ›´ä¸ºæ·±å…¥çš„é€»è¾‘å¤„ç†ï¼Œå‰è¾¹å‡ ç¯‡ELKçš„æ–‡ç« ä»‹ç»è¿‡åˆ©ç”¨logstashå°†kafkaçš„æ•°æ®å†™å…¥åˆ°elasticsearché›†ç¾¤ï¼Œè¿™ç¯‡æ–‡ç« å°†ä¼šä»‹ç»å¦‚ä½•é€šè¿‡logstashå°†æ•°æ®å†™å…¥HDFS</p>
<p>æœ¬æ–‡æ‰€æœ‰æ¼”ç¤ºå‡åŸºäºlogstash 6.6.2ç‰ˆæœ¬</p>
<h1 id="_1">æ•°æ®æ”¶é›†</h1>
<p>logstashé»˜è®¤ä¸æ”¯æŒæ•°æ®ç›´æ¥å†™å…¥HDFSï¼Œå®˜æ–¹æ¨èçš„outputæ’ä»¶æ˜¯<code>webhdfs</code>ï¼Œwebhdfsä½¿ç”¨HDFSæä¾›çš„APIå°†æ•°æ®å†™å…¥HDFSé›†ç¾¤</p>
<h2 id="_2">æ’ä»¶å®‰è£…</h2>
<p>æ’ä»¶å®‰è£…æ¯”è¾ƒç®€å•ï¼Œç›´æ¥ä½¿ç”¨å†…ç½®å‘½ä»¤å³å¯</p>
<pre class="codehilite"><code># cd /home/opt/tools/logstash-6.6.2
# ./bin/logstash-plugin install logstash-output-webhdfs</code></pre>


<h2 id="hosts">é…ç½®hosts</h2>
<p>HDFSé›†ç¾¤å†…é€šè¿‡ä¸»æœºåè¿›è¡Œé€šä¿¡æ‰€ä»¥logstashæ‰€åœ¨çš„ä¸»æœºéœ€è¦é…ç½®hadoopé›†ç¾¤çš„hostsä¿¡æ¯</p>
<pre class="codehilite"><code># cat /etc/hosts
192.168.107.154 master01
192.168.107.155 slave01
192.168.107.156 slave02
192.168.107.157 slave03</code></pre>


<p>å¦‚æœä¸é…ç½®hostä¿¡æ¯ï¼Œå¯èƒ½ä¼šæŠ¥ä¸‹è¾¹çš„é”™</p>
<pre class="codehilite"><code>[WARN ][logstash.outputs.webhdfs ] Failed to flush outgoing items</code></pre>


<h2 id="logstash">logstashé…ç½®</h2>
<p>kafkaé‡Œè¾¹çš„æºæ—¥å¿—æ ¼å¼å¯ä»¥å‚è€ƒè¿™ç‰‡æ–‡ç« ï¼š<a href="/elk/elasticsearch-logstash-rsyslog-nginx" target="_blank">ELKæ—¥å¿—ç³»ç»Ÿä¹‹ä½¿ç”¨Rsyslogå¿«é€Ÿæ–¹ä¾¿çš„æ”¶é›†Nginxæ—¥å¿—</a></p>
<p>logstashçš„é…ç½®å¦‚ä¸‹ï¼š</p>
<pre class="codehilite"><code># cat config/indexer_rsyslog_nginx.conf
input {
    kafka {
        bootstrap_servers =&gt; &quot;10.82.9.202:9092,10.82.9.203:9092,10.82.9.204:9092&quot;
        topics =&gt; [&quot;rsyslog_nginx&quot;]
        codec =&gt; &quot;json&quot;
    }
}

filter {
    date {
        match =&gt; [&quot;time_local&quot;,&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;]
        target =&gt; &quot;time_local&quot;
    }

    ruby {
        code =&gt; &quot;event.set('index.date', event.get('time_local').time.localtime.strftime('%Y%m%d'))&quot;
    }

    ruby {
        code =&gt; &quot;event.set('index.hour', event.get('time_local').time.localtime.strftime('%H'))&quot;
    }
}

output {
    webhdfs {
        host =&gt; &quot;master01&quot;
        port =&gt; 50070
        user =&gt; &quot;hadmin&quot;
        path =&gt; &quot;/logs/nginx/%{index.date}/%{index.hour}.log&quot;
        codec =&gt; &quot;json&quot;
    }
    stdout { codec =&gt; rubydebug }
}</code></pre>


<p>logstashé…ç½®æ–‡ä»¶åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼šinputã€filterã€output</p>
<p><strong>input</strong>æŒ‡å®šæºåœ¨å“ªé‡Œï¼Œæˆ‘ä»¬æ˜¯ä»kafkaå–æ•°æ®ï¼Œè¿™é‡Œå°±å†™kafkaé›†ç¾¤çš„é…ç½®ä¿¡æ¯ï¼Œé…ç½®è§£é‡Šï¼š
  - bootstrap_serversï¼šæŒ‡å®škafkaé›†ç¾¤çš„åœ°å€
  - topicsï¼šéœ€è¦è¯»å–çš„topicåå­—
  - codecï¼šæŒ‡å®šä¸‹æ•°æ®çš„æ ¼å¼ï¼Œæˆ‘ä»¬å†™å…¥çš„æ—¶å€™ç›´æ¥æ˜¯jsonæ ¼å¼çš„ï¼Œè¿™é‡Œä¹Ÿé…ç½®jsonæ–¹ä¾¿åç»­å¤„ç†</p>
<p><strong>filter</strong>å¯ä»¥å¯¹inputè¾“å…¥çš„å†…å®¹è¿›è¡Œè¿‡æ»¤æˆ–å¤„ç†ï¼Œä¾‹å¦‚æ ¼å¼åŒ–ï¼Œæ·»åŠ å­—æ®µï¼Œåˆ é™¤å­—æ®µç­‰ç­‰</p>
<ul>
<li>è¿™é‡Œæˆ‘ä»¬ä¸»è¦æ˜¯ä¸ºäº†è§£å†³ç”ŸæˆHDFSæ–‡ä»¶æ—¶å› æ—¶åŒºä¸å¯¹å·®8å°æ—¶å¯¼è‡´çš„æ–‡ä»¶åä¸å¯¹çš„é—®é¢˜ï¼Œåè¾¹æœ‰è¯¦ç»†è§£é‡Š</li>
</ul>
<p><strong>output</strong>æŒ‡å®šå¤„ç†è¿‡çš„æ—¥å¿—è¾“å‡ºåˆ°å“ªé‡Œï¼Œå¯ä»¥æ˜¯ESæˆ–è€…æ˜¯HDFSç­‰ç­‰ï¼Œå¯ä»¥åŒæ—¶é…ç½®å¤šä¸ªï¼Œwebhdfsä¸»è¦é…ç½®è§£é‡Šï¼š</p>
<ul>
<li>hostï¼šä¸ºhadoopé›†ç¾¤namenodeèŠ‚ç‚¹åç§°</li>
<li>userï¼šä¸ºå¯åŠ¨hdfsçš„ç”¨æˆ·åï¼Œä¸ç„¶æ²¡æœ‰æƒé™å†™å…¥æ•°æ®</li>
<li>pathï¼šæŒ‡å®šå­˜å‚¨åˆ°HDFSä¸Šçš„æ–‡ä»¶è·¯å¾„ï¼Œè¿™é‡Œæˆ‘ä»¬æ¯æ—¥åˆ›å»ºç›®å½•ï¼Œå¹¶æŒ‰å°æ—¶å­˜æ”¾æ–‡ä»¶</li>
<li>stdoutï¼šæ‰“å¼€ä¸»è¦æ˜¯æ–¹ä¾¿è°ƒè¯•ï¼Œå¯åŠ¨logstashæ—¶ä¼šåœ¨æ§åˆ¶å°æ‰“å°è¯¦ç»†çš„æ—¥å¿—ä¿¡æ¯å¹¶æ ¼å¼åŒ–æ–¹ä¾¿æŸ¥æ‰¾é—®é¢˜ï¼Œæ­£å¼ç¯å¢ƒå»ºè®®å…³é—­</li>
</ul>
<p>webhdfsè¿˜æœ‰ä¸€äº›å…¶ä»–çš„å‚æ•°ä¾‹å¦‚<code>compression</code>,<code>flush_size</code>,<code>standby_host</code>,<code>standby_port</code>ç­‰å¯æŸ¥çœ‹<a href="https://www.elastic.co/guide/en/logstash/current/plugins-outputs-webhdfs.html" target="_blank">å®˜æ–¹æ–‡æ¡£</a>äº†è§£è¯¦ç»†ç”¨æ³•</p>
<h2 id="logstash_1">å¯åŠ¨logstash</h2>
<pre class="codehilite"><code># bin/logstash -f config/indexer_rsyslog_nginx.conf</code></pre>


<p>å› ä¸ºlogstashé…ç½®ä¸­å¼€äº†<code>stdout</code>è¾“å‡ºï¼Œæ‰€ä»¥èƒ½åœ¨æ§åˆ¶å°çœ‹åˆ°æ ¼å¼åŒ–çš„æ•°æ®ï¼Œå¦‚ä¸‹ï¼š</p>
<pre class="codehilite"><code>{
               &quot;server_addr&quot; =&gt; &quot;172.18.90.17&quot;,
           &quot;http_user_agent&quot; =&gt; &quot;Mozilla/5.0 (iPhone; CPU iPhone OS 10_2 like Mac OS X) AppleWebKit/602.3.12 (KHTML, like Gecko) Mobile/14C92 Safari/601.1 wechatdevtools/1.02.1902010 MicroMessenger/6.7.3 Language/zh_CN webview/ token/e7b92168159736c30401a55589317d8c&quot;,
               &quot;remote_addr&quot; =&gt; &quot;172.18.101.0&quot;,
                    &quot;status&quot; =&gt; 200,
              &quot;http_referer&quot; =&gt; &quot;https://ops-coffee.cn/wx02935bb29080a7b4/devtools/page-frame.html&quot;,
    &quot;upstream_response_time&quot; =&gt; &quot;0.056&quot;,
                      &quot;host&quot; =&gt; &quot;ops-coffee.cn&quot;,
               &quot;request_uri&quot; =&gt; &quot;/api/community/v2/news/list&quot;,
              &quot;request_time&quot; =&gt; 0.059,
           &quot;upstream_status&quot; =&gt; &quot;200&quot;,
                  &quot;@version&quot; =&gt; &quot;1&quot;,
      &quot;http_x_forwarded_for&quot; =&gt; &quot;192.168.106.100&quot;,
                &quot;time_local&quot; =&gt; 2019-03-18T11:03:45.000Z,
           &quot;body_bytes_sent&quot; =&gt; 12431,
                &quot;@timestamp&quot; =&gt; 2019-03-18T11:03:45.984Z,
                &quot;index.date&quot; =&gt; &quot;20190318&quot;,
                &quot;index.hour&quot; =&gt; &quot;19&quot;,
            &quot;request_method&quot; =&gt; &quot;POST&quot;,
             &quot;upstream_addr&quot; =&gt; &quot;127.0.0.1:8181&quot;
}</code></pre>


<p>æŸ¥çœ‹hdfså‘ç°æ•°æ®å·²ç»æŒ‰ç…§å®šä¹‰å¥½çš„è·¯å¾„æ­£å¸¸å†™å…¥</p>
<pre class="codehilite"><code>$ hadoop fs -ls /logs/nginx/20190318/19.log
-rw-r--r--   3 hadmin supergroup       7776 2019-03-18 19:07 /logs/nginx/20190318/19.log</code></pre>


<p>è‡³æ­¤kafkaåˆ°hdfsæ•°æ®è½¬å‚¨å®Œæˆ</p>
<h1 id="_3">é‡åˆ°çš„å‘</h1>
<h2 id="hdfs">HDFSæŒ‰å°æ—¶ç”Ÿæˆæ–‡ä»¶åä¸å¯¹</h2>
<p>logstashåœ¨å¤„ç†æ•°æ®æ—¶ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªå­—æ®µ<code>@timestamp</code>ï¼Œé»˜è®¤æƒ…å†µä¸‹è¿™ä¸ªå­—æ®µå­˜å‚¨çš„æ˜¯logstashæ”¶åˆ°æ¶ˆæ¯çš„æ—¶é—´ï¼Œä½¿ç”¨çš„æ˜¯UTCæ—¶åŒºï¼Œä¼šè·Ÿå›½å†…çš„æ—¶é—´å·®8å°æ—¶</p>
<p>æˆ‘ä»¬outputåˆ°ESæˆ–è€…HDFSæ—¶é€šå¸¸ä¼šä½¿ç”¨ç±»ä¼¼äº<code>rsyslog-nginx-%{+YYYY.MM.dd}</code>è¿™æ ·çš„å˜é‡æ¥åŠ¨æ€çš„è®¾ç½®indexæˆ–è€…æ–‡ä»¶åï¼Œæ–¹ä¾¿åç»­çš„æ£€ç´¢ï¼Œè¿™é‡Œçš„å˜é‡<code>YYYY</code>ä½¿ç”¨çš„å°±æ˜¯<code>@timestamp</code>ä¸­çš„æ—¶é—´ï¼Œå› ä¸ºæ—¶åŒºçš„é—®é¢˜ç”Ÿæˆçš„indexæˆ–è€…æ–‡ä»¶åå°±å·®8å°æ—¶ä¸æ˜¯å¾ˆå‡†ç¡®ï¼Œè¿™ä¸ªé—®é¢˜åœ¨ELKæ¶æ„ä¸­å› ä¸ºå…¨éƒ¨éƒ½æ˜¯ç”¨çš„UTCæ—¶é—´ä¸”æœ€ç»ˆkibanaå±•ç¤ºæ—¶ä¼šè‡ªåŠ¨è½¬æ¢æˆ‘ä»¬æ— éœ€å…³å¿ƒï¼Œä½†è¿™é‡Œè¦ç”Ÿæˆæ–‡ä»¶å°±éœ€è¦è®¤çœŸå¯¹å¾…ä¸‹äº†</p>
<p>è¿™é‡Œé‡‡ç”¨çš„æ–¹æ¡ˆæ˜¯è§£ææ—¥å¿—ä¸­çš„æ—¶é—´å­—æ®µ<code>time_local</code>ï¼Œç„¶åæ ¹æ®æ—¥å¿—ä¸­çš„æ—¶é—´å­—æ®µæ·»åŠ ä¸¤ä¸ªæ–°å­—æ®µ<code>index.date</code>å’Œ<code>index.hour</code>æ¥åˆ†åˆ«æ ‡è¯†æ—¥æœŸå’Œå°æ—¶ï¼Œåœ¨outputçš„æ—¶å€™ä½¿ç”¨è¿™ä¸¤ä¸ªæ–°åŠ çš„å­—æ®µåšå˜é‡æ¥ç”Ÿæˆæ–‡ä»¶</p>
<p>logstash filteré…ç½®å¦‚ä¸‹ï¼š</p>
<pre class="codehilite"><code>filter {
    # åŒ¹é…åŸå§‹æ—¥å¿—ä¸­çš„time_localå­—æ®µå¹¶è®¾ç½®ä¸ºæ—¶é—´å­—æ®µ
    # time_localå­—æ®µä¸ºæœ¬åœ°æ—¶é—´å­—æ®µï¼Œæ²¡æœ‰8å°æ—¶çš„æ—¶é—´å·®
    date {
        match =&gt; [&quot;time_local&quot;,&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;]
        target =&gt; &quot;time_local&quot;
    }

    # æ·»åŠ ä¸€ä¸ªindex.dateå­—æ®µï¼Œå€¼è®¾ç½®ä¸ºtime_localçš„æ—¥æœŸ
    ruby {
        code =&gt; &quot;event.set('index.date', event.get('time_local').time.localtime.strftime('%Y%m%d'))&quot;
    }

    # æ·»åŠ ä¸€ä¸ªindex.hourå­—æ®µï¼Œå€¼è®¾ç½®ä¸ºtime_localçš„å°æ—¶
    ruby {
        code =&gt; &quot;event.set('index.hour', event.get('time_local').time.localtime.strftime('%H'))&quot;
    }
}</code></pre>


<p>outputçš„pathä¸­é…ç½®å¦‚ä¸‹</p>
<pre class="codehilite"><code>path =&gt; &quot;/logs/nginx/%{index.date}/%{index.hour}.log&quot;</code></pre>


<h2 id="hdfshost">HDFSè®°å½•å¤šäº†æ—¶é—´å’Œhostå­—æ®µ</h2>
<p>åœ¨æ²¡æœ‰æŒ‡å®šcodecçš„æƒ…å†µä¸‹ï¼Œlogstashä¼šç»™æ¯ä¸€æ¡æ—¥å¿—æ·»åŠ æ—¶é—´å’Œhostå­—æ®µï¼Œä¾‹å¦‚ï¼š</p>
<p>æºæ—¥å¿—æ ¼å¼ä¸º</p>
<pre class="codehilite"><code>ops-coffee.cn | 192.168.105.91 | 19/Mar/2019:14:28:07 +0800 | GET / HTTP/1.1 | 304 | 0 | - | 0.000</code></pre>


<p>ç»è¿‡logstashå¤„ç†åå¤šäº†æ—¶é—´å’Œhostå­—æ®µ</p>
<pre class="codehilite"><code>2019-03-19T06:28:07.510Z %{host}  ops-coffee.cn | 192.168.105.91 | 19/Mar/2019:14:28:07 +0800 | GET / HTTP/1.1 | 304 | 0 | - | 0.000</code></pre>


<p>å¦‚æœä¸éœ€è¦æˆ‘ä»¬å¯ä»¥æŒ‡å®šæœ€ç»ˆçš„formatåªå–messageï¼Œè§£å†³æ–¹æ³•ä¸ºåœ¨outputä¸­æ·»åŠ å¦‚ä¸‹é…ç½®ï¼š</p>
<pre class="codehilite"><code>codec =&gt; line {
    format =&gt; &quot;%{message}&quot;
}</code></pre>


<h1 id="outputeshdfs">åŒæ—¶outputåˆ°ESå’ŒHDFS</h1>
<p>åœ¨å®é™…åº”ç”¨ä¸­æˆ‘ä»¬éœ€è¦åŒæ—¶å°†æ—¥å¿—æ•°æ®å†™å…¥ESå’ŒHDFSï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥ç”¨ä¸‹è¾¹çš„é…ç½®æ¥å¤„ç†</p>
<pre class="codehilite"><code># cat config/indexer_rsyslog_nginx.conf
input {
    kafka {
        bootstrap_servers =&gt; &quot;localhost:9092&quot;
        topics =&gt; [&quot;rsyslog_nginx&quot;]
        codec =&gt; &quot;json&quot;
    }
}

filter {
    date {  
        match =&gt; [&quot;time_local&quot;,&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;]
        target =&gt; &quot;@timestamp&quot;
    }

    ruby {
        code =&gt; &quot;event.set('index.date', event.get('@timestamp').time.localtime.strftime('%Y%m%d'))&quot;
    }

    ruby {
        code =&gt; &quot;event.set('index.hour', event.get('@timestamp').time.localtime.strftime('%H'))&quot;
    }


}

output {
    elasticsearch {
        hosts =&gt; [&quot;192.168.106.203:9200&quot;]
        index =&gt; &quot;rsyslog-nginx-%{+YYYY.MM.dd}&quot;
    }

    webhdfs {
        host =&gt; &quot;master01&quot;
        port =&gt; 50070
        user =&gt; &quot;hadmin&quot;
        path =&gt; &quot;/logs/nginx/%{index.date}/%{index.hour}.log&quot;
        codec =&gt; &quot;json&quot;
    }
}</code></pre>


<p>è¿™é‡Œæˆ‘ä½¿ç”¨logstashçš„dateæ’ä»¶å°†æ—¥å¿—ä¸­çš„"time_local"å­—æ®µç›´æ¥æ›¿æ¢ä¸ºäº†@timestampï¼Œè¿™æ ·åšæœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿ</p>
<p>logstashé»˜è®¤ç”Ÿæˆçš„@timestampå­—æ®µè®°å½•çš„æ—¶é—´æ˜¯logstashæ¥æ”¶åˆ°æ¶ˆæ¯çš„æ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´å¯èƒ½ä¸æ—¥å¿—äº§ç”Ÿçš„æ—¶é—´ä¸åŒï¼Œè€Œæˆ‘ä»¬å¾€å¾€éœ€è¦å…³æ³¨çš„æ—¶é—´æ˜¯æ—¥å¿—äº§ç”Ÿçš„æ—¶é—´ï¼Œä¸”åœ¨ELKæ¶æ„ä¸­Kibanaæ—¥å¿—è¾“å‡ºçš„é»˜è®¤é¡ºåºå°±æ˜¯æŒ‰ç…§@timestampæ¥æ’åºçš„ï¼Œæ‰€ä»¥å¾€å¾€æˆ‘ä»¬éœ€è¦å°†é»˜è®¤çš„@timestampæ›¿æ¢æˆæ—¥å¿—äº§ç”Ÿçš„æ—¶é—´ï¼Œæ›¿æ¢æ–¹æ³•å°±ç”¨åˆ°äº†dateæ’ä»¶ï¼Œdateæ’ä»¶çš„ç”¨æ³•å¦‚ä¸‹</p>
<pre class="codehilite"><code>date {  
    match =&gt; [&quot;time_local&quot;,&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;]
    target =&gt; &quot;@timestamp&quot;
}</code></pre>


<p>matchï¼šåŒ¹é…æ—¥å¿—ä¸­çš„æ—¶é—´å­—æ®µï¼Œè¿™é‡Œä¸ºtime_local</p>
<p>targetï¼šå°†matchåŒ¹é…åˆ°çš„æ—¶é—´æˆ³å­˜å‚¨åˆ°ç»™å®šçš„å­—æ®µä¸­ï¼Œé»˜è®¤ä¸æŒ‡å®šçš„è¯å°±å­˜åˆ°@timestampå­—æ®µ</p>
<p>å¦å¤–è¿˜æœ‰å‚æ•°å¯ä»¥é…ç½®ï¼š<code>timezone</code>,<code>locale</code>,<code>tag_on_failure</code>ç­‰ï¼Œå…·ä½“å¯æŸ¥çœ‹<a href="https://www.elastic.co/guide/en/logstash/6.6/plugins-filters-date.html" target="_blank">å®˜æ–¹æ–‡æ¡£</a></p>

        <div>
          <ul style="display: inline-block;padding: 0;margin: 0 0 0.5em;color: #999;">
            <li style="display: inline-block;margin: 0 1em 0 0;"><a href="/elk/elasticsearch-logstash-kafka-webhdfs.html">ğŸ“… 2019-03-19</a></li>
<li style="display: inline-block;margin: 0 1em 0 0;"><a href="/tag/å…³äºæŠ€æœ¯/">ğŸ·ï¸ å…³äºæŠ€æœ¯</a></li>          </ul>
        </div>

        <hr>

        <div class="pagination">
            <a href="https://blog.ops-coffee.cn/elk/common-system-project-java-log-collect.html" class="pagination-item prev-page">
                <span class="pagination-arrow">â†</span>
                <span class="pagination-text">ä¸Šä¸€ç¯‡ï¼š<br>ELKæ—¥å¿—ç³»ç»Ÿä¹‹é€šç”¨åº”ç”¨ç¨‹åºæ—¥å¿—æ¥å…¥æ–¹æ¡ˆ</span>
            </a>
            <a href="https://blog.ops-coffee.cn/elk/elasticsearch-logstash-filebeat-registry.html" class="pagination-item next-page">
                <span class="pagination-text">ä¸‹ä¸€ç¯‡ï¼š<br>Filebeatçš„Registryæ–‡ä»¶è§£è¯»</span>
                <span class="pagination-arrow">â†’</span>
            </a>
        </div>

        <div class="nav-cell">
    <script async src="https://giscus.app/client.js"
            data-repo="ops-coffee/blog" data-repo-id="MDEwOlJlcG9zaXRvcnkxNDY4OTI0MTg="
            data-category="Announcements" data-category-id="DIC_kwDOCMFmgs4CQar3"
            data-mapping="pathname" data-strict="0" data-reactions-enabled="1"
            data-emit-metadata="0" data-input-position="top" data-theme="light"
            data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous">
    </script>
</div>

        <div>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8944257246828217"
         data-ad-slot="6731434232" data-ad-format="auto" data-full-width-responsive="true"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
</div>

        <div class="nav-cell">
            <p class="nav-list-title">èƒ½çœ‹åˆ°è¿™é‡Œä¸€å®šæ˜¯çœŸçˆ±ï¼Œè®¢é˜…ä¸€ä¸‹å§</p>
            <img alt="" loading="lazy" src="/static/images/wx.sou1.png" />
        </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="copy"> Â© ops-coffee</div>

      <div class="link">
        <a href="/comments.html" title="ç»™æˆ‘ç•™è¨€" target="_blank">ç•™è¨€</a>
        <a href="/friends.html" title="å‹æƒ…é“¾æ¥" target="_blank">å‹é“¾</a>
      </div>
    </div>
  </footer>
  
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7VC01SQQTE"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-7VC01SQQTE');
</script>

<!-- Google Adsense -->
<script data-ad-client="ca-pub-8944257246828217" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</body>

</html>