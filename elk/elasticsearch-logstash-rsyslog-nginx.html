<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="applicable-device" content="pc,mobile">
  <meta name="keywords" content="Rsyslog, æ—¥å¿—æ”¶é›†, æ— éœ€Agent, Nginxæ—¥å¿—, ELK, Kafka, Logstash, Elasticsearch, Kibana" />
  <meta name="description" content="Rsyslogæ˜¯ä¸€æ¬¾é«˜æ€§èƒ½çš„æ—¥å¿—æ”¶é›†å¤„ç†æœåŠ¡ï¼Œæ— éœ€é¢å¤–å®‰è£…Agentå³å¯å®ç°æ—¥å¿—æ”¶é›†ã€‚æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨Rsyslogæ”¶é›†Nginxæ—¥å¿—ï¼Œå¹¶é€šè¿‡ELKæ ˆè¿›è¡Œæ—¥å¿—åˆ†æå’Œå±•ç¤ºï¼Œæä¾›äº†å®Œæ•´çš„é…ç½®æŒ‡å—å’Œè”è°ƒæµ‹è¯•æ­¥éª¤ã€‚" />
  <link rel="alternate" type="application/rss+xml" title="è¿ç»´å’–å•¡å§" href="https://blog.ops-coffee.cn/feed.xml" />
  <link rel="stylesheet" href="https://blog.ops-coffee.cn/static/posts/css/ops-coffee.min.css" type="text/css" />

  <!-- Begin SEO tag -->
  <title>ELKæ—¥å¿—ç³»ç»Ÿä¹‹ä½¿ç”¨Rsyslogå¿«é€Ÿæ–¹ä¾¿çš„æ”¶é›†Nginxæ—¥å¿—</title>
  <meta property="og:locale" content="zh_CN" />
  <meta property="og:site_name" content="è¿ç»´å’–å•¡å§" />
  <meta property="og:url" content="https://blog.ops-coffee.cn" />
  <meta property="og:title" content="ELKæ—¥å¿—ç³»ç»Ÿä¹‹ä½¿ç”¨Rsyslogå¿«é€Ÿæ–¹ä¾¿çš„æ”¶é›†Nginxæ—¥å¿—" />
  <meta property="og:description" content="Rsyslogæ˜¯ä¸€æ¬¾é«˜æ€§èƒ½çš„æ—¥å¿—æ”¶é›†å¤„ç†æœåŠ¡ï¼Œæ— éœ€é¢å¤–å®‰è£…Agentå³å¯å®ç°æ—¥å¿—æ”¶é›†ã€‚æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨Rsyslogæ”¶é›†Nginxæ—¥å¿—ï¼Œå¹¶é€šè¿‡ELKæ ˆè¿›è¡Œæ—¥å¿—åˆ†æå’Œå±•ç¤ºï¼Œæä¾›äº†å®Œæ•´çš„é…ç½®æŒ‡å—å’Œè”è°ƒæµ‹è¯•æ­¥éª¤ã€‚" />
  <link rel="canonical" href="https://blog.ops-coffee.cn" />
  <!-- End SEO tag -->
</head>

<body>
  <div class="header">
    <div class="menu-button">&#9776; 
        <span class="menu-title">è¿ç»´å’–å•¡å§</span>
    </div> 

    <div class="container no-sidebar">
      <nav class="header-site">
        <ul>
          <li><a href="/">é¦–é¡µ</a></li>
            <li class="has-submenu">
              <a href="#" target="_self">è¿ç»´</a>
              <ul class="sub-menu">
                <li><a href="/tag/ç³»ç»Ÿè¿ç»´/" target="_self">ç³»ç»Ÿè¿ç»´</a></li>
                <li><a href="/elk/index.html" target="_self">ELKç³»åˆ—</a></li>
                <li><a href="/ldap/index.html" target="_self">LDAPç³»åˆ—</a></li>
              </ul>
            </li>
            <li class="has-submenu">
              <a href="#" target="_self">å¼€å‘</a>
              <ul class="sub-menu">
                <li><a href="/tag/Devops/" target="_self">DevOps</a></li>
                <li><a href="/tag/Python/" target="_self">Python</a></li>
                <li><a href="/tag/Django/" target="_self">Django</a></li>
                <li><a href="/bpmn/index.html" target="_self">BPMNç³»åˆ—</a></li>
                <li><a href="/webssh/index.html" target="_self">WebSSHç³»åˆ—</a></li>
                <li><a href="/frontend/index.html" target="_self">å‰ç«¯å¼€å‘ç³»åˆ—</a></li>
              </ul>
            </li>
            <li><a href="/devops/index.html" target="_self">è¿ç»´å¹³å°</a></li>
            <li class="has-submenu">
              <a href="#" target="_self">è¿™æ˜¯ç”Ÿæ´»</a>
              <ul class="sub-menu">
                <li><a href="/life/chronicles" target="_self">æ—¶å…‰å°è®°</a></li>
                <li><a href="/life/money" target="_self">å‰¯ä¸šèµšé’±</a></li>
                <li><a href="/life/writing" target="_self">å†™ä½œç›¸å…³</a></li>
                <li><a href="/tag/è¿™æ˜¯ç”Ÿæ´»/" target="_self">ç”Ÿæ´»éšç¬”</a></li>
              </ul>
            </li>
            <li class="has-submenu">
              <a href="#" target="_self">æˆ¿è½¦æ—…è¡Œ</a>
              <ul class="sub-menu">
                <li><a href="/rv.html" target="_self">æˆ¿è½¦ä½“éªŒ</a></li>
                <li><a href="/travels.html" target="_self">æ—…è¡Œæ¸¸è®°</a></li>
                <li><a href="/travel/china.html" target="_self">æ—…è¡Œåœ°å›¾</a></li>
              </ul>
            </li>
            <li><a href="/tag/index.html" target="_self">æ ‡ç­¾</a></li>
            <li><a href="/archive.html" target="_self">å½’æ¡£</a></li>
          <li class="search"><a href="/search.html" target="_self">ğŸ”</a></li>
        </ul>
      </nav>
    </div>
  </div>

  <header>
    <div class="container no-sidebar">
      <a href="/">
        <div class="name">è¿ç»´å’–å•¡å§</div>
        <div class="slogan">äº«å—æŠ€æœ¯å¸¦æ¥çš„ä¹è¶£ï¼Œä½“éªŒç”Ÿæ´»ç»™äºˆçš„æ„ŸåŠ¨</div>
      </a>
    </div>
  </header>

  <div id="content-wrap">
    <div class="container no-sidebar">
        <h1 id="art-title">ELKæ—¥å¿—ç³»ç»Ÿä¹‹ä½¿ç”¨Rsyslogå¿«é€Ÿæ–¹ä¾¿çš„æ”¶é›†Nginxæ—¥å¿—</h1>

        <blockquote>
<p>å¸¸è§„çš„æ—¥å¿—æ”¶é›†æ–¹æ¡ˆä¸­Clientç«¯éƒ½éœ€è¦é¢å¤–å®‰è£…ä¸€ä¸ªAgentæ¥æ”¶é›†æ—¥å¿—ï¼Œä¾‹å¦‚logstashã€filebeatç­‰ï¼Œé¢å¤–çš„ç¨‹åºä¹Ÿå°±æ„å‘³ç€ç¯å¢ƒçš„å¤æ‚ï¼Œèµ„æºçš„å ç”¨ï¼Œæœ‰æ²¡æœ‰ä¸€ç§æ–¹å¼æ˜¯ä¸éœ€è¦é¢å¤–å®‰è£…ç¨‹åºå°±èƒ½å®ç°æ—¥å¿—æ”¶é›†å‘¢ï¼ŸRsyslogå°±æ˜¯ä½ è¦æ‰¾çš„ç­”æ¡ˆï¼</p>
</blockquote>
<h1 id="rsyslog">Rsyslog</h1>
<p>Rsyslogæ˜¯é«˜é€Ÿçš„æ—¥å¿—æ”¶é›†å¤„ç†æœåŠ¡ï¼Œå®ƒå…·æœ‰é«˜æ€§èƒ½ã€å®‰å…¨å¯é å’Œæ¨¡å—åŒ–è®¾è®¡çš„ç‰¹ç‚¹ï¼Œèƒ½å¤Ÿæ¥æ”¶æ¥è‡ªå„ç§æ¥æºçš„æ—¥å¿—è¾“å…¥ï¼ˆä¾‹å¦‚ï¼šfileï¼Œtcpï¼Œudpï¼Œuxsockç­‰ï¼‰ï¼Œå¹¶é€šè¿‡å¤„ç†åå°†ç»“æœè¾“å‡ºçš„ä¸åŒçš„ç›®çš„åœ°ï¼ˆä¾‹å¦‚ï¼šmysqlï¼Œmongodbï¼Œelasticsearchï¼Œkafkaç­‰ï¼‰ï¼Œæ¯ç§’å¤„ç†æ—¥å¿—é‡èƒ½å¤Ÿè¶…è¿‡ç™¾ä¸‡æ¡ã€‚</p>
<p>Rsyslogä½œä¸ºsyslogçš„å¢å¼ºå‡çº§ç‰ˆæœ¬å·²ç»åœ¨å„linuxå‘è¡Œç‰ˆ<strong>é»˜è®¤å®‰è£…</strong>äº†ï¼Œæ— éœ€é¢å¤–å®‰è£…ã€‚</p>
<h1 id="nginx">æ”¶é›†Nginxæ—¥å¿—</h1>
<p>ELKé€šè¿‡Rsyslogæ”¶é›†æ—¥å¿—æµç¨‹å›¾å¦‚ä¸‹ï¼š</p>
<p><img alt="" loading="lazy" src="/static/images/2018/0828.00.jpg" /></p>
<ol>
<li>å¤„ç†æµç¨‹ä¸ºï¼šNginx --syslog--&gt; Rsyslog --omkafka--&gt; Kafka --&gt; Logstash --&gt; Elasticsearch --&gt; Kibana</li>
<li>Nginxäº§ç”Ÿæ—¥å¿—é€šè¿‡syslogç³»ç»ŸæœåŠ¡ä¼ ç»™RsyslogæœåŠ¡ç«¯ï¼ŒRsyslogæ¥æ”¶åˆ°æ—¥å¿—åé€šè¿‡omkafkaæ¨¡å—å°†æ—¥å¿—å†™å…¥Kafkaï¼ŒLogstashè¯»å–Kafkaé˜Ÿåˆ—ç„¶åå†™å…¥Elasticsearchï¼Œç”¨æˆ·é€šè¿‡Kibanaæ£€ç´¢Elasticsearché‡Œå­˜å‚¨çš„æ—¥å¿—</li>
<li>RsyslogæœåŠ¡ç³»ç»Ÿè‡ªå¸¦æ— éœ€å®‰è£…ï¼Œæ‰€ä»¥æ•´ä¸ªæµç¨‹ä¸­å®¢æˆ·ç«¯ä¸éœ€è¦é¢å¤–å®‰è£…åº”ç”¨</li>
<li>æœåŠ¡ç«¯è™½ç„¶Rsyslogä¹Ÿå·²å®‰è£…ï¼Œä½†é»˜è®¤æ²¡æœ‰omkafkaæ¨¡å—ï¼Œå¦‚æœéœ€è¦Rsyslogå†™å…¥Kafkaéœ€è¦å…ˆå®‰è£…è¿™ä¸ªæ¨¡å—</li>
<li>omkafkaæ¨¡å—åœ¨rsyslog v8.7.0ä¹‹åçš„ç‰ˆæœ¬æ‰æ”¯æŒï¼Œæ‰€ä»¥éœ€è¦å…ˆé€šè¿‡<code>rsyslogd -v</code>å‘½ä»¤æŸ¥çœ‹rsyslogç‰ˆæœ¬ï¼Œå¦‚æœç‰ˆæœ¬è¾ƒä½åˆ™éœ€è¦å‡çº§</li>
</ol>
<h2 id="rsyslog_1">Rsyslogå‡çº§</h2>
<p>1.æ·»åŠ rsyslogæºçš„key</p>
<pre class="codehilite"><code># apt-key adv --recv-keys --keyserver keys.gnupg.net AEF0CF8E</code></pre>


<p>2.æ·»åŠ rsyslogæºåœ°å€</p>
<pre class="codehilite"><code>echo &quot;deb http://debian.adiscon.com/v8-stable wheezy/&quot; &gt;&gt; /etc/apt/sources.list
echo &quot;deb-src http://debian.adiscon.com/v8-stable wheezy/&quot; &gt;&gt; /etc/apt/sources.list</code></pre>


<p>3.å‡çº§rsyslogæœåŠ¡</p>
<pre class="codehilite"><code># apt-get update &amp;&amp; apt-get -y install rsyslog</code></pre>


<h2 id="omkafka">æ·»åŠ omkafkaæ¨¡å—</h2>
<p>1.å®‰è£…ç¼–è¯‘å·¥å…·ï¼Œä¸‹è¾¹autoreconféœ€è¦ç”¨åˆ°ï¼Œä¸ç„¶æ— æ³•ç”Ÿæˆconfigureæ–‡ä»¶</p>
<pre class="codehilite"><code># apt-get -y install pkg-config autoconf automake libtool unzip</code></pre>


<p>2.omkafkaéœ€è¦å®‰è£…ä¸€å †çš„ä¾èµ–åŒ…</p>
<pre class="codehilite"><code># apt-get -y install libdbi-dev libmysqlclient-dev postgresql-client libpq-dev  libnet-dev   librdkafka-dev   libgrok-dev libgrok1 libgrok-dev libpcre3-dev libtokyocabinet-dev libglib2.0-dev  libmongo-client-dev  libhiredis-dev
# apt-get -y install libestr-dev libfastjson-dev uuid-dev liblogging-stdlog-dev libgcrypt-dev
# apt-get -y install flex bison librdkafka1 librdkafka-dev librdkafka1-dbg</code></pre>


<p>3.ç¼–è¯‘å®‰è£…omkafkaæ¨¡å—</p>
<pre class="codehilite"><code># mkdir tmp &amp;&amp; cd tmp

# git init
# git pull git@github.com:VertiPub/omkafka.git

# autoreconf -fvi
# ./configure --sbindir=/usr/sbin --libdir=/usr/lib --enable-omkafka &amp;&amp; make &amp;&amp; make install &amp;&amp; cd ..</code></pre>


<h2 id="rsyslognginx">Rsyslogæ”¶é›†nginxæ—¥å¿—</h2>
<h5 id="clientnginx">Clientç«¯Nginxé…ç½®</h5>
<pre class="codehilite"><code>log_format  jsonlog '{'
    '&quot;host&quot;: &quot;$host&quot;,'
    '&quot;server_addr&quot;: &quot;$server_addr&quot;,'
    '&quot;http_x_forwarded_for&quot;:&quot;$http_x_forwarded_for&quot;,'
    '&quot;remote_addr&quot;:&quot;$remote_addr&quot;,'
    '&quot;time_local&quot;:&quot;$time_local&quot;,'
    '&quot;request_method&quot;:&quot;$request_method&quot;,'
    '&quot;request_uri&quot;:&quot;$request_uri&quot;,'
    '&quot;status&quot;:$status,'
    '&quot;body_bytes_sent&quot;:$body_bytes_sent,'
    '&quot;http_referer&quot;:&quot;$http_referer&quot;,'
    '&quot;http_user_agent&quot;:&quot;$http_user_agent&quot;,'
    '&quot;upstream_addr&quot;:&quot;$upstream_addr&quot;,'
    '&quot;upstream_status&quot;:&quot;$upstream_status&quot;,'
    '&quot;upstream_response_time&quot;:&quot;$upstream_response_time&quot;,'
    '&quot;request_time&quot;:$request_time'
'}';


access_log syslog:server=rsyslog.domain.com,facility=local7,tag=nginx_access_log,severity=info jsonlog;</code></pre>


<p>1.Nginxåœ¨<strong>v1.10ä¹‹å</strong>çš„ç‰ˆæœ¬æ‰æ”¯æŒsyslogçš„æ–¹å¼å¤„ç†æ—¥å¿—ï¼Œè¯·ç¡®ä¿ä½ çš„Nginxç‰ˆæœ¬é«˜äº1.10</p>
<p>2.ä¸ºäº†é™ä½logstashçš„å¤„ç†å‹åŠ›ï¼ŒåŒæ—¶ä¹Ÿä¸ºäº†é™ä½æ•´ä¸ªé…ç½®çš„å¤æ‚åº¦ï¼Œæˆ‘ä»¬nginxçš„æ—¥å¿—ç›´æ¥é‡‡ç”¨jsonæ ¼å¼</p>
<p>3.æŠ›å¼ƒæ–‡æœ¬æ–‡ä»¶è®°å½•nginxæ—¥å¿—ï¼Œæ”¹ç”¨syslogç›´æ¥å°†æ—¥å¿—ä¼ è¾“åˆ°è¿œç«¯çš„rsyslogæœåŠ¡å™¨ï¼Œä»¥ä¾¿æˆ‘ä»¬åç»­çš„å¤„ç†ï¼›è¿™æ ·åšçš„å¦ä¸€ä¸ªéå¸¸é‡è¦çš„å¥½å¤„æ˜¯æˆ‘ä»¬å†ä¹Ÿæ— éœ€è€ƒè™‘nginxæ—¥å¿—çš„åˆ†å‰²å’Œå®šæœŸåˆ é™¤é—®é¢˜ï¼ˆä¸€èˆ¬æˆ‘ä»¬ä¸ºäº†æ–¹ä¾¿ç®¡ç†é€šå¸¸ä¼šé‡‡ç”¨logrotateæœåŠ¡æ¥å¯¹æ—¥å¿—è¿›è¡ŒæŒ‰å¤©æ‹†åˆ†å’Œå®šæœŸåˆ é™¤,ä»¥å…ç£ç›˜è¢«å æ»¡ï¼‰</p>
<p>4.access_logç›´æ¥è¾“å‡ºåˆ°syslogæœåŠ¡ï¼Œå„å‚æ•°è§£é‡Šå¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>syslog</strong>ï¼šæŒ‡æ˜æ—¥å¿—ç”¨syslogæœåŠ¡æ¥æ”¶</li>
<li><strong>server</strong>ï¼šæ¥æ”¶syslogå‘é€æ—¥å¿—çš„RsyslogæœåŠ¡ç«¯åœ°å€ï¼Œé»˜è®¤ä½¿ç”¨udpåè®®ï¼Œç«¯å£æ˜¯514</li>
<li><strong>facility</strong>ï¼šæŒ‡å®šè®°å½•æ—¥å¿—æ¶ˆæ¯çš„ç±»å‹ï¼Œä¾‹å¦‚è®¤è¯ç±»å‹authã€è®¡åˆ’ä»»åŠ¡cronã€ç¨‹åºè‡ªå®šä¹‰çš„local0-7ç­‰ï¼Œæ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„å«ä¹‰ï¼Œä¸å¿…æ·±ç©¶ï¼Œé»˜è®¤çš„å€¼æ˜¯local7</li>
<li><strong>tag</strong>ï¼šç»™æ—¥å¿—æ·»åŠ ä¸€ä¸ªtagï¼Œä¸»è¦æ˜¯ä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬åœ¨æœåŠ¡ç«¯åŒºåˆ†æ˜¯å“ªä¸ªæœåŠ¡æˆ–è€…clientä¼ æ¥çš„æ—¥å¿—ï¼Œä¾‹å¦‚æˆ‘ä»¬è¿™é‡Œç»™äº†tagï¼š<code>nginx_access_log</code>ï¼Œå¦‚æœæœ‰å¤šä¸ªæœåŠ¡åŒæ—¶éƒ½å†™æ—¥å¿—ç»™rsyslogï¼Œä¸”é…ç½®äº†ä¸é€šçš„tagï¼Œåœ¨rsyslogæœåŠ¡ç«¯å°±å¯ä»¥æ ¹æ®è¿™ä¸ªtagæ‰¾å‡ºå“ªäº›æ˜¯nginxçš„æ—¥å¿—</li>
<li><strong>severity</strong>ï¼šå®šä¹‰æ—¥å¿—çš„çº§åˆ«ï¼Œä¾‹å¦‚debugï¼Œinfoï¼Œnoticeç­‰ï¼Œé»˜è®¤æ˜¯error</li>
</ul>
<h5 id="serverrsyslog">Serverç«¯Rsyslogé…ç½®</h5>
<pre class="codehilite"><code># cat /etc/rsyslog.d/rsyslog_nginx_kafka_cluster.conf 
module(load=&quot;imudp&quot;)
input(type=&quot;imudp&quot; port=&quot;514&quot;)

# nginx access log ==&gt; rsyslog server(local) ==&gt; kafka
module(load=&quot;omkafka&quot;)

template(name=&quot;nginxLog&quot; type=&quot;string&quot; string=&quot;%msg%&quot;)

if $inputname == &quot;imudp&quot; then {
    if ($programname == &quot;nginx_access_log&quot;) then
        action(type=&quot;omkafka&quot;
            template=&quot;nginxLog&quot;
            broker=[&quot;10.82.9.202:9092&quot;,&quot;10.82.9.203:9092&quot;,&quot;10.82.9.204:9092&quot;]
            topic=&quot;rsyslog_nginx&quot;
            partitions.auto=&quot;on&quot;
            confParam=[
                &quot;socket.keepalive.enable=true&quot;
            ]
        )
}

:rawmsg, contains, &quot;nginx_access_log&quot; ~</code></pre>


<p>1.åœ¨rsyslog.dç›®å½•ä¸‹æ·»åŠ ä¸€ä¸ªä¸“é—¨å¤„ç†nginxæ—¥å¿—çš„é…ç½®æ–‡ä»¶</p>
<p>2.rsyslogé…ç½®æ–‡ä»¶é‡è¦é…ç½®è§£é‡Šå¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>module</strong>ï¼šåŠ è½½æ¨¡å—ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦åŠ è½½imudpæ¨¡å—æ¥æ¥æ”¶nginxæœåŠ¡å™¨syslogå‘è¿‡æ¥çš„æ—¥å¿—æ•°æ®ï¼Œä¹Ÿéœ€è¦åŠ è½½omkafkaæ¨¡å—æ¥å°†æ—¥å¿—å†™å…¥åˆ°kafka</li>
<li><strong>input</strong>ï¼šå¼€å¯udpåè®®ï¼Œç«¯å£514ï¼Œä¹Ÿå¯ä»¥åŒæ—¶å¼€å¯tcpåè®®ï¼Œä¸¤è€…å¯ä»¥å…±å­˜</li>
<li><strong>template</strong>ï¼šå®šä¹‰ä¸€ä¸ªæ¨¡æ¿ï¼Œåå­—å«nginxLogï¼Œæ¨¡æ¿é‡Œå¯ä»¥å®šä¹‰æ—¥å¿—çš„æ ¼å¼ï¼Œå› ä¸ºæˆ‘ä»¬ä¼ çš„å·²ç»æ˜¯jsonäº†ï¼Œä¸éœ€è¦å†åŒ¹é…æ ¼å¼ï¼Œæ‰€ä»¥è¿™é‡Œä¸é¢å¤–å®šä¹‰ï¼Œæ³¨æ„æ¨¡æ¿åå­—è¦å”¯ä¸€</li>
<li><strong>action</strong>ï¼šåœ¨åŒ¹é…åˆ°inputnameä¸º<code>imudp</code>ä¸”programnameä¸º<code>nginx_access_log</code>ï¼ˆå°±æ˜¯æˆ‘ä»¬ä¸Šè¾¹nginxé…ç½®é‡Œè¾¹çš„tagï¼‰ä¹‹åçš„å¤„ç†æ–¹å¼ï¼Œè¿™é‡Œçš„é…ç½®ä¸ºåŒ¹é…åˆ°çš„æ—¥å¿—é€šè¿‡omkafkaæ¨¡å—å†™å…¥kafkaé›†ç¾¤ï¼Œè¿˜æœ‰ä¸€äº›å…³äºomkafkaæ›´è¯¦ç»†çš„é…ç½®å‚è€ƒä¸Šè¾¹ç»™å‡ºçš„omkafkaæ¨¡å—å®˜æ–¹æ–‡æ¡£</li>
<li><strong>:rawmsg, contains</strong>ï¼šæœ€åè¿™ä¸€è¡Œçš„æ„æ€æ˜¯å¿½ç•¥åŒ…å«<code>nginx_access_log</code>çš„æ—¥å¿—ï¼Œæ²¡æœ‰è¿™ä¸€è¡Œçš„è¯rsyslogæœåŠ¡é»˜è®¤ä¼šæŠŠæ‰€æœ‰æ—¥å¿—éƒ½è®°å½•åˆ°messageé‡Œè¾¹ä¸€ä»½ï¼Œæˆ‘ä»¬å·²ç»æŠŠæ—¥å¿—è¾“å‡ºåˆ°kafkaäº†ï¼Œæœ¬åœ°å°±æ²¡å¿…è¦å†è®°å½•äº†</li>
</ul>
<p>3.omkafkaæ¨¡å—æ£€æŸ¥kafkaé‡Œè¾¹topicæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œæ— éœ€æ‰‹åŠ¨åˆ›å»ºkafkaçš„topic</p>
<h5 id="serverlogstash">Serverç«¯logstashé…ç½®</h5>
<pre class="codehilite"><code>input {
    kafka {
        bootstrap_servers =&gt; &quot;10.82.9.202:9092,10.82.9.203:9092,10.82.9.204:9092&quot;
        topics =&gt; [&quot;rsyslog_nginx&quot;]
    }
}

filter {
    mutate {
        gsub =&gt; [&quot;message&quot;, &quot;\\x&quot;, &quot;\\\x&quot;]
    }

    json {
        source =&gt; &quot;message&quot;
    }

    date {
        match =&gt; [&quot;time_local&quot;,&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;]
        target =&gt; &quot;@timestamp&quot;
    }

}

output {
    elasticsearch {
        hosts =&gt; [&quot;10.82.9.205&quot;, &quot;10.82.9.206&quot;, &quot;10.82.9.207&quot;]
        index =&gt; &quot;rsyslog-nginx-%{+YYYY.MM.dd}&quot;
    }
}</code></pre>


<p>é‡è¦é…ç½®å‚æ•°è§£é‡Šå¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>input</strong>ï¼šé…ç½®kafkaçš„é›†ç¾¤åœ°å€å’Œtopicåå­—</li>
<li><strong>filter</strong>ï¼šä¸€äº›è¿‡æ»¤ç­–ç•¥ï¼Œå› ä¸ºä¼ å…¥kafkaçš„æ—¶å€™æ˜¯jsonæ ¼å¼ï¼Œæ‰€ä»¥ä¸éœ€è¦é¢å¤–å¤„ç†ï¼Œå”¯ä¸€éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœæ—¥å¿—ä¸­æœ‰ä¸­æ–‡ï¼Œä¾‹å¦‚urlä¸­æœ‰ä¸­æ–‡å†…å®¹æ—¶éœ€è¦æ›¿æ¢<code>\\x</code>ï¼Œä¸ç„¶jsonæ ¼å¼ä¼šæŠ¥é”™</li>
<li><strong>output</strong>ï¼šé…ç½®ESæœåŠ¡å™¨é›†ç¾¤çš„åœ°å€å’Œindexï¼Œindexè‡ªåŠ¨æŒ‰å¤©åˆ†å‰²</li>
</ul>
<h5 id="_1">è”è°ƒæµ‹è¯•</h5>
<p>é…ç½®å®Œæˆååˆ†åˆ«é‡å¯rsyslogæœåŠ¡å’ŒnginxæœåŠ¡ï¼Œè®¿é—®nginxäº§ç”Ÿæ—¥å¿—</p>
<p>1.æŸ¥çœ‹kafkaæ˜¯å¦æœ‰æ­£å¸¸ç”Ÿæˆtopic</p>
<pre class="codehilite"><code># bin/kafka-topics.sh --list --zookeeper 127.0.0.1:2181
__consumer_offsets
rsyslog_nginx</code></pre>


<p>2.æŸ¥çœ‹topicæ˜¯å¦èƒ½æ­£å¸¸æ¥æ”¶æ—¥å¿—</p>
<pre class="codehilite"><code># bin/kafka-console-consumer.sh --zookeeper localhost:2181 --topic rsyslog_nginx
{&quot;host&quot;: &quot;domain.com&quot;,&quot;server_addr&quot;: &quot;172.17.0.2&quot;,&quot;http_x_forwarded_for&quot;:&quot;58.52.198.68&quot;,&quot;remote_addr&quot;:&quot;10.120.89.84&quot;,&quot;time_local&quot;:&quot;28/Aug/2018:14:26:00 +0800&quot;,&quot;request_method&quot;:&quot;GET&quot;,&quot;request_uri&quot;:&quot;/&quot;,&quot;status&quot;:200,&quot;body_bytes_sent&quot;:1461,&quot;http_referer&quot;:&quot;-&quot;,&quot;http_user_agent&quot;:&quot;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Safari/537.36&quot;,&quot;upstream_addr&quot;:&quot;-&quot;,&quot;upstream_status&quot;:&quot;-&quot;,&quot;upstream_response_time&quot;:&quot;-&quot;,&quot;request_time&quot;:0.000}</code></pre>


<p>3.kibanaæ·»åŠ indexï¼ŒæŸ¥çœ‹Elasticsearchä¸­æ˜¯å¦æœ‰æ•°æ®ï¼Œå¦‚æœå‰ä¸¤æ­¥éƒ½æ­£å¸¸ï¼Œkibanaæœä¸åˆ°indexæˆ–indexæ²¡æœ‰æ•°æ®ï¼Œå¤šåŠæ˜¯indexåå­—å†™é”™äº†ä¹‹ç±»çš„åŸºç¡€é—®é¢˜ï¼Œä»”ç»†æ£€æŸ¥</p>
<h2 id="kibana">kibanaæŸ¥è¯¢å±•ç¤º</h2>
<ul>
<li>æ‰“å¼€Kibanaæ·»åŠ <code>rsyslog-nginx-*</code>çš„Indexï¼Œå¹¶é€‰æ‹©timestampï¼Œåˆ›å»ºIndex Pattern</li>
</ul>
<p><img alt="" loading="lazy" src="/static/images/2018/0828.02.png" /></p>
<ul>
<li>è¿›å…¥Discoveré¡µé¢ï¼Œå¯ä»¥å¾ˆç›´è§‚çš„çœ‹åˆ°å„ä¸ªæ—¶é—´ç‚¹è¯·æ±‚é‡çš„å˜åŒ–ï¼Œæ ¹æ®å·¦ä¾§Fieldå®ç°ç®€å•è¿‡æ»¤ï¼Œä¾‹å¦‚æˆ‘ä»¬æƒ³æŸ¥çœ‹æ‰€æœ‰è®¿é—®çŠ¶æ€ä¸º404çš„uriï¼Œå¯ä»¥ç‚¹å‡»request_uriå’Œstatusåè¾¹çš„addï¼Œè¿™ä¸¤é¡¹çš„å†…å®¹å°†å‡ºç°åœ¨å³ä¾§ï¼Œç„¶åç‚¹å‡»statusä¸‹è¾¹404çŠ¶æ€ç åè¾¹çš„åŠ å·ï¼Œåˆ™åªæŸ¥çœ‹çŠ¶æ€ä¸º404çš„è¯·æ±‚ï¼Œç‚¹å‡»ä¸Šæ–¹auto-refreshå¯ä»¥è®¾ç½®é¡µé¢è‡ªåŠ¨åˆ·æ–°æ—¶é—´</li>
</ul>
<p><img alt="" loading="lazy" src="/static/images/2018/0828.03.png" /></p>
<ul>
<li>é€šè¿‡å„ç§æ¡ä»¶çš„ç»„åˆæŸ¥è¯¢å¯ä»¥å®ç°å„ç§å„æ ·çš„éœ€æ±‚ï¼Œä¾‹å¦‚æ¯ç§’è¯·æ±‚ã€å¸¦å®½å ç”¨ã€å¼‚å¸¸æ¯”ä¾‹ã€æ…¢å“åº”ã€TOP IPã€TOP URLç­‰ç­‰å„ç§æƒ…å†µï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡Visualizeå¾ˆæ–¹ä¾¿çš„å°†è¿™äº›ä¿¡æ¯ç»˜åˆ¶å›¾æ ‡ï¼Œç”ŸæˆDashboardä¿å­˜</li>
</ul>
<p><img alt="" loading="lazy" src="/static/images/2018/0828.04.png" /></p>
<h1 id="_2">å†™åœ¨æœ€å</h1>
<ol>
<li>Nginxçš„access logç»å¯¹æ˜¯ç½‘ç«™çš„ä¸€ä¸ªå®è—ï¼Œé€šè¿‡æ—¥å¿—é‡çš„å˜åŒ–å¯ä»¥çŸ¥é“ç½‘ç«™çš„æµé‡æƒ…å†µï¼Œé€šè¿‡å¯¹statusçŠ¶æ€çš„åˆ†æå¯ä»¥çŸ¥é“æˆ‘ä»¬æä¾›æœåŠ¡çš„å¯é æ€§ï¼Œé€šè¿‡å¯¹ç‰¹å®šæ´»åŠ¨urlçš„è¿½è¸ªå¯ä»¥å®æ—¶äº†è§£æ´»åŠ¨çš„ç«çˆ†ç¨‹åº¦ï¼Œé€šè¿‡å¯¹æŸäº›æ¡ä»¶çš„ç»„åˆæŸ¥è¯¢ä¹Ÿèƒ½ä¸ºç½‘ç«™è¿è¥æä¾›å»ºè®®å’Œå¸®åŠ©ï¼Œä»è€Œä½¿æˆ‘ä»¬çš„ç½‘ç«™æ›´å‹å¥½æ›´æ˜“ç”¨</li>
<li>RsyslogæœåŠ¡çš„å•ç‚¹é—®é¢˜å¯ä»¥é€šè¿‡éƒ¨ç½²å¤šä¸ªRsyslogæœåŠ¡è¿‡ä¸‰å±‚è´Ÿè½½æ¥ä¿è¯é«˜å¯ç”¨ï¼Œä¸è¿‡ä»¥æˆ‘ä»¬çš„ç»éªŒæ¥è¯´rsyslogæœåŠ¡è¿˜æ˜¯å¾ˆç¨³å®šçš„ï¼Œè·‘äº†ä¸€å¹´å¤šï¼Œæ¯åˆ†é’Ÿæ—¥å¿—å¤„ç†é‡åœ¨20wå·¦å³ï¼Œæ²¡æœ‰å‡ºç°è¿‡å®•æœºæƒ…å†µï¼Œä¸æƒ³è¿™ä¹ˆå¤æ‚çš„è¯å¯ä»¥å†™ä¸ªcheck rsyslogæœåŠ¡çŠ¶æ€çš„è„šæœ¬è·‘åå°ï¼ŒæŒ‚äº†è‡ªåŠ¨æ‹‰èµ·æ¥</li>
<li>æ•´ä¸ªè¿‡ç¨‹ä¸­æˆ‘ä»¬ä½¿ç”¨äº†UDPåè®®ï¼Œç¬¬ä¸€æ˜¯å› ä¸ºNginxæ—¥å¿—çš„syslogæ¨¡å¼é»˜è®¤æ”¯æŒçš„å°±æ˜¯UDPåè®®ï¼Œç¿»äº†å®˜ç½‘æ²¡æ‰¾åˆ°æ”¯æŒTCPçš„æ–¹å¼ï¼Œæˆ‘æƒ³è¿™ä¹Ÿæ˜¯è€ƒè™‘åˆ°UDPåè®®çš„æ€§èƒ½è¦æ¯”TCPå¥½çš„å¤šï¼Œç¬¬äºŒä¹Ÿè€ƒè™‘åˆ°å¦‚æœä½¿ç”¨TCPé‡åˆ°ç½‘ç»œä¸ç¨³å®šçš„æƒ…å†µä¸‹å¯èƒ½ä¼šä¸åœçš„é‡è¯•æˆ–ç­‰å¾…ï¼Œå½±å“åˆ°Nginxçš„ç¨³å®šã€‚å¯¹äºå› ä¸ºå†…å®¹è¿‡é•¿è¶…è¿‡ä»¥å¤ªç½‘æ•°æ®å¸§é•¿åº¦çš„é—®é¢˜æš‚æ—¶æ²¡æœ‰é‡åˆ°</li>
</ol>

        <div>
          <ul style="display: inline-block;padding: 0;margin: 0 0 0.5em;color: #999;">
            <li style="display: inline-block;margin: 0 1em 0 0;"><a href="/elk/elasticsearch-logstash-rsyslog-nginx.html">ğŸ“… 2018-08-30</a></li>
<li style="display: inline-block;margin: 0 1em 0 0;"><a href="/tag/å…³äºæŠ€æœ¯/">ğŸ·ï¸ å…³äºæŠ€æœ¯</a></li>          </ul>
        </div>

        <hr>

        <div class="nav-cell">
    <script async src="https://giscus.app/client.js"
            data-repo="ops-coffee/blog" data-repo-id="MDEwOlJlcG9zaXRvcnkxNDY4OTI0MTg="
            data-category="Announcements" data-category-id="DIC_kwDOCMFmgs4CQar3"
            data-mapping="pathname" data-strict="0" data-reactions-enabled="1"
            data-emit-metadata="0" data-input-position="top" data-theme="light"
            data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous">
    </script>
</div>

        <div>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8944257246828217"
         data-ad-slot="6731434232" data-ad-format="auto" data-full-width-responsive="true"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
</div>

        <div class="nav-cell">
            <p class="nav-list-title">èƒ½çœ‹åˆ°è¿™é‡Œä¸€å®šæ˜¯çœŸçˆ±ï¼Œè®¢é˜…ä¸€ä¸‹å§</p>
            <img alt="" loading="lazy" src="/static/images/wx.sou1.png" />
        </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="copy"> Â© ops-coffee</div>

      <div class="link">
        <a href="/comments.html" title="ç»™æˆ‘ç•™è¨€" target="_blank">ç•™è¨€</a>
        <a href="/friends.html" title="å‹æƒ…é“¾æ¥" target="_blank">å‹é“¾</a>
      </div>
    </div>
  </footer>
  
  <!-- Umami Cloud -->
<script async src="https://umami.ops-coffee.cn/script.js" data-website-id="a4aabd8e-32c7-40e7-a81c-119b909f2d0f"></script>

<!-- Google Adsense -->
<script data-ad-client="ca-pub-8944257246828217" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</body>

</html>