<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="applicable-device" content="pc,mobile">
  <meta name="keywords" content="关于技术,js,bpmn" />
  <meta name="description" content="最好用的流程编辑器bpmn-js系列文章" />
  <link rel="alternate" type="application/rss+xml" title="运维咖啡吧" href="https://blog.ops-coffee.cn/feed.xml" />
  <link rel="stylesheet" href="https://blog.ops-coffee.cn/static/posts/css/ops-coffee.min.css" type="text/css" />

  <!-- Begin SEO tag -->
  <title>最好用的流程编辑器bpmn-js系列之本地文件</title>
  <meta property="og:locale" content="zh_CN" />
  <meta property="og:site_name" content="运维咖啡吧" />
  <meta property="og:url" content="https://blog.ops-coffee.cn" />
  <meta property="og:title" content="最好用的流程编辑器bpmn-js系列之本地文件" />
  <meta property="og:description" content="最好用的流程编辑器bpmn-js系列文章" />
  <link rel="canonical" href="https://blog.ops-coffee.cn" />
  <!-- End SEO tag -->
</head>

<body>
  <div class="header">
    <div class="menu-button">&#9776; 
        <span class="menu-title">运维咖啡吧</span>
    </div> 

    <div class="container no-sidebar">
      <nav class="header-site">
        <ul>
          <li><a href="/">首页</a></li>
            <li class="has-submenu">
              <a href="#" target="_self">运维</a>
              <ul class="sub-menu">
                <li><a href="/tag/系统运维/" target="_self">系统运维</a></li>
                <li><a href="/elk/index.html" target="_self">ELK系列</a></li>
                <li><a href="/ldap/index.html" target="_self">LDAP系列</a></li>
              </ul>
            </li>
            <li class="has-submenu">
              <a href="#" target="_self">开发</a>
              <ul class="sub-menu">
                <li><a href="/tag/Devops/" target="_self">DevOps</a></li>
                <li><a href="/tag/Python/" target="_self">Python</a></li>
                <li><a href="/tag/Django/" target="_self">Django</a></li>
                <li><a href="/bpmn/index.html" target="_self">BPMN系列</a></li>
                <li><a href="/webssh/index.html" target="_self">WebSSH系列</a></li>
                <li><a href="/frontend/index.html" target="_self">前端开发系列</a></li>
              </ul>
            </li>
            <li><a href="/devops.html" target="_self">运维平台</a></li>
            <li><a href="/tag/这是生活/" target="_self">这是生活</a></li>
            <li class="has-submenu">
              <a href="#" target="_self">房车旅行</a>
              <ul class="sub-menu">
                <li><a href="/r/index.html" target="_self">房车体验</a></li>
                <li><a href="/travels.html" target="_self">旅行游记</a></li>
                <li><a href="/travel/china.html" target="_self">旅行地图</a></li>
              </ul>
            </li>
            <li><a href="/tag/index.html" target="_self">标签</a></li>
            <li><a href="/archive.html" target="_self">归档</a></li>
        </ul>
      </nav>
    </div>
  </div>

  <header>
    <div class="container no-sidebar">
      <a href="/">
        <div class="name">运维咖啡吧</div>
        <div class="slogan">享受技术带来的乐趣，体验生活给予的感动</div>
      </a>
    </div>
  </header>

  <div id="content-wrap">
    <div class="container no-sidebar">
        <h1 id="art-title">最好用的流程编辑器bpmn-js系列之本地文件</h1>

        <blockquote>
<p>最好用的流程编辑器bpmn-js系列文章</p>
</blockquote>
<p>上一篇文章<a href="https://blog.ops-coffee.cn/bpmn/bpmn-js-vue-base-usage-demo-code-source" target="_blank">『最好用的流程编辑器bpmn-js系列之基本使用』</a>介绍了bpmn的相关概念以及基本使用，基于bpmn-js的工作流编辑器已经run了起来，这篇文章将会介绍如何从本地加载xml格式的bpmn文件，以及如何将绘制好的工作流保作为bpmn文件或是svg图片保存到本地</p>
<p>以下演示代码基于上一节搭建好的vue环境，使用bpmn版本为当前最新版7.3.0</p>
<h2 id="_1">从本地文件中加载流程</h2>
<p>上一节的演示代码中我们将bpmn流程图内容作为字符串赋予给了变量<code>xmlStr</code>，在渲染时通过<code>importXML(xmlStr)</code>直接读取了<code>xmlStr</code>变量的内容从而实现了绘图，核心代码如下所示</p>
<pre class="codehilite"><code>import { xmlStr } from &quot;../mock/xmlStr&quot;;

...

async createNewDiagram() {
  try {
    const result = await this.bpmnModeler.importXML(xmlStr);
    const { warnings } = result;
    console.log(warnings);
  } catch (err) {
    console.log(err.message, err.warnings);
  }
},</code></pre>


<p>如果想要从本地导入bpmn格式的流程文件该如何实现呢？借助于上边的思路，其实只需要以下两步即可</p>
<p>template模版，添加一个type为file的input输入框，用于文件上传，为了好看这里将input给隐藏，这里用一个a标签通过<code>$refs.refFile.click()</code>模拟点击触发弹出资源管理器，然后input通过change事件触发<code>loadXML</code>函数的执行</p>
<pre class="codehilite"><code>&lt;template&gt;
  &lt;div class=&quot;containers&quot;&gt;
    &lt;div class=&quot;canvas&quot; ref=&quot;canvas&quot;&gt;&lt;/div&gt;

    &lt;ul class=&quot;buttons&quot;&gt;
      &lt;li&gt;
        &lt;a href=&quot;javascript:&quot; @click=&quot;$refs.refFile.click()&quot;&gt;加载本地BPMN文件&lt;/a&gt;
        &lt;input type=&quot;file&quot; id=&quot;files&quot; ref=&quot;refFile&quot; style=&quot;display: none&quot; @change=&quot;loadXML&quot; /&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/div&gt;
&lt;/template&gt;</code></pre>


<p><code>loadXML</code>主要用来接收用户上传的文件，然后将文件内容赋予变量<code>xmlStr</code>，之后调用<code>createNewDiagram</code>方法将bpmn文件内容渲染到编辑器，完整的代码如下</p>
<pre class="codehilite"><code>&lt;script&gt;
import BpmnModeler from &quot;bpmn-js/lib/Modeler&quot;;
import { xmlStr } from &quot;../mock/xmlStr&quot;;

export default {
  name: &quot;ops-coffee&quot;,
  mounted() {
    this.init();
  },
  data() {
    return {
      bpmnModeler: null,
      container: null,
      canvas: null,
      xmlStr: xmlStr
    };
  },
  methods: {
    init() {
      const canvas = this.$refs.canvas;
      this.bpmnModeler = new BpmnModeler({
        container: canvas
      });

      this.createNewDiagram();
    },
    createNewDiagram() {
      try {
        const result = this.bpmnModeler.importXML(this.xmlStr);
        const { warnings } = result;
        console.log(warnings);
      } catch (err) {
        console.log(err.message, err.warnings);
      }
    },
    loadXML() {
      const that = this;
      const file = this.$refs.refFile.files[0];

      var reader = new FileReader();
      reader.readAsText(file);
      reader.onload = function() {
        that.xmlStr = this.result;
        that.createNewDiagram();
      };
    }
  }
};
&lt;/script&gt;</code></pre>


<p>需要注意的是，新增了一个<code>xmlStr</code>的变量，初始值赋予了默认的bpmn格式字符串，这样在每次新打开页面时都可以正常渲染默认的流程，当上传bpmn文件后会替换掉这个<code>xmlStr</code>变量的值为新上传的文件内容，再次渲染时就能渲染新上传的流程文件了</p>
<p>另外这里也可以做一些基础的判断，例如只接收.bpmn后缀的文件等等，让程序更健壮</p>
<p>为了让添加的按钮看起来好看一点，新增了如下CSS</p>
<pre class="codehilite"><code>.buttons {
  position: absolute;
  left: 20px;
  bottom: 20px;
}
.buttons li {
  display: inline-block;
  margin: 5px;
}
.buttons li a {
  color: #333;
  background: #fff;
  cursor: pointer;
  padding: 8px;
  border: 1px solid #ccc;
  text-decoration: none;
}</code></pre>


<h2 id="_2">将流程保存到本地文件</h2>
<p>上边讲了如何导入本地文件，那么本地文件从哪里来呢？官方提供了一个<code>saveXML</code>方法可以将绘制的工作流输出为xml格式的数据，而我们可以将xml格式的数据保存到本地文件，而这个文件就能通过上边的导入步骤导入渲染啦</p>
<p><code>saveXML</code>使用也非常简单，第一步依然是添加一个导出的按钮</p>
<pre class="codehilite"><code>&lt;li&gt;
  &lt;a href=&quot;javascript:&quot; @click=&quot;saveXML&quot; title=&quot;保存为bpmn&quot;&gt;保存为BPMN文件&lt;/a&gt;
&lt;/li&gt;</code></pre>


<p>然后编写一个<code>saveXML</code>的方法来实现将xml格式数据保存为本地文件，完整代码如下</p>
<pre class="codehilite"><code>async saveXML() {
  try {
    const result = await this.bpmnModeler.saveXML({ format: true });
    const { xml } = result;

    var xmlBlob = new Blob([xml], {
      type: &quot;application/bpmn20-xml;charset=UTF-8,&quot;
    });

    var downloadLink = document.createElement(&quot;a&quot;);
    downloadLink.download = &quot;ops-coffee-bpmn.bpmn&quot;;
    downloadLink.innerHTML = &quot;Get BPMN SVG&quot;;
    downloadLink.href = window.URL.createObjectURL(xmlBlob);
    downloadLink.onclick = function(event) {
      document.body.removeChild(event.target);
    };
    downloadLink.style.visibility = &quot;hidden&quot;;
    document.body.appendChild(downloadLink);
    downloadLink.click();
  } catch (err) {
    console.log(err);
  }
},</code></pre>


<p>同样的，官方除了支持导出为xml格式的bpmn文件外，还支持直接导出为svg格式的图片，方法与导出bpmn文件类似，代码如下</p>
<pre class="codehilite"><code>&lt;li&gt;
  &lt;a href=&quot;javascript:&quot; @click=&quot;saveSVG&quot; title=&quot;保存为svg&quot;&gt;保存为SVG图片&lt;/a&gt;
&lt;/li&gt;</code></pre>


<pre class="codehilite"><code>async saveSVG() {
  try {
    const result = await this.bpmnModeler.saveSVG();
    const { svg } = result;

    var svgBlob = new Blob([svg], {
      type: &quot;image/svg+xml&quot;
    });

    var downloadLink = document.createElement(&quot;a&quot;);
    downloadLink.download = &quot;ops-coffee-bpmn.svg&quot;;
    downloadLink.innerHTML = &quot;Get BPMN SVG&quot;;
    downloadLink.href = window.URL.createObjectURL(svgBlob);
    downloadLink.onclick = function(event) {
      document.body.removeChild(event.target);
    };
    downloadLink.style.visibility = &quot;hidden&quot;;
    document.body.appendChild(downloadLink);
    downloadLink.click();
  } catch (err) {
    console.log(err);
  }
},</code></pre>


<h3 id="_3">监听变化下载文件</h3>
<p>以上下载文件的方式是在每一次点击下载按钮时去构建下载链接，而官方示例里还给了另外一种下载文件的方式，那就是通过<code>bpmnModeler.on</code>的监听方法，监听到流程图变化然后直接构建下载链接，用户点击下载按钮时直接下载，不再构建下载链接</p>
<p>官方示例代码地址https://github.com/bpmn-io/bpmn-js-examples/blob/ebd40ecbb9672227f1d9eb5c00bc1aaf38127df6/modeler/app/app.js</p>
<p>优化后可在本项目中使用的代码如下</p>
<pre class="codehilite"><code>&lt;li&gt;
  &lt;a href=&quot;javascript:&quot; ref=&quot;saveXML&quot; title=&quot;保存为bpmn&quot;&gt;保存为BPMN文件&lt;/a&gt;
&lt;/li&gt;
&lt;li&gt;
  &lt;a href=&quot;javascript:&quot; ref=&quot;saveSvg&quot; title=&quot;保存为svg&quot;&gt;保存为SVG图片&lt;/a&gt;
&lt;/li&gt;</code></pre>


<p>为了优化结构，参考了网上成熟的例子，在渲染完成后调用了<code>success</code>方法，而<code>success</code>方法调用<code>addBpmnListener</code>，在<code>addBpmnListener</code>内通过<code>bpmnModeler.on</code>来监听流程变化从而更新下载链接</p>
<pre class="codehilite"><code>&lt;script&gt;
export default {
  name: &quot;ops-coffee&quot;,
  mounted() {
    this.init();
  },
  data() {
    return {
      bpmnModeler: null,
      container: null,
      canvas: null,
      xmlStr: xmlStr
    };
  },
  methods: {
    init() {
      const canvas = this.$refs.canvas;
      this.bpmnModeler = new BpmnModeler({
        container: canvas
      });

      this.createNewDiagram();
    },
    async createNewDiagram() {
      try {
        const result = await this.bpmnModeler.importXML(this.xmlStr);
        const { warnings } = result;
        console.log(warnings);

        this.success();
      } catch (err) {
        console.log(err.message, err.warnings);
      }
    },
    success() {
      this.addBpmnListener();
    },
    async loadXML() {
      const that = this;
      const file = this.$refs.refFile.files[0];

      var reader = new FileReader();
      reader.readAsText(file);
      reader.onload = function() {
        that.xmlStr = this.result;
        that.createNewDiagram();
      };
    },
    async addBpmnListener() {
      const that = this;
      const downloadLink = this.$refs.saveXML;
      const downloadSvgLink = this.$refs.saveSvg;

      async function opscoffee() {
        try {
          const result = await that.saveSVG();
          const { svg } = result;

          that.setEncoded(downloadSvgLink, &quot;ops-coffee.svg&quot;, svg);
        } catch (err) {
          console.log(err);
        }

        try {
          const result = await that.saveXML();
          const { xml } = result;

          that.setEncoded(downloadLink, &quot;ops-coffee.bpmn&quot;, xml);
        } catch (err) {
          console.log(err);
        }
      }

      opscoffee();
      this.bpmnModeler.on(&quot;commandStack.changed&quot;, opscoffee);
    },
    async saveSVG(done) {
      try {
        const result = await this.bpmnModeler.saveSVG(done);
        return result;
      } catch (err) {
        console.log(err);
      }
    },
    async saveXML(done) {
      try {
        const result = await this.bpmnModeler.saveXML({ format: true }, done);
        return result;
      } catch (err) {
        console.log(err);
      }
    },
    setEncoded(link, name, data) {
      const encodedData = encodeURIComponent(data);

      if (data) {
        link.href = &quot;data:application/bpmn20-xml;charset=UTF-8,&quot; + encodedData;
        link.download = name;
      }
    }
  }
};
&lt;/script&gt;</code></pre>


<p>以上两个功能完成后就可以愉快的将流程图保存到本地或者选择本地流程文件渲染流程图啦</p>
<p><img alt="" loading="lazy" src="/static/images/2020/0910.01.png" /></p>
<h2 id="_4">写在最后</h2>
<p>接触bpmn-js不久，且第一次用VUE，边学边写，文章难免出错，各位多多包含。想要打造一个好用的适合自己的流程编辑器，需要了解的内容比较多，bpmn-js会分多篇文章来介绍，下一篇介绍bpmn-js的页面布局等内容，欢迎关注</p>
<p>部分小伙伴对流程编辑器不了解，或是对BPMN不了解，我搭建了个在线的Demo: <a href="https://bpmn.ops-coffee.cn" target="_blank">https://bpmn.ops-coffee.cn</a>，点击链接即可轻松体验，建议PC端打开效果更好</p>

        <div>
          <ul style="display: inline-block;padding: 0;margin: 0 0 0.5em;color: #999;">
            <li style="display: inline-block;margin: 0 1em 0 0;"><a href="/bpmn/bpmn-js-vue-local-file-demo-code-source.html">📅 2020-09-10</a></li>
<li style="display: inline-block;margin: 0 1em 0 0;"><a href="/tag/关于技术/">🏷️ 关于技术</a></li>          </ul>
        </div>

        <hr>

        <div class="nav-cell">
            <script async src="https://giscus.app/client.js"
                    data-repo="ops-coffee/blog" data-repo-id="MDEwOlJlcG9zaXRvcnkxNDY4OTI0MTg="
                    data-category="Announcements" data-category-id="DIC_kwDOCMFmgs4CQar3"
                    data-mapping="pathname" data-strict="0" data-reactions-enabled="1"
                    data-emit-metadata="0" data-input-position="top" data-theme="light"
                    data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous">
            </script>
        </div>

        <div>
            <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
            <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8944257246828217"
                 data-ad-slot="6731434232" data-ad-format="auto" data-full-width-responsive="true"></ins>
            <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
        </div>

        <div class="nav-cell">
            <p class="nav-list-title">能看到这里一定是真爱，关注一下吧</p>
            <img alt="" loading="lazy" src="/static/images/wx.sou1.png" />
        </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="copy"> © ops-coffee</div>

      <div class="link">
        <a href="/search.html" title="搜索" target="_blank">搜索</a>
        <a href="/questions.html" title="提问" target="_blank">提问</a>
        <a href="/friends.html" title="友情链接" target="_blank">友链</a>
      </div>
    </div>
  </footer>
  
  <!-- Umami Cloud -->
<script async src="https://umami.ops-coffee.cn/script.js" data-website-id="a4aabd8e-32c7-40e7-a81c-119b909f2d0f"></script>

<!-- Google Adsense -->
<script data-ad-client="ca-pub-8944257246828217" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</body>

</html>