<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="applicable-device" content="pc,mobile">
  <meta name="keywords" content="HTTPSè¯ä¹¦ç®¡ç†, åŸŸååˆ—è¡¨è·å–, è¯ä¹¦è¿‡æœŸæ£€æŸ¥, è¯ä¹¦æ›´æ–°, é˜¿é‡Œäº‘API, pyopenssl, å®šæ—¶æ‰§è¡Œå…¥åº“" />
  <meta name="description" content="æœ¬æ•™ç¨‹è¯¦ç»†ä»‹ç»äº†å¦‚ä½•ä»è·å–åŸŸååˆ—è¡¨ã€æ£€æŸ¥HTTPSæ”¯æŒã€è·å–è¯ä¹¦è¿‡æœŸæ—¶é—´ã€å®šæ—¶æ‰§è¡Œå…¥åº“åˆ°æ›´æ–°è¯ä¹¦çš„å…¨æµç¨‹ï¼Œå¸®åŠ©æ‚¨æœ‰æ•ˆç®¡ç†HTTPSè¯ä¹¦ï¼Œé¿å…å› è¯ä¹¦è¿‡æœŸå¯¼è‡´çš„ç³»ç»Ÿé—®é¢˜ã€‚" />
  <link rel="alternate" type="application/rss+xml" title="è¿ç»´å’–å•¡å§" href="https://blog.ops-coffee.cn/feed.xml" />
  <link rel="stylesheet" href="https://blog.ops-coffee.cn/static/posts/css/ops-coffee.min.css" type="text/css" />

  <!-- Begin SEO tag -->
  <title>Pythonå®ç°HTTPSç½‘ç«™è¯ä¹¦è¿‡æœŸç›‘æ§åŠæ›´æ–°</title>
  <meta property="og:locale" content="zh_CN" />
  <meta property="og:site_name" content="è¿ç»´å’–å•¡å§" />
  <meta property="og:url" content="https://blog.ops-coffee.cn" />
  <meta property="og:title" content="Pythonå®ç°HTTPSç½‘ç«™è¯ä¹¦è¿‡æœŸç›‘æ§åŠæ›´æ–°" />
  <meta property="og:description" content="æœ¬æ•™ç¨‹è¯¦ç»†ä»‹ç»äº†å¦‚ä½•ä»è·å–åŸŸååˆ—è¡¨ã€æ£€æŸ¥HTTPSæ”¯æŒã€è·å–è¯ä¹¦è¿‡æœŸæ—¶é—´ã€å®šæ—¶æ‰§è¡Œå…¥åº“åˆ°æ›´æ–°è¯ä¹¦çš„å…¨æµç¨‹ï¼Œå¸®åŠ©æ‚¨æœ‰æ•ˆç®¡ç†HTTPSè¯ä¹¦ï¼Œé¿å…å› è¯ä¹¦è¿‡æœŸå¯¼è‡´çš„ç³»ç»Ÿé—®é¢˜ã€‚" />
  <link rel="canonical" href="https://blog.ops-coffee.cn" />
  <!-- End SEO tag -->
</head>

<body>
  <div class="header">
    <div class="menu-button">&#9776; 
        <span class="menu-title">è¿ç»´å’–å•¡å§</span>
    </div> 

    <div class="container no-sidebar">
      <nav class="header-site">
        <ul>
          <li><a href="/">é¦–é¡µ</a></li>
            <li class="has-submenu">
              <a href="#" target="_self">è¿ç»´</a>
              <ul class="sub-menu">
                <li><a href="/tag/ç³»ç»Ÿè¿ç»´/" target="_self">ç³»ç»Ÿè¿ç»´</a></li>
                <li><a href="/elk/index.html" target="_self">ELKç³»åˆ—</a></li>
                <li><a href="/ldap/index.html" target="_self">LDAPç³»åˆ—</a></li>
              </ul>
            </li>
            <li class="has-submenu">
              <a href="#" target="_self">å¼€å‘</a>
              <ul class="sub-menu">
                <li><a href="/tag/Devops/" target="_self">DevOps</a></li>
                <li><a href="/tag/Python/" target="_self">Python</a></li>
                <li><a href="/tag/Django/" target="_self">Django</a></li>
                <li><a href="/bpmn/index.html" target="_self">BPMNç³»åˆ—</a></li>
                <li><a href="/webssh/index.html" target="_self">WebSSHç³»åˆ—</a></li>
                <li><a href="/frontend/index.html" target="_self">å‰ç«¯å¼€å‘ç³»åˆ—</a></li>
              </ul>
            </li>
            <li><a href="/devops/index.html" target="_self">è¿ç»´å¹³å°</a></li>
            <li class="has-submenu">
              <a href="#" target="_self">è¿™æ˜¯ç”Ÿæ´»</a>
              <ul class="sub-menu">
                <li><a href="/life/chronicles.html" target="_self">æ—¶å…‰å°è®°</a></li>
                <li><a href="/life/money.html" target="_self">å‰¯ä¸šèµšé’±</a></li>
                <li><a href="/life/writing.html" target="_self">å†™ä½œç›¸å…³</a></li>
                <li><a href="/tag/è¿™æ˜¯ç”Ÿæ´»/" target="_self">ç”Ÿæ´»éšç¬”</a></li>
              </ul>
            </li>
            <li class="has-submenu">
              <a href="#" target="_self">æˆ¿è½¦æ—…è¡Œ</a>
              <ul class="sub-menu">
                <li><a href="/rv.html" target="_self">æˆ¿è½¦ä½“éªŒ</a></li>
                <li><a href="/travels.html" target="_self">æ—…è¡Œæ¸¸è®°</a></li>
                <li><a href="/travel/china.html" target="_self">æ—…è¡Œåœ°å›¾</a></li>
              </ul>
            </li>
            <li><a href="/tag/index.html" target="_self">æ ‡ç­¾</a></li>
            <li><a href="/archive.html" target="_self">å½’æ¡£</a></li>
          <li class="search"><a href="/search.html" target="_self">ğŸ”</a></li>
        </ul>
      </nav>
    </div>
  </div>

  <header>
    <div class="container no-sidebar">
      <a href="/">
        <div class="name">è¿ç»´å’–å•¡å§</div>
        <div class="slogan">äº«å—æŠ€æœ¯å¸¦æ¥çš„ä¹è¶£ï¼Œä½“éªŒç”Ÿæ´»ç»™äºˆçš„æ„ŸåŠ¨</div>
      </a>
    </div>
  </header>

  <div id="content-wrap">
    <div class="container no-sidebar">
        <h1 id="art-title">Pythonå®ç°HTTPSç½‘ç«™è¯ä¹¦è¿‡æœŸç›‘æ§åŠæ›´æ–°</h1>

        <p>å½“å‰HTTPé€æ¸è¢«å¤§ä¼—æ‰€æŠ›å¼ƒï¼ŒHTTPSæ­£åœ¨æˆä¸ºäº’è”ç½‘ä¸Šçš„ä¸»æµã€‚å‰æ®µæ—¶é—´æˆ‘ä»¬ç»´æŠ¤çš„ä¸€ä¸ªHTTPSè¯ä¹¦å³å°†è¿‡æœŸï¼Œç”±äºå¤šäº‘ç¯å¢ƒæ¯”è¾ƒå¤æ‚ï¼Œå›¢é˜Ÿå°ä¼™ä¼´åœ¨æ›¿æ¢æ›´æ–°è¯ä¹¦çš„è¿‡ç¨‹ä¸­å‡ºç°ç–æ¼ï¼Œå¯¼è‡´æœ‰ä¸€ä¸ªåŸŸåè¯ä¹¦æ²¡æœ‰åŠæ—¶æ›´æ–°ï¼Œå½±å“äº†ç³»ç»Ÿå¯ç”¨æ€§ï¼Œä¸ºäº†æœç»è¿™ç§é—®é¢˜å†æ¬¡å‘ç”Ÿï¼Œä¾¿å†™äº†è¿™ä¹ˆä¸ªåŠŸèƒ½</p>
<p><img alt="" loading="lazy" src="/static/images/2020/0929.01.png" /></p>
<p>æ¯”è¾ƒç®€å•ï¼Œä½†å¾ˆå®ç”¨ï¼Œå†ä¹Ÿä¸ä¼šå‡ºç°è¯ä¹¦æ¼æ›´æ–°çš„é—®é¢˜ï¼Œå…·ä½“æµç¨‹ä¸ºï¼šæ‰«æåŸŸååˆ—è¡¨--&gt;æ£€æŸ¥æ˜¯å¦å¼€å¯HTTPS--&gt;è·å–è¯ä¹¦è¿‡æœŸæ—¶é—´--&gt;è®°å½•å…¥åº“--&gt;æ›´æ–°è¯ä¹¦</p>
<h2 id="_1">è·å–åŸŸååˆ—è¡¨</h2>
<p>æˆ‘ä»¬ç”¨äº†å¾ˆå¤šçš„å†…éƒ¨ç§æœ‰äº‘SAASæœåŠ¡ï¼Œè¿™äº›SAASæœåŠ¡éƒ½æä¾›æœ‰å®Œå–„çš„APIæ”¯æŒï¼ŒDNSæœåŠ¡ä¾¿æ˜¯å…¶ä¸­ä¹‹ä¸€ï¼Œå¯ä»¥æ ¹æ®DNSç³»ç»Ÿæä¾›çš„APIæ‹¿åˆ°æ‰€æœ‰çš„åŸŸåå’Œè®°å½•ã€‚å…¬æœ‰äº‘ä¹Ÿæä¾›æœ‰å®Œå–„çš„APIæ–‡æ¡£ï¼Œè¿™é‡Œä»¥é˜¿é‡Œäº‘ä¸ºä¾‹ï¼Œè·å–åŸŸåè®°å½•çš„ä»£ç å¦‚ä¸‹</p>
<pre class="codehilite"><code>import json
from aliyunsdkcore.client import AcsClient
from aliyunsdkcore.acs_exception.exceptions import ClientException
from aliyunsdkcore.acs_exception.exceptions import ServerException
from aliyunsdkdomain.request.v20180129.QueryDomainListRequest import QueryDomainListRequest
from aliyunsdkalidns.request.v20150109.DescribeDomainRecordsRequest import DescribeDomainRecordsRequest

class DomainApi:
    def __init__(self):
        self.client = client = AcsClient('&lt;accessKeyId&gt;', '&lt;accessSecret&gt;', 'cn-hangzhou')

    def get_domains(self, pagenum=1, pagesize=10):
        try:
            request = QueryDomainListRequest()
            request.set_accept_format('json')

            request.set_PageNum(pagenum)
            request.set_PageSize(pagesize)

            response = self.client.do_action_with_exception(request)
            jsondata = json.loads(str(response, encoding='utf-8'))

            return True, jsondata
        except Exception as e:
            return False, str(e)

    def get_records(self, domain):
        try:
            request = DescribeDomainRecordsRequest()
            request.set_accept_format('json')

            request.set_DomainName(domain)
            response = self.client.do_action_with_exception(request)

            jsondata = json.loads(str(response, encoding='utf-8'))
            return True, jsondata
        except Exception as e:
            return False, str(e)

if __name__ == '__main__':
    print(DomainApi().get_records('ops-coffee.cn'))</code></pre>


<p>ä»¥ä¸Šä»£ç ä½¿ç”¨äº†é˜¿é‡Œäº‘æä¾›çš„SDKï¼Œè°ƒç”¨ç®€å•æ–¹ä¾¿ï¼Œæœ€ç»ˆè¿”å›è¯·æ±‚çŠ¶æ€åŠæ•°æ®ã€‚<code>get_domains</code>æ–¹æ³•å¯ä»¥è·å–åˆ°è´¦å·ä¸‹çš„æ‰€æœ‰åŸŸåï¼Œ<code>get_records</code>æ–¹æ³•å¯ä»¥è·å–åˆ°åŸŸåä¸‹çš„æ‰€æœ‰è§£æè®°å½•ï¼Œéœ€è¦æ³¨æ„æ•°æ®é‡å¤§å°ï¼Œä»¥ç¡®å®šæ˜¯å¦éœ€è¦åˆ†é¡µæŸ¥è¯¢</p>
<h2 id="https">æ£€æŸ¥æ˜¯å¦å¼€å¯HTTPS</h2>
<p>æ£€æŸ¥æ˜¯å¦å¼€å¯HTTPSä¹Ÿæ˜¯ç®€å•ç²—æš´ï¼Œç›´æ¥é€šè¿‡<code>requests</code>æ¨¡å—è¯·æ±‚HTTPSåœ°å€ï¼Œæ²¡æœ‰æŠ¥é”™åˆ™è¡¨ç¤ºå¼€å¯äº†httpsæ”¯æŒï¼Œå¤§æ¦‚ä»£ç å¦‚ä¸‹</p>
<pre class="codehilite"><code>session = requests.session()

try:
    session.get('https://' + domain)
except Exception as e:
    print(e)</code></pre>


<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæ‰¹é‡æ‰«æåŸŸåçš„è¯éœ€è¦ä½¿ç”¨<code>session</code>æ¨¡å¼ï¼Œå¦åˆ™å¯èƒ½ä¼šå› ä¸ºé“¾æ¥è¿‡å¤šè€ŒæŠ¥é”™</p>
<h2 id="_2">è·å–è¯ä¹¦è¿‡æœŸæ—¶é—´</h2>
<p>ä¹‹åå†é€šè¿‡<code>pyopenssl</code>æ¨¡å—æ¥æ‹¿åˆ°åŸŸåçš„HTTPSè¯ä¹¦è¿‡æœŸæ—¶é—´ï¼Œä»£ç å¦‚ä¸‹</p>
<pre class="codehilite"><code>from _datetime import datetime
from urllib3.contrib import pyopenssl

def get_expire(domain):
    try:
        certificate = pyopenssl.ssl.get_server_certificate((domain, 443))
        data = pyopenssl.OpenSSL.crypto.load_certificate(pyopenssl.OpenSSL.crypto.FILETYPE_PEM, certificate)

        expire_time = datetime.strptime(data.get_notAfter().decode()[0:-1], '%Y%m%d%H%M%S')
        expire_days = (expire_time - datetime.now()).days

        return True, 200, {'expire_time': str(expire_time), 'expire_days': expire_days}
    except Exception as e:
        return False, 500, str(e)

if __name__ == '__main__':
    print(get_expire('blog.ops-coffee.cn'))</code></pre>


<p>ä½¿ç”¨ä¹‹å‰éœ€è¦å…ˆå®‰è£…<code>pyopenssl</code>æ¨¡å—ï¼Œè¿™é‡Œå»ºè®®ä½¿ç”¨python3.6åŠä»¥ä¸Šç‰ˆæœ¬ï¼Œé™¤äº†<code>get_notAfter</code>å¯ä»¥æ‹¿åˆ°è¯ä¹¦è¿‡æœŸæ—¶é—´å¤–ï¼Œè¿˜æœ‰ä»¥ä¸‹æ–¹æ³•èƒ½å¤Ÿè·å–åˆ°æ›´å¤šè¯ä¹¦ç›¸å…³çš„ä¿¡æ¯ï¼š<code>get_notAfter</code>,<code>get_notBefore</code>,<code>get_pubkey</code>,<code>get_serial_number</code>,<code>get_signature_algorithm</code>,<code>get_subject</code>,<code>get_version</code>,<code>gmtime_adj_notAfter</code>,<code>gmtime_adj_notBefore</code>,<code>has_expired</code></p>
<h2 id="_3">å®šæ—¶æ‰§è¡Œå…¥åº“</h2>
<p>ä»¥ä¸Šæ­¥éª¤ä¼šå®šæ—¶æ‰§è¡Œç›‘æ§ï¼Œå½“å‘ç°è¯ä¹¦è¿‡æœŸæ—¶é—´å°äº30å¤©æ—¶å‘æŠ¥è­¦ï¼Œæ‰§è¡Œæ—¥å¿—å°±å†™å…¥äº†æ•°æ®åº“æ–¹ä¾¿å‰ç«¯é¡µé¢å±•ç¤º</p>
<pre class="codehilite"><code>class Domain(models.Model):
    create_time = models.DateTimeField(auto_now_add=True, verbose_name='åˆ›å»ºæ—¶é—´')

    domain = models.CharField(max_length=64, verbose_name='ä¸€çº§åŸŸå')
    jsondata = models.TextField(verbose_name='åŸŸåè¯¦æƒ…')</code></pre>


<p>æ•°æ®åº“å°±ä¸‰ä¸ªå­—æ®µï¼Œåœ¨æ¯æ¬¡æ‰§è¡Œå®Œä¸€è½®æ‰«ç åéƒ½ä¼šå°†è¯¦ç»†ä¿¡æ¯è®¡å…¥ä¸Šè¡¨ä¸­</p>
<pre class="codehilite"><code>jsondata = {
    'items': [{
        'record': 'blog.ops-coffee.cn',
        'rdtype': 'A',
        'dept': 'å¤©ç‘'
        'enable_https': 1,
        'expire_time': '2021-10-22 12:00:00',
        'expire_days': '387',
        'notes': ''
    }], 
    'total_count': 26,
    'record_a_count': 23,
    'record_a_https_count': 19}

Domain.objects.create(domain='ops-coffee.cn', jsondata=jsondata)</code></pre>


<p>å‰ç«¯è·å–æœ€æ–°ä¸€æ¡æ•°æ®å±•ç¤º</p>
<pre class="codehilite"><code>Domain.objects.filter(domain=domain).order_by('-create_time').first()</code></pre>


<h2 id="_4">æ›´æ–°è¯ä¹¦</h2>
<p>è¯ä¹¦æ›´æ–°æ˜¯æœ€ç¹ççš„äº‹æƒ…ï¼Œå› ä¸ºæ¶‰åŠåˆ°å¤šå¹³å°ä¸åŒç¯å¢ƒï¼Œæ¯å®¶å…¬å¸æƒ…å†µå¯èƒ½éƒ½æœ‰ä¸åŒï¼Œæˆ‘ä»¬å› ä¸ºå¤§é‡ä½¿ç”¨äº†SAASæœåŠ¡ï¼ŒSAASæœåŠ¡åˆæä¾›æœ‰APIï¼Œæ‰€ä»¥æ›´æ–°èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œè°ƒç”¨APIå³</p>
<pre class="codehilite"><code>class LBCApi:
    def __init__(self):
        self.domain = 'https://lbc.ops-coffee.cn'

        self.headers = {
            'content-type': 'application/json',
            'Auth-Token': get_auth_token()[1]
        }

    def update_cert(self, id, cert):
        try:
            data = json.dumps({&quot;cert&quot;: cert})
            r = requests.put(self.domain + '/port/%d' % (id), data=data, headers=self.headers)

            if r.status_code != 200:
                return False, r.status_code, r.json()

            return True, 200, port['id']
        except Exception as e:
            return False, 500, 'PortIdï¼š%s,æ›´æ–°è¯ä¹¦å¤±è´¥' % str(e)

if __name__ == '__main__':
    state, code, data = LBCApi().update_cert(37, 'cert-ops-coffee-cn')
    print(state, code, json.dumps(data))</code></pre>


<p>æå®šæ”¶å®˜ï¼KPI++</p>

        <div>
          <ul style="display: inline-block;padding: 0;margin: 0 0 0.5em;color: #999;">
            <li style="display: inline-block;margin: 0 1em 0 0;"><a href="/python/https-certificate-management-automation.html">ğŸ“… 2020-09-30</a></li>
<li style="display: inline-block;margin: 0 1em 0 0;"><a href="/tag/Python/">ğŸ·ï¸ Python</a></li><li style="display: inline-block;margin: 0 1em 0 0;"><a href="/tag/ç›‘æ§/">ğŸ·ï¸ ç›‘æ§</a></li><li style="display: inline-block;margin: 0 1em 0 0;"><a href="/tag/å…³äºæŠ€æœ¯/">ğŸ·ï¸ å…³äºæŠ€æœ¯</a></li>          </ul>
        </div>

        <hr>

        <div class="pagination">
            <a href="https://blog.ops-coffee.cn/python/how-to-create-system-command-using-argparse.html" class="pagination-item prev-page">
                <span class="pagination-arrow">â†</span>
                <span class="pagination-text">ä¸Šä¸€ç¯‡ï¼š<br>ç”¨Pythonå†™ä¸ªLinuxç³»ç»Ÿå‘½ä»¤</span>
            </a>
            <a href="https://blog.ops-coffee.cn/python/python-https-certificate-expiration-sni-issue.html" class="pagination-item next-page">
                <span class="pagination-text">ä¸‹ä¸€ç¯‡ï¼š<br>è¯ä¹¦ç›‘æ§ | ä¸ºä»€ä¹ˆæˆ‘è·å–åˆ°çš„è¯ä¹¦æœ‰æ•ˆæœŸæ˜¯é”™çš„</span>
                <span class="pagination-arrow">â†’</span>
            </a>
        </div>

        <div class="nav-cell">
    <script async src="https://giscus.app/client.js"
            data-repo="ops-coffee/blog" data-repo-id="MDEwOlJlcG9zaXRvcnkxNDY4OTI0MTg="
            data-category="Announcements" data-category-id="DIC_kwDOCMFmgs4CQar3"
            data-mapping="pathname" data-strict="0" data-reactions-enabled="1"
            data-emit-metadata="0" data-input-position="top" data-theme="light"
            data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous">
    </script>
</div>

        <div>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8944257246828217"
         data-ad-slot="6731434232" data-ad-format="auto" data-full-width-responsive="true"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
</div>

        <div class="nav-cell">
            <p class="nav-list-title">èƒ½çœ‹åˆ°è¿™é‡Œä¸€å®šæ˜¯çœŸçˆ±ï¼Œè®¢é˜…ä¸€ä¸‹å§</p>
            <img alt="" loading="lazy" src="/static/images/wx.sou1.png" />
        </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="copy"> Â© ops-coffee</div>

      <div class="link">
        <a href="/comments.html" title="ç»™æˆ‘ç•™è¨€" target="_blank">ç•™è¨€</a>
        <a href="/friends.html" title="å‹æƒ…é“¾æ¥" target="_blank">å‹é“¾</a>
      </div>
    </div>
  </footer>
  
  <!-- Umami Cloud -->
<script async src="https://umami.ops-coffee.cn/script.js" data-website-id="a4aabd8e-32c7-40e7-a81c-119b909f2d0f"></script>

<!-- Google Adsense -->
<script data-ad-client="ca-pub-8944257246828217" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</body>

</html>