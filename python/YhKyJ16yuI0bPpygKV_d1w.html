<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="applicable-device" content="pc,mobile">
  <meta name="keywords" content="P2PæŠ•èµ„, ç†è´¢äº§å“, æŠ€æœ¯å®ç°, Python, Django, MySQL, Redis, å¾®ä¿¡æœºå™¨äºº, å¾®ä¿¡å…¬ä¼—å·, æŠ•èµ„é£é™©, æ•°æ®æŠ“å–, ç†è´¢éœ€è°¨æ…" />
  <meta name="description" content="æœ¬æ–‡ä»‹ç»äº†P2Pç†è´¢äº§å“çš„ç‰¹ç‚¹åŠå…¶æŠ•èµ„é£é™©ï¼Œå¹¶è¯¦ç»†é˜è¿°äº†å¦‚ä½•ä½¿ç”¨Pythonã€Djangoç­‰æŠ€æœ¯å®ç°æ•°æ®çš„æŠ“å–ã€å¤„ç†å’Œå±•ç¤ºï¼Œä»¥åŠå¦‚ä½•é€šè¿‡å¾®ä¿¡å’Œå¾®ä¿¡å…¬ä¼—å·å®ç°è‡ªåŠ¨å›å¤åŠŸèƒ½ã€‚" />
  <link rel="alternate" type="application/rss+xml" title="è¿ç»´å’–å•¡å§" href="https://blog.ops-coffee.cn/feed.xml" />
  <link rel="stylesheet" href="https://blog.ops-coffee.cn/static/posts/css/ops-coffee.min.css" type="text/css" />

  <!-- Begin SEO tag -->
  <title>pythonå¦‚ä½•å¸®æˆ‘åœ¨æŠ•èµ„ä¸­è·å–æ›´é«˜æ”¶ç›Š</title>
  <meta property="og:locale" content="zh_CN" />
  <meta property="og:site_name" content="è¿ç»´å’–å•¡å§" />
  <meta property="og:url" content="https://blog.ops-coffee.cn" />
  <meta property="og:title" content="pythonå¦‚ä½•å¸®æˆ‘åœ¨æŠ•èµ„ä¸­è·å–æ›´é«˜æ”¶ç›Š" />
  <meta property="og:description" content="æœ¬æ–‡ä»‹ç»äº†P2Pç†è´¢äº§å“çš„ç‰¹ç‚¹åŠå…¶æŠ•èµ„é£é™©ï¼Œå¹¶è¯¦ç»†é˜è¿°äº†å¦‚ä½•ä½¿ç”¨Pythonã€Djangoç­‰æŠ€æœ¯å®ç°æ•°æ®çš„æŠ“å–ã€å¤„ç†å’Œå±•ç¤ºï¼Œä»¥åŠå¦‚ä½•é€šè¿‡å¾®ä¿¡å’Œå¾®ä¿¡å…¬ä¼—å·å®ç°è‡ªåŠ¨å›å¤åŠŸèƒ½ã€‚" />
  <link rel="canonical" href="https://blog.ops-coffee.cn" />
  <!-- End SEO tag -->
</head>

<body>
  <div class="header">
    <div class="menu-button">&#9776; 
        <span class="menu-title">è¿ç»´å’–å•¡å§</span>
    </div> 

    <div class="container no-sidebar">
      <nav class="header-site">
        <ul>
          <li><a href="/">é¦–é¡µ</a></li>
            <li class="has-submenu">
              <a href="#" target="_self">è¿ç»´</a>
              <ul class="sub-menu">
                <li><a href="/tag/ç³»ç»Ÿè¿ç»´/" target="_self">ç³»ç»Ÿè¿ç»´</a></li>
                <li><a href="/elk/index.html" target="_self">ELKç³»åˆ—</a></li>
                <li><a href="/ldap/index.html" target="_self">LDAPç³»åˆ—</a></li>
              </ul>
            </li>
            <li class="has-submenu">
              <a href="#" target="_self">å¼€å‘</a>
              <ul class="sub-menu">
                <li><a href="/tag/Devops/" target="_self">DevOps</a></li>
                <li><a href="/tag/Python/" target="_self">Python</a></li>
                <li><a href="/tag/Django/" target="_self">Django</a></li>
                <li><a href="/bpmn/index.html" target="_self">BPMNç³»åˆ—</a></li>
                <li><a href="/webssh/index.html" target="_self">WebSSHç³»åˆ—</a></li>
                <li><a href="/frontend/index.html" target="_self">å‰ç«¯å¼€å‘ç³»åˆ—</a></li>
              </ul>
            </li>
            <li><a href="/devops/index.html" target="_self">è¿ç»´å¹³å°</a></li>
            <li class="has-submenu">
              <a href="#" target="_self">è¿™æ˜¯ç”Ÿæ´»</a>
              <ul class="sub-menu">
                <li><a href="/life/chronicles.html" target="_self">æ—¶å…‰å°è®°</a></li>
                <li><a href="/life/money.html" target="_self">å‰¯ä¸šèµšé’±</a></li>
                <li><a href="/life/writing.html" target="_self">å†™ä½œç›¸å…³</a></li>
                <li><a href="/tag/è¿™æ˜¯ç”Ÿæ´»/" target="_self">ç”Ÿæ´»éšç¬”</a></li>
              </ul>
            </li>
            <li class="has-submenu">
              <a href="#" target="_self">æˆ¿è½¦æ—…è¡Œ</a>
              <ul class="sub-menu">
                <li><a href="/rv.html" target="_self">æˆ¿è½¦ä½“éªŒ</a></li>
                <li><a href="/travels.html" target="_self">æ—…è¡Œæ¸¸è®°</a></li>
                <li><a href="/travel/china.html" target="_self">æ—…è¡Œåœ°å›¾</a></li>
              </ul>
            </li>
            <li><a href="/tag/index.html" target="_self">æ ‡ç­¾</a></li>
            <li><a href="/archive.html" target="_self">å½’æ¡£</a></li>
          <li class="search"><a href="/search.html" target="_self">ğŸ”</a></li>
        </ul>
      </nav>
    </div>
  </div>

  <header>
    <div class="container no-sidebar">
      <a href="/">
        <div class="name">è¿ç»´å’–å•¡å§</div>
        <div class="slogan">äº«å—æŠ€æœ¯å¸¦æ¥çš„ä¹è¶£ï¼Œä½“éªŒç”Ÿæ´»ç»™äºˆçš„æ„ŸåŠ¨</div>
      </a>
    </div>
  </header>

  <div id="content-wrap">
    <div class="container no-sidebar">
        <h1 id="art-title">pythonå¦‚ä½•å¸®æˆ‘åœ¨æŠ•èµ„ä¸­è·å–æ›´é«˜æ”¶ç›Š</h1>

        <blockquote>
<p>ææŠ€æœ¯çš„å¤§éƒ½æ¯”è¾ƒçº¯ç²¹ï¼Œæ¯”è¾ƒå®åœ¨ï¼Œé™¤äº†å·¥èµ„ä¹‹å¤–åŸºæœ¬å°±æ²¡æœ‰åˆ«çš„æ”¶å…¥äº†ï¼ˆå°‘éƒ¨åˆ†äººèƒ½æ¥å¤–åŒ…èµšå¤–å—ï¼‰ã€‚æˆ–è®¸æ˜¯è¿«äºç”Ÿæ´»çš„å‹åŠ›ï¼Œæˆ–è®¸æ˜¯ä¸ç”˜äºå›ºå®šçš„å·¥èµ„ï¼Œæˆ–è®¸æ˜¯å‡ºäºæŠ€æœ¯äººéª¨å­é‡Œçš„å¥½å¥‡ï¼Œäº¦æˆ–æ˜¯è¿™å‡ å¹´å…³äºç†è´¢æŠ•èµ„çš„å¤§åŠ›å®£ä¼ ã€é—¨æ§›é™ä½ï¼Œç†è´¢è¶Šæ¥è¶Šè¢«æˆ‘ä»¬æ‰€æ¥å—ï¼Œå¹¶å¼€å§‹å°è¯•è‚¡ç¥¨ã€åŸºé‡‘ã€P2Pã€XXå®ç­‰å„ç§ç†è´¢äº§å“ï¼Œæœ¬æ–‡æ‰€è®²ä¸P2Pæœ‰å…³ï¼Œä½†ä¸æ‰“å¹¿å‘Šï¼Œåªè®²æŠ€æœ¯ï¼Œé¡ºä¾¿è¯´æ˜ï¼š<strong>æŠ•èµ„æœ‰é£é™©ï¼Œç†è´¢éœ€è°¨æ…</strong>ï¼Œæˆ‘ä»¬èµšé’±ä¸å®¹æ˜“ï¼Œä¸èƒ½ç»™æ‰“äº†æ°´æ¼‚ã€‚</p>
</blockquote>
<h1 id="_1">èƒŒæ™¯ä»‹ç»</h1>
<p>æŸå…¬å¸çš„ç†è´¢äº§å“æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š</p>
<ol>
<li>å…¬å¸åˆ†åˆ«æœ‰12,18,24,36ä¸ªæœˆçš„å›ºå®šæœŸé™ç†è´¢äº§å“ï¼ŒæœŸé™è¶Šé•¿åˆ©ç‡è¶Šé«˜</li>
<li>æŠ•èµ„ç”¨æˆ·å¯å°†å€ºæƒç”³è¯·è½¬ç»™å…¶ä»–æŠ•èµ„äººï¼Œè½¬å‡ºæ—¶çš„åˆ©ç‡ä½ å¯ä»¥è‡ªè¡Œæ§åˆ¶</li>
<li>ä½ ä¹Ÿå¯ä»¥é€šè¿‡å¹³å°å€Ÿé’±ï¼Œå€Ÿé’±é‡‘é¢ä¸èƒ½è¶…è¿‡åœ¨æŠ•é‡‘é¢çš„3å€ï¼Œæ‰€è°“åŠ æ æ†</li>
</ol>
<p>æœ‰ä¸€éƒ¨åˆ†ç”¨æˆ·ï¼ˆè¡Œè¯å«ç‰›ï¼‰å°±é å¹³å°æ´»åŠ¨æˆ–é«˜æ¯çš„æ—¶å€™å€Ÿé’±åŠ æ æ†æŠ•èµ„ï¼Œéœ€è¦è¿˜é’±çš„æ—¶å€™é€šè¿‡å€ºæƒè½¬è®©å¹³å°è½¬è®©æ ‡è¿˜å€Ÿæ¬¾ï¼Œé€šè¿‡ä¹°å…¥å’Œå–å‡ºæ—¶çš„åˆ©ç‡å·®è·å¾—é¢å¤–æ”¶ç›Šã€‚è¿™ä¸­é—´æ¯”è¾ƒå…³é”®çš„ä¸€ç‚¹å°±æ˜¯è½¬å‡ºæ—¶çš„åˆ©ç‡ï¼Œåˆ©ç‡ä½æ”¶ç›Šå°±é«˜ï¼ˆä½†å¤ªä½å°±æ²¡æœ‰äººæ¥æ‰‹äº†ï¼Œè½¬ä¸å‡ºå»è¿˜ä¸äº†å€Ÿæ¬¾å°±è¦æ”¯ä»˜é«˜é¢ç½šé‡‘ï¼‰ï¼Œåˆ©ç‡åˆè·Ÿå½“å¤©å¾…è¿˜çš„é‡‘é¢å’Œå·²æˆäº¤çš„é‡‘é¢æœ‰ç›´æ¥å…³ç³»ï¼Œé‚£ä¹ˆå¦‚æœèƒ½åŠæ—¶è·å–è¿™ä¸¤ä¸ªæ•°æ®å°±å¤§æ¦‚çŸ¥é“è‡ªå·±æ ‡å¤šå°‘åˆ©ç‡èƒ½è½¬æ‰‹æˆåŠŸäº†ã€‚</p>
<p>æˆ‘ä»¬æ¥ä¸‹æ¥çš„æŠ€æœ¯å®ç°å°±ä¸»è¦è·Ÿè·å–è¿™ä¸¤ä¸ªæ•°æ®ï¼Œä»¥åŠå¦‚ä½•åŠæ—¶çš„å±•ç¤ºæ•°æ®æœ‰å…³ã€‚</p>
<h1 id="_2">æœåŠ¡å’Œå·¥å…·</h1>
<ul>
<li>python3.4</li>
<li>mysql5.7</li>
<li>redis2.8</li>
<li>django2.0</li>
</ul>
<h1 id="_3">æŠ€æœ¯å®ç°</h1>
<p><strong>åªæ˜¯ä¸ºäº†æŠ€æœ¯ç ”ç©¶</strong>ï¼Œæ²¡æœ‰å•†ç”¨ï¼Œä»£ç å’Œæ¶æ„ä»¥å®ç°éœ€æ±‚ä¸ºç›®çš„ï¼Œæœªåšä¼˜åŒ–ï¼Œä¸”éä¸“ä¸šå¼€å‘ï¼Œå‡‘åˆçœ‹</p>
<h2 id="_4">æŠ“å–æ•°æ®</h2>
<p>ç¿»äº†ä¸€éå¹³å°å®˜ç½‘å‘ç°æœ‰ä¸ªé¡µé¢ç›´æ¥å±•ç¤ºäº†è½¬è®©æ ‡çš„è¯¦ç»†ä¿¡æ¯ï¼Œæ— éœ€ç™»å½•ï¼Œä¸”æ˜¯é€šè¿‡ajaxæ–¹å¼å¼‚æ­¥åŠ è½½çš„jsonå­—ç¬¦ä¸²ï¼ˆä½†æ˜¯jsonå­—ç¬¦ä¸²é‡Œå¥—äº†ä¸€å †çš„htmlä»£ç ï¼Œä¸çŸ¥é“å’‹è®¾è®¡çš„ï¼‰çš„æ–¹å¼æ¸²æŸ“é¡µé¢çš„ï¼Œé‚£æŠ“å–å·¥ä½œç®€å•å¤šäº†ï¼Œå†™äº†ä¸ªæŠ“å–è„šæœ¬ï¼Œæµç¨‹ä¸ºï¼šè®¿é—®é¡µé¢æ¥å£ --&gt; å–åˆ°æ•°æ® --&gt; ç®€å•å¤„ç† --&gt; å½•å…¥æ•°æ®åº“ï¼ŒæŠ“å–è„šæœ¬ç›´æ¥æ”¾åœ¨è®¡åˆ’ä»»åŠ¡é‡Œæ¯ä¸‰åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼Œè„šæœ¬å†…å®¹å¦‚ä¸‹ï¼š</p>
<pre class="codehilite"><code>import re
import time
import datetime
import requests

import pymysql

# è¿æ¥mysqlæ•°æ®åº“
db = pymysql.connect(&quot;127.0.0.1&quot;,&quot;root&quot;,&quot;passwd&quot;,&quot;pzp&quot;)
cursor = db.cursor()

for i in range(1, 9999):
    data = {
        &quot;RepaymentTypeId&quot;: 0,
        &quot;pagesize&quot;: 1,
        &quot;pageindex&quot;: i,
        &quot;type&quot;: 1,
        &quot;status&quot;: 2,
        &quot;startDeadLine&quot;: 0,
        &quot;endDeadLine&quot;: 0,
        &quot;rate&quot;: 0,
        &quot;beginRate&quot;: 0,
        &quot;endRate&quot;: 0,
        &quot;strkey&quot;: None,
        &quot;orderby&quot;: 15,
        &quot;unitStart&quot;: 0,
        &quot;unitEnd&quot;: 0
    }

    try:
        r = requests.post('https://www.tuandai.com/pages/zSharePlan/getZXList', data=data).json()

        if r.get('code') == 0:
            html = r.get('data').get('projectListHtml')

            dr = re.compile(r'&lt;[^&gt;]+&gt;', re.S)
            dd = dr.sub('', html).split()

            # æˆªå–å•å·ï¼Œåªå–å­—ç¬¦ä¸²ä¸­çš„æ•°å­—
            order_num = ''.join(re.compile('\d+').findall(dd[0]))

            # æŸ¥è¯¢mysqlæ•°æ®åº“
            cursor.execute(&quot;select order_num from tdw_zx_done where order_num = %s&quot; %order_num)
            # è·å–åˆ°æŸ¥è¯¢ç»“æœ
            ex = cursor.fetchone()

            # åˆ¤æ–­å•å·æ˜¯å¦å·²ç»è®°å½•è¿‡
            if ex is None:
                # å¦‚æœå•å·æ²¡æœ‰è®°å½•è¿‡ï¼Œåˆ™è®¡æ•°å™¨ç½®ä¸º0
                x = 0

                publish_time = datetime.datetime.strptime(
                    '20%s-%s-%s %s:%s:%s' %(order_num[0:2],order_num[2:4],order_num[4:6],order_num[6:8],order_num[8:10],order_num[10:12]),
                    '%Y-%m-%d %H:%M:%S'
                )

                # â€˜å…ƒâ€™å•ä½éƒ½æ›¿æ¢æˆâ€˜ä¸‡å…ƒâ€™ï¼Œå¹¶å»æ‰æ±‰å­—
                a = dd[1].split(':')[1]
                if 'å…ƒ' in a:
                    money = int(''.join(re.compile('\d+').findall(a))) / 10000
                else:
                    money = a.replace('ä¸‡','')

                # å–åˆ©ç‡
                rate = dd[4].replace('%','')

                # è®¡ç®—è¿˜æ¬¾æ—¥æœŸï¼Œå€Ÿæ¬¾æ—¥æœŸ + å€Ÿæ¬¾æ—¶é—´
                days = ''.join(re.compile('\d+').findall(dd[6]))
                repay = (publish_time + datetime.timedelta(days=int(days))).strftime('%Y-%m-%d')

                print(publish_time, order_num, money, rate, days, repay)

                # å¾€æ•°æ®åº“é‡Œæ’å…¥æ•°æ®å¹¶æäº¤
                sql = &quot;INSERT INTO tdw_zx_done VALUES('%s', %s, %s, %s, %s, '%s')&quot; %(publish_time, order_num, money, rate, days, repay)
                cursor.execute(sql)
                db.commit()

            else:
                # å¦‚æœå•å·å·²ç»è®°å½•è¿‡ï¼Œåˆ™è®¡æ•°å™¨åŠ 1
                x += 1

                # å¦‚æœå•å·å·²å½•å…¥è¿‡æ•°æ®åº“ï¼Œåˆ™è¿”å›
                print('å•å·å·²å½•å…¥ï¼š%s' %str(order_num))

            # åˆ¤æ–­å¦‚æœæœ‰è¿ç»­200ä¸ªå•å·éƒ½å·²ç»å½•å…¥è¿‡æ•°æ®åº“ï¼Œåˆ™è·³å‡ºå¾ªç¯
            if x == 200:
                break

            time.sleep(0.02)
        else:
            print(r)
    except Exception as e:
        print(e)

db.close()</code></pre>


<h2 id="_5">æ•°æ®å¤„ç†åŠç¼“å­˜</h2>
<p>ä¸Šè¾¹å·²ç»è·å–åˆ°äº†åŸå§‹æ•°æ®ï¼Œæ¥ä¸‹æ¥éœ€è¦å¯¹åŸå§‹æ•°æ®è¿›è¡Œæ¸…æ´—ï¼Œå–è‡ªå·±éœ€è¦çš„ä»Šæ—¥å¾…è¿˜åŠå®æ—¶æˆäº¤ï¼Œå¹¶å†™å…¥ç¼“å­˜ï¼Œå†™å…¥ç¼“å­˜çš„ç›®çš„æ˜¯å…¬ä¼—å·å¹¶å‘æŸ¥è¯¢çš„æƒ…å†µä¸‹ï¼Œç›´æ¥å»ç¼“å­˜å–æ•°æ®ï¼Œå‡å°å¯¹æ•°æ®åº“çš„å‹åŠ›ï¼Œè¿™ä¸ªè„šæœ¬ç¨‹åºä¹Ÿæ”¾åœ¨è®¡åˆ’ä»»åŠ¡é‡Œæ¯åˆ†é’Ÿæ‰§è¡Œ</p>
<pre class="codehilite"><code>import os
import sys
import json
import datetime
from decimal import Decimal

os.chdir(sys.path[0])

from connection import rediscon, mysqlcon
mc, rc = mysqlcon().cursor(), rediscon()

def cache_now_data():
    today = datetime.date.today().strftime('%Y-%m-%d')

    tj, th, = '', ''

    try:
        # æˆäº¤æ•°æ®ç»Ÿè®¡
        mc.execute(&quot;select count(1),sum(money) from tdw_zx_done where DATE(publish_time)='%s';&quot; %today)
        tj = mc.fetchone()

        tjie = 'å€Ÿæ¬¾äººæ•°ï¼š%s å€Ÿæ¬¾é‡‘é¢ï¼š%s' %(tj[0], tj[1])

        # å¾…è¿˜æ•°æ®ç»Ÿè®¡
        mc.execute(&quot;select count(1),sum(money) from tdw_zx_done where repay='%s';&quot; %today)
        th = mc.fetchone()

        thuan = 'å¾…è¿˜äººæ•°ï¼š%s å¾…è¿˜é‡‘é¢ï¼š%s' %(th[0], th[1])

        # å®Œæˆè¿˜æ¬¾é¢„ä¼°æ—¶é—´
        if th[0]:
            tomorror_date = datetime.date.today() + datetime.timedelta(days=1)
            tomorror_time_str = tomorror_date.strftime('%Y-%m-%d 00:00:00')
            tomorror_time_format = datetime.datetime.strptime(tomorror_time_str, '%Y-%m-%d %H:%M:%S') 

            last_hour = (tomorror_time_format - datetime.datetime.now()).seconds / 60 / 60
            avg_hour_money = round(Decimal(th[1] - tj[1]) / Decimal(last_hour), 4)
            avg_hour_money = avg_hour_money if avg_hour_money &gt; 0 else 0
        else:
            avg_hour_money = 'æ— ä»Šæ—¥å¾…è¿˜æ•°æ®ï¼Œæ— æ³•è®¡ç®—'

        # æŒ‰å°æ—¶ç»Ÿè®¡è¯¦æƒ…
        mc.execute(&quot;select Hour(publish_time) as Hour,count(1),sum(money) from tdw_zx_done where DATE(publish_time) ='%s' group by Hour;&quot; %today)
        tdetail = mc.fetchall()

        dl = 'å°æ—¶  |  æˆäº¤é¢ï¼ˆä¸‡å…ƒï¼‰\n'
        for i in tdetail:
            dl += str(i[0]) + '  |  ' + str(i[2]) + '\n'

    except Exception as e:
        print('æ•°æ®åº“æ“ä½œå¼‚å¸¸ï¼š%s' %e)

    try:
        key = datetime.datetime.now().strftime('%Y%m%d%H%M')
        val = {&quot;daihuan&quot;:str(th[1]),&quot;chengjiao&quot;:str(tj[1]),&quot;avg_hour_money&quot;:str(avg_hour_money)}

        print(rc.set('tdw_zx_now_'+key, json.dumps(val), ex=7200))
    except Exception as e:
        print('ç¼“å­˜æ“ä½œå¼‚å¸¸ï¼š%s' %e)

if __name__ == '__main__':
    cache_now_data()</code></pre>


<h2 id="_6">å¾®ä¿¡å¥½å‹ã€ç¾¤è‡ªåŠ¨å›å¤</h2>
<p>æˆ‘æƒ³çœ‹æ•°æ®çš„æ—¶å€™å¦‚ä½•å»çœ‹å‘¢ï¼Ÿå»æœåŠ¡å™¨ä¸Šæ‰§è¡Œä¸‹è„šæœ¬è¿™æ–¹å¼å¤ªlowäº†å§ï¼Œå€ŸåŠ©å¾®ä¿¡æœºå™¨äººï¼Œå°±åƒä½ è·Ÿæœ‹å‹èŠå¤©ä¸€æ ·ï¼Œå‘æ¶ˆæ¯â€œæœ€æ–°æ•°æ®â€ï¼Œé‚£ä»–å°±ç«‹å³å›å¤æœ€æ–°æ¶ˆæ¯ç»™ä½ ï¼Œè¿™ä¸ªæ–¹å¼çœ‹èµ·æ¥ä¸é”™ï¼Œå®ç°å®Œæˆåæœ‰å‡ ä¸ªæœ‹å‹è§‰å¾—ä¸é”™ï¼Œä¹Ÿæƒ³çœ‹æ•°æ®ï¼Œé‚£æˆ‘å¹²è„†å°†è¿™äº›éœ€è¦çœ‹æ•°æ®çš„æœ‹å‹éƒ½æ‹‰å€’ä¸€ä¸ªç¾¤é‡Œå§ï¼Œå›å¤æ¶ˆæ¯ç¾¤é‡Œæ‰€æœ‰ç”¨æˆ·éƒ½çœ‹å¾—åˆ°å¾ˆæ–¹ä¾¿äº†ï¼ŒæŠ€æœ¯å®ç°ä¸»è¦å€ŸåŠ©äº†<code>itchat</code>æ¨¡å—ï¼ˆitchatä¸»è¦é€šè¿‡ç½‘é¡µç‰ˆå¾®ä¿¡æ¥å£å¤„ç†æ•°æ®ï¼Œç½‘é¡µç‰ˆå¾®ä¿¡å¾ˆå¤šç”¨æˆ·æ— æ³•ç™»é™†äº†ï¼Œä¹Ÿå°±æ²¡æœ‰åŠæ³•ä½¿ç”¨itchatï¼‰ï¼Œä»£ç å¦‚ä¸‹</p>
<pre class="codehilite"><code>import itchat

from tdw_data_statistics_now import get_now_data

# å¤„ç†å¥½å‹æ¶ˆæ¯
@itchat.msg_register(itchat.content.TEXT)
def text_reply(msg):
    if msg['Text'].startswith('å‘½ä»¤ï¼š'):
        message = msg['Content'].split('å‘½ä»¤ï¼š')[1]
        msg.user.send('æ­£åœ¨å¤„ç†ä½ çš„å‘½ä»¤ï¼š%s' %(message))
    if 'æœ€æ–°æ•°æ®' == msg['Text']:
        message = get_now_data()
        msg.user.send(message)

# å¤„ç†ç¾¤èŠæ¶ˆæ¯
@itchat.msg_register(itchat.content.TEXT, isGroupChat=True)
def text_reply(msg):
    #itchat.send(u'@%s\u2005I received: %s' % (msg['ActualNickName'], msg['Content']), msg['FromUserName'])
    if 'æœ€æ–°æ•°æ®' == msg['Text']:
        message = get_now_data()
        msg.user.send(message)

#message = getMessage()
#itchat.send(message, toUserName='filehelper')

itchat.auto_login(True, enableCmdQR=True)
itchat.run(True)</code></pre>


<h2 id="_7">å¾®ä¿¡å…¬ä¼—å·è‡ªåŠ¨å›å¤</h2>
<p>è®¾æƒ³ä¸€ä¸ªåº”ç”¨åœºæ™¯ï¼Œå¦‚æœæœ‰å¾ˆå¤šäººéœ€è¦è¿™ä¸ªæ•°æ®æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿè®©ä»–ä»¬éƒ½åŠ ä¸€ä¸‹æˆ‘çš„å¾®ä¿¡æˆ–æŠŠä»–ä»¬éƒ½ç»™åŠ åˆ°ä¸€ä¸ªç¾¤é‡Œå›ºç„¶å¯ä»¥ï¼Œåªæ˜¯ä¸å¤Ÿä¼˜é›…ï¼Œè¿™é‡Œæƒ³åˆ°äº†å¾®ä¿¡å…¬ä¼—å·ï¼Œå½“ç”¨æˆ·å…³æ³¨å…¬ä¼—å·åï¼Œå›å¤â€œæœ€æ–°æ•°æ®â€å¯æŠŠæœ€æ–°æ•°æ®è‡ªåŠ¨å›å¤ç»™ç”¨æˆ·æ˜¯ä¸æ˜¯å°±ä¼˜é›…å¾ˆå¤šäº†ã€‚ç„¶åå°±å†™äº†ä¸ªæœºå™¨äººè‡ªåŠ¨å¤„ç†ï¼Œä¸»è¦å€ŸåŠ©<code>werobot</code>æ¨¡å—å®ç°ã€‚</p>
<p>å¾®ä¿¡å…¬ä¼—å·å¯ä»¥é…ç½®ä¸ºå¼€å‘è€…æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯å¼€å‘è€…å¯ä»¥æä¾›ä¸€ä¸ªhttpæ¥å£ï¼Œå…¬ä¼—å·ä¼šæŠŠæ”¶åˆ°çš„æ‰€æœ‰æ¶ˆæ¯å‘é€ç»™å¼€å‘è€…æä¾›çš„æ¥å£ï¼ŒæœåŠ¡å™¨æ¥æ”¶åˆ°æ•°æ®ååˆ¤æ–­æ•°æ®ç±»å‹ï¼Œå¯¹æ•°æ®åšå¤„ç†ï¼Œè¿™é‡Œéœ€è¦ç”¨åˆ°webæœåŠ¡ï¼Œæ‰€ä»¥å¼•å…¥Django</p>
<ul>
<li>url</li>
</ul>
<pre class="codehilite"><code>from django.urls import path

from werobot.contrib.django import make_view
from official.robot import robot

urlpatterns = [
    path('robot/', make_view(robot)),
]</code></pre>


<ul>
<li>æœºå™¨äººç¨‹åº</li>
</ul>
<pre class="codehilite"><code># cat official/robot.py
import re

from werobot import WeRoBot
from werobot.replies import ImageReply

from official.backends.get_tdw_data import get_now_data

robot = WeRoBot(enable_session=False,
                token='',
                APP_ID='',
                APP_SECRET='')

# æ–°ç”¨æˆ·å…³æ³¨è‡ªåŠ¨å›å¤
@robot.subscribe
def subscribe(message):
    return '''æ¥äº†ï¼Ÿåï¼Œå¥½æˆé©¬ä¸Šå¼€å§‹

å›å¤[æœ€æ–°æ•°æ®]è·å–æœ€æ–°æ•°æ®æ›´æ–°'''

# è”ç³»äºŒç»´ç ï¼Œç”¨æˆ·è¾“å…¥&quot;è”ç³»&quot;å…³é”®å­—å›å¤ä½œè€…äºŒç»´ç 
@robot.filter(re.compile(&quot;.*?è”ç³».*?&quot;))
def contact(message):
    return ImageReply(
        message=message,
        media_id=&quot;DBO8qVu-8bwNF9O7o8wCyRs4awfVTjA_WuPoLkj33B1C8ZX9JVdmw30zZo9l8ovx&quot;
    )

# å¤„ç†æ–‡æœ¬æ¶ˆæ¯
@robot.text
def hello(message):
    try:
        msg = message.content.strip().lower()

        if re.compile(&quot;æœ€æ–°.*&quot;).match(msg):
            tdw_zx_now_data = get_now_data()

            if tdw_zx_now_data:
                return tdw_zx_now_data
            else:
                return 'æš‚æ—¶æ— æ³•è·å–æ•°æ®ï¼Œè¯·ç¨åå†è¯•'
        else:
            return 'è¯·è¾“å…¥[ æœ€æ–°æ•°æ® ]è·å–æ™ºäº«æ•°æ®æ›´æ–°\n\nå¦‚æœ‰ç–‘é—®å¯ä»¥å›å¤[ è”ç³»ä½œè€… ]ä¸æˆ‘è”ç³»'
    except Exception as e:
        print(e)</code></pre>


<ul>
<li>åå°å¤„ç†ç¨‹åº</li>
</ul>
<pre class="codehilite"><code>import json
import datetime

from django_redis import get_redis_connection
cache = get_redis_connection('default')

def get_now_data():
    now_time = datetime.datetime.now()
    prev_time = now_time - datetime.timedelta(minutes=1)

    # ç›´æ¥å»ç¼“å­˜å–æ•°æ®
    redis_value = cache.get('tdw_zx_now_'+prev_time.strftime('%Y%m%d%H%M'))

    if redis_value:
        jsondata = json.loads(redis_value.decode())
        daihuan = 'ä»Šæ—¥å¾…è¿˜é‡‘é¢ï¼š%sä¸‡å…ƒ' %jsondata.get('daihuan')
        chengjiao = 'å½“å‰å·²æˆäº¤é‡‘é¢ï¼š%sä¸‡å…ƒ' %jsondata.get('chengjiao')
        avg_hour_money = 'å®Œæˆè¿˜æ¬¾é¢„ä¼°æ¯å°æ—¶éœ€è¦æˆäº¤ï¼š%sä¸‡å…ƒ' %jsondata.get('avg_hour_money')

        return '''%s\n%s\n%s\n%s''' %(prev_time.strftime('%Y-%m-%d %H:%M'), daihuan, chengjiao, avg_hour_money)
    else:
        return None</code></pre>


<h1 id="_8">æ€»ç»“</h1>
<ol>
<li>å­¦ä¼šæŠ•èµ„ç†è´¢</li>
<li>åˆ«äººèµšé’±çš„æ–¹å¼å¯èƒ½è·Ÿè‡ªå·±æƒ³è±¡çš„ä¸ä¸€æ ·</li>
<li>ç”¨æŠ€æœ¯è§£å†³ç”Ÿæ´»ä¸­çš„å®é™…é—®é¢˜ï¼Œä¸ä»…èƒ½æé«˜èƒ½åŠ›ï¼Œè¿˜èƒ½è·å¾—æ›´å¤§çš„æ»¡è¶³</li>
</ol>

        <div>
          <ul style="display: inline-block;padding: 0;margin: 0 0 0.5em;color: #999;">
            <li style="display: inline-block;margin: 0 1em 0 0;"><a href="/python/YhKyJ16yuI0bPpygKV_d1w.html">ğŸ“… 2018-07-06</a></li>
<li style="display: inline-block;margin: 0 1em 0 0;"><a href="/tag/Python/">ğŸ·ï¸ Python</a></li><li style="display: inline-block;margin: 0 1em 0 0;"><a href="/tag/å…³äºæŠ€æœ¯/">ğŸ·ï¸ å…³äºæŠ€æœ¯</a></li>          </ul>
        </div>

        <hr>

        <div class="nav-cell">
    <script async src="https://giscus.app/client.js"
            data-repo="ops-coffee/blog" data-repo-id="MDEwOlJlcG9zaXRvcnkxNDY4OTI0MTg="
            data-category="Announcements" data-category-id="DIC_kwDOCMFmgs4CQar3"
            data-mapping="pathname" data-strict="0" data-reactions-enabled="1"
            data-emit-metadata="0" data-input-position="top" data-theme="light"
            data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous">
    </script>
</div>

        <div>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8944257246828217"
         data-ad-slot="6731434232" data-ad-format="auto" data-full-width-responsive="true"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
</div>

        <div class="nav-cell">
            <p class="nav-list-title">èƒ½çœ‹åˆ°è¿™é‡Œä¸€å®šæ˜¯çœŸçˆ±ï¼Œè®¢é˜…ä¸€ä¸‹å§</p>
            <img alt="" loading="lazy" src="/static/images/wx.sou1.png" />
        </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="copy"> Â© ops-coffee</div>

      <div class="link">
        <a href="/comments.html" title="ç»™æˆ‘ç•™è¨€" target="_blank">ç•™è¨€</a>
        <a href="/friends.html" title="å‹æƒ…é“¾æ¥" target="_blank">å‹é“¾</a>
      </div>
    </div>
  </footer>
  
  <!-- Umami Cloud -->
<script async src="https://umami.ops-coffee.cn/script.js" data-website-id="a4aabd8e-32c7-40e7-a81c-119b909f2d0f"></script>

<!-- Google Adsense -->
<script data-ad-client="ca-pub-8944257246828217" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</body>

</html>