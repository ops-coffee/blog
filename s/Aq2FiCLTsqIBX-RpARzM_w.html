<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="applicable-device" content="pc,mobile">
  <meta name="keywords" content="pyopenssl,SNI,è¿ç»´,è¿ç»´åšå®¢,è¿ç»´å¼€å‘,è‡ªåŠ¨åŒ–,äº‘è®¡ç®—,ops,sre,linux,devops,cloud" />
  <meta name="description" content="è¯ä¹¦ç›‘æ§ | ä¸ºä»€ä¹ˆæˆ‘è·å–åˆ°çš„è¯ä¹¦æœ‰æ•ˆæœŸæ˜¯é”™çš„" />
  <link rel="stylesheet" href="https://static.opendevops.cn/static/posts/css/ops-coffee.min.css" type="text/css" />
  <link rel="shortcut icon" href="/static/images/favicon.ico" />

  <!-- Begin SEO tag -->
  <title>è¯ä¹¦ç›‘æ§ | ä¸ºä»€ä¹ˆæˆ‘è·å–åˆ°çš„è¯ä¹¦æœ‰æ•ˆæœŸæ˜¯é”™çš„</title>
  <meta property="og:locale" content="zh_CN" />
  <meta property="og:site_name" content="è¿ç»´å’–å•¡å§" />
  <meta property="og:url" content="https://blog.ops-coffee.cn" />
  <meta property="og:title" content="è¯ä¹¦ç›‘æ§ | ä¸ºä»€ä¹ˆæˆ‘è·å–åˆ°çš„è¯ä¹¦æœ‰æ•ˆæœŸæ˜¯é”™çš„" />
  <meta property="og:description" content="è¯ä¹¦ç›‘æ§ | ä¸ºä»€ä¹ˆæˆ‘è·å–åˆ°çš„è¯ä¹¦æœ‰æ•ˆæœŸæ˜¯é”™çš„" />
  <link rel="canonical" href="https://blog.ops-coffee.cn" />
  <!-- End SEO tag -->

  <!-- Umami Cloud -->
  <script async src="https://umami.ops-coffee.cn/script.js" data-website-id="a4aabd8e-32c7-40e7-a81c-119b909f2d0f"></script>

  <!-- Google Adsense -->
  <script data-ad-client="ca-pub-8944257246828217" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</head>

<body>
  <header>
    <div class="container">
      <a href="https://blog.ops-coffee.cn">
        <h1>è¿ç»´å’–å•¡å§</h1>
      </a>
      <h2>äº«å—æŠ€æœ¯å¸¦æ¥çš„ä¹è¶£ï¼Œä½“éªŒç”Ÿæ´»ç»™äºˆçš„æ„ŸåŠ¨</h2>
    </div>
  </header>

  <div id="content-wrap">
    <div class="container">
        <h1 id="art-title">è¯ä¹¦ç›‘æ§ | ä¸ºä»€ä¹ˆæˆ‘è·å–åˆ°çš„è¯ä¹¦æœ‰æ•ˆæœŸæ˜¯é”™çš„</h1>

        <p>ä»Šå¤©å’–å•¡å§çš„ä¸€ä¸ªå°ä¼™ä¼´åœ¨å®è·µ<a href="/s/AXOUz0v99OfpHrURdei9vw">ã€Pythonå®ç°HTTPSç½‘ç«™è¯ä¹¦è¿‡æœŸç›‘æ§åŠæ›´æ–°ã€</a>ååé¦ˆï¼Œé€šè¿‡æ–‡ç« å†…çš„ä»£ç è·å–åˆ°çš„è¯ä¹¦è¿‡æœŸæ—¶é—´æ˜¯é”™çš„</p>
<p><img alt="" loading="lazy" src="/static/images/20201023.01.png" /></p>
<p>çœ‹åˆ°è¿™ä¸ªæ¶ˆæ¯ï¼Œç¬¬ä¸€ååº”å°±æ˜¯ä»–çš„ç½‘ç»œæˆ–ç¯å¢ƒå¯èƒ½æœ‰é—®é¢˜å¯¼è‡´è·å–åˆ°äº†é”™è¯¯çš„è¯ä¹¦ï¼Œå› ä¸ºå…¶ä¸€æˆ‘æ‰€æœ‰æ–‡ç« é‡Œçš„ä»£ç éƒ½æ˜¯äº²è‡ªè·‘è¿‡çš„ï¼Œåº”è¯¥ä¸ä¼šæœ‰æ˜æ˜¾çš„BUGï¼Œå…¶äºŒè·å–è¯ä¹¦è¿‡æœŸæ—¶é—´æ˜¯é€šè¿‡<code>pyOpenSSL</code>æ¨¡å—æ¥å®ç°çš„ï¼Œåº•å±‚ä½¿ç”¨çš„<code>openssl</code>æˆç†Ÿä¸”ç¨³å®šã€‚ä½†æœ¬ç€å¯¹æŠ€æœ¯ä¸¥è°¨çš„æ€åº¦ï¼Œè¿˜æ˜¯è¯¢é—®å°ä¼™ä¼´æ˜¯å¦å¯ä»¥æä¾›åŸŸåæˆ‘æ¥äº²è‡ªæµ‹è¯•ä¸‹</p>
<p>å°ä¼™ä¼´å¾ˆå¿«æŠŠåŸŸåå‘äº†è¿‡æ¥ï¼ˆä¸ºäº†ä¿æŠ¤éšç§ï¼Œå°ä¼™ä¼´çš„åŸŸåæˆ‘ç»Ÿä¸€ç”¨blog.ops-coffee.cnæ¥ä»£æ›¿ï¼‰ï¼Œæˆ‘æ‰“å¼€æµè§ˆå™¨æŸ¥çœ‹åŸŸåæœ‰æ•ˆæœŸæ—¶é—´ï¼Œä»2020å¹´10æœˆ22æ—¥åˆ°2021å¹´10æœˆ22æ—¥</p>
<p><img alt="" loading="lazy" src="/static/images/20201023.02.png" /></p>
<p>é€šè¿‡å¦‚ä¸‹ä»£ç ï¼Œä¹Ÿå°±æ˜¯æ–‡ç« <a href="/s/AXOUz0v99OfpHrURdei9vw">ã€Pythonå®ç°HTTPSç½‘ç«™è¯ä¹¦è¿‡æœŸç›‘æ§åŠæ›´æ–°ã€</a>é‡Œæä¾›çš„è·å–åŸŸåè¿‡æœŸæ—¶é—´çš„ä»£ç ï¼Œæ‹¿åˆ°çš„è¿‡æœŸæ—¶é—´æ˜¯2021å¹´8æœˆ29æ—¥</p>
<pre class="codehilite"><code>from _datetime import datetime
from urllib3.contrib import pyopenssl

def get_expire(domain):
    try:
        certificate = pyopenssl.ssl.get_server_certificate((domain, 443))
        data = pyopenssl.OpenSSL.crypto.load_certificate(pyopenssl.OpenSSL.crypto.FILETYPE_PEM, certificate)

        expire_time = datetime.strptime(data.get_notAfter().decode()[0:-1], '%Y%m%d%H%M%S')
        expire_days = (expire_time - datetime.now()).days

        return True, 200, {'expire_time': str(expire_time), 'expire_days': expire_days}
    except Exception as e:
        return False, 500, str(e)

if __name__ == '__main__':
    print(get_expire('blog.ops-coffee.cn'))</code></pre>


<pre class="codehilite"><code>root@ops-coffee.cn:~# python ops-coffee.py
(True, 200, {'expire_time': '2021-08-29 12:00:00', 'expire_days': 309})</code></pre>


<p>å’¦ï¼Ÿè¿˜çœŸçš„æ˜¯æˆ‘é”™äº†ï¼ä»£ç å¾ˆç®€å•ï¼Œåº”è¯¥ä¸ä¼šæœ‰é€»è¾‘BUGï¼Œé‚£å°±å¯èƒ½æ˜¯<code>openssl</code>è·å–åˆ°çš„æ•°æ®å°±æœ‰é—®é¢˜ï¼Œäºæ˜¯ç›´æ¥é€šè¿‡<code>openssl</code>å‘½ä»¤æ¥éªŒè¯ï¼Œæœç„¶æ˜¯ï¼Œå‘½ä»¤è¿”å›ä¸ä»£ç è¿”å›è¿‡æœŸæ—¶é—´ä¸€è‡´ï¼Œéƒ½æ˜¯2021å¹´8æœˆ29æ—¥</p>
<pre class="codehilite"><code>root@ops-coffee.cn:~# echo | openssl s_client -connect &quot;blog.ops-coffee.cn&quot;:443 2&gt;/dev/null | openssl x509 -noout -dates
notBefore=Aug 28 00:00:00 2020 GMT
notAfter=Aug 29 12:00:00 2021 GMT</code></pre>


<p>çœ‹æ¥çœŸçš„æ˜¯æˆ‘é”™äº†ï¼Œå•ªå•ªæ‰“è„¸ï¼Œç©¶ç«Ÿä¼šæ˜¯å“ªé‡Œçš„é—®é¢˜ï¼Ÿè¿™æ—¶æˆ‘æƒ³åˆ°äº†SNIï¼Œé‚£ä¹ˆä»€ä¹ˆæ˜¯SNIï¼ŒSNIåˆæœ‰ä»€ä¹ˆä½œç”¨å‘¢</p>
<p>SNIï¼šServer Name Indicationï¼ŒæœåŠ¡åç§°æ ‡è¯†ï¼Œæ˜¯ä¸€é¡¹ç”¨äºæ”¹å–„SSL/TLSçš„æŠ€æœ¯ï¼Œåœ¨SSLv3/TLSv1ä¸­è¢«å¯ç”¨ã€‚å®ƒå…è®¸å®¢æˆ·ç«¯åœ¨å‘èµ·SSLæ¡æ‰‹è¯·æ±‚æ—¶æäº¤è¯·æ±‚çš„Hostä¿¡æ¯ï¼Œä½¿å¾—æœåŠ¡å™¨èƒ½å¤Ÿåˆ‡æ¢åˆ°æ­£ç¡®çš„åŸŸå¹¶è¿”å›ç›¸åº”çš„è¯ä¹¦</p>
<p>è¿™æœ‰ä»€ä¹ˆç”¨å¤„å‘¢ï¼Ÿåœ¨æ—©æœŸæ˜¯SSLv2è®¾è®¡ä¸­ï¼Œé»˜è®¤è®¤ä¸ºä¸€å°æœåŠ¡å™¨æˆ–è€…ä¸€ä¸ªIPåœ°å€åªä¼šéƒ¨ç½²ä¸€ä¸ªwebæœåŠ¡ï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨é€šä¿¡æ—¶ä¹Ÿä¸éœ€è¦å…³å¿ƒå®¢æˆ·ç«¯è¯·æ±‚çš„æ˜¯å“ªä¸ªåŸŸåçš„è¯ä¹¦ï¼ˆå› ä¸ºé»˜è®¤æœåŠ¡å™¨ä¸Šåªéƒ¨ç½²äº†ä¸€ä¸ªè¯ä¹¦ï¼‰ï¼Œéšç€è™šæ‹Ÿä¸»æœºæŠ€æœ¯çš„å‘å±•ï¼Œåœ¨ä¸€å°æœåŠ¡å™¨ä¸Šéƒ¨ç½²å¤šä¸ªwebæœåŠ¡å˜å¾—éå¸¸æ™®éï¼Œä½†SSLåè®®åˆæ²¡æœ‰è¯·æ±‚hostnameçš„è®°å½•ï¼Œè¿™å°±å¯¼è‡´äº†æœåŠ¡å™¨ä¸çŸ¥é“è¦å‘é€å“ªä¸ªè¯ä¹¦ç»™å®¢æˆ·ç«¯ï¼Œé»˜è®¤å°±è¿”å›æœåŠ¡å™¨ä¸Šé…ç½®çš„<strong>ç¬¬ä¸€ä¸ªå¯ç”¨è¯ä¹¦</strong>ç»™å®¢æˆ·ç«¯</p>
<p>ä¹Ÿå°±æ˜¯è¯´å½“å®¢æˆ·ç«¯æ²¡æœ‰å‘é€SNIä¿¡æ¯ï¼Œä¸”è¯·æ±‚çš„æœåŠ¡å™¨ä¸Šéƒ¨ç½²äº†å¤šä¸ªHTTPSæœåŠ¡æ—¶ï¼Œå¾—åˆ°çš„è¯ä¹¦ä¿¡æ¯å¯èƒ½å°±æ˜¯é”™è¯¯çš„ï¼Œä¸ºäº†éªŒè¯çŒœæƒ³ï¼Œæˆ‘åœ¨<code>openssl</code>å‘½ä»¤ä¸­æ·»åŠ äº†<code>servername</code>é€‰é¡¹ï¼Œå†æ¬¡æŸ¥çœ‹è¿”å›çš„ç»“æœï¼Œè¿‡æœŸæ—¶é—´2021å¹´10æœˆ22æ—¥</p>
<pre class="codehilite"><code>root@ops-coffee.cn:~# echo | openssl s_client -servername blog.ops-coffee.cn -connect &quot;blog.ops-coffee.cn&quot;:443 2&gt;/dev/null | openssl x509 -noout -dates
notBefore=Oct 23 00:00:00 2020 GMT
notAfter=Oct 22 23:59:59 2021 GMT</code></pre>


<p>åˆè·Ÿå°ä¼™ä¼´ç¡®è®¤äº†ä¸€ä¸‹ï¼Œç¡®è®¤äº†ä»¥ä¸Šçš„çŒœæƒ³ï¼Œç¡®å®æ˜¯SNIçš„é—®é¢˜ï¼Œç ´æ¡ˆäº†</p>
<p><img alt="" loading="lazy" src="/static/images/20201023.03.png" /></p>
<p>çŸ¥é“äº†é—®é¢˜æ‰€åœ¨ï¼Œé‚£å°±æ”¹ä¸‹ä»£ç ä¿®å¤é—®é¢˜å§ï¼Œä¿®å¤åæ›´ä¸ºå¼ºå£®çš„ä»£ç å¦‚ä¸‹</p>
<pre class="codehilite"><code>from _datetime import datetime
from urllib3.contrib import pyopenssl

def get_expire(domain):
    try:
        conn = pyopenssl.ssl.create_connection((domain, 443))
        sock = pyopenssl.ssl.SSLContext(pyopenssl.ssl.PROTOCOL_SSLv23).wrap_socket(conn, server_hostname=domain)

        certificate = pyopenssl.ssl.DER_cert_to_PEM_cert(sock.getpeercert(True))
        data = pyopenssl.OpenSSL.crypto.load_certificate(pyopenssl.OpenSSL.crypto.FILETYPE_PEM, certificate)

        expire_time = datetime.strptime(data.get_notAfter().decode()[0:-1], '%Y%m%d%H%M%S')
        expire_days = (expire_time - datetime.now()).days

        return True, 200, {'expire_time': str(expire_time), 'expire_days': expire_days}
    except Exception as e:
        return False, 500, str(e)

if __name__ == '__main__':
    print(get_expire('blog.ops-coffee.cn'))</code></pre>


<p>é‡è¦çš„æ˜¯<code>server_hostname</code>å‚æ•°ï¼Œåœ¨è¯·æ±‚æ—¶å¸¦ä¸Šhostnameæ ‡è¯†ï¼Œå°±èƒ½å¾—åˆ°æ­£ç¡®çš„ç»“æœå•¦</p>

        <div>
          <ul style="display: inline-block;padding: 0;margin: 0 0 0.5em;color: #999;">
            <li style="display: inline-block;margin: 0 1em 0 0;"><a href="/s/Aq2FiCLTsqIBX-RpARzM_w.html">ğŸ“… 2020-10-23</a></li>
            <li style="display: inline-block;margin: 0 1em 0 0;"><a href="/tag/Python/">ğŸ·ï¸ Python</a></li>
          </ul>
        </div>

        <hr>

        <div class="nav-cell clearfix">
            <script src="https://giscus.app/client.js"
                    data-repo="ops-coffee/blog"
                    data-repo-id="MDEwOlJlcG9zaXRvcnkxNDY4OTI0MTg="
                    data-category="Announcements"
                    data-category-id="DIC_kwDOCMFmgs4CQar3"
                    data-mapping="pathname"
                    data-strict="0"
                    data-reactions-enabled="1"
                    data-emit-metadata="0"
                    data-input-position="top"
                    data-theme="light"
                    data-lang="zh-CN"
                    data-loading="lazy"
                    crossorigin="anonymous"
                    async>
            </script>
        </div>

        <div>
            <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-8944257246828217"
                 data-ad-slot="6731434232"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
            <script>
                 (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
        </div>

        <div class="nav-cell clearfix">
            <p class="nav-list-title">èƒ½çœ‹åˆ°è¿™é‡Œä¸€å®šæ˜¯çœŸçˆ±ï¼Œå…³æ³¨ä¸€ä¸‹å§</p>
            <img alt="" loading="lazy" src="/static/images/wx.sou1.png" />
        </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container clearfix">
      <div class="copy"> Â© ops-coffee</div>

      <div class="link">
        <a href="/" target="_blank">å…³äºæœ¬ç«™</a>
        <a href="/" target="_blank">å›åˆ°é¦–é¡µ</a>
      </div>
    </div>
  </footer>
</body>
</html>