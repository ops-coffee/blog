<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="applicable-device" content="pc,mobile">
  <meta name="keywords" content="Django, Channels, WebSocket, Celery, æ—¥å¿—ç›‘å¬, Tailf, Python" />
  <meta name="description" content="æœ¬æ–‡ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨Django Channelsä¸Celeryå®ç°WebSocketæ—¥å¿—ç›‘å¬åŠŸèƒ½ï¼Œè¯¦ç»†è®²è§£äº†å¦‚ä½•é›†æˆChannelså’ŒCeleryæ¥å®ç°å®æ—¶æ—¥å¿—ç›‘æ§ï¼Œå¹¶æä¾›äº†å®Œæ•´çš„ä»£ç ç¤ºä¾‹ã€‚" />
  <link rel="alternate" type="application/rss+xml" title="è¿ç»´å’–å•¡å§" href="https://blog.ops-coffee.cn/feed.xml" />
  <link rel="stylesheet" href="https://blog.ops-coffee.cn/static/posts/css/ops-coffee.min.css" type="text/css" />

  <!-- Begin SEO tag -->
  <title>Djangoä½¿ç”¨Channelså®ç°WebSocket--ä¸‹ç¯‡</title>
  <meta property="og:locale" content="zh_CN" />
  <meta property="og:site_name" content="è¿ç»´å’–å•¡å§" />
  <meta property="og:url" content="https://blog.ops-coffee.cn" />
  <meta property="og:title" content="Djangoä½¿ç”¨Channelså®ç°WebSocket--ä¸‹ç¯‡" />
  <meta property="og:description" content="æœ¬æ–‡ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨Django Channelsä¸Celeryå®ç°WebSocketæ—¥å¿—ç›‘å¬åŠŸèƒ½ï¼Œè¯¦ç»†è®²è§£äº†å¦‚ä½•é›†æˆChannelså’ŒCeleryæ¥å®ç°å®æ—¶æ—¥å¿—ç›‘æ§ï¼Œå¹¶æä¾›äº†å®Œæ•´çš„ä»£ç ç¤ºä¾‹ã€‚" />
  <link rel="canonical" href="https://blog.ops-coffee.cn" />
  <!-- End SEO tag -->
</head>

<body>
  <div class="header">
    <div class="menu-button">&#9776; 
        <span class="menu-title">è¿ç»´å’–å•¡å§</span>
    </div> 

    <div class="container no-sidebar">
      <nav class="header-site">
        <ul>
          <li><a href="/">é¦–é¡µ</a></li>
            <li class="has-submenu">
              <a href="#" target="_self">è¿ç»´</a>
              <ul class="sub-menu">
                <li><a href="/tag/ç³»ç»Ÿè¿ç»´/" target="_self">ç³»ç»Ÿè¿ç»´</a></li>
                <li><a href="/elk/index.html" target="_self">ELKç³»åˆ—</a></li>
                <li><a href="/ldap/index.html" target="_self">LDAPç³»åˆ—</a></li>
              </ul>
            </li>
            <li class="has-submenu">
              <a href="#" target="_self">å¼€å‘</a>
              <ul class="sub-menu">
                <li><a href="/tag/Devops/" target="_self">DevOps</a></li>
                <li><a href="/tag/Python/" target="_self">Python</a></li>
                <li><a href="/tag/Django/" target="_self">Django</a></li>
                <li><a href="/bpmn/index.html" target="_self">BPMNç³»åˆ—</a></li>
                <li><a href="/webssh/index.html" target="_self">WebSSHç³»åˆ—</a></li>
                <li><a href="/frontend/index.html" target="_self">å‰ç«¯å¼€å‘ç³»åˆ—</a></li>
              </ul>
            </li>
            <li><a href="/devops/index.html" target="_self">è¿ç»´å¹³å°</a></li>
            <li><a href="/tag/è¿™æ˜¯ç”Ÿæ´»/" target="_self">è¿™æ˜¯ç”Ÿæ´»</a></li>
            <li class="has-submenu">
              <a href="#" target="_self">æˆ¿è½¦æ—…è¡Œ</a>
              <ul class="sub-menu">
                <li><a href="/rv.html" target="_self">æˆ¿è½¦ä½“éªŒ</a></li>
                <li><a href="/travels.html" target="_self">æ—…è¡Œæ¸¸è®°</a></li>
                <li><a href="/travel/china.html" target="_self">æ—…è¡Œåœ°å›¾</a></li>
              </ul>
            </li>
            <li><a href="/tag/index.html" target="_self">æ ‡ç­¾</a></li>
            <li><a href="/archive.html" target="_self">å½’æ¡£</a></li>
          <li class="search"><a href="/search.html" target="_self">ğŸ”</a></li>
        </ul>
      </nav>
    </div>
  </div>

  <header>
    <div class="container no-sidebar">
      <a href="/">
        <div class="name">è¿ç»´å’–å•¡å§</div>
        <div class="slogan">äº«å—æŠ€æœ¯å¸¦æ¥çš„ä¹è¶£ï¼Œä½“éªŒç”Ÿæ´»ç»™äºˆçš„æ„ŸåŠ¨</div>
      </a>
    </div>
  </header>

  <div id="content-wrap">
    <div class="container no-sidebar">
        <h1 id="art-title">Djangoä½¿ç”¨Channelså®ç°WebSocket--ä¸‹ç¯‡</h1>

        <blockquote>
<p>å¸Œæœ›é€šè¿‡å¯¹è¿™ä¸¤ç¯‡æ–‡ç« çš„å­¦ä¹ ï¼Œèƒ½å¤Ÿå¯¹Channelsæœ‰æ›´åŠ æ·±å…¥çš„äº†è§£ï¼Œä½¿ç”¨èµ·æ¥å¾—å¿ƒåº”æ‰‹æ¸¸åˆƒæœ‰ä½™</p>
</blockquote>
<p>é€šè¿‡ä¸Šä¸€ç¯‡<a href="https://blog.ops-coffee.cn/s/django-channels-websocket-devops-01.html" target="_blank">ã€ŠDjangoä½¿ç”¨Channelså®ç°WebSocket--ä¸Šç¯‡ã€‹</a>çš„å­¦ä¹ åº”è¯¥å¯¹Channelsçš„å„ç§æ¦‚å¿µæœ‰äº†æ¸…æ™°çš„è®¤çŸ¥ï¼Œå¯ä»¥é¡ºåˆ©çš„å°†Channelsæ¡†æ¶é›†æˆåˆ°è‡ªå·±çš„Djangoé¡¹ç›®ä¸­å®ç°WebSocketäº†ï¼Œæœ¬ç¯‡æ–‡ç« å°†ä»¥ä¸€ä¸ªChannels+Celeryå®ç°webç«¯tailfåŠŸèƒ½çš„ä¾‹å­æ›´åŠ æ·±å…¥çš„ä»‹ç»Channels</p>
<p>å…ˆè¯´ä¸‹æˆ‘ä»¬è¦å®ç°çš„ç›®æ ‡ï¼šæ‰€æœ‰ç™»å½•çš„ç”¨æˆ·å¯ä»¥æŸ¥çœ‹tailfæ—¥å¿—é¡µé¢ï¼Œåœ¨é¡µé¢ä¸Šèƒ½å¤Ÿé€‰æ‹©æ—¥å¿—æ–‡ä»¶è¿›è¡Œç›‘å¬ï¼Œå¤šä¸ªé¡µé¢ç»ˆç«¯åŒæ—¶ç›‘å¬ä»»ä½•æ—¥å¿—éƒ½äº’ä¸å½±å“ï¼Œé¡µé¢åŒæ—¶æä¾›ç»ˆæ­¢ç›‘å¬çš„æŒ‰é’®èƒ½å¤Ÿç»ˆæ­¢å‰ç«¯çš„è¾“å‡ºä»¥åŠåå°å¯¹æ—¥å¿—æ–‡ä»¶çš„è¯»å–</p>
<p>æœ€ç»ˆå®ç°çš„ç»“æœè§ä¸‹å›¾</p>
<p><img alt="" loading="lazy" src="/static/images/2019/0419.channels.2.gif" /></p>
<p>æ¥ç€æˆ‘ä»¬æ¥çœ‹ä¸‹å…·ä½“çš„å®ç°è¿‡ç¨‹</p>
<h1 id="_1">æŠ€æœ¯å®ç°</h1>
<p>æ‰€æœ‰ä»£ç å‡åŸºäºä»¥ä¸‹è½¯ä»¶ç‰ˆæœ¬ï¼š</p>
<ul>
<li>python==3.6.3</li>
<li>django==2.2</li>
<li>channels==2.1.7</li>
<li>celery==4.3.0</li>
</ul>
<p>celery4åœ¨windowsä¸‹æ”¯æŒä¸å®Œå–„ï¼Œæ‰€ä»¥è¯·<strong>åœ¨linuxä¸‹è¿è¡Œ</strong>æµ‹è¯•</p>
<h2 id="_2">æ—¥å¿—æ•°æ®å®šä¹‰</h2>
<p>æˆ‘ä»¬åªå¸Œæœ›ç”¨æˆ·èƒ½å¤ŸæŸ¥è¯¢å›ºå®šçš„å‡ ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œå°±ä¸æ˜¯ç”¨æ•°æ®åº“ä»…å€ŸåŠ©settings.pyæ–‡ä»¶é‡Œå†™å…¨å±€å˜é‡æ¥å®ç°æ•°æ®å­˜å‚¨</p>
<p>åœ¨settings.pyé‡Œæ·»åŠ ä¸€ä¸ªå«<code>TAILF</code>çš„å˜é‡ï¼Œç±»å‹ä¸ºå­—å…¸ï¼Œkeyæ ‡è¯†æ–‡ä»¶çš„ç¼–å·ï¼Œvalueæ ‡è¯†æ–‡ä»¶çš„è·¯å¾„</p>
<pre class="codehilite"><code>TAILF = {
    1: '/ops/coffee/error.log',
    2: '/ops/coffee/access.log',
}</code></pre>


<h2 id="web">åŸºç¡€Webé¡µé¢æ­å»º</h2>
<p>å‡è®¾ä½ å·²ç»åˆ›å»ºå¥½äº†ä¸€ä¸ªå«tailfçš„appï¼Œå¹¶æ·»åŠ åˆ°äº†settings.pyçš„INSTALLED_APPSä¸­ï¼Œappçš„ç›®å½•ç»“æ„å¤§æ¦‚å¦‚ä¸‹</p>
<pre class="codehilite"><code>tailf
    - migrations
        - __init__.py
    - __init__.py
    - admin.py
    - apps.py
    - models.py
    - tests.py
    - views.py</code></pre>


<p>ä¾ç„¶å…ˆæ„å»ºä¸€ä¸ªæ ‡å‡†çš„Djangoé¡µé¢ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹</p>
<p>url:</p>
<pre class="codehilite"><code>from django.urls import path
from django.contrib.auth.views import LoginView,LogoutView

from tailf.views import tailf

urlpatterns = [
    path('tailf', tailf, name='tailf-url'),

    path('login', LoginView.as_view(template_name='login.html'), name='login-url'),
    path('logout', LogoutView.as_view(template_name='login.html'), name='logout-url'),
]</code></pre>


<p>å› ä¸ºæˆ‘ä»¬è§„å®šåªæœ‰é€šè¿‡ç™»å½•çš„ç”¨æˆ·æ‰èƒ½æŸ¥çœ‹æ—¥å¿—ï¼Œæ‰€ä»¥å¼•å…¥Djangoè‡ªå¸¦çš„LoginViewï¼ŒlogoutViewå¸®åŠ©æˆ‘ä»¬å¿«é€Ÿæ„å»ºLoginï¼ŒLogoutåŠŸèƒ½</p>
<p>æŒ‡å®šäº†ç™»å½•æ¨¡æ¿ä½¿ç”¨<code>login.html</code>ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ç™»å½•é¡µé¢ï¼Œpostä¼ å…¥usernameå’Œpasswordä¸¤ä¸ªå‚æ•°å³å¯ï¼Œä¸è´´ä»£ç äº†</p>
<p>view:</p>
<pre class="codehilite"><code>from django.conf import settings
from django.shortcuts import render
from django.contrib.auth.decorators import login_required


# Create your views here.
@login_required(login_url='/login')
def tailf(request):
    logDict = settings.TAILF
    return render(request, 'tailf/index.html', {&quot;logDict&quot;: logDict})</code></pre>


<p>å¼•å…¥äº†<code>login_required</code>è£…é¥°å™¨ï¼Œæ¥åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•ï¼Œæœªç™»å½•å°±ç»™è·³åˆ°<code>/login</code>ç™»å½•é¡µé¢</p>
<p><strong>logDict</strong> å»settingé‡Œå–æˆ‘ä»¬å®šä¹‰å¥½çš„<code>TAILF</code>å­—å…¸èµ‹å€¼ï¼Œå¹¶ä¼ é€’ç»™å‰ç«¯</p>
<p>template:</p>
<pre class="codehilite"><code>{% extends &quot;base.html&quot; %}

{% block content %}
&lt;div class=&quot;col-sm-8&quot;&gt;
  &lt;select class=&quot;form-control&quot; id=&quot;file&quot;&gt;
    &lt;option value=&quot;&quot;&gt;é€‰æ‹©è¦ç›‘å¬çš„æ—¥å¿—&lt;/option&gt;
    {% for k,v in logDict.items %}
    &lt;option value=&quot;{{ k }}&quot;&gt;{{ v }}&lt;/option&gt;
    {% endfor %}
  &lt;/select&gt;
&lt;/div&gt;
&lt;div class=&quot;col-sm-2&quot;&gt;
  &lt;input class=&quot;btn btn-success btn-block&quot; type=&quot;button&quot; onclick=&quot;connect()&quot; value=&quot;å¼€å§‹ç›‘å¬&quot;/&gt;&lt;br/&gt;
&lt;/div&gt;
&lt;div class=&quot;col-sm-2&quot;&gt;
  &lt;input class=&quot;btn btn-warning btn-block&quot; type=&quot;button&quot; onclick=&quot;goclose()&quot; value=&quot;ç»ˆæ­¢ç›‘å¬&quot;/&gt;&lt;br/&gt;
&lt;/div&gt;
&lt;div class=&quot;col-sm-12&quot;&gt;
  &lt;textarea class=&quot;form-control&quot; id=&quot;chat-log&quot; disabled rows=&quot;20&quot;&gt;&lt;/textarea&gt;
&lt;/div&gt;
{% endblock %}</code></pre>


<p>å‰ç«¯æ‹¿åˆ°<code>TAILF</code>åé€šè¿‡å¾ªç¯çš„æ–¹å¼å¡«å……åˆ°selecté€‰æ‹©æ¡†ä¸‹ï¼Œå› ä¸ºæ•°æ®æ˜¯å­—å…¸æ ¼å¼ï¼Œä½¿ç”¨<code>logDict.items</code>çš„æ–¹å¼å¯ä»¥å¾ªç¯å‡ºå­—å…¸çš„keyå’Œvalue</p>
<p>è¿™æ ·ä¸€ä¸ªæ—¥å¿—ç›‘å¬é¡µé¢å°±å®Œæˆäº†ï¼Œä½†è¿˜æ— æ³•å®ç°æ—¥å¿—çš„ç›‘å¬ï¼Œç»§ç»­å¾€ä¸‹</p>
<h2 id="channelswebsocket">é›†æˆChannelså®ç°WebSocket</h2>
<p>æ—¥å¿—ç›‘å¬åŠŸèƒ½ä¸»è¦çš„è®¾è®¡æ€è·¯å°±æ˜¯é¡µé¢è·Ÿåç«¯æœåŠ¡å™¨å»ºç«‹websocketé•¿è¿æ¥ï¼Œåç«¯é€šè¿‡celeryå¼‚æ­¥æ‰§è¡Œwhileå¾ªç¯ä¸æ–­çš„è¯»å–æ—¥å¿—æ–‡ä»¶ç„¶åå‘é€åˆ°websocketçš„channelé‡Œï¼Œå®ç°é¡µé¢ä¸Šçš„å®æ—¶æ˜¾ç¤º</p>
<p>æ¥ç€æˆ‘ä»¬æ¥é›†æˆchannels</p>
<ol>
<li>å…ˆæ·»åŠ routingè·¯ç”±ï¼Œç›´æ¥ä¿®æ”¹<code>webapp/routing.py</code></li>
</ol>
<pre class="codehilite"><code>from channels.auth import AuthMiddlewareStack
from channels.routing import ProtocolTypeRouter, URLRouter

from django.urls import path, re_path
from chat.consumers import ChatConsumer
from tailf.consumers import TailfConsumer

application = ProtocolTypeRouter({
    'websocket': AuthMiddlewareStack(
        URLRouter([
            path('ws/chat/', ChatConsumer),
            re_path(r'^ws/tailf/(?P&lt;id&gt;\d+)/$', TailfConsumer),
        ])
    )
})</code></pre>


<p>ç›´æ¥å°†è·¯ç”±ä¿¡æ¯å†™å…¥åˆ°äº†<code>URLRouter</code>é‡Œï¼Œæ³¨æ„è·¯ç”±ä¿¡æ¯çš„å¤–å±‚å¤šäº†ä¸€ä¸ªlistï¼ŒåŒºåˆ«äºä¸Šä¸€ç¯‡ä¸­ä»‹ç»çš„å†™è·¯ç”±æ–‡ä»¶è·¯å¾„çš„æ–¹å¼</p>
<p>é¡µé¢éœ€è¦å°†ç›‘å¬çš„æ—¥å¿—æ–‡ä»¶ä¼ é€’ç»™åç«¯ï¼Œæˆ‘ä»¬ä½¿ç”¨routingæ­£åˆ™<code>P&lt;id&gt;\d+</code>ä¼ æ–‡ä»¶IDç»™åç«¯ç¨‹åºï¼Œåç«¯ç¨‹åºæ‹¿åˆ°IDä¹‹åæ ¹æ®settingsä¸­æŒ‡å®šçš„<code>TAILF</code>è§£æå‡ºæ—¥å¿—è·¯å¾„</p>
<p>routingçš„å†™æ³•è·ŸDjangoä¸­çš„urlå†™æ³•å®Œå…¨ä¸€è‡´ï¼Œä½¿ç”¨<code>re_path</code>åŒ¹é…æ­£åˆ™routingè·¯ç”±</p>
<ol>
<li>æ·»åŠ consumeråœ¨<code>tailf/consumers.py</code>æ–‡ä»¶ä¸­</li>
</ol>
<pre class="codehilite"><code>import json
from channels.generic.websocket import WebsocketConsumer
from tailf.tasks import tailf


class TailfConsumer(WebsocketConsumer):
    def connect(self):
        self.file_id = self.scope[&quot;url_route&quot;][&quot;kwargs&quot;][&quot;id&quot;]

        self.result = tailf.delay(self.file_id, self.channel_name)

        print('connect:', self.channel_name, self.result.id)
        self.accept()

    def disconnect(self, close_code):
        # ä¸­æ­¢æ‰§è¡Œä¸­çš„Task
        self.result.revoke(terminate=True)
        print('disconnect:', self.file_id, self.channel_name)

    def send_message(self, event):
        self.send(text_data=json.dumps({
            &quot;message&quot;: event[&quot;message&quot;]
        }))</code></pre>


<p>è¿™é‡Œä½¿ç”¨Channelsçš„å•é€šé“æ¨¡å¼ï¼Œæ¯ä¸€ä¸ªæ–°è¿æ¥éƒ½ä¼šå¯ç”¨ä¸€ä¸ªæ–°çš„channelï¼Œå½¼æ­¤äº’ä¸å½±å“ï¼Œå¯ä»¥éšæ„ç»ˆæ­¢ä»»ä½•ä¸€ä¸ªç›‘å¬æ—¥å¿—çš„è¯·æ±‚</p>
<p><strong>connect</strong> </p>
<p>æˆ‘ä»¬çŸ¥é“<code>self.scope</code>ç±»ä¼¼äºDjangoä¸­çš„requestï¼Œè®°å½•äº†ä¸°å¯Œçš„è¯·æ±‚ä¿¡æ¯ï¼Œé€šè¿‡<code>self.scope["url_route"]["kwargs"]["id"]</code>å–å‡ºroutingä¸­æ­£åˆ™åŒ¹é…çš„æ—¥å¿—ID</p>
<p>ç„¶åå°†<code>id</code>å’Œ<code>channel_name</code>ä¼ é€’ç»™celeryçš„ä»»åŠ¡å‡½æ•°tailfï¼Œtailfæ ¹æ®<code>id</code>å–åˆ°æ—¥å¿—æ–‡ä»¶çš„è·¯å¾„ï¼Œç„¶åå¾ªç¯æ–‡ä»¶ï¼Œå°†æ–°å†…å®¹æ ¹æ®<code>channel_name</code>å†™å…¥å¯¹åº”channel</p>
<p><strong>disconnect</strong> </p>
<p>å½“websocketè¿æ¥æ–­å¼€çš„æ—¶å€™æˆ‘ä»¬éœ€è¦ç»ˆæ­¢Celeryçš„Taskæ‰§è¡Œï¼Œä»¥æ¸…é™¤celeryçš„èµ„æºå ç”¨</p>
<p>ç»ˆæ­¢Celeryä»»åŠ¡ä½¿ç”¨åˆ°<code>revoke</code>æŒ‡ä»¤ï¼Œé‡‡ç”¨å¦‚ä¸‹ä»£ç æ¥å®ç°</p>
<pre class="codehilite"><code>self.result.revoke(terminate=True)</code></pre>


<p>æ³¨æ„<code>self.result</code>æ˜¯ä¸€ä¸ªresultå¯¹è±¡ï¼Œè€Œéid</p>
<p>å‚æ•°<code>terminate=True</code>çš„æ„æ€æ˜¯æ˜¯å¦ç«‹å³ç»ˆæ­¢Taskï¼Œä¸ºTrueæ—¶æ— è®ºTaskæ˜¯å¦æ­£åœ¨æ‰§è¡Œéƒ½ç«‹å³ç»ˆæ­¢ï¼Œä¸ºFalseï¼ˆé»˜è®¤ï¼‰æ—¶éœ€è¦ç­‰å¾…Taskè¿è¡Œç»“æŸä¹‹åæ‰ä¼šç»ˆæ­¢ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†Whileå¾ªç¯ä¸è®¾ç½®ä¸ºTrueå°±æ°¸è¿œä¸ä¼šç»ˆæ­¢äº†</p>
<p>ç»ˆæ­¢Celeryä»»åŠ¡çš„å¦å¤–ä¸€ç§æ–¹æ³•æ˜¯ï¼š</p>
<pre class="codehilite"><code>from webapp.celery import app
app.control.revoke(result.id, terminate=True)</code></pre>


<p><strong>send_message</strong> </p>
<p>æ–¹ä¾¿æˆ‘ä»¬é€šè¿‡Djangoçš„viewæˆ–è€…Celeryçš„taskè°ƒç”¨ç»™channelå‘é€æ¶ˆæ¯ï¼Œå®˜æ–¹ä¹Ÿæ¯”è¾ƒæ¨èè¿™ç§æ–¹å¼</p>
<h2 id="celery">ä½¿ç”¨Celeryå¼‚æ­¥å¾ªç¯è¯»å–æ—¥å¿—</h2>
<p>ä¸Šè¾¹å·²ç»é›†æˆäº†Channelså®ç°äº†WebSocketï¼Œä½†connectå‡½æ•°ä¸­çš„celeryä»»åŠ¡<code>tailf</code>è¿˜æ²¡æœ‰å®ç°ï¼Œä¸‹è¾¹æ¥å®ç°å®ƒ</p>
<p>å…³äºCeleryçš„è¯¦ç»†å†…å®¹å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« ï¼š<a href="/s/lXrp3igYo9W2UuE5Gauysg" target="_blank">ã€ŠDjangoé…ç½®Celeryæ‰§è¡Œå¼‚æ­¥ä»»åŠ¡å’Œå®šæ—¶ä»»åŠ¡ã€‹</a>ï¼Œæœ¬æ–‡å°±ä¸ä»‹ç»é›†æˆä½¿ç”¨ä»¥åŠç»†èŠ‚åŸç†ï¼Œåªè®²ä¸€ä¸‹ä»»åŠ¡task</p>
<p>taskå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<pre class="codehilite"><code>from __future__ import absolute_import
from celery import shared_task

import time
from channels.layers import get_channel_layer
from asgiref.sync import async_to_sync
from django.conf import settings


@shared_task
def tailf(id, channel_name):
    channel_layer = get_channel_layer()
    filename = settings.TAILF[int(id)]

    try:
        with open(filename) as f:
            f.seek(0, 2)

            while True:
                line = f.readline()

                if line:
                    print(channel_name, line)
                    async_to_sync(channel_layer.send)(
                        channel_name,
                        {
                            &quot;type&quot;: &quot;send.message&quot;,
                            &quot;message&quot;: &quot;å¾®ä¿¡å…¬ä¼—å·ã€è¿ç»´å’–å•¡å§ã€‘åŸåˆ› ç‰ˆæƒæ‰€æœ‰ &quot; + str(line)
                        }
                    )
                else:
                    time.sleep(0.5)
    except Exception as e:
        print(e)</code></pre>


<p>è¿™é‡Œè¾¹ä¸»è¦æ¶‰åŠåˆ°Channelsä¸­å¦ä¸€ä¸ªéå¸¸é‡è¦çš„ç‚¹ï¼š<strong>ä»Channelsçš„å¤–éƒ¨å‘é€æ¶ˆæ¯ç»™Channel</strong></p>
<p>å…¶å®<a href="https://blog.ops-coffee.cn/s/django-channels-websocket-devops-01.html" target="_blank">ä¸Šç¯‡æ–‡ç« </a>ä¸­æ£€æŸ¥é€šé“å±‚æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸å·¥ä½œçš„æ—¶å€™ä½¿ç”¨çš„æ–¹æ³•å°±æ˜¯ä»å¤–éƒ¨ç»™Channelé€šé“å‘æ¶ˆæ¯çš„ç¤ºä¾‹ï¼Œæœ¬æ–‡çš„å…·ä½“ä»£ç å¦‚ä¸‹</p>
<pre class="codehilite"><code>async_to_sync(channel_layer.send)(
    channel_name,
    {
        &quot;type&quot;: &quot;send.message&quot;,
        &quot;message&quot;: &quot;å¾®ä¿¡å…¬ä¼—å·ã€è¿ç»´å’–å•¡å§ã€‘åŸåˆ› ç‰ˆæƒæ‰€æœ‰ &quot; + str(line)
    }
)</code></pre>


<p><strong>channel_name</strong> å¯¹åº”äºä¼ é€’ç»™è¿™ä¸ªä»»åŠ¡çš„channel_nameï¼Œå‘é€æ¶ˆæ¯ç»™è¿™ä¸ªåå­—çš„channel</p>
<p><strong>type</strong> å¯¹åº”äºæˆ‘ä»¬Channelsçš„TailfConsumerç±»ä¸­çš„<code>send_message</code>æ–¹æ³•ï¼Œå°†æ–¹æ³•ä¸­çš„<code>_</code>æ¢æˆ<code>.</code>å³å¯</p>
<p><strong>message</strong> å°±æ˜¯è¦å‘é€ç»™è¿™ä¸ªchannelçš„å…·ä½“ä¿¡æ¯</p>
<p>ä¸Šè¾¹æ˜¯å‘é€ç»™å•Channelçš„æƒ…å†µï¼Œå¦‚æœæ˜¯éœ€è¦å‘é€åˆ°Groupçš„è¯éœ€è¦ä½¿ç”¨å¦‚ä¸‹ä»£ç </p>
<pre class="codehilite"><code>async_to_sync(channel_layer.group_send)(
    group_name,
    {
        'type': 'chat.message',
        'message': 'æ¬¢è¿å…³æ³¨å…¬ä¼—å·ã€è¿ç»´å’–å•¡å§ã€‘'
    }
)</code></pre>


<p>åªéœ€è¦å°†å‘é€å•channelçš„<code>send</code>æ”¹ä¸º<code>group_send</code>ï¼Œ<code>channel_name</code>æ”¹ä¸º<code>group_name</code>å³å¯</p>
<p>éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼š<strong>ä½¿ç”¨äº†channel layerä¹‹åä¸€å®šè¦é€šè¿‡async_to_syncæ¥å¼‚æ­¥æ‰§è¡Œ</strong></p>
<h2 id="websocket">é¡µé¢æ·»åŠ WebSocketæ”¯æŒ</h2>
<p>åç«¯åŠŸèƒ½éƒ½å·²ç»å®Œæˆï¼Œæˆ‘ä»¬æœ€åéœ€è¦æ·»åŠ å‰ç«¯é¡µé¢æ”¯æŒWebSocket</p>
<pre class="codehilite"><code>  function connect() {
    if ( $('#file').val() ) {
      window.chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/tailf/' + $('#file').val() + '/');

      chatSocket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        var message = data['message'];
        document.querySelector('#chat-log').value += (message);
        // è·³è½¬åˆ°é¡µé¢åº•éƒ¨
        $('#chat-log').scrollTop($('#chat-log')[0].scrollHeight);
      };

      chatSocket.onerror = function(e) {
        toastr.error('æœåŠ¡ç«¯è¿æ¥å¼‚å¸¸ï¼')
      };

      chatSocket.onclose = function(e) {
        toastr.error('websocketå·²å…³é—­ï¼')
      };
    } else {
      toastr.warning('è¯·é€‰æ‹©è¦ç›‘å¬çš„æ—¥å¿—æ–‡ä»¶')
    }
  }</code></pre>


<p><a href="https://blog.ops-coffee.cn/s/django-channels-websocket-devops-01.html" target="_blank">ä¸Šä¸€ç¯‡æ–‡ç« </a>ä¸­æœ‰è¯¦ç»†ä»‹ç»è¿‡websocketçš„æ¶ˆæ¯ç±»å‹ï¼Œè¿™é‡Œä¸å¤šä»‹ç»äº†</p>
<p>è‡³æ­¤æˆ‘ä»¬ä¸€ä¸ªæ—¥å¿—ç›‘å¬é¡µé¢å®Œæˆäº†ï¼ŒåŒ…å«äº†å®Œæ•´çš„ç›‘å¬åŠŸèƒ½ï¼Œä½†è¿˜æ— æ³•ç»ˆæ­¢ï¼Œæ¥ç€çœ‹ä¸‹é¢çš„å†…å®¹</p>
<h2 id="webwebsocket">Webé¡µé¢ä¸»åŠ¨æ–­å¼€WebSocket</h2>
<p>webé¡µé¢ä¸Šâ€œç»ˆæ­¢ç›‘å¬â€æŒ‰é’®çš„ä¸»è¦é€»è¾‘å°±æ˜¯è§¦å‘WebSocketçš„oncloseæ–¹æ³•ï¼Œä»è€Œå¯ä»¥è§¦å‘Channelsåç«¯consumerçš„<code>disconnect</code>æ–¹æ³•ï¼Œè¿›è€Œç»ˆæ­¢Celeryçš„å¾ªç¯è¯»å–æ—¥å¿—ä»»åŠ¡</p>
<p>å‰ç«¯é¡µé¢é€šè¿‡<code>.close()</code>å¯ä»¥ç›´æ¥è§¦å‘WebSocketå…³é—­ï¼Œå½“ç„¶ä½ å¦‚æœç›´æ¥å…³æ‰é¡µé¢çš„è¯ä¹Ÿä¼šè§¦å‘WebSocketçš„oncloseæ¶ˆæ¯ï¼Œæ‰€ä»¥ä¸ç”¨æ‹…å¿ƒCeleryä»»åŠ¡æ— æ³•ç»“æŸçš„é—®é¢˜</p>
<pre class="codehilite"><code>  function goclose() {
    console.log(window.chatSocket);

    window.chatSocket.close();
    window.chatSocket.onclose = function(e) {
      toastr.success('å·²ç»ˆæ­¢æ—¥å¿—ç›‘å¬ï¼')
    };
  }</code></pre>


<p>è‡³æ­¤æˆ‘ä»¬åŒ…å«å®Œå–„åŠŸèƒ½çš„Tailfæ—¥å¿—ç›‘å¬ã€ç»ˆæ­¢é¡µé¢å°±å…¨éƒ¨å®Œæˆäº†</p>
<h1 id="_3">å†™åœ¨æœ€å</h1>
<p>ä¸¤ç¯‡æ–‡ç« ç»“æŸä¸çŸ¥é“ä½ æ˜¯å¦å¯¹Channelsæœ‰äº†æ›´æ·±ä¸€æ­¥çš„äº†è§£ï¼Œèƒ½å¤Ÿæ“åˆ€ä¸Šæ‰‹å°†Channelsç”¨åœ¨è‡ªå·±çš„é¡¹ç›®ä¸­ï¼Œå®ç°ç†æƒ³çš„åŠŸèƒ½ã€‚ä¸ªäººè§‰å¾—Channelsçš„é‡ç‚¹å’Œéš¾ç‚¹åœ¨äºå¯¹<strong>channel layer</strong>çš„ç†è§£å’Œè¿ç”¨ï¼ŒçœŸæ­£çš„ç†è§£äº†å¹¶èƒ½ç†Ÿç»ƒè¿ç”¨ï¼Œç›¸ä¿¡ä½ ä¸€å®šèƒ½å¤Ÿä¸¾ä¸€åä¸‰å®Œç¾å®ç°æ›´å¤šéœ€æ±‚ã€‚æœ€åå¦‚æœå¯¹æœ¬æ–‡çš„demoæºç æ„Ÿå…´è¶£å¯ä»¥å…³æ³¨å¾®ä¿¡å…¬ä¼—å·ã€è¿ç»´å’–å•¡å§ã€‘åå°å›å¤å°äºŒåŠ æˆ‘å¾®ä¿¡å‘æˆ‘ç´¢å–</p>

        <div>
          <ul style="display: inline-block;padding: 0;margin: 0 0 0.5em;color: #999;">
            <li style="display: inline-block;margin: 0 1em 0 0;"><a href="/s/django-channels-websocket-devops-02.html">ğŸ“… 2019-04-19</a></li>
<li style="display: inline-block;margin: 0 1em 0 0;"><a href="/tag/Django/">ğŸ·ï¸ Django</a></li><li style="display: inline-block;margin: 0 1em 0 0;"><a href="/tag/å…³äºæŠ€æœ¯/">ğŸ·ï¸ å…³äºæŠ€æœ¯</a></li>          </ul>
        </div>

        <hr>

        <div class="nav-cell">
    <script async src="https://giscus.app/client.js"
            data-repo="ops-coffee/blog" data-repo-id="MDEwOlJlcG9zaXRvcnkxNDY4OTI0MTg="
            data-category="Announcements" data-category-id="DIC_kwDOCMFmgs4CQar3"
            data-mapping="pathname" data-strict="0" data-reactions-enabled="1"
            data-emit-metadata="0" data-input-position="top" data-theme="light"
            data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous">
    </script>
</div>

        <div>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8944257246828217"
         data-ad-slot="6731434232" data-ad-format="auto" data-full-width-responsive="true"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
</div>

        <div class="nav-cell">
            <p class="nav-list-title">èƒ½çœ‹åˆ°è¿™é‡Œä¸€å®šæ˜¯çœŸçˆ±ï¼Œè®¢é˜…ä¸€ä¸‹å§</p>
            <img alt="" loading="lazy" src="/static/images/wx.sou1.png" />
        </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="copy"> Â© ops-coffee</div>

      <div class="link">
        <a href="/comments.html" title="ç»™æˆ‘ç•™è¨€" target="_blank">ç•™è¨€</a>
        <a href="/friends.html" title="å‹æƒ…é“¾æ¥" target="_blank">å‹é“¾</a>
      </div>
    </div>
  </footer>
  
  <!-- Umami Cloud -->
<script async src="https://umami.ops-coffee.cn/script.js" data-website-id="a4aabd8e-32c7-40e7-a81c-119b909f2d0f"></script>

<!-- Google Adsense -->
<script data-ad-client="ca-pub-8944257246828217" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</body>

</html>