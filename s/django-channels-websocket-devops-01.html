<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="applicable-device" content="pc,mobile">
  <meta name="keywords" content="WebSocket, Django Channels, å®æ—¶é€šä¿¡, å…¨åŒå·¥é€šä¿¡, èŠå¤©å®¤, å¼‚æ­¥, ASGI, Channels Layer, Redis" />
  <meta name="description" content="æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨WebSocketå’ŒDjango Channelsæ„å»ºå®æ—¶åº”ç”¨ï¼Œç‰¹åˆ«æ˜¯èŠå¤©å®¤åŠŸèƒ½ã€‚é€šè¿‡é›†æˆChannelsæ¡†æ¶ï¼ŒDjangoä¸ä»…æ”¯æŒHTTPåè®®ï¼Œè¿˜èƒ½æ”¯æŒWebSocketç­‰å¤šç§åè®®ã€‚æ–‡ç« è¿˜è®²è§£äº†å¦‚ä½•ä½¿ç”¨Channels Layerå®ç°å¤šäººèŠå¤©ï¼Œå¹¶æä¾›äº†å¼‚æ­¥ä»£ç å®ç°ä»¥æå‡æ€§èƒ½ã€‚" />
  <link rel="alternate" type="application/rss+xml" title="è¿ç»´å’–å•¡å§" href="https://blog.ops-coffee.com/feed.xml" />
  <link rel="stylesheet" href="https://blog.ops-coffee.com/static/posts/css/ops-coffee.min.css" type="text/css" />

  <!-- Begin SEO tag -->
  <title>Djangoä½¿ç”¨Channelså®ç°WebSocket--ä¸Šç¯‡</title>
  <meta property="og:locale" content="zh_CN" />
  <meta property="og:site_name" content="è¿ç»´å’–å•¡å§" />
  <meta property="og:url" content="https://blog.ops-coffee.coms/django-channels-websocket-devops-01.html" />
  <meta property="og:title" content="Djangoä½¿ç”¨Channelså®ç°WebSocket--ä¸Šç¯‡" />
  <meta property="og:description" content="æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨WebSocketå’ŒDjango Channelsæ„å»ºå®æ—¶åº”ç”¨ï¼Œç‰¹åˆ«æ˜¯èŠå¤©å®¤åŠŸèƒ½ã€‚é€šè¿‡é›†æˆChannelsæ¡†æ¶ï¼ŒDjangoä¸ä»…æ”¯æŒHTTPåè®®ï¼Œè¿˜èƒ½æ”¯æŒWebSocketç­‰å¤šç§åè®®ã€‚æ–‡ç« è¿˜è®²è§£äº†å¦‚ä½•ä½¿ç”¨Channels Layerå®ç°å¤šäººèŠå¤©ï¼Œå¹¶æä¾›äº†å¼‚æ­¥ä»£ç å®ç°ä»¥æå‡æ€§èƒ½ã€‚" />
  <link rel="canonical" href="https://blog.ops-coffee.coms/django-channels-websocket-devops-01.html" />

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "Djangoä½¿ç”¨Channelså®ç°WebSocket--ä¸Šç¯‡",
    "description": "æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨WebSocketå’ŒDjango Channelsæ„å»ºå®æ—¶åº”ç”¨ï¼Œç‰¹åˆ«æ˜¯èŠå¤©å®¤åŠŸèƒ½ã€‚é€šè¿‡é›†æˆChannelsæ¡†æ¶ï¼ŒDjangoä¸ä»…æ”¯æŒHTTPåè®®ï¼Œè¿˜èƒ½æ”¯æŒWebSocketç­‰å¤šç§åè®®ã€‚æ–‡ç« è¿˜è®²è§£äº†å¦‚ä½•ä½¿ç”¨Channels Layerå®ç°å¤šäººèŠå¤©ï¼Œå¹¶æä¾›äº†å¼‚æ­¥ä»£ç å®ç°ä»¥æå‡æ€§èƒ½ã€‚",
    "url": "https://blog.ops-coffee.coms/django-channels-websocket-devops-01.html",
    "author": {
      "@type": "Person",
      "name": "è¿ç»´å’–å•¡å§"
    },
    "publisher": {
      "@type": "Organization",
      "name": "è¿ç»´å’–å•¡å§",
      "logo": {
        "@type": "ImageObject",
        "url": "https://blog.ops-coffee.com/favicon.ico"
      }
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https://blog.ops-coffee.coms/django-channels-websocket-devops-01.html"
    }
  }
  </script>
  <!-- End SEO tag -->
</head>

<body>
  <div class="header">
    <div class="menu-button">&#9776; 
        <span class="menu-title">è¿ç»´å’–å•¡å§</span>
    </div> 

    <div class="container">
      <nav class="header-site">
        <ul>
          <li><a href="/">é¦–é¡µ</a></li>
            <li class="has-submenu">
              <a href="#" target="_self">è¿ç»´</a>
              <ul class="sub-menu">
                <li><a href="/tag/ç³»ç»Ÿè¿ç»´/" target="_self">ç³»ç»Ÿè¿ç»´</a></li>
                <li><a href="/elk/index.html" target="_self">ELKç³»åˆ—</a></li>
                <li><a href="/ldap/index.html" target="_self">LDAPç³»åˆ—</a></li>
              </ul>
            </li>
            <li class="has-submenu">
              <a href="#" target="_self">å¼€å‘</a>
              <ul class="sub-menu">
                <li><a href="/tag/Devops/" target="_self">DevOps</a></li>
                <li><a href="/tag/Python/" target="_self">Python</a></li>
                <li><a href="/tag/Django/" target="_self">Django</a></li>
                <li><a href="/bpmn/index.html" target="_self">BPMNç³»åˆ—</a></li>
                <li><a href="/webssh/index.html" target="_self">WebSSHç³»åˆ—</a></li>
                <li><a href="/frontend/index.html" target="_self">å‰ç«¯å¼€å‘ç³»åˆ—</a></li>
              </ul>
            </li>
            <li><a href="/devops/index.html" target="_self">è¿ç»´å¹³å°</a></li>
            <li class="has-submenu">
              <a href="#" target="_self">è¿™æ˜¯ç”Ÿæ´»</a>
              <ul class="sub-menu">
                <li><a href="/life/chronicles.html" target="_self">æ—¶å…‰å°è®°</a></li>
                <li><a href="/life/money.html" target="_self">å‰¯ä¸šèµšé’±</a></li>
                <li><a href="/life/writing.html" target="_self">å†™ä½œç›¸å…³</a></li>
                <li><a href="/tag/è¿™æ˜¯ç”Ÿæ´»/" target="_self">ç”Ÿæ´»éšç¬”</a></li>
              </ul>
            </li>
            <li class="has-submenu">
              <a href="#" target="_self">æˆ¿è½¦æ—…è¡Œ</a>
              <ul class="sub-menu">
                <li><a href="/rv.html" target="_self">æˆ¿è½¦ä½“éªŒ</a></li>
                <li><a href="/travels.html" target="_self">æ—…è¡Œæ¸¸è®°</a></li>
                <li><a href="/travel/china.html" target="_self">æ—…è¡Œåœ°å›¾</a></li>
              </ul>
            </li>
            <li><a href="/tag/index.html" target="_self">æ ‡ç­¾</a></li>
            <li><a href="/archive.html" target="_self">å½’æ¡£</a></li>
          <li class="search"><a href="/search.html" target="_self" aria-label="æœç´¢">ğŸ”</a></li>
        </ul>
      </nav>
    </div>
  </div>

  <header>
    <div class="container">
      <a href="/">
        <div class="name">è¿ç»´å’–å•¡å§</div>
        <div class="slogan">äº«å—æŠ€æœ¯å¸¦æ¥çš„ä¹è¶£ï¼Œä½“éªŒç”Ÿæ´»ç»™äºˆçš„æ„ŸåŠ¨</div>
      </a>
    </div>
  </header>

  <div id="content-wrap">
    <div class="container">
        <h1 id="art-title">Djangoä½¿ç”¨Channelså®ç°WebSocket--ä¸Šç¯‡</h1>

        <blockquote>
<p>WebSocket - å¼€å¯é€šå¾€æ–°ä¸–ç•Œçš„å¤§é—¨</p>
</blockquote>
<p><strong>WebSocketæ˜¯ä»€ä¹ˆï¼Ÿ</strong></p>
<p>WebSocketæ˜¯ä¸€ç§åœ¨å•ä¸ªTCPè¿æ¥ä¸Šè¿›è¡Œå…¨åŒå·¥é€šè®¯çš„åè®®ã€‚WebSocketå…è®¸æœåŠ¡ç«¯ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€æ•°æ®ã€‚åœ¨WebSocketåè®®ä¸­ï¼Œå®¢æˆ·ç«¯æµè§ˆå™¨å’ŒæœåŠ¡å™¨åªéœ€è¦å®Œæˆä¸€æ¬¡æ¡æ‰‹å°±å¯ä»¥åˆ›å»ºæŒä¹…æ€§çš„è¿æ¥ï¼Œå¹¶åœ¨æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´è¿›è¡ŒåŒå‘çš„æ•°æ®ä¼ è¾“ã€‚</p>
<p><strong>WebSocketæœ‰ä»€ä¹ˆç”¨ï¼Ÿ</strong></p>
<p>WebSocketåŒºåˆ«äºHTTPåè®®çš„ä¸€ä¸ªæœ€ä¸ºæ˜¾è‘—çš„ç‰¹ç‚¹æ˜¯ï¼ŒWebSocketåè®®å¯ä»¥ç”±æœåŠ¡ç«¯ä¸»åŠ¨å‘èµ·æ¶ˆæ¯ï¼Œå¯¹äºæµè§ˆå™¨éœ€è¦åŠæ—¶æ¥æ”¶æ•°æ®å˜åŒ–çš„åœºæ™¯éå¸¸é€‚åˆï¼Œä¾‹å¦‚åœ¨Djangoä¸­é‡åˆ°ä¸€äº›è€—æ—¶è¾ƒé•¿çš„ä»»åŠ¡æˆ‘ä»¬é€šå¸¸ä¼šä½¿ç”¨Celeryæ¥å¼‚æ­¥æ‰§è¡Œï¼Œé‚£ä¹ˆæµè§ˆå™¨å¦‚æœæƒ³è¦è·å–è¿™ä¸ªä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€ï¼Œåœ¨HTTPåè®®ä¸­åªèƒ½é€šè¿‡è½®è®­çš„æ–¹å¼ç”±æµè§ˆå™¨ä¸æ–­çš„å‘é€è¯·æ±‚ç»™æœåŠ¡å™¨æ¥è·å–æœ€æ–°çŠ¶æ€ï¼Œè¿™æ ·å‘é€å¾ˆå¤šæ— ç”¨çš„è¯·æ±‚ä¸ä»…æµªè´¹èµ„æºï¼Œè¿˜ä¸å¤Ÿä¼˜é›…ï¼Œå¦‚æœä½¿ç”¨WebSokcetæ¥å®ç°å°±å¾ˆå®Œç¾äº†</p>
<p>WebSocketçš„å¦å¤–ä¸€ä¸ªåº”ç”¨åœºæ™¯å°±æ˜¯ä¸‹æ–‡è¦è¯´çš„èŠå¤©å®¤ï¼Œä¸€ä¸ªç”¨æˆ·ï¼ˆæµè§ˆå™¨ï¼‰å‘é€çš„æ¶ˆæ¯éœ€è¦å®æ—¶çš„è®©å…¶ä»–ç”¨æˆ·ï¼ˆæµè§ˆå™¨ï¼‰æ¥æ”¶ï¼Œè¿™åœ¨HTTPåè®®ä¸‹æ˜¯å¾ˆéš¾å®ç°çš„ï¼Œä½†WebSocketåŸºäºé•¿è¿æ¥åŠ ä¸Šå¯ä»¥ä¸»åŠ¨ç»™æµè§ˆå™¨å‘æ¶ˆæ¯çš„ç‰¹æ€§å¤„ç†èµ·æ¥å°±æ¸¸åˆƒæœ‰ä½™äº†</p>
<p>åˆæ­¥äº†è§£WebSocketä¹‹åï¼Œæˆ‘ä»¬çœ‹çœ‹å¦‚ä½•åœ¨Djangoä¸­å®ç°WebSocket</p>
<h1 id="channels">Channels</h1>
<p>Djangoæœ¬èº«ä¸æ”¯æŒWebSocketï¼Œä½†å¯ä»¥é€šè¿‡é›†æˆChannelsæ¡†æ¶æ¥å®ç°WebSocket</p>
<p>Channelsæ˜¯é’ˆå¯¹Djangoé¡¹ç›®çš„ä¸€ä¸ªå¢å¼ºæ¡†æ¶ï¼Œå¯ä»¥ä½¿Djangoä¸ä»…æ”¯æŒHTTPåè®®ï¼Œè¿˜èƒ½æ”¯æŒWebSocketï¼ŒMQTTç­‰å¤šç§åè®®ï¼ŒåŒæ—¶Channelsè¿˜æ•´åˆäº†Djangoçš„authä»¥åŠsessionç³»ç»Ÿæ–¹ä¾¿è¿›è¡Œç”¨æˆ·ç®¡ç†åŠè®¤è¯ã€‚</p>
<p>æˆ‘ä¸‹æ–‡æ‰€æœ‰çš„ä»£ç å®ç°ä½¿ç”¨ä»¥ä¸‹pythonå’ŒDjangoç‰ˆæœ¬</p>
<ul>
<li>python==3.6.3</li>
<li>django==2.2</li>
</ul>
<h2 id="channels_1">é›†æˆChannels</h2>
<p>æˆ‘å‡è®¾ä½ å·²ç»æ–°å»ºäº†ä¸€ä¸ªdjangoé¡¹ç›®ï¼Œé¡¹ç›®åå­—å°±å«<code>webapp</code>ï¼Œç›®å½•ç»“æ„å¦‚ä¸‹</p>
<pre class="codehilite"><code>project
    - webapp
        - __init__.py
        - settings.py
        - urls.py
        - wsgi.py
    - manage.py</code></pre>


<ol>
<li>å®‰è£…channels</li>
</ol>
<pre class="codehilite"><code>pip install channels==2.1.7</code></pre>


<ol>
<li>ä¿®æ”¹settings.pyæ–‡ä»¶ï¼Œ</li>
</ol>
<pre class="codehilite"><code># APPSä¸­æ·»åŠ channels
INSTALLED_APPS = [
    'django.contrib.staticfiles',
    'channels',
]

# æŒ‡å®šASGIçš„è·¯ç”±åœ°å€
ASGI_APPLICATION = 'webapp.routing.application'</code></pre>


<p>channelsè¿è¡ŒäºASGIåè®®ä¸Šï¼ŒASGIçš„å…¨åæ˜¯Asynchronous Server Gateway Interfaceã€‚å®ƒæ˜¯åŒºåˆ«äºDjangoä½¿ç”¨çš„WSGIåè®® çš„ä¸€ç§å¼‚æ­¥æœåŠ¡ç½‘å…³æ¥å£åè®®ï¼Œæ­£æ˜¯å› ä¸ºå®ƒæ‰å®ç°äº†websocket</p>
<p><strong>ASGI_APPLICATION</strong> æŒ‡å®šä¸»è·¯ç”±çš„ä½ç½®ä¸ºwebappä¸‹çš„routing.pyæ–‡ä»¶ä¸­çš„application</p>
<ol>
<li>setting.pyçš„åŒçº§ç›®å½•ä¸‹åˆ›å»ºrouting.pyè·¯ç”±æ–‡ä»¶ï¼Œrouting.pyç±»ä¼¼äºDjangoä¸­çš„url.pyæŒ‡æ˜websocketåè®®çš„è·¯ç”±</li>
</ol>
<pre class="codehilite"><code>from channels.routing import ProtocolTypeRouter

application = ProtocolTypeRouter({
    # æš‚æ—¶ä¸ºç©ºï¼Œä¸‹æ–‡å¡«å……
})</code></pre>


<ol>
<li>è¿è¡ŒDjangoé¡¹ç›®</li>
</ol>
<pre class="codehilite"><code>C:\python36\python.exe D:/demo/tailf/manage.py runserver 0.0.0.0:80
Performing system checks...
Watching for file changes with StatReloader

System check identified no issues (0 silenced).
April 12, 2019 - 17:44:52
Django version 2.2, using settings 'webapp.settings'
Starting ASGI/Channels version 2.1.7 development server at http://0.0.0.0:80/
Quit the server with CTRL-BREAK.</code></pre>


<p>ä»”ç»†è§‚å¯Ÿä¸Šè¾¹çš„è¾“å‡ºä¼šå‘ç°Djangoå¯åŠ¨ä¸­çš„<code>Starting development server</code>å·²ç»å˜æˆäº†<code>Starting ASGI/Channels version 2.1.7 development server</code>ï¼Œè¿™è¡¨æ˜é¡¹ç›®å·²ç»ç”±djangoä½¿ç”¨çš„WSGIåè®®è½¬æ¢ä¸ºäº†Channelsä½¿ç”¨çš„ASGIåè®®</p>
<p>è‡³æ­¤Djangoå·²ç»åŸºæœ¬é›†æˆäº†Channelsæ¡†æ¶</p>
<h2 id="_1">æ„å»ºèŠå¤©å®¤</h2>
<p>ä¸Šè¾¹è™½ç„¶åœ¨é¡¹ç›®ä¸­é›†æˆäº†Channelsï¼Œä½†å¹¶æ²¡æœ‰ä»»ä½•çš„åº”ç”¨ä½¿ç”¨å®ƒï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä»¥èŠå¤©å®¤çš„ä¾‹å­æ¥è®²è§£Channelsçš„ä½¿ç”¨</p>
<p>å‡è®¾ä½ å·²ç»åˆ›å»ºå¥½äº†ä¸€ä¸ªå«chatçš„appï¼Œå¹¶æ·»åŠ åˆ°äº†settings.pyçš„INSTALLED_APPSä¸­ï¼Œappçš„ç›®å½•ç»“æ„å¤§æ¦‚å¦‚ä¸‹</p>
<pre class="codehilite"><code>chat
    - migrations
        - __init__.py
    - __init__.py
    - admin.py
    - apps.py
    - models.py
    - tests.py
    - views.py</code></pre>


<p>æˆ‘ä»¬æ„å»ºä¸€ä¸ªæ ‡å‡†çš„DjangoèŠå¤©é¡µé¢ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹</p>
<p>url:</p>
<pre class="codehilite"><code>from django.urls import path
from chat.views import chat

urlpatterns = [
    path('chat', chat, name='chat-url')
]</code></pre>


<p>view:</p>
<pre class="codehilite"><code>from django.shortcuts import render

def chat(request):
    return render(request, 'chat/index.html')</code></pre>


<p>template:</p>
<pre class="codehilite"><code>{% extends &quot;base.html&quot; %}

{% block content %}
  &lt;textarea class=&quot;form-control&quot; id=&quot;chat-log&quot; disabled rows=&quot;20&quot;&gt;&lt;/textarea&gt;&lt;br/&gt;
  &lt;input class=&quot;form-control&quot; id=&quot;chat-message-input&quot; type=&quot;text&quot;/&gt;&lt;br/&gt;
  &lt;input class=&quot;btn btn-success btn-block&quot; id=&quot;chat-message-submit&quot; type=&quot;button&quot; value=&quot;Send&quot;/&gt;
{% endblock %}</code></pre>


<p>é€šè¿‡ä¸Šè¾¹çš„ä»£ç ä¸€ä¸ªç®€å•çš„webèŠå¤©é¡µé¢æ„å»ºå®Œæˆäº†ï¼Œè®¿é—®é¡µé¢å¤§æ¦‚æ ·å­å¦‚ä¸‹ï¼š</p>
<p><img alt="" loading="lazy" src="/static/images/2019/0416.01.jpeg" /></p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ©ç”¨Channelsçš„WebSocketåè®®å®ç°æ¶ˆæ¯çš„å‘é€æ¥æ”¶åŠŸèƒ½</p>
<ol>
<li>å…ˆä»è·¯ç”±å…¥æ‰‹ï¼Œä¸Šè¾¹æˆ‘ä»¬å·²ç»åˆ›å»ºäº†routing.pyè·¯ç”±æ–‡ä»¶ï¼Œç°åœ¨æ¥å¡«å……é‡Œè¾¹çš„å†…å®¹</li>
</ol>
<pre class="codehilite"><code>from channels.auth import AuthMiddlewareStack
from channels.routing import ProtocolTypeRouter, URLRouter
import chat.routing

application = ProtocolTypeRouter({
    'websocket': AuthMiddlewareStack(
        URLRouter(
            chat.routing.websocket_urlpatterns
        )
    ),
})</code></pre>


<p><strong>ProtocolTypeRouterï¼š</strong> ASIGæ”¯æŒå¤šç§ä¸åŒçš„åè®®ï¼Œåœ¨è¿™é‡Œå¯ä»¥æŒ‡å®šç‰¹å®šåè®®çš„è·¯ç”±ä¿¡æ¯ï¼Œæˆ‘ä»¬åªä½¿ç”¨äº†websocketåè®®ï¼Œè¿™é‡Œåªé…ç½®websocketå³å¯</p>
<p><strong>AuthMiddlewareStackï¼š</strong> djangoçš„channelså°è£…äº†djangoçš„authæ¨¡å—ï¼Œä½¿ç”¨è¿™ä¸ªé…ç½®æˆ‘ä»¬å°±å¯ä»¥åœ¨consumerä¸­é€šè¿‡ä¸‹è¾¹çš„ä»£ç è·å–åˆ°ç”¨æˆ·çš„ä¿¡æ¯</p>
<pre class="codehilite"><code>def connect(self):
    self.user = self.scope[&quot;user&quot;]</code></pre>


<p><code>self.scope</code>ç±»ä¼¼äºdjangoä¸­çš„requestï¼ŒåŒ…å«äº†è¯·æ±‚çš„typeã€pathã€headerã€cookieã€sessionã€userç­‰ç­‰æœ‰ç”¨çš„ä¿¡æ¯</p>
<p><strong>URLRouterï¼š</strong> æŒ‡å®šè·¯ç”±æ–‡ä»¶çš„è·¯å¾„ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å°†è·¯ç”±ä¿¡æ¯å†™åœ¨è¿™é‡Œï¼Œä»£ç ä¸­é…ç½®äº†è·¯ç”±æ–‡ä»¶çš„è·¯å¾„ï¼Œä¼šå»chatä¸‹çš„routeing.pyæ–‡ä»¶ä¸­æŸ¥æ‰¾websocket_urlpatternsï¼Œ<code>chat/routing.py</code>å†…å®¹å¦‚ä¸‹</p>
<pre class="codehilite"><code>from django.urls import path
from chat.consumers import ChatConsumer

websocket_urlpatterns = [
    path('ws/chat/', ChatConsumer),
]</code></pre>


<p>routing.pyè·¯ç”±æ–‡ä»¶è·Ÿdjangoçš„url.pyåŠŸèƒ½ç±»ä¼¼ï¼Œè¯­æ³•ä¹Ÿä¸€æ ·ï¼Œæ„æ€å°±æ˜¯è®¿é—®<code>ws/chat/</code>éƒ½äº¤ç»™<code>ChatConsumer</code>å¤„ç†</p>
<ol>
<li>æ¥ç€ç¼–å†™consumerï¼Œconsumerç±»ä¼¼djangoä¸­çš„viewï¼Œå†…å®¹å¦‚ä¸‹</li>
</ol>
<pre class="codehilite"><code>from channels.generic.websocket import WebsocketConsumer
import json

class ChatConsumer(WebsocketConsumer):
    def connect(self):
        self.accept()

    def disconnect(self, close_code):
        pass

    def receive(self, text_data):
        text_data_json = json.loads(text_data)
        message = 'è¿ç»´å’–å•¡å§ï¼š' + text_data_json['message']

        self.send(text_data=json.dumps({
            'message': message
        }))</code></pre>


<p>è¿™é‡Œæ˜¯ä¸ªæœ€ç®€å•çš„åŒæ­¥websocket consumerç±»ï¼Œconnectæ–¹æ³•åœ¨è¿æ¥å»ºç«‹æ—¶è§¦å‘ï¼Œdisconnectåœ¨è¿æ¥å…³é—­æ—¶è§¦å‘ï¼Œreceiveæ–¹æ³•ä¼šåœ¨æ”¶åˆ°æ¶ˆæ¯åè§¦å‘ã€‚æ•´ä¸ªChatConsumerç±»ä¼šå°†æ‰€æœ‰æ”¶åˆ°çš„æ¶ˆæ¯åŠ ä¸Šâ€œè¿ç»´å’–å•¡å§ï¼šâ€çš„å‰ç¼€å‘é€ç»™å®¢æˆ·ç«¯</p>
<ol>
<li>æœ€åæˆ‘ä»¬åœ¨htmlæ¨¡æ¿é¡µé¢æ·»åŠ websocketæ”¯æŒ</li>
</ol>
<pre class="codehilite"><code>{% extends &quot;base.html&quot; %}

{% block content %}
  &lt;textarea class=&quot;form-control&quot; id=&quot;chat-log&quot; disabled rows=&quot;20&quot;&gt;&lt;/textarea&gt;&lt;br/&gt;
  &lt;input class=&quot;form-control&quot; id=&quot;chat-message-input&quot; type=&quot;text&quot;/&gt;&lt;br/&gt;
  &lt;input class=&quot;btn btn-success btn-block&quot; id=&quot;chat-message-submit&quot; type=&quot;button&quot; value=&quot;Send&quot;/&gt;
{% endblock %}

{% block js %}
&lt;script&gt;
  var chatSocket = new WebSocket(
    'ws://' + window.location.host + '/ws/chat/');

  chatSocket.onmessage = function(e) {
    var data = JSON.parse(e.data);
    var message = data['message'];
    document.querySelector('#chat-log').value += (message + '\n');
  };

  chatSocket.onclose = function(e) {
    console.error('Chat socket closed unexpectedly');
  };

  document.querySelector('#chat-message-input').focus();
  document.querySelector('#chat-message-input').onkeyup = function(e) {
    if (e.keyCode === 13) {  // enter, return
        document.querySelector('#chat-message-submit').click();
    }
  };

  document.querySelector('#chat-message-submit').onclick = function(e) {
    var messageInputDom = document.querySelector('#chat-message-input');
    var message = messageInputDom.value;
    chatSocket.send(JSON.stringify({
        'message': message
    }));

    messageInputDom.value = '';
  };
&lt;/script&gt;
{% endblock %}</code></pre>


<p>WebSocketå¯¹è±¡ä¸€ä¸ªæ”¯æŒå››ä¸ªæ¶ˆæ¯ï¼šonopenï¼Œonmessageï¼Œoncluseå’Œonerrorï¼Œæˆ‘ä»¬è¿™é‡Œç”¨äº†ä¸¤ä¸ªonmessageå’Œonclose</p>
<p><strong>onopenï¼š</strong> å½“æµè§ˆå™¨å’ŒwebsocketæœåŠ¡ç«¯è¿æ¥æˆåŠŸåä¼šè§¦å‘onopenæ¶ˆæ¯</p>
<p><strong>onerrorï¼š</strong> å¦‚æœè¿æ¥å¤±è´¥ï¼Œæˆ–è€…å‘é€ã€æ¥æ”¶æ•°æ®å¤±è´¥ï¼Œæˆ–è€…æ•°æ®å¤„ç†å‡ºé”™éƒ½ä¼šè§¦å‘onerroræ¶ˆæ¯</p>
<p><strong>onmessageï¼š</strong> å½“æµè§ˆå™¨æ¥æ”¶åˆ°websocketæœåŠ¡å™¨å‘é€è¿‡æ¥çš„æ•°æ®æ—¶ï¼Œå°±ä¼šè§¦å‘onmessageæ¶ˆæ¯ï¼Œå‚æ•°<code>e</code>åŒ…å«äº†æœåŠ¡ç«¯å‘é€è¿‡æ¥çš„æ•°æ®</p>
<p><strong>oncloseï¼š</strong> å½“æµè§ˆå™¨æ¥æ”¶åˆ°websocketæœåŠ¡å™¨å‘é€è¿‡æ¥çš„å…³é—­è¿æ¥è¯·æ±‚æ—¶ï¼Œä¼šè§¦å‘oncloseæ¶ˆæ¯</p>
<ol>
<li>å®Œæˆå‰è¾¹çš„ä»£ç ï¼Œä¸€ä¸ªå¯ä»¥èŠå¤©çš„websocketé¡µé¢å°±å®Œæˆäº†ï¼Œè¿è¡Œé¡¹ç›®ï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥æ¶ˆæ¯å°±ä¼šé€šè¿‡websocket--&gt;rouging.py--&gt;consumer.pyå¤„ç†åè¿”å›ç»™å‰ç«¯</li>
</ol>
<p><img alt="" loading="lazy" src="/static/images/2019/0416.02.jpeg" /></p>
<h2 id="channel-layer">å¯ç”¨Channel Layer</h2>
<p>ä¸Šè¾¹çš„ä¾‹å­æˆ‘ä»¬å·²ç»å®ç°äº†æ¶ˆæ¯çš„å‘é€å’Œæ¥æ”¶ï¼Œä½†æ—¢ç„¶æ˜¯èŠå¤©å®¤ï¼Œè‚¯å®šè¦æ”¯æŒå¤šäººåŒæ—¶èŠå¤©çš„ï¼Œå½“æˆ‘ä»¬æ‰“å¼€å¤šä¸ªæµè§ˆå™¨åˆ†åˆ«è¾“å…¥æ¶ˆæ¯åå‘ç°åªæœ‰è‡ªå·±æ”¶åˆ°æ¶ˆæ¯ï¼Œå…¶ä»–æµè§ˆå™¨ç«¯æ”¶ä¸åˆ°ï¼Œå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè®©æ‰€æœ‰å®¢æˆ·ç«¯éƒ½èƒ½ä¸€èµ·èŠå¤©å‘¢ï¼Ÿ</p>
<p>Channelså¼•å…¥äº†ä¸€ä¸ªlayerçš„æ¦‚å¿µï¼Œchannel layeræ˜¯ä¸€ç§é€šä¿¡ç³»ç»Ÿï¼Œå…è®¸å¤šä¸ªconsumerå®ä¾‹ä¹‹é—´äº’ç›¸é€šä¿¡ï¼Œä»¥åŠä¸å¤–éƒ¨Djanboç¨‹åºå®ç°äº’é€šã€‚</p>
<p>channel layerä¸»è¦å®ç°äº†ä¸¤ç§æ¦‚å¿µæŠ½è±¡ï¼š</p>
<p><strong>channel nameï¼š</strong> channelå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªå‘é€æ¶ˆæ¯çš„é€šé“ï¼Œæ¯ä¸ªChanneléƒ½æœ‰ä¸€ä¸ªåç§°ï¼Œæ¯ä¸€ä¸ªæ‹¥æœ‰è¿™ä¸ªåç§°çš„äººéƒ½å¯ä»¥å¾€Channelé‡Œè¾¹å‘é€æ¶ˆæ¯</p>
<p><strong>groupï¼š</strong> å¤šä¸ªchannelå¯ä»¥ç»„æˆä¸€ä¸ªGroupï¼Œæ¯ä¸ªGroupéƒ½æœ‰ä¸€ä¸ªåç§°ï¼Œæ¯ä¸€ä¸ªæ‹¥æœ‰è¿™ä¸ªåç§°çš„äººéƒ½å¯ä»¥å¾€Groupé‡Œæ·»åŠ /åˆ é™¤Channelï¼Œä¹Ÿå¯ä»¥å¾€Groupé‡Œå‘é€æ¶ˆæ¯ï¼ŒGroupå†…çš„æ‰€æœ‰channeléƒ½å¯ä»¥æ”¶åˆ°ï¼Œä½†æ˜¯æ— æ³•å‘é€ç»™Groupå†…çš„å…·ä½“æŸä¸ªChannel</p>
<p>äº†è§£äº†ä¸Šè¾¹çš„æ¦‚å¿µï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åˆ©ç”¨channel layerå®ç°çœŸæ­£çš„èŠå¤©å®¤ï¼Œèƒ½å¤Ÿè®©å¤šä¸ªå®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯è¢«å½¼æ­¤çœ‹åˆ°</p>
<ol>
<li>å®˜æ–¹æ¨èä½¿ç”¨redisä½œä¸ºchannel layerï¼Œæ‰€ä»¥å…ˆå®‰è£…channels_redis</li>
</ol>
<pre class="codehilite"><code>pip install channels_redis==2.3.3</code></pre>


<ol>
<li>ç„¶åä¿®æ”¹settings.pyæ·»åŠ å¯¹layerçš„æ”¯æŒ</li>
</ol>
<pre class="codehilite"><code>CHANNEL_LAYERS = {
    'default': {
        'BACKEND': 'channels_redis.core.RedisChannelLayer',
        'CONFIG': {
            &quot;hosts&quot;: [('ops-coffee.com', 6379)],
        },
    },
}</code></pre>


<p>æ·»åŠ channelä¹‹åæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ£€æŸ¥é€šé“å±‚æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸å·¥ä½œ</p>
<pre class="codehilite"><code>&gt;python manage.py shell
Python 3.6.3 (v3.6.3:2c5fed8, Oct  3 2017, 18:11:49) [MSC v.1900 64 bit (AMD64)] on win32
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
(InteractiveConsole)
&gt;&gt;&gt; import channels.layers
&gt;&gt;&gt; channel_layer = channels.layers.get_channel_layer()
&gt;&gt;&gt;
&gt;&gt;&gt; from asgiref.sync import async_to_sync
&gt;&gt;&gt; async_to_sync(channel_layer.send)('test_channel',{'site':'https://ops-coffee.com'})
&gt;&gt;&gt; async_to_sync(channel_layer.receive)('test_channel')
{'site': 'https://ops-coffee.com'}
&gt;&gt;&gt;</code></pre>


<ol>
<li>consumeråšå¦‚ä¸‹ä¿®æ”¹å¼•å…¥channel layer</li>
</ol>
<pre class="codehilite"><code>from asgiref.sync import async_to_sync
from channels.generic.websocket import WebsocketConsumer
import json

class ChatConsumer(WebsocketConsumer):
    def connect(self):
        self.room_group_name = 'ops_coffee'

        # Join room group
        async_to_sync(self.channel_layer.group_add)(
            self.room_group_name,
            self.channel_name
        )

        self.accept()

    def disconnect(self, close_code):
        # Leave room group
        async_to_sync(self.channel_layer.group_discard)(
            self.room_group_name,
            self.channel_name
        )

    # Receive message from WebSocket
    def receive(self, text_data):
        text_data_json = json.loads(text_data)
        message = text_data_json['message']

        # Send message to room group
        async_to_sync(self.channel_layer.group_send)(
            self.room_group_name,
            {
                'type': 'chat_message',
                'message': message
            }
        )

    # Receive message from room group
    def chat_message(self, event):
        message = 'è¿ç»´å’–å•¡å§ï¼š' + event['message']

        # Send message to WebSocket
        self.send(text_data=json.dumps({
            'message': message
        }))</code></pre>


<p>è¿™é‡Œæˆ‘ä»¬è®¾ç½®äº†ä¸€ä¸ªå›ºå®šçš„æˆ¿é—´åä½œä¸ºGroup nameï¼Œæ‰€æœ‰çš„æ¶ˆæ¯éƒ½ä¼šå‘é€åˆ°è¿™ä¸ªGroupé‡Œè¾¹ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥é€šè¿‡å‚æ•°çš„æ–¹å¼å°†æˆ¿é—´åä¼ è¿›æ¥ä½œä¸ºGroup nameï¼Œä»è€Œå»ºç«‹å¤šä¸ªGroupï¼Œè¿™æ ·å¯ä»¥å®ç°ä»…åŒæˆ¿é—´å†…çš„æ¶ˆæ¯äº’é€š</p>
<p>å½“æˆ‘ä»¬å¯ç”¨äº†channel layerä¹‹åï¼Œæ‰€æœ‰ä¸consumerä¹‹é—´çš„é€šä¿¡å°†ä¼šå˜æˆå¼‚æ­¥çš„ï¼Œæ‰€ä»¥å¿…é¡»ä½¿ç”¨<code>async_to_sync</code></p>
<p>ä¸€ä¸ªé“¾æ¥ï¼ˆchannelï¼‰åˆ›å»ºæ—¶ï¼Œé€šè¿‡<code>group_add</code>å°†channelæ·»åŠ åˆ°Groupä¸­ï¼Œé“¾æ¥å…³é—­é€šè¿‡<code>group_discard</code>å°†channelä»Groupä¸­å‰”é™¤ï¼Œæ”¶åˆ°æ¶ˆæ¯æ—¶å¯ä»¥è°ƒç”¨<code>group_send</code>æ–¹æ³•å°†æ¶ˆæ¯å‘é€åˆ°Groupï¼Œè¿™ä¸ªGroupå†…æ‰€æœ‰çš„channeléƒ½å¯ä»¥æ”¶çš„åˆ°</p>
<p><code>group_send</code>ä¸­çš„typeæŒ‡å®šäº†æ¶ˆæ¯å¤„ç†çš„å‡½æ•°ï¼Œè¿™é‡Œä¼šå°†æ¶ˆæ¯è½¬ç»™<code>chat_message</code>å‡½æ•°å»å¤„ç†</p>
<ol>
<li>ç»è¿‡ä»¥ä¸Šçš„ä¿®æ”¹ï¼Œæˆ‘ä»¬å†æ¬¡åœ¨å¤šä¸ªæµè§ˆå™¨ä¸Šæ‰“å¼€èŠå¤©é¡µé¢è¾“å…¥æ¶ˆæ¯ï¼Œå‘ç°å½¼æ­¤å·²ç»èƒ½å¤Ÿçœ‹åˆ°äº†ï¼Œè‡³æ­¤ä¸€ä¸ªå®Œæ•´çš„èŠå¤©å®¤å·²ç»åŸºæœ¬å®Œæˆ</li>
</ol>
<h2 id="_2">ä¿®æ”¹ä¸ºå¼‚æ­¥</h2>
<p>æˆ‘ä»¬å‰è¾¹å®ç°çš„consumeræ˜¯åŒæ­¥çš„ï¼Œä¸ºäº†èƒ½æœ‰æ›´å¥½çš„æ€§èƒ½ï¼Œå®˜æ–¹æ”¯æŒå¼‚æ­¥çš„å†™æ³•ï¼Œåªéœ€è¦ä¿®æ”¹consumer.pyå³å¯</p>
<pre class="codehilite"><code>from channels.generic.websocket import AsyncWebsocketConsumer
import json

class ChatConsumer(AsyncWebsocketConsumer):
    async def connect(self):
        self.room_group_name = 'ops_coffee'

        # Join room group
        await self.channel_layer.group_add(
            self.room_group_name,
            self.channel_name
        )

        await self.accept()

    async def disconnect(self, close_code):
        # Leave room group
        await self.channel_layer.group_discard(
            self.room_group_name,
            self.channel_name
        )

    # Receive message from WebSocket
    async def receive(self, text_data):
        text_data_json = json.loads(text_data)
        message = text_data_json['message']

        # Send message to room group
        await self.channel_layer.group_send(
            self.room_group_name,
            {
                'type': 'chat_message',
                'message': message
            }
        )

    # Receive message from room group
    async def chat_message(self, event):
        message = 'è¿ç»´å’–å•¡å§ï¼š' + event['message']

        # Send message to WebSocket
        await self.send(text_data=json.dumps({
            'message': message
        }))</code></pre>


<p>å…¶å®å¼‚æ­¥çš„ä»£ç è·Ÿä¹‹å‰çš„å·®åˆ«ä¸å¤§ï¼Œåªæœ‰å‡ ä¸ªå°åŒºåˆ«ï¼š</p>
<p>ChatConsumerç”±<code>WebsocketConsumer</code>ä¿®æ”¹ä¸ºäº†<code>AsyncWebsocketConsumer</code></p>
<p>æ‰€æœ‰çš„æ–¹æ³•éƒ½ä¿®æ”¹ä¸ºäº†å¼‚æ­¥def<code>async def</code></p>
<p>ç”¨<code>await</code>æ¥å®ç°å¼‚æ­¥I/Oçš„è°ƒç”¨</p>
<p>channel layerä¹Ÿä¸å†éœ€è¦ä½¿ç”¨<code>async_to_sync</code>äº†</p>
<p>å¥½äº†ï¼Œç°åœ¨ä¸€ä¸ªå®Œå…¨å¼‚æ­¥ä¸”åŠŸèƒ½å®Œæ•´çš„èŠå¤©å®¤å·²ç»æ„å»ºå®Œæˆäº†</p>
<h1 id="_3">ä»£ç åœ°å€</h1>
<p>æˆ‘å·²ç»å°†ä»¥ä¸Šçš„æ¼”ç¤ºä»£ç ä¸Šä¼ è‡³Githubæ–¹ä¾¿ä½ åœ¨å®ç°çš„è¿‡ç¨‹ä¸­æŸ¥çœ‹å‚è€ƒï¼Œå…·ä½“åœ°å€ä¸ºï¼š</p>
<p><a href="https://github.com/ops-coffee/demo/tree/master/websocket" target="_blank">https://github.com/ops-coffee/demo/tree/master/websocket</a></p>

        <div>
          <ul style="display: inline-block;padding: 0;margin: 0 0 0.5em;color: #999;">
            <li style="display: inline-block;margin: 0 1em 0 0;"><a href="/s/django-channels-websocket-devops-01.html">ğŸ“… 2019-04-16</a></li>
<li style="display: inline-block;margin: 0 1em 0 0;"><a href="/tag/Django/">ğŸ·ï¸ Django</a></li><li style="display: inline-block;margin: 0 1em 0 0;"><a href="/tag/å…³äºæŠ€æœ¯/">ğŸ·ï¸ å…³äºæŠ€æœ¯</a></li>          </ul>
        </div>

        <hr>

        <div class="pagination">
            <a href="https://blog.ops-coffee.com/s/wechat-miniapp-development-journey.html" class="pagination-item prev-page">
                <span class="pagination-arrow">â†</span>
                <span class="pagination-text">ä¸Šä¸€ç¯‡ï¼š<br>æ²¡æœ‰åŸºç¡€ä¹Ÿèƒ½å†™ä¸ªå°ç¨‹åº</span>
            </a>
            <a href="https://blog.ops-coffee.com/s/django-channels-websocket-devops-02.html" class="pagination-item next-page">
                <span class="pagination-text">ä¸‹ä¸€ç¯‡ï¼š<br>Djangoä½¿ç”¨Channelså®ç°WebSocket--ä¸‹ç¯‡</span>
                <span class="pagination-arrow">â†’</span>
            </a>
        </div>

        <div>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8944257246828217"
         data-ad-slot="6731434232" data-ad-format="auto" data-full-width-responsive="true"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
</div>

<div class="nav-cell">
    <script async src="https://giscus.app/client.js"
            data-repo="ops-coffee/blog" data-repo-id="MDEwOlJlcG9zaXRvcnkxNDY4OTI0MTg="
            data-category="Announcements" data-category-id="DIC_kwDOCMFmgs4CQar3"
            data-mapping="pathname" data-strict="0" data-reactions-enabled="1"
            data-emit-metadata="0" data-input-position="top" data-theme="light"
            data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous">
    </script>
</div>

        <div class="nav-cell">
    <p class="nav-list-title">èƒ½çœ‹åˆ°è¿™é‡Œä¸€å®šæ˜¯çœŸçˆ±ï¼Œè®¢é˜…ä¸€ä¸‹å§</p>
    <img alt="" loading="lazy" src="/static/images/wx.sou1.png" />
</div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="copy"> Â© ops-coffee</div>

      <div class="link">
        <a href="/comments.html" title="ç»™æˆ‘ç•™è¨€" target="_blank">ç•™è¨€</a>
        <a href="/friends.html" title="å‹æƒ…é“¾æ¥" target="_blank">å‹é“¾</a>
      </div>
    </div>
  </footer>
  
  <!-- Umami -->
<script defer src="https://umami.ops-coffee.cn/script.js" data-website-id="248e61f0-c324-444e-a56d-bf97ee44a8fc"></script>

<!-- Google Adsense -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8944257246828217" crossorigin="anonymous"></script>
</body>
</html>