<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="applicable-device" content="pc,mobile">
  <meta name="keywords" content="Django, API, Tokené‰´æƒ, JWT, PyJWT, å‰åç«¯åˆ†ç¦», é‰´æƒæœºåˆ¶, DRF, HTTPæ— çŠ¶æ€åè®®, æƒé™æ ¡éªŒ" />
  <meta name="description" content="æœ¬æ–‡æ¢è®¨äº†åœ¨Djangoé¡¹ç›®ä¸­ä¸ä½¿ç”¨Django Rest Frameworkï¼ˆDRFï¼‰æä¾›APIçš„å¯èƒ½æ€§ï¼Œé‡ç‚¹ä»‹ç»äº†åŸºäºTokençš„é‰´æƒæœºåˆ¶ï¼Œç‰¹åˆ«æ˜¯JWTçš„ä½¿ç”¨ï¼Œä»¥åŠå¦‚ä½•åœ¨Djangoä¸­å®ç°è‡ªå®šä¹‰çš„é‰´æƒå’Œæƒé™æ ¡éªŒã€‚" />
  <link rel="alternate" type="application/rss+xml" title="è¿ç»´å’–å•¡å§" href="https://blog.ops-coffee.com/feed.xml" />
  <link rel="stylesheet" href="https://blog.ops-coffee.com/static/posts/css/ops-coffee.min.css" type="text/css" />

  <!-- Begin SEO tag -->
  <title>Django+JWTå®ç°Tokenè®¤è¯</title>
  <meta property="og:locale" content="zh_CN" />
  <meta property="og:site_name" content="è¿ç»´å’–å•¡å§" />
  <meta property="og:url" content="https://blog.ops-coffee.coms/django-api-auth-jwt-token-without-drf.html" />
  <meta property="og:title" content="Django+JWTå®ç°Tokenè®¤è¯" />
  <meta property="og:description" content="æœ¬æ–‡æ¢è®¨äº†åœ¨Djangoé¡¹ç›®ä¸­ä¸ä½¿ç”¨Django Rest Frameworkï¼ˆDRFï¼‰æä¾›APIçš„å¯èƒ½æ€§ï¼Œé‡ç‚¹ä»‹ç»äº†åŸºäºTokençš„é‰´æƒæœºåˆ¶ï¼Œç‰¹åˆ«æ˜¯JWTçš„ä½¿ç”¨ï¼Œä»¥åŠå¦‚ä½•åœ¨Djangoä¸­å®ç°è‡ªå®šä¹‰çš„é‰´æƒå’Œæƒé™æ ¡éªŒã€‚" />
  <link rel="canonical" href="https://blog.ops-coffee.coms/django-api-auth-jwt-token-without-drf.html" />

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "Django+JWTå®ç°Tokenè®¤è¯",
    "description": "æœ¬æ–‡æ¢è®¨äº†åœ¨Djangoé¡¹ç›®ä¸­ä¸ä½¿ç”¨Django Rest Frameworkï¼ˆDRFï¼‰æä¾›APIçš„å¯èƒ½æ€§ï¼Œé‡ç‚¹ä»‹ç»äº†åŸºäºTokençš„é‰´æƒæœºåˆ¶ï¼Œç‰¹åˆ«æ˜¯JWTçš„ä½¿ç”¨ï¼Œä»¥åŠå¦‚ä½•åœ¨Djangoä¸­å®ç°è‡ªå®šä¹‰çš„é‰´æƒå’Œæƒé™æ ¡éªŒã€‚",
    "url": "https://blog.ops-coffee.coms/django-api-auth-jwt-token-without-drf.html",
    "author": {
      "@type": "Person",
      "name": "è¿ç»´å’–å•¡å§"
    },
    "publisher": {
      "@type": "Organization",
      "name": "è¿ç»´å’–å•¡å§",
      "logo": {
        "@type": "ImageObject",
        "url": "https://blog.ops-coffee.com/favicon.ico"
      }
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https://blog.ops-coffee.coms/django-api-auth-jwt-token-without-drf.html"
    }
  }
  </script>
  <!-- End SEO tag -->
</head>

<body>
  <div class="top-nav">
    <input type="checkbox" id="menu-toggle" class="menu-toggle" />
    <label for="menu-toggle" class="menu-button">&#9776; 
        <span class="menu-title">è¿ç»´å’–å•¡å§</span>
    </label> 

    <div class="container">
      <nav class="header-site">
        <ul>
          <li><a href="/">é¦–é¡µ</a></li>
            <li class="has-submenu">
              <a href="#" target="_self">è¿ç»´</a>
              <ul class="sub-menu">
                <li><a href="/tag/ç³»ç»Ÿè¿ç»´/" target="_self">ç³»ç»Ÿè¿ç»´</a></li>
                <li><a href="/elk/index.html" target="_self">ELKç³»åˆ—</a></li>
                <li><a href="/ldap/index.html" target="_self">LDAPç³»åˆ—</a></li>
              </ul>
            </li>
            <li class="has-submenu">
              <a href="#" target="_self">å¼€å‘</a>
              <ul class="sub-menu">
                <li><a href="/tag/Devops/" target="_self">DevOps</a></li>
                <li><a href="/tag/Python/" target="_self">Python</a></li>
                <li><a href="/tag/Django/" target="_self">Django</a></li>
                <li><a href="/bpmn/index.html" target="_self">BPMNç³»åˆ—</a></li>
                <li><a href="/webssh/index.html" target="_self">WebSSHç³»åˆ—</a></li>
                <li><a href="/frontend/index.html" target="_self">å‰ç«¯å¼€å‘ç³»åˆ—</a></li>
              </ul>
            </li>
            <li class="has-submenu">
              <a href="#" target="_self">äº§å“</a>
              <ul class="sub-menu">
                <li><a href="/img.html" target="_self">CollageMaker</a></li>
              </ul>
            </li>
            <li><a href="/devops/index.html" target="_self">è¿ç»´å¹³å°</a></li>
            <li class="has-submenu">
              <a href="#" target="_self">è¿™æ˜¯ç”Ÿæ´»</a>
              <ul class="sub-menu">
                <li><a href="/life/chronicles.html" target="_self">æ—¶å…‰å°è®°</a></li>
                <li><a href="/life/money.html" target="_self">å‰¯ä¸šèµšé’±</a></li>
                <li><a href="/life/writing.html" target="_self">å†™ä½œç›¸å…³</a></li>
                <li><a href="/tag/è¿™æ˜¯ç”Ÿæ´»/" target="_self">ç”Ÿæ´»éšç¬”</a></li>
              </ul>
            </li>
            <li class="has-submenu">
              <a href="#" target="_self">æˆ¿è½¦æ—…è¡Œ</a>
              <ul class="sub-menu">
                <li><a href="/rv.html" target="_self">æˆ¿è½¦ä½“éªŒ</a></li>
                <li><a href="/travels.html" target="_self">æ—…è¡Œæ¸¸è®°</a></li>
                <li><a href="/travel/china.html" target="_self">æ—…è¡Œåœ°å›¾</a></li>
              </ul>
            </li>
            <li><a href="/tag/index.html" target="_self">æ ‡ç­¾</a></li>
            <li><a href="/archive.html" target="_self">å½’æ¡£</a></li>
          <li class="search"><a href="/search.html" target="_self" aria-label="æœç´¢">ğŸ”</a></li>
        </ul>
      </nav>
    </div>
  </div>

  <header>
    <div class="container">
      <a href="/">
        <div class="name">è¿ç»´å’–å•¡å§</div>
        <div class="slogan">äº«å—æŠ€æœ¯å¸¦æ¥çš„ä¹è¶£ï¼Œä½“éªŒç”Ÿæ´»ç»™äºˆçš„æ„ŸåŠ¨</div>
      </a>
    </div>
  </header>

  <div id="content-wrap">
    <div class="container">
        <h1 id="art-title">Django+JWTå®ç°Tokenè®¤è¯</h1>

        <blockquote>
<p>å¯¹å¤–æä¾›APIä¸ç”¨django rest frameworkï¼ˆDRFï¼‰å°±æ˜¯æ—é—¨å·¦é“å—ï¼Ÿ</p>
</blockquote>
<p>åŸºäºTokençš„é‰´æƒæœºåˆ¶è¶Šæ¥è¶Šå¤šçš„ç”¨åœ¨äº†é¡¹ç›®ä¸­ï¼Œå°¤å…¶æ˜¯å¯¹äºçº¯åç«¯åªå¯¹å¤–æä¾›APIæ²¡æœ‰webé¡µé¢çš„é¡¹ç›®ï¼Œä¾‹å¦‚æˆ‘ä»¬é€šå¸¸æ‰€è®²çš„å‰åç«¯åˆ†ç¦»æ¶æ„ä¸­çš„çº¯åç«¯æœåŠ¡ï¼Œåªæä¾›APIç»™å‰ç«¯ï¼Œå‰ç«¯é€šè¿‡APIæä¾›çš„æ•°æ®å¯¹é¡µé¢è¿›è¡Œæ¸²æŸ“å±•ç¤ºæˆ–å¢åŠ ä¿®æ”¹ç­‰ï¼Œæˆ‘ä»¬çŸ¥é“HTTPæ˜¯ä¸€ç§æ— çŠ¶æ€çš„åè®®ï¼Œä¹Ÿå°±æ˜¯è¯´åç«¯æœåŠ¡å¹¶ä¸çŸ¥é“æ˜¯è°å‘æ¥çš„è¯·æ±‚ï¼Œé‚£ä¹ˆå¦‚ä½•æ ¡éªŒè¯·æ±‚çš„åˆæ³•æ€§å‘¢ï¼Ÿè¿™å°±éœ€è¦é€šè¿‡ä¸€äº›æ–¹å¼å¯¹è¯·æ±‚è¿›è¡Œé‰´æƒäº†</p>
<p>å…ˆæ¥çœ‹çœ‹ä¼ ç»Ÿçš„ç™»å½•é‰´æƒè·ŸåŸºäºTokençš„é‰´æƒæœ‰ä»€ä¹ˆåŒºåˆ«</p>
<p>ä»¥Djangoçš„è´¦å·å¯†ç ç™»å½•ä¸ºä¾‹æ¥è¯´æ˜ä¼ ç»Ÿçš„éªŒè¯é‰´æƒæ–¹å¼æ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Œå½“æˆ‘ä»¬ç™»å½•é¡µé¢è¾“å…¥è´¦å·å¯†ç æäº¤è¡¨å•åï¼Œä¼šå‘é€è¯·æ±‚ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨å¯¹å‘é€è¿‡æ¥çš„è´¦å·å¯†ç è¿›è¡ŒéªŒè¯é‰´æƒï¼ŒéªŒè¯é‰´æƒé€šè¿‡åï¼ŒæŠŠç”¨æˆ·ä¿¡æ¯è®°å½•åœ¨æœåŠ¡å™¨ç«¯ï¼ˆdjango_sessionè¡¨ä¸­ï¼‰ï¼ŒåŒæ—¶è¿”å›ç»™æµè§ˆå™¨ä¸€ä¸ªsessionidç”¨æ¥å”¯ä¸€æ ‡è¯†è¿™ä¸ªç”¨æˆ·ï¼Œæµè§ˆå™¨å°†sessionidä¿å­˜åœ¨cookieä¸­ï¼Œä¹‹åæµè§ˆå™¨çš„æ¯æ¬¡è¯·æ±‚éƒ½ä¸€å¹¶å°†sessionidå‘é€ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨æ ¹æ®sessionidä¸è®°å½•çš„ä¿¡æ¯åšå¯¹æ¯”ä»¥éªŒè¯èº«ä»½</p>
<p>Tokençš„é‰´æƒæ–¹å¼å°±æ¸…æ™°å¾ˆå¤šäº†ï¼Œå®¢æˆ·ç«¯ç”¨è‡ªå·±çš„è´¦å·å¯†ç è¿›è¡Œç™»å½•ï¼ŒæœåŠ¡ç«¯éªŒè¯é‰´æƒï¼ŒéªŒè¯é‰´æƒé€šè¿‡ç”ŸæˆTokenè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œä¹‹åå®¢æˆ·ç«¯æ¯æ¬¡è¯·æ±‚éƒ½å°†Tokenæ”¾åœ¨headeré‡Œä¸€å¹¶å‘é€ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°è¯·æ±‚æ—¶æ ¡éªŒTokenä»¥ç¡®å®šè®¿é—®è€…èº«ä»½</p>
<p>sessionçš„ä¸»è¦ç›®çš„æ˜¯ç»™æ— çŠ¶æ€çš„HTTPåè®®æ·»åŠ çŠ¶æ€ä¿æŒï¼Œé€šå¸¸åœ¨æµè§ˆå™¨ä½œä¸ºå®¢æˆ·ç«¯çš„æƒ…å†µä¸‹æ¯”è¾ƒé€šç”¨ã€‚è€ŒTokençš„ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†é‰´æƒï¼ŒåŒæ—¶åˆä¸éœ€è¦è€ƒè™‘CSRFé˜²æŠ¤ä»¥åŠè·¨åŸŸçš„é—®é¢˜ï¼Œæ‰€ä»¥æ›´å¤šçš„ç”¨åœ¨ä¸“é—¨ç»™ç¬¬ä¸‰æ–¹æä¾›APIçš„æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯è¯·æ±‚æ— è®ºæ˜¯æµè§ˆå™¨å‘èµ·è¿˜æ˜¯å…¶ä»–çš„ç¨‹åºå‘èµ·éƒ½èƒ½å¾ˆå¥½çš„æ”¯æŒã€‚æ‰€ä»¥ç›®å‰åŸºäºTokençš„é‰´æƒæœºåˆ¶å‡ ä¹å·²ç»æˆäº†å‰åç«¯åˆ†ç¦»æ¶æ„æˆ–è€…å¯¹å¤–æä¾›APIè®¿é—®çš„é‰´æƒæ ‡å‡†ï¼Œå¾—åˆ°å¹¿æ³›ä½¿ç”¨</p>
<p>JSON Web Tokenï¼ˆJWT)æ˜¯ç›®å‰Tokené‰´æƒæœºåˆ¶ä¸‹æœ€æµè¡Œçš„æ–¹æ¡ˆï¼Œç½‘ä¸Šå…³äºJWTçš„ä»‹ç»æœ‰å¾ˆå¤šï¼Œè¿™é‡Œä¸ç»†è¯´ï¼Œåªè®²ä¸‹Djangoå¦‚ä½•åˆ©ç”¨JWTå®ç°å¯¹APIçš„è®¤è¯é‰´æƒï¼Œæœäº†å‡ ä¹æ‰€æœ‰çš„æ–‡ç« éƒ½æ˜¯è¯´JWTå¦‚ä½•ç»“åˆDRFä½¿ç”¨çš„ï¼Œå¦‚æœä½ çš„é¡¹ç›®æ²¡æœ‰ç”¨åˆ°DRFæ¡†æ¶ï¼Œä¹Ÿä¸æƒ³ä»…ä»…ä¸ºäº†é‰´æƒAPIå°±å¼•å…¥åºå¤§å¤æ‚çš„DRFæ¡†æ¶ï¼Œé‚£ä¹ˆå¯ä»¥æ¥ç€å¾€ä¸‹çœ‹</p>
<p>æˆ‘çš„éœ€æ±‚å¦‚ä¸‹ï¼š</p>
<ol>
<li>åŒä¸€ä¸ªviewå‡½æ•°æ—¢ç»™å‰ç«¯é¡µé¢æä¾›æ•°æ®ï¼Œåˆå¯¹å¤–æä¾›APIæœåŠ¡ï¼Œè¦åŒæ—¶æ»¡è¶³åŸºäºè´¦å·å¯†ç çš„éªŒè¯å’ŒJWTéªŒè¯</li>
<li>é¡¹ç›®ç”¨äº†Djangoé»˜è®¤çš„æƒé™ç³»ç»Ÿï¼Œæ—¢èƒ½å¯¹è´¦å·å¯†ç ç™»å½•çš„è¿›è¡Œæƒé™æ ¡éªŒï¼Œåˆèƒ½å¯¹åŸºäºJWTçš„è¯·æ±‚è¿›è¡Œæƒé™æ ¡éªŒ</li>
</ol>
<h1 id="pyjwt">PyJWTä»‹ç»</h1>
<p>è¦å®ç°ä¸Šè¾¹çš„éœ€æ±‚1ï¼Œæˆ‘ä»¬é¦–å…ˆå¾—å¼•å…¥JWTæ¨¡å—ï¼Œpythonä¸‹æœ‰ç°æˆçš„PyJWTæ¨¡å—å¯ä»¥ç›´æ¥ç”¨ï¼Œå…ˆçœ‹ä¸‹JWTçš„ç®€å•ç”¨æ³•</p>
<h5 id="pyjwt_1">å®‰è£…PyJWT</h5>
<pre class="codehilite"><code>$ pip install pyjwt</code></pre>


<h5 id="pyjwttoken">åˆ©ç”¨PyJWTç”ŸæˆToken</h5>
<pre class="codehilite"><code>&gt;&gt;&gt; import jwt
&gt;&gt;&gt; encoded_jwt = jwt.encode({'username':'è¿ç»´å’–å•¡å§','site':'https://ops-coffee.com'},'secret_key',algorithm='HS256')</code></pre>


<p>è¿™é‡Œä¼ äº†ä¸‰éƒ¨åˆ†å†…å®¹ç»™JWTï¼Œ</p>
<p>ç¬¬ä¸€éƒ¨åˆ†æ˜¯ä¸€ä¸ªJsonå¯¹è±¡ï¼Œç§°ä¸ºPayloadï¼Œä¸»è¦ç”¨æ¥å­˜æ”¾æœ‰æ•ˆçš„ä¿¡æ¯ï¼Œä¾‹å¦‚ç”¨æˆ·åï¼Œè¿‡æœŸæ—¶é—´ç­‰ç­‰æ‰€æœ‰ä½ æƒ³è¦ä¼ é€’çš„ä¿¡æ¯</p>
<p>ç¬¬äºŒéƒ¨åˆ†æ˜¯ä¸€ä¸ªç§˜é’¥å­—ä¸²ï¼Œè¿™ä¸ªç§˜é’¥ä¸»è¦ç”¨åœ¨ä¸‹æ–‡Signatureç­¾åä¸­ï¼ŒæœåŠ¡ç«¯ç”¨æ¥æ ¡éªŒTokenåˆæ³•æ€§ï¼Œè¿™ä¸ªç§˜é’¥åªæœ‰æœåŠ¡ç«¯çŸ¥é“ï¼Œä¸èƒ½æ³„éœ²</p>
<p>ç¬¬ä¸‰éƒ¨åˆ†æŒ‡å®šäº†Signatureç­¾åçš„ç®—æ³•</p>
<h5 id="token">æŸ¥çœ‹ç”Ÿæˆçš„Token</h5>
<pre class="codehilite"><code>&gt;&gt;&gt; print(encoded_jwt)
b'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6Ilx1OGZkMFx1N2VmNFx1NTQ5Nlx1NTU2MVx1NTQyNyIsInNpdGUiOiJodHRwczovL29wcy1jb2ZmZWUuY24ifQ.fIpSXy476r9F9i7GhdYFNkd-2Ndz8uKLgJPcd84BkJ4'</code></pre>


<p>JWTç”Ÿæˆçš„Tokenæ˜¯ä¸€ä¸ªç”¨ä¸¤ä¸ªç‚¹ï¼ˆ.ï¼‰åˆ†å‰²çš„é•¿å­—ç¬¦ä¸²</p>
<p>ç‚¹åˆ†å‰²æˆçš„ä¸‰éƒ¨åˆ†åˆ†åˆ«æ˜¯Headerå¤´éƒ¨ï¼ŒPayloadè´Ÿè½½ï¼ŒSignatureç­¾åï¼š<code>Header.Payload.Signature</code></p>
<p>JWTæ˜¯ä¸åŠ å¯†çš„ï¼Œä»»ä½•äººéƒ½å¯ä»¥è¯»çš„åˆ°å…¶ä¸­çš„ä¿¡æ¯ï¼Œå…¶ä¸­ç¬¬ä¸€éƒ¨åˆ†Headerå’Œç¬¬äºŒéƒ¨åˆ†Payloadåªæ˜¯å¯¹åŸå§‹è¾“å…¥çš„ä¿¡æ¯è½¬æˆäº†base64ç¼–ç ï¼Œç¬¬ä¸‰éƒ¨åˆ†Signatureæ˜¯ç”¨header+payload+secret_keyè¿›è¡ŒåŠ å¯†çš„ç»“æœ</p>
<p>å¯ä»¥ç›´æ¥ç”¨base64å¯¹Headerå’ŒPayloadè¿›è¡Œè§£ç å¾—åˆ°ç›¸åº”çš„ä¿¡æ¯</p>
<pre class="codehilite"><code>&gt;&gt;&gt; import base64
&gt;&gt;&gt; base64.b64decode('eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9')
b'{&quot;typ&quot;:&quot;JWT&quot;,&quot;alg&quot;:&quot;HS256&quot;}'

&gt;&gt;&gt; base64.b64decode('eyJ1c2VybmFtZSI6Ilx1OGZkMFx1N2VmNFx1NTQ5Nlx1NTU2MVx1NTQyNyIsInNpdGUiOiJodHRwczovL29wcy1jb2ZmZWUuY24ifQ==')
# è¿™é‡Œæœ€ååŠ =çš„åŸå› æ˜¯base64è§£ç å¯¹ä¼ å…¥çš„å‚æ•°é•¿åº¦ä¸æ˜¯2çš„å¯¹è±¡ï¼Œéœ€è¦å†å‚æ•°æœ€ååŠ ä¸Šä¸€ä¸ªæˆ–ä¸¤ä¸ªç­‰å·=</code></pre>


<p>å› ä¸ºJWTä¸ä¼šå¯¹ç»“æœè¿›è¡ŒåŠ å¯†ï¼Œæ‰€ä»¥ä¸è¦ä¿å­˜æ•æ„Ÿä¿¡æ¯åœ¨Headeræˆ–è€…Payloadä¸­ï¼ŒæœåŠ¡ç«¯ä¹Ÿä¸»è¦ä¾é æœ€åçš„Signatureæ¥éªŒè¯Tokenæ˜¯å¦æœ‰æ•ˆä»¥åŠæœ‰æ— è¢«ç¯¡æ”¹</p>
<h5 id="token_1">è§£å¯†Token</h5>
<pre class="codehilite"><code>&gt;&gt;&gt; jwt.decode(encoded_jwt,'secret_key',algorithms=['HS256'])
{'username': 'è¿ç»´å’–å•¡å§', 'site': 'https://ops-coffee.com'}</code></pre>


<p>æœåŠ¡ç«¯åœ¨æœ‰ç§˜é’¥çš„æƒ…å†µä¸‹å¯ä»¥ç›´æ¥å¯¹JWTç”Ÿæˆçš„Tokenè¿›è¡Œè§£å¯†ï¼Œè§£å¯†æˆåŠŸè¯´æ˜Tokenæ­£ç¡®ï¼Œä¸”æ•°æ®æ²¡æœ‰è¢«ç¯¡æ”¹</p>
<p>å½“ç„¶æˆ‘ä»¬å‰æ–‡è¯´äº†JWTå¹¶æ²¡æœ‰å¯¹æ•°æ®è¿›è¡ŒåŠ å¯†ï¼Œå¦‚æœæ²¡æœ‰secret_keyä¹Ÿå¯ä»¥ç›´æ¥è·å–åˆ°Payloadé‡Œè¾¹çš„æ•°æ®ï¼Œåªæ˜¯ç¼ºå°‘äº†ç­¾åç®—æ³•æ— æ³•éªŒè¯æ•°æ®æ˜¯å¦å‡†ç¡®ï¼Œpyjwtä¹Ÿæä¾›äº†ç›´æ¥è·å–Payloadæ•°æ®çš„æ–¹æ³•ï¼Œå¦‚ä¸‹</p>
<pre class="codehilite"><code>&gt;&gt;&gt; jwt.decode(encoded_jwt, verify=False)
{'username': 'è¿ç»´å’–å•¡å§', 'site': 'https://ops-coffee.com'}</code></pre>


<h1 id="django">Djangoæ¡ˆä¾‹</h1>
<p>Djangoè¦å…¼å®¹sessionè®¤è¯çš„æ–¹å¼ï¼Œè¿˜éœ€è¦åŒæ—¶æ”¯æŒJWTï¼Œå¹¶ä¸”ä¸¤ç§éªŒè¯éœ€è¦å…±ç”¨åŒä¸€å¥—æƒé™ç³»ç»Ÿï¼Œè¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥å‚è€ƒDjangoçš„è§£å†³æ–¹æ¡ˆï¼šè£…é¥°å™¨ï¼Œä¾‹å¦‚ç”¨æ¥æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•çš„<code>login_required</code>å’Œç”¨æ¥æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™çš„<code>permission_required</code>ä¸¤ä¸ªè£…é¥°å™¨ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±å®ç°ä¸€ä¸ªè£…é¥°å™¨ï¼Œæ£€æŸ¥ç”¨æˆ·çš„è®¤è¯æ¨¡å¼ï¼ŒåŒæ—¶è®¤è¯å®ŒæˆåéªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰æƒé™æ“ä½œ</p>
<p>äºæ˜¯ä¸€ä¸ª<code>auth_permission_required</code>çš„è£…é¥°å™¨äº§ç”Ÿäº†ï¼š</p>
<pre class="codehilite"><code>from django.conf import settings
from django.http import JsonResponse
from django.contrib.auth import get_user_model
from django.core.exceptions import PermissionDenied

UserModel = get_user_model()


def auth_permission_required(perm):
    def decorator(view_func):
        def _wrapped_view(request, *args, **kwargs):
            # æ ¼å¼åŒ–æƒé™
            perms = (perm,) if isinstance(perm, str) else perm

            if request.user.is_authenticated:
                # æ­£å¸¸ç™»å½•ç”¨æˆ·åˆ¤æ–­æ˜¯å¦æœ‰æƒé™
                if not request.user.has_perms(perms):
                    raise PermissionDenied
            else:
                try:
                    auth = request.META.get('HTTP_AUTHORIZATION').split()
                except AttributeError:
                    return JsonResponse({&quot;code&quot;: 401, &quot;message&quot;: &quot;No authenticate header&quot;})

                # ç”¨æˆ·é€šè¿‡APIè·å–æ•°æ®éªŒè¯æµç¨‹
                if auth[0].lower() == 'token':
                    try:
                        dict = jwt.decode(auth[1], settings.SECRET_KEY, algorithms=['HS256'])
                        username = dict.get('data').get('username')
                    except jwt.ExpiredSignatureError:
                        return JsonResponse({&quot;status_code&quot;: 401, &quot;message&quot;: &quot;Token expired&quot;})
                    except jwt.InvalidTokenError:
                        return JsonResponse({&quot;status_code&quot;: 401, &quot;message&quot;: &quot;Invalid token&quot;})
                    except Exception as e:
                        return JsonResponse({&quot;status_code&quot;: 401, &quot;message&quot;: &quot;Can not get user object&quot;})

                    try:
                        user = UserModel.objects.get(username=username)
                    except UserModel.DoesNotExist:
                        return JsonResponse({&quot;status_code&quot;: 401, &quot;message&quot;: &quot;User Does not exist&quot;})

                    if not user.is_active:
                        return JsonResponse({&quot;status_code&quot;: 401, &quot;message&quot;: &quot;User inactive or deleted&quot;})

                    # Tokenç™»å½•çš„ç”¨æˆ·åˆ¤æ–­æ˜¯å¦æœ‰æƒé™
                    if not user.has_perms(perms):
                        return JsonResponse({&quot;status_code&quot;: 403, &quot;message&quot;: &quot;PermissionDenied&quot;})
                else:
                    return JsonResponse({&quot;status_code&quot;: 401, &quot;message&quot;: &quot;Not support auth type&quot;})

            return view_func(request, *args, **kwargs)

        return _wrapped_view

    return decorator</code></pre>


<p>åœ¨viewä½¿ç”¨æ—¶å°±å¯ä»¥ç”¨è¿™ä¸ªè£…é¥°å™¨æ¥ä»£æ›¿åŸæœ¬çš„<code>login_required</code>å’Œ<code>permission_required</code>è£…é¥°å™¨äº†</p>
<pre class="codehilite"><code>@auth_permission_required('account.select_user')
def user(request):
    if request.method == 'GET':
        _jsondata = {
            &quot;user&quot;: &quot;ops-coffee&quot;,
            &quot;site&quot;: &quot;https://ops-coffee.com&quot;
        }

        return JsonResponse({&quot;state&quot;: 1, &quot;message&quot;: _jsondata})
    else:
        return JsonResponse({&quot;state&quot;: 0, &quot;message&quot;: &quot;Request method 'POST' not supported&quot;})</code></pre>


<p>æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªç”Ÿæˆç”¨æˆ·Tokençš„æ–¹æ³•ï¼Œé€šè¿‡ç»™User modelæ·»åŠ ä¸€ä¸ªtokençš„é™æ€æ–¹æ³•æ¥å¤„ç†</p>
<pre class="codehilite"><code>class User(AbstractBaseUser, PermissionsMixin):
    create_time = models.DateTimeField(auto_now_add=True, verbose_name='åˆ›å»ºæ—¶é—´')
    update_time = models.DateTimeField(auto_now=True, verbose_name='æ›´æ–°æ—¶é—´')
    username = models.EmailField(max_length=255, unique=True, verbose_name='ç”¨æˆ·å')
    fullname = models.CharField(max_length=64, null=True, verbose_name='ä¸­æ–‡å')
    phonenumber = models.CharField(max_length=16, null=True, unique=True, verbose_name='ç”µè¯')
    is_active = models.BooleanField(default=True, verbose_name='æ¿€æ´»çŠ¶æ€')

    objects = UserManager()

    USERNAME_FIELD = 'username'
    REQUIRED_FIELDS = []

    def __str__(self):
        return self.username

    @property
    def token(self):
        return self._generate_jwt_token()

    def _generate_jwt_token(self):
        token = jwt.encode({
            'exp': datetime.utcnow() + timedelta(days=1),
            'iat': datetime.utcnow(),
            'data': {
                'username': self.username
            }
        }, settings.SECRET_KEY, algorithm='HS256')

        return token.decode('utf-8')

    class Meta:
        default_permissions = ()

        permissions = (
            (&quot;select_user&quot;, &quot;æŸ¥çœ‹ç”¨æˆ·&quot;),
            (&quot;change_user&quot;, &quot;ä¿®æ”¹ç”¨æˆ·&quot;),
            (&quot;delete_user&quot;, &quot;åˆ é™¤ç”¨æˆ·&quot;),
        )</code></pre>


<p>å¯ä»¥ç›´æ¥é€šè¿‡ç”¨æˆ·å¯¹è±¡æ¥ç”ŸæˆTokenï¼š</p>
<pre class="codehilite"><code>&gt;&gt;&gt; from accounts.models import User
&gt;&gt;&gt; u = User.objects.get(username='admin@ops-coffee.com')
&gt;&gt;&gt; u.token
'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE1NDgyMjg3NzksImlhdCI6MTU0ODE0MjM3OSwiZGF0YSI6eyJ1c2VybmFtZSI6ImFkbWluQDE2My5jb20ifX0.akZNU7t_z2kwPxDJjmc-QxtNdICK0yhnwWmKxqqXKLw'</code></pre>


<p>ç”Ÿæˆçš„Tokenç»™åˆ°å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥æ‹¿è¿™ä¸ªTokenè¿›è¡Œé‰´æƒäº†</p>
<pre class="codehilite"><code>&gt;&gt;&gt; import requests
&gt;&gt;&gt; token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE1NDgyMjg4MzgsImlhdCI6MTU0ODE0MjQzOCwiZGF0YSI6eyJ1c2VybmFtZSI6ImFkbWluQDE2My5jb20ifX0.oKc0SafgksMT9ZIhTACupUlz49Q5kI4oJA-B8-GHqLA'
&gt;&gt;&gt;
&gt;&gt;&gt; r = requests.get('http://localhost/api/user', headers={'Authorization': 'Token '+token})
&gt;&gt;&gt; r.json()
{'username': 'admin@ops-coffee.com', 'fullname': 'è¿ç»´å’–å•¡å§', 'is_active': True}</code></pre>


<p>è¿™æ ·ä¸€ä¸ª<code>auth_permission_required</code>æ–¹æ³•å°±å¯ä»¥æå®šä¸Šè¾¹çš„å…¨éƒ¨éœ€æ±‚äº†ï¼Œç®€å•å¥½ç”¨ã€‚</p>

        <div>
          <ul class="article-meta">
            <li><a href="/s/django-api-auth-jwt-token-without-drf.html">ğŸ“… 2019-01-22</a></li>
<li><a href="/tag/Django/">ğŸ·ï¸ Django</a></li><li><a href="/tag/å…³äºæŠ€æœ¯/">ğŸ·ï¸ å…³äºæŠ€æœ¯</a></li>          </ul>
        </div>

        <hr>

        <div class="pagination">
            <a href="https://blog.ops-coffee.com/s/optimizing-continuous-deployment-with-docker.html" class="pagination-item prev-page">
                <span class="pagination-arrow">â†</span>
                <span class="pagination-text">ä¸Šä¸€ç¯‡ï¼š<br>Dockerç¯å¢ƒçš„æŒç»­éƒ¨ç½²ä¼˜åŒ–å®è·µ</span>
            </a>
            <a href="https://blog.ops-coffee.com/s/markdown-editor-md-integration.html" class="pagination-item next-page">
                <span class="pagination-text">ä¸‹ä¸€ç¯‡ï¼š<br>Djangoé›†æˆMarkdownç¼–è¾‘å™¨ã€é™„æºç ã€‘</span>
                <span class="pagination-arrow">â†’</span>
            </a>
        </div>

        <div>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8944257246828217"
         data-ad-slot="6731434232" data-ad-format="auto" data-full-width-responsive="true"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
</div>

<div class="nav-cell">
    <script async src="https://giscus.app/client.js"
            data-repo="ops-coffee/blog" data-repo-id="MDEwOlJlcG9zaXRvcnkxNDY4OTI0MTg="
            data-category="Announcements" data-category-id="DIC_kwDOCMFmgs4CQar3"
            data-mapping="pathname" data-strict="0" data-reactions-enabled="1"
            data-emit-metadata="0" data-input-position="top" data-theme="light"
            data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous">
    </script>
</div>

        <div class="nav-cell">
    <p class="nav-list-title">èƒ½çœ‹åˆ°è¿™é‡Œä¸€å®šæ˜¯çœŸçˆ±ï¼Œè®¢é˜…ä¸€ä¸‹å§</p>
    <img alt="" loading="lazy" src="/static/images/wx.sou1.png" />
</div>

    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="copy"> Â© ops-coffee</div>

      <div class="link">
        <a href="/comments.html" title="ç»™æˆ‘ç•™è¨€" target="_blank">ç•™è¨€</a>
        <a href="/friends.html" title="å‹æƒ…é“¾æ¥" target="_blank">å‹é“¾</a>
      </div>
    </div>
  </footer>
  
  <!-- Umami -->
<script defer src="https://umami.ops-coffee.cn/script.js" data-website-id="248e61f0-c324-444e-a56d-bf97ee44a8fc"></script>

<!-- Google Adsense -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8944257246828217" crossorigin="anonymous"></script>
</body>
</html>