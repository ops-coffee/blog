<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="applicable-device" content="pc,mobile">
  <meta name="keywords" content="å·¥å•é€šçŸ¥, Django2.0, signals, Python, å·¥å•çŠ¶æ€å˜æ›´" />
  <meta name="description" content="æœ¬æ–‡ä»‹ç»äº†åœ¨å®ç°å·¥å•é€šçŸ¥è¿‡ç¨‹ä¸­çš„ä¸€äº›ä¼˜åŒ–æŠ€å·§ï¼ŒåŒ…æ‹¬å¦‚ä½•åˆ©ç”¨Pythonçš„ifè¯­å¥ç®€åŒ–ä»£ç ï¼Œé€šè¿‡Djangoçš„signalsæœºåˆ¶å®ç°çŠ¶æ€å˜æ›´é€šçŸ¥çš„è‡ªåŠ¨åŒ–ï¼Œä»¥åŠå¦‚ä½•æé«˜ä»£ç çš„å¯è¯»æ€§å’Œç»´æŠ¤æ€§ã€‚" />
  <link rel="alternate" type="application/rss+xml" title="è¿ç»´å’–å•¡å§" href="https://blog.ops-coffee.cn/feed.xml" />
  <link rel="stylesheet" href="https://blog.ops-coffee.cn/static/posts/css/ops-coffee.min.css" type="text/css" />

  <!-- Begin SEO tag -->
  <title>Djangoä½¿ç”¨Signalsç›‘æµ‹modelå­—æ®µå˜åŒ–å‘é€é€šçŸ¥</title>
  <meta property="og:locale" content="zh_CN" />
  <meta property="og:site_name" content="è¿ç»´å’–å•¡å§" />
  <meta property="og:url" content="https://blog.ops-coffee.cn" />
  <meta property="og:title" content="Djangoä½¿ç”¨Signalsç›‘æµ‹modelå­—æ®µå˜åŒ–å‘é€é€šçŸ¥" />
  <meta property="og:description" content="æœ¬æ–‡ä»‹ç»äº†åœ¨å®ç°å·¥å•é€šçŸ¥è¿‡ç¨‹ä¸­çš„ä¸€äº›ä¼˜åŒ–æŠ€å·§ï¼ŒåŒ…æ‹¬å¦‚ä½•åˆ©ç”¨Pythonçš„ifè¯­å¥ç®€åŒ–ä»£ç ï¼Œé€šè¿‡Djangoçš„signalsæœºåˆ¶å®ç°çŠ¶æ€å˜æ›´é€šçŸ¥çš„è‡ªåŠ¨åŒ–ï¼Œä»¥åŠå¦‚ä½•æé«˜ä»£ç çš„å¯è¯»æ€§å’Œç»´æŠ¤æ€§ã€‚" />
  <link rel="canonical" href="https://blog.ops-coffee.cn" />
  <!-- End SEO tag -->
</head>

<body>
  <div class="header">
    <div class="menu-button">&#9776; 
        <span class="menu-title">è¿ç»´å’–å•¡å§</span>
    </div> 

    <div class="container no-sidebar">
      <nav class="header-site">
        <ul>
          <li><a href="/">é¦–é¡µ</a></li>
            <li class="has-submenu">
              <a href="#" target="_self">è¿ç»´</a>
              <ul class="sub-menu">
                <li><a href="/tag/ç³»ç»Ÿè¿ç»´/" target="_self">ç³»ç»Ÿè¿ç»´</a></li>
                <li><a href="/elk/index.html" target="_self">ELKç³»åˆ—</a></li>
                <li><a href="/ldap/index.html" target="_self">LDAPç³»åˆ—</a></li>
              </ul>
            </li>
            <li class="has-submenu">
              <a href="#" target="_self">å¼€å‘</a>
              <ul class="sub-menu">
                <li><a href="/tag/Devops/" target="_self">DevOps</a></li>
                <li><a href="/tag/Python/" target="_self">Python</a></li>
                <li><a href="/tag/Django/" target="_self">Django</a></li>
                <li><a href="/bpmn/index.html" target="_self">BPMNç³»åˆ—</a></li>
                <li><a href="/webssh/index.html" target="_self">WebSSHç³»åˆ—</a></li>
                <li><a href="/frontend/index.html" target="_self">å‰ç«¯å¼€å‘ç³»åˆ—</a></li>
              </ul>
            </li>
            <li><a href="/devops/index.html" target="_self">è¿ç»´å¹³å°</a></li>
            <li><a href="/tag/è¿™æ˜¯ç”Ÿæ´»/" target="_self">è¿™æ˜¯ç”Ÿæ´»</a></li>
            <li class="has-submenu">
              <a href="#" target="_self">æˆ¿è½¦æ—…è¡Œ</a>
              <ul class="sub-menu">
                <li><a href="/rv.html" target="_self">æˆ¿è½¦ä½“éªŒ</a></li>
                <li><a href="/travels.html" target="_self">æ—…è¡Œæ¸¸è®°</a></li>
                <li><a href="/travel/china.html" target="_self">æ—…è¡Œåœ°å›¾</a></li>
              </ul>
            </li>
            <li><a href="/tag/index.html" target="_self">æ ‡ç­¾</a></li>
            <li><a href="/archive.html" target="_self">å½’æ¡£</a></li>
          <li class="search"><a href="/search.html" target="_self">ğŸ”</a></li>
        </ul>
      </nav>
    </div>
  </div>

  <header>
    <div class="container no-sidebar">
      <a href="/">
        <div class="name">è¿ç»´å’–å•¡å§</div>
        <div class="slogan">äº«å—æŠ€æœ¯å¸¦æ¥çš„ä¹è¶£ï¼Œä½“éªŒç”Ÿæ´»ç»™äºˆçš„æ„ŸåŠ¨</div>
      </a>
    </div>
  </header>

  <div id="content-wrap">
    <div class="container no-sidebar">
        <h1 id="art-title">Djangoä½¿ç”¨Signalsç›‘æµ‹modelå­—æ®µå˜åŒ–å‘é€é€šçŸ¥</h1>

        <blockquote>
<p>ä¸Šä¸€ç¯‡æ–‡ç« <a href="/s/6ztLq8Q591KnlQY33-YFdQ" target="_blank">ã€Šè¿ç»´æ•ˆç‡ä¹‹æ•°æ®è¿ç§»è‡ªåŠ¨åŒ–ã€‹</a>ä¸­è®²åˆ°äº†å·¥å•é€šçŸ¥ï¼Œæœ¬æ–‡å°†ä»‹ç»å·¥å•é€šçŸ¥å®ç°è¿‡ç¨‹ä¸­çš„ä¸€äº›å°æŠ€å·§ã€‚æ‰€æœ‰æ¼”ç¤ºå‡åŸºäºDjango2.0</p>
</blockquote>
<p>é˜…è¯»æ­¤ç¯‡æ–‡ç« ä½ å¯ä»¥ï¼š</p>
<ul>
<li>è§£é”ä¸€ä¸ªpython ifçš„ä½¿ç”¨æ–°å§¿åŠ¿</li>
<li>è·å–ä¸€ä¸ªåˆ©ç”¨signalsåšé€šçŸ¥çš„çœŸå®æ¡ˆä¾‹</li>
</ul>
<h1 id="_1">èƒŒæ™¯è¯´æ˜</h1>
<p>å…ˆçœ‹çœ‹å·¥å•è¡¨ç®€åŒ–åçš„ç»“æ„</p>
<pre class="codehilite"><code>class Ticket(models.Model):
    '''å·¥å•è¡¨'''

    STATE = (
        (1, 'å¾…å®¡æ‰¹'),
        (2, 'å·²æ’¤é”€'),
        (3, 'å·²é€šè¿‡'),
        (4, 'è¢«æ‹’ç»'),
        (5, 'å·²æŒ‚èµ·'),
        (6, 'æ‰§è¡Œä¸­'),
        (7, 'å·²å®Œæˆ'),
        (8, 'å·²å¤±è´¥')
    )

    create_time = models.DateTimeField(auto_now_add=True, verbose_name='åˆ›å»ºæ—¶é—´')
    create_user = models.ForeignKey(User, on_delete=models.DO_NOTHING, verbose_name='åˆ›å»ºç”¨æˆ·')

    state = models.IntegerField(choices=STATE, default=1, verbose_name='å·¥å•çŠ¶æ€')</code></pre>


<p>Ticketå·¥å•è¡¨æœ‰ä¸€ä¸ªstateå­—æ®µæ ‡è¯†å½“å‰å·¥å•çŠ¶æ€ï¼Œè¿™ä¸ªçŠ¶æ€ä¼šéšç€å·¥å•çš„è¿›è¡Œè€Œæ”¹å˜ï¼Œæ¯å½“å·¥å•çŠ¶æ€æ”¹å˜æ—¶å°±éœ€è¦å‘é€é€šçŸ¥ç»™ç›¸åº”çš„ç”¨æˆ·ï¼Œä¾‹å¦‚å·¥å•åˆ›å»ºæ—¶ï¼Œéœ€è¦å‘é€ç»™åˆ›å»ºè€…ä¸€ä¸ªå·¥å•åˆ›å»ºæˆåŠŸçš„é€šçŸ¥ï¼ŒåŒæ—¶å‘é€ç»™å®¡æ ¸è€…ä¸€ä¸ªå¾…å®¡æ ¸çš„é€šçŸ¥</p>
<h1 id="_2">é€šçŸ¥</h1>
<p>æ¯ä¸€ä¸ªçŠ¶æ€çš„å˜åŒ–éƒ½éœ€è¦é€šçŸ¥ï¼Œä¸ºäº†ä»£ç æ˜“è¯»åŠè§£è€¦ï¼Œæˆ‘ä»¬éœ€è¦å†™ä¸€ä¸ªå•ç‹¬çš„é€šçŸ¥ç±»ï¼Œå½“éœ€è¦é€šçŸ¥çš„æ—¶å€™è°ƒç”¨ä¸€ä¸‹å°±å¥½äº†ã€‚é€šçŸ¥ç±»ä¸­éœ€è¦åˆ¤æ–­å½“å‰å·¥å•çš„çŠ¶æ€ï¼Œé‚£ä¹ˆé€šå¸¸ä¼šå†™æˆä¸‹è¾¹è¿™æ ·</p>
<pre class="codehilite"><code>class Notify:
    def __init__(self):
        self.dba_list = [&quot;dba1@ops-coffee.cn&quot;, &quot;dba2@ops-coffee.cn&quot;]

    def migration(self, pk):
        '''è¿ç§»é€šçŸ¥'''

        _t = Ticket.objects.get(id=pk)
        _u = _t.create_user.username
        _s = _t.state

        _d = &quot;https://ops-coffee.cn/workflow/migration/%d/&quot; % (_t.id)

        if _s == 1:
            try:
                Email(
                    subject=&quot;[å·²æäº¤]-[overmind]æ•°æ®è¿ç§»å·¥å•&quot;,
                    content=&quot;ä½ çš„æ•°æ®è¿ç§»å·¥å•å·²æäº¤ï¼Œæ­£åœ¨ç­‰å¾…DBAå®¡æ‰¹ï¼Œåç»­æœ‰çŠ¶æ€å˜æ›´å°†ä¼šè‡ªåŠ¨é€šçŸ¥ä½ ã€‚\r\n\r\nå·¥å•è¯¦æƒ…ï¼š%s&quot; % _d,
                    reciever_list=[_u]
                )
            except Exception as e:
                print('Error:' + str(e))

            try:
                Email(
                    subject=&quot;[å¾…å®¡æ‰¹]-[overmind]æ•°æ®è¿ç§»å·¥å•&quot;,
                    content=&quot;ä½ æœ‰å·¥å•éœ€è¦å®¡æ‰¹ï¼Œç‚¹å‡»ä¸‹æ–¹å·¥å•è¯¦æƒ…é“¾æ¥åŠæ—¶å®¡æ‰¹ã€‚\r\n\r\nå·¥å•è¯¦æƒ…ï¼š%s&quot; % _d,
                    reciever_list=self.dba_list
                )
            except Exception as e:
                print('Error:' + str(e))
        elif _s == 6:
            try:
                Email(
                    subject=&quot;[æ‰§è¡Œä¸­]-[overmind]æ•°æ®è¿ç§»å·¥å•&quot;,
                    content=&quot;æ•°æ®è¿ç§»å·¥å•å·²é€šè¿‡DBAå®¡æ ¸ï¼Œæ­£åœ¨æ‰§è¡Œä¸­ï¼Œåç»­æœ‰çŠ¶æ€å˜æ›´å°†ä¼šè‡ªåŠ¨é€šçŸ¥ä½ ã€‚\r\n\r\nå·¥å•è¯¦æƒ…ï¼š%s&quot; % _d,
                    reciever_list=[_u] + self.dba_list,
                )
            except Exception as e:
                print('Error:' + str(e))
        elif _s == 7:
            try:
                Email(
                    subject=&quot;[å·²å®Œæˆ]-[overmind]æ•°æ®è¿ç§»å·¥å•&quot;,
                    content=&quot;æ•°æ®è¿ç§»å·¥å•å·²è‡ªåŠ¨å®Œæˆè¿ç§»ï¼Œè¯·æ£€æŸ¥æœ€ç»ˆçŠ¶æ€ï¼Œå¦‚æœ‰ä»»ä½•ç–‘é—®éšæ—¶è”ç³»DBAã€‚\r\n\r\nå·¥å•è¯¦æƒ…ï¼š%s&quot; % _d,
                    reciever_list=[_u] + self.dba_list,
                )
            except Exception as e:
                print('Error:' + str(e))</code></pre>


<p>ä»¥ä¸Šçš„ä»£ç å¯ä»¥çœ‹å‡ºæ¥å†™äº†å¾ˆå¤šé‡å¤çš„tryä»£ç ï¼Œå¹¶ä¸”å½“çŠ¶æ€è¶Šå¤šï¼Œifåˆ¤æ–­è¶Šå¤æ‚æ—¶é‡å¤çš„ä»£ç ä¹Ÿä¼šè¶Šæ¥è¶Šå¤šï¼Œæœ‰æ²¡æœ‰æ›´ç®€æ´çš„æ–¹å¼å‘¢ï¼Ÿ</p>
<p>çœ‹çœ‹ä¸‹è¾¹çš„ä»£ç ï¼Œç»´æŠ¤ä¸€ä¸ªçŠ¶æ€å­—å…¸ï¼Œç„¶åç”¨ä¸€ä¸ªifåˆ¤æ–­å°±å¯ä»¥å®ç°ä¸Šè¾¹ä¸€å †ifçš„ä»£ç å†™æ³•ï¼Œæ˜¯ä¸æ˜¯å°±ç®€æ´äº†å¾ˆå¤š</p>
<pre class="codehilite"><code>class Notify:
    def __init__(self):
        self.dba_list = [&quot;dba1@ops-coffee.cn&quot;, &quot;dba2@ops-coffee.cn&quot;]

    def migration(self, pk):
        '''è¿ç§»é€šçŸ¥'''

        _t = Ticket.objects.get(id=pk)
        _u = _t.create_user.username
        _s = _t.state

        _d = &quot;https://ops-coffee.cn/workflow/migration/%d/&quot; %(_t.id)
        smap = {
            1: [{
                &quot;subject&quot;: &quot;[å·²æäº¤]-[overmind]æ•°æ®è¿ç§»å·¥å•&quot;,
                &quot;content&quot;: &quot;ä½ çš„æ•°æ®è¿ç§»å·¥å•å·²æäº¤ï¼Œæ­£åœ¨ç­‰å¾…DBAå®¡æ‰¹ï¼Œåç»­æœ‰çŠ¶æ€å˜æ›´å°†ä¼šè‡ªåŠ¨é€šçŸ¥ä½ ã€‚\r\n\r\nå·¥å•è¯¦æƒ…ï¼š%s&quot; %_d,
                &quot;reciever_list&quot;: [_u],
            }, {
                &quot;subject&quot;: &quot;[å¾…å®¡æ‰¹]-[overmind]æ•°æ®è¿ç§»å·¥å•&quot;,
                &quot;content&quot;: &quot;ä½ æœ‰å·¥å•éœ€è¦å®¡æ‰¹ï¼Œç‚¹å‡»ä¸‹æ–¹å·¥å•è¯¦æƒ…é“¾æ¥åŠæ—¶å®¡æ‰¹ã€‚\r\n\r\nå·¥å•è¯¦æƒ…ï¼š%s&quot; %_d,
                &quot;reciever_list&quot;: self.dba_list,
            }],
            6: [{
                &quot;subject&quot;: &quot;[æ‰§è¡Œä¸­]-[overmind]æ•°æ®è¿ç§»å·¥å•&quot;,
                &quot;content&quot;: &quot;æ•°æ®è¿ç§»å·¥å•å·²é€šè¿‡DBAå®¡æ ¸ï¼Œæ­£åœ¨æ‰§è¡Œä¸­ï¼Œåç»­æœ‰çŠ¶æ€å˜æ›´å°†ä¼šè‡ªåŠ¨é€šçŸ¥ä½ ã€‚\r\n\r\nå·¥å•è¯¦æƒ…ï¼š%s&quot; %_d,
                &quot;reciever_list&quot;: [_u] + self.dba_list,
            }],
            7: [{
                &quot;subject&quot;: &quot;[å·²å®Œæˆ]-[overmind]æ•°æ®è¿ç§»å·¥å•&quot;,
                &quot;content&quot;: &quot;æ•°æ®è¿ç§»å·¥å•å·²è‡ªåŠ¨å®Œæˆè¿ç§»ï¼Œè¯·æ£€æŸ¥æœ€ç»ˆçŠ¶æ€ï¼Œå¦‚æœ‰ä»»ä½•ç–‘é—®éšæ—¶è”ç³»DBAã€‚\r\n\r\nå·¥å•è¯¦æƒ…ï¼š%s&quot; %_d,
                &quot;reciever_list&quot;: [_u] + self.dba_list,
            }]
        }

        _list = smap[_s]
        for i in range(0, len(_list)):
            try:
                Email(
                    subject=_list[i]['subject'], 
                    content=_list[i]['content'], 
                    reciever_list=_list[i]['reciever_list']
                )
            except Exception as e:
                print('Error:' +str(e))</code></pre>


<p>åœ¨æ„é€ å­—å…¸çš„æ—¶å€™é‡‡ç”¨äº†çŠ¶æ€åškeyï¼Œé€šçŸ¥å˜é‡åšvalueï¼ŒåŒæ—¶ä¸€ä¸ªçŠ¶æ€å¯èƒ½ä¼šäº§ç”Ÿå¤šä¸ªä¸åŒçš„é€šçŸ¥ï¼Œæ‰€ä»¥valueé‡‡ç”¨åˆ—è¡¨çš„æ–¹å¼ï¼Œè¿™æ ·å³å¯è½»æ¾å®ç°ä¸€ä¸ªçŠ¶æ€å¤šæ¡é€šçŸ¥ï¼Œæ¯æ¡é€šçŸ¥éƒ½å¯ä»¥å‘ç»™ä¸åŒçš„äººï¼Œæœ‰ä¸åŒçš„ä¸»é¢˜ï¼Œä¸åŒçš„å†…å®¹ã€‚</p>
<h1 id="signals">Signals</h1>
<p>ä¸Šè¾¹æˆ‘ä»¬å·²ç»å†™å¥½äº†å‘é€é€šçŸ¥çš„ç±»ï¼Œåœ¨viewé‡Œæ¯æ¬¡ä¿®æ”¹å·¥å•çŠ¶æ€ä¹‹åè°ƒç”¨ä¸‹é€šçŸ¥ç±»å³å¯å®ç°é€šçŸ¥å‘é€ï¼Œä½†è¿™æ ·é€šçŸ¥è·Ÿviewå¼ºè€¦åˆï¼Œä¸”é€šçŸ¥ä¼šåˆ†æ•£åœ¨viewä¸­çš„å¤šä¸ªåœ°æ–¹ï¼Œé€ æˆä»£ç å†—ä½™ä¸”ä¸å¤Ÿä¼˜é›…ã€‚æˆ‘ä»¬éœ€è¦ä¸€ä¸ªç®€å•ä¼˜é›…çš„æ–¹å¼æ¥å®ç°ï¼Œsignalså¯ä»¥è¯´æ˜¯éå¸¸æœ‰ç”¨äº†</p>
<p>Signalsæ˜¯Djangoè‡ªå¸¦çš„ä¸€ä¸ªä¿¡å·è°ƒåº¦ç¨‹åºã€‚å¦‚æœä½ å¯¹svnæˆ–è€…gitä¹‹ç±»çš„hooksæœ‰äº†è§£ï¼Œè¿™ä¸ªç†è§£èµ·æ¥å°±ç®€å•å¤šäº†ï¼Œé€šä¿—æ¥è¯´å°±æ˜¯å½“ä½ çš„ç¨‹åºäº§ç”Ÿä¸€ä¸ªäº‹ä»¶æ—¶ï¼Œä¼šé€šè¿‡signalsè‡ªåŠ¨è§¦å‘å…¶ä»–çš„äº‹ä»¶ã€‚å°±æ¯”å¦‚æˆ‘ä»¬è¿™ä¸ªå·¥å•ç³»ç»Ÿé€šçŸ¥ï¼Œå½“å·¥å•çŠ¶æ€äº§ç”Ÿå˜åŒ–æ—¶è‡ªåŠ¨å‘é€é‚®ä»¶ç»™ç›¸å…³äººã€‚</p>
<p>Djangoå†…éƒ¨å·²ç»å®šä¹‰å¥½äº†ä¸€äº›signalä¾›æˆ‘ä»¬ä½¿ç”¨ï¼Œå¦‚æœä¸èƒ½æ»¡è¶³æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå®šä¹‰signalï¼Œå…¶ä¸­Djangoå†…éƒ¨å®šä¹‰çš„signalä¸»è¦åˆ†ä¸ºå‡ ç±»</p>
<ol>
<li>
<p>model signals</p>
<ul>
<li><code>pre_init</code>ï¼šmodelåˆå§‹åŒ–å‰è§¦å‘</li>
<li><code>post_init</code>ï¼šmodelåˆå§‹åŒ–åè§¦å‘</li>
<li><code>pre_save</code>ï¼šsave()æ–¹æ³•å‰è§¦å‘</li>
<li><code>post_save</code>ï¼šsave()æ–¹æ³•åè§¦å‘</li>
<li><code>pre_delete</code>ï¼šdelete()æ–¹æ³•å‰è§¦å‘</li>
<li><code>post_delete</code>ï¼šdelete()æ–¹æ³•åè§¦å‘</li>
<li><code>m2m_changed</code>ï¼šManyToManyFieldå­—æ®µæ”¹å˜æ—¶è§¦å‘</li>
<li><code>class_prepared</code>ï¼šæ²¡ç”¨è¿‡å­—é¢æ„æ€ç†è§£å§</li>
</ul>
</li>
<li>
<p>management signals</p>
<ul>
<li><code>pre_migrate</code>ï¼šmigrateä¹‹å‰è§¦å‘</li>
<li><code>post_migrate</code>ï¼šmigrateä¹‹åè§¦å‘</li>
</ul>
</li>
<li>
<p>request/response signals</p>
<ul>
<li><code>request_started</code>ï¼šè¯·æ±‚å¼€å§‹æ—¶è§¦å‘</li>
<li><code>request_finished</code>ï¼šè¯·æ±‚å®Œæˆåè§¦å‘</li>
<li><code>got_request_exception</code>ï¼šè¯·æ±‚å¼‚å¸¸æ—¶è§¦å‘</li>
</ul>
</li>
<li>
<p>test signals</p>
<ul>
<li><code>setting_changed</code>ï¼šé…ç½®æ”¹å˜æ—¶è§¦å‘</li>
<li><code>template_rendered</code>ï¼šæ¨¡æ¿æ¸²æŸ“æ—¶è§¦å‘</li>
</ul>
</li>
<li>
<p>Database Wrappers</p>
<ul>
<li><code>connection_created</code>ï¼šè¿æ¥å»ºç«‹æ—¶è§¦å‘</li>
</ul>
</li>
</ol>
<p>é‚£ä¹ˆä¿¡å·ç©¶ç«Ÿè¯¥å¦‚ä½•ä½¿ç”¨å‘¢ï¼Ÿä¸‹è¾¹ä¸€ä¸ªå®é™…çš„ä¾‹å­æ¥è¯´æ˜ä¸‹ä¿¡å·çš„ä½¿ç”¨</p>
<p>å°±ä»¥æˆ‘ä»¬å‘é€é€šçŸ¥çš„éœ€æ±‚ä¸ºä¾‹ï¼Œworkflowæ˜¯ä¸€ä¸ªæ™®é€šçš„appï¼Œç¬¬ä¸€æ­¥éœ€è¦æ–°å»º<code>workflow/signals.py</code>æ–‡ä»¶ç»‘å®šsignal</p>
<pre class="codehilite"><code>from django.db.models import signals
from django.dispatch import receiver

from workflow.models import Ticket
from workflow.backends.notify import Notify


@receiver(signals.post_init, sender=Ticket)
def migrate_notify_init(instance, **kwargs):
    instance.old_state = instance.state


@receiver(signals.post_save, sender=Ticket)
def migrate_notify_post(instance, created, **kwargs):
    if created or instance.old_state != instance.state:
        Notify().migration(instance.id)</code></pre>


<p>è¿™é‡Œç”¨åˆ°äº†ä¸¤ä¸ªsignalï¼Œ<code>post_init</code>å’Œ<code>post_save</code></p>
<p>åœ¨modelåˆå§‹åŒ–ä¹‹åé€šè¿‡<code>post_init</code>ä¿¡å·è·å–åˆ°stateçš„å€¼ä½œä¸ºåˆå§‹çŠ¶æ€å€¼ï¼Œåœ¨æ¯æ¬¡modelæ‰§è¡Œsaveæ–¹æ³•åè°ƒç”¨<code>post_save</code>ä¿¡å·è·å–åˆ°æ–°çš„çŠ¶æ€å€¼ï¼Œå¯¹ä¸¤æ¬¡çŠ¶æ€å€¼åšæ¯”è¾ƒå¦‚æœä¸ä¸€è‡´åˆ™è¡¨ç¤ºçŠ¶æ€æœ‰æ›´æ–°å‘é€é€šçŸ¥</p>
<p>æ˜¯ä¸Šè¾¹çš„åˆ¤æ–­åªèƒ½åˆ¤æ–­åˆ°çŠ¶æ€å˜æ›´äº†å‘é€šçŸ¥ï¼Œä½†å·¥å•åœ¨ç¬¬ä¸€æ¬¡åˆ›å»ºæ—¶old_stateå’Œstateæ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦åœ¨saveä¹‹ååˆ¤æ–­ä¸‹è¿™æ¬¡æ“ä½œæ˜¯ä¸æ˜¯æ–°å»ºï¼Œå¦‚æœæ˜¯æ–°å»ºåŒæ ·éœ€è¦å‘é€é€šçŸ¥</p>
<p>ç¬¬äºŒæ­¥åŠ è½½signalï¼Œéœ€è¦ä¿®æ”¹ä¸¤ä¸ªé…ç½®æ–‡ä»¶</p>
<p>config1ï¼š<code>workflow/apps.py</code></p>
<pre class="codehilite"><code>from django.apps import AppConfig


class WorkflowConfig(AppConfig):
    name = 'workflow'

    def ready(self):
        import workflow.signals</code></pre>


<p>config2ï¼š<code>workflow/__init__.py</code></p>
<pre class="codehilite"><code>default_app_config = 'workflow.apps.WorkflowConfig'</code></pre>


<p>ç»‘å®šæˆåŠŸåå°±å¯ä»¥åœ¨æ¯æ¬¡å·¥å•çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶å‘é€é‚®ä»¶äº†</p>

        <div>
          <ul style="display: inline-block;padding: 0;margin: 0 0 0.5em;color: #999;">
            <li style="display: inline-block;margin: 0 1em 0 0;"><a href="/s/cMxdAfsTno56ixurmD4KXA.html">ğŸ“… 2018-11-19</a></li>
<li style="display: inline-block;margin: 0 1em 0 0;"><a href="/tag/Django/">ğŸ·ï¸ Django</a></li><li style="display: inline-block;margin: 0 1em 0 0;"><a href="/tag/å…³äºæŠ€æœ¯/">ğŸ·ï¸ å…³äºæŠ€æœ¯</a></li>          </ul>
        </div>

        <hr>

        <div class="nav-cell">
            <script async src="https://giscus.app/client.js"
                    data-repo="ops-coffee/blog" data-repo-id="MDEwOlJlcG9zaXRvcnkxNDY4OTI0MTg="
                    data-category="Announcements" data-category-id="DIC_kwDOCMFmgs4CQar3"
                    data-mapping="pathname" data-strict="0" data-reactions-enabled="1"
                    data-emit-metadata="0" data-input-position="top" data-theme="light"
                    data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous">
            </script>
        </div>

        <div>
            <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
            <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8944257246828217"
                 data-ad-slot="6731434232" data-ad-format="auto" data-full-width-responsive="true"></ins>
            <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
        </div>

        <div class="nav-cell">
            <p class="nav-list-title">èƒ½çœ‹åˆ°è¿™é‡Œä¸€å®šæ˜¯çœŸçˆ±ï¼Œè®¢é˜…ä¸€ä¸‹å§</p>
            <img alt="" loading="lazy" src="/static/images/wx.sou1.png" />
        </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="copy"> Â© ops-coffee</div>

      <div class="link">
        <a href="/questions.html" title="æé—®" target="_blank">æé—®</a>
        <a href="/friends.html" title="å‹æƒ…é“¾æ¥" target="_blank">å‹é“¾</a>
      </div>
    </div>
  </footer>
  
  <!-- Umami Cloud -->
<script async src="https://umami.ops-coffee.cn/script.js" data-website-id="a4aabd8e-32c7-40e7-a81c-119b909f2d0f"></script>

<!-- Google Adsense -->
<script data-ad-client="ca-pub-8944257246828217" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</body>

</html>