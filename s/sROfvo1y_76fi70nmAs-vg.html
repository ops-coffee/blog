<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="applicable-device" content="pc,mobile">
  <meta name="keywords" content="Nagios, ä¸šåŠ¡ç›‘æ§, ç›‘æ§ç³»ç»Ÿ, ä¸šåŠ¡çŠ¶æ€, APIç›‘æ§, ç½‘ç»œç›‘æ§, ç›‘æ§éƒ¨ç½², ç›‘æ§æŠ¥è­¦, ç›‘æ§é…ç½®, ç›‘æ§æ’ä»¶" />
  <meta name="description" content="æœ¬æ–‡ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨Nagiosç›‘æ§ä¸šåŠ¡çŠ¶æ€ï¼Œæ¢è®¨äº†ä¼ ç»Ÿç›‘æ§ç³»ç»Ÿçš„ä¸è¶³ä»¥åŠå¦‚ä½•é€šè¿‡Nagioså¼¥è¡¥ä¸šåŠ¡çŠ¶æ€ç›‘æ§çš„ç¼ºå¤±ï¼Œè¯¦ç»†è®²è§£äº†Nagiosçš„éƒ¨ç½²ä¸é…ç½®ï¼Œä»¥åŠå¦‚ä½•é€šè¿‡Nagiosæ’ä»¶å®ç°æ›´åŠæ—¶çš„ç›‘æ§æŠ¥è­¦ã€‚" />
  <link rel="alternate" type="application/rss+xml" title="è¿ç»´å’–å•¡å§" href="https://blog.ops-coffee.cn/feed.xml" />
  <link rel="stylesheet" href="https://blog.ops-coffee.cn/static/posts/css/ops-coffee.min.css" type="text/css" />

  <!-- Begin SEO tag -->
  <title>ä½¿ç”¨Nagiosæ‰“é€ ä¸“ä¸šçš„ä¸šåŠ¡çŠ¶æ€ç›‘æ§</title>
  <meta property="og:locale" content="zh_CN" />
  <meta property="og:site_name" content="è¿ç»´å’–å•¡å§" />
  <meta property="og:url" content="https://blog.ops-coffee.cn" />
  <meta property="og:title" content="ä½¿ç”¨Nagiosæ‰“é€ ä¸“ä¸šçš„ä¸šåŠ¡çŠ¶æ€ç›‘æ§" />
  <meta property="og:description" content="æœ¬æ–‡ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨Nagiosç›‘æ§ä¸šåŠ¡çŠ¶æ€ï¼Œæ¢è®¨äº†ä¼ ç»Ÿç›‘æ§ç³»ç»Ÿçš„ä¸è¶³ä»¥åŠå¦‚ä½•é€šè¿‡Nagioså¼¥è¡¥ä¸šåŠ¡çŠ¶æ€ç›‘æ§çš„ç¼ºå¤±ï¼Œè¯¦ç»†è®²è§£äº†Nagiosçš„éƒ¨ç½²ä¸é…ç½®ï¼Œä»¥åŠå¦‚ä½•é€šè¿‡Nagiosæ’ä»¶å®ç°æ›´åŠæ—¶çš„ç›‘æ§æŠ¥è­¦ã€‚" />
  <link rel="canonical" href="https://blog.ops-coffee.cn" />
  <!-- End SEO tag -->
</head>

<body>
  <div class="header">
    <div class="menu-button">&#9776; 
        <span class="menu-title">è¿ç»´å’–å•¡å§</span>
    </div> 

    <div class="container no-sidebar">
      <nav class="header-site">
        <ul>
          <li><a href="/">é¦–é¡µ</a></li>
            <li class="has-submenu">
              <a href="#" target="_self">è¿ç»´</a>
              <ul class="sub-menu">
                <li><a href="/tag/ç³»ç»Ÿè¿ç»´/" target="_self">ç³»ç»Ÿè¿ç»´</a></li>
                <li><a href="/elk/index.html" target="_self">ELKç³»åˆ—</a></li>
                <li><a href="/ldap/index.html" target="_self">LDAPç³»åˆ—</a></li>
              </ul>
            </li>
            <li class="has-submenu">
              <a href="#" target="_self">å¼€å‘</a>
              <ul class="sub-menu">
                <li><a href="/tag/Devops/" target="_self">DevOps</a></li>
                <li><a href="/tag/Python/" target="_self">Python</a></li>
                <li><a href="/tag/Django/" target="_self">Django</a></li>
                <li><a href="/bpmn/index.html" target="_self">BPMNç³»åˆ—</a></li>
                <li><a href="/webssh/index.html" target="_self">WebSSHç³»åˆ—</a></li>
                <li><a href="/frontend/index.html" target="_self">å‰ç«¯å¼€å‘ç³»åˆ—</a></li>
              </ul>
            </li>
            <li><a href="/devops.html" target="_self">è¿ç»´å¹³å°</a></li>
            <li><a href="/tag/è¿™æ˜¯ç”Ÿæ´»/" target="_self">è¿™æ˜¯ç”Ÿæ´»</a></li>
            <li class="has-submenu">
              <a href="#" target="_self">æˆ¿è½¦æ—…è¡Œ</a>
              <ul class="sub-menu">
                <li><a href="/rv.html" target="_self">æˆ¿è½¦ä½“éªŒ</a></li>
                <li><a href="/travels.html" target="_self">æ—…è¡Œæ¸¸è®°</a></li>
                <li><a href="/travel/china.html" target="_self">æ—…è¡Œåœ°å›¾</a></li>
              </ul>
            </li>
            <li><a href="/tag/index.html" target="_self">æ ‡ç­¾</a></li>
            <li><a href="/archive.html" target="_self">å½’æ¡£</a></li>
          <li class="search"><a href="/search.html" target="_self">ğŸ”</a></li>
        </ul>
      </nav>
    </div>
  </div>

  <header>
    <div class="container no-sidebar">
      <a href="/">
        <div class="name">è¿ç»´å’–å•¡å§</div>
        <div class="slogan">äº«å—æŠ€æœ¯å¸¦æ¥çš„ä¹è¶£ï¼Œä½“éªŒç”Ÿæ´»ç»™äºˆçš„æ„ŸåŠ¨</div>
      </a>
    </div>
  </header>

  <div id="content-wrap">
    <div class="container no-sidebar">
        <h1 id="art-title">ä½¿ç”¨Nagiosæ‰“é€ ä¸“ä¸šçš„ä¸šåŠ¡çŠ¶æ€ç›‘æ§</h1>

        <blockquote>
<p>æƒ³å¿…å„ä¸ªå…¬å¸éƒ½æœ‰éƒ¨ç½²zabbixä¹‹ç±»çš„ç›‘æ§ç³»ç»Ÿæ¥ç›‘æ§æœåŠ¡å™¨çš„èµ„æºä½¿ç”¨æƒ…å†µã€å„æœåŠ¡çš„è¿è¡ŒçŠ¶æ€ï¼Œæ˜¯å¦è¿™ç§ç›‘æ§å°±è¶³å¤Ÿäº†å‘¢ï¼Ÿæœ‰æ²¡æœ‰é‡åˆ°ç›‘æ§ç³»ç»Ÿä¸€åˆ‡æ­£å¸¸ç¡®å‘ç°é¡¹ç›®æ— æ³•æ­£å¸¸å¯¹å¤–æä¾›æœåŠ¡çš„æƒ…å†µå‘¢ï¼Ÿæœ¬ç¯‡æ–‡ç« èŠèŠæˆ‘ä»¬å¦‚ä½•ç®€å•çš„ä½¿ç”¨Nagiosç›‘æ§ä¸šåŠ¡çš„çŠ¶æ€</p>
<p>æ–‡ä¸­çš„ä¸šåŠ¡æŒ‡ç”¨æˆ·è®¿é—®çš„ç½‘ç«™é¡µé¢ï¼Œå¯¹å¤–æä¾›çš„APIæ¥å£ï¼Œç§»åŠ¨ç«¯çš„APPç­‰äº§å“</p>
</blockquote>
<h1 id="_1">ç›‘æ§çš„æ€è€ƒ</h1>
<p>é€šå¸¸æˆ‘ä»¬ä¼šåœ¨é¡¹ç›®æ‰€åœ¨çš„æœºæˆ¿éƒ¨ç½²ä¸€å¥—ç›‘æ§ç³»ç»Ÿæ¥ç›‘æ§æˆ‘ä»¬æœåŠ¡å™¨å’ŒMySQLä¹‹ç±»çš„å…¬å…±æœåŠ¡ï¼Œåˆ¶å®šæŠ¥è­¦ç­–ç•¥ï¼Œåœ¨å‡ºç°å¼‚å¸¸æƒ…å†µçš„æ—¶å€™é‚®ä»¶æˆ–çŸ­ä¿¡æé†’æˆ‘ä»¬åŠæ—¶å¤„ç†ã€‚</p>
<p>æ­¤ç±»ç›‘æ§ä¸»è¦çš„å…³æ³¨ç‚¹æœ‰ä¸¤ä¸ªï¼š</p>
<ol>
<li>èµ„æºçš„å ç”¨æƒ…å†µï¼Œä¾‹å¦‚è´Ÿè½½é«˜ä½ã€å†…å­˜å¤§å°ã€ç£ç›˜ç©ºé—´ç­‰</li>
<li>æœåŠ¡çš„çŠ¶æ€ç›‘æ§ï¼Œä¾‹å¦‚NginxçŠ¶æ€ã€Mysqlä¸»ä»çŠ¶æ€ç­‰</li>
</ol>
<p>åŒæ—¶ä¹Ÿä¼šå­˜åœ¨ä»¥ä¸‹ä¸¤ä¸ªä¸»è¦é—®é¢˜ï¼š</p>
<ol>
<li>ç¼ºå°‘ä¸šåŠ¡çŠ¶æ€çš„ç›‘æ§ï¼Œä¸èƒ½å¾ˆç›´è§‚çš„çŸ¥é“ä¸šåŠ¡å½“å‰çš„çŠ¶æ€ï¼Œå¯èƒ½æœåŠ¡å™¨ã€æœåŠ¡éƒ½æ­£å¸¸ä½†ä¸šåŠ¡ç¡®æŒ‚äº†</li>
<li>ç›‘æ§æœåŠ¡å™¨å’Œä¸šåŠ¡æœåŠ¡å™¨å¤„äºåŒä¸€æœºæˆ¿ç¯å¢ƒå†…ï¼Œç›‘æ§ç½‘ç»œæ•…éšœã€å…¥å£ç½‘ç»œæ‹¥å µç­‰æƒ…å†µéƒ½å¯èƒ½ä¼šå¯¼è‡´æ”¶ä¸åˆ°ç›‘æ§ç³»ç»Ÿçš„æŠ¥è­¦ï¼Œä¸”åªèƒ½ç›‘æ§æœºæˆ¿å†…çš„æƒ…å†µï¼Œç”¨æˆ·åˆ°æœºæˆ¿å…¥å£çš„æƒ…å†µæ— æ³•ç›‘æ§</li>
</ol>
<p>é‚£ä¹ˆå¦‚ä½•è§£å†³è¿™ä¸¤ä¸ªé—®é¢˜å‘¢ï¼Ÿ</p>
<p>ä¸šåŠ¡çŠ¶æ€ç›‘æ§ï¼Œå°±æ˜¯è¦æœ€ç›´è§‚çš„çš„åæ˜ ä¸šåŠ¡å½“å‰æ˜¯æ­£å¸¸è¿˜æ˜¯æ•…éšœï¼Œè¯¥æ€ä¹ˆç›‘æ§å‘¢ï¼Ÿä»¥webé¡¹ç›®ä¸ºä¾‹ï¼Œé¦–å…ˆå°±æ˜¯è¦ç¡®å®šå…·ä½“URLçš„è¿”å›çŠ¶æ€ï¼Œæ˜¯200æ­£å¸¸è¿˜æ˜¯404æœªæ‰¾åˆ°ç­‰ï¼Œå…¶æ¬¡è¦è€ƒè™‘é¡µé¢é‡Œè¾¹çš„å†…å®¹æ˜¯ä¸æ˜¯æ­£å¸¸ï¼Œæˆ‘ä»¬çŸ¥é“æœ€ç»ˆåé¦ˆç»™ç”¨æˆ·å†…å®¹çš„æ˜¯ç”±ä¸€äº›é™æ€èµ„æºå’Œåç«¯æ¥å£æ•°æ®å…±åŒç»„æˆçš„HTMLé¡µé¢ï¼Œæƒ³çŸ¥é“å†…å®¹ç©¶ç«Ÿå¯¹ä¸å¯¹è¿™ä¸ªæ¯”è¾ƒå›°éš¾ï¼Œé€€è€Œæ±‚å…¶æ¬¡æˆ‘ä»¬é»˜è®¤æ‰€æœ‰é™æ€èµ„æºå’Œåç«¯æ¥å£éƒ½è¿”å›æ­£å¸¸çŠ¶æ€åˆ™è¡¨ç¤ºæ­£å¸¸ï¼Œè¿™ä¸ªç›‘æ§å°±æ¯”è¾ƒå®¹æ˜“å®ç°äº†ã€‚</p>
<p>é™æ€èµ„æºå¯ä»¥ç›´æ¥ç”±nginxæœåŠ¡å™¨å¤„ç†ï¼Œnginxçš„å¹¶å‘èƒ½åŠ›å¾ˆå¼ºï¼Œä¸€èˆ¬ä¸ä¼šæˆä¸ºæ€§èƒ½çš„ç“¶é¢ˆï¼Œé’ˆå¯¹é™æ€èµ„æºçš„ç›‘æ§æˆ‘ä»¬å¯ä»¥ç»“åˆELKä¸€èµ·æ¥çœ‹ã€‚åç«¯æ¥å£çš„å¤„ç†æ€§èƒ½å°±è¦å·®å¾ˆå¤šäº†ï¼Œå¯¹ä¸šåŠ¡çŠ¶æ€çš„ç›‘æ§ä¹Ÿä¸»è¦æ˜¯å¯¹åç«¯æ¥å£çŠ¶æ€çš„ç›‘æ§ï¼Œé‚£æˆ‘ä»¬æ˜¯å¦éœ€è¦ç›‘æ§æ‰€æœ‰çš„æ¥å£å‘¢ï¼Ÿè¿™ä¸ªå®æ–½èµ·æ¥æ¯”è¾ƒéº»çƒ¦ï¼Œæˆ‘è§‰å¾—æ²¡å¤ªå¤§å¿…è¦ï¼Œåªéœ€è¦ç›‘æ§å‡ ä¸ªæœ‰ä»£è¡¨æ€§çš„æ¥å£å°±å¯ä»¥äº†ï¼Œä¾‹å¦‚<strong>æˆ‘ä»¬æ‰€æœ‰çš„é¡¹ç›®ä¸­éƒ½è®©å¼€å‘å•ç‹¬åŠ äº†ä¸€ä¸ªhealth checkçš„æ¥å£ï¼Œè¿™ä¸ªæ¥å£çš„ä½œç”¨æ˜¯è¿æ¥é¡¹ç›®æ‰€æœ‰ç”¨åˆ°çš„æœåŠ¡è¿›è¡Œæ“ä½œï¼Œå¦‚æ¥å£è¿æ¥mysqlè¿›è¡Œæ•°æ®æŸ¥è¯¢ä»¥ç¡®å®šmysqlèƒ½ç»™æ­£å¸¸æä¾›æœåŠ¡ï¼Œè¿æ¥redisè¿›è¡Œgetã€setæ“ä½œä»¥ç¡®å®šredisæœåŠ¡æ­£å¸¸ï¼Œå¯¹äºè¿™ä¸ªæ¥å£çš„ç›‘æ§å°±èƒ½è¦†ç›–åˆ°æ•´ä¸ªé“¾è·¯çš„æœåŠ¡æƒ…å†µ</strong>ã€‚</p>
<p>å¯¹äºç›‘æ§æœåŠ¡å™¨å’Œä¸šåŠ¡æœåŠ¡å™¨åœ¨åŒä¸€ä¸ªæœºæˆ¿å†…æ‰€å¯¼è‡´çš„é—®é¢˜ï¼ˆä¸Šè¾¹è®²åˆ°çš„ç¬¬äºŒç‚¹é—®é¢˜ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ä¸åŒçš„ç½‘ç»œç¯å¢ƒå†…éƒ¨ç½²ç‹¬ç«‹çš„çŠ¶æ€ç›‘æ§æ¥è§£å†³ï¼Œä¾‹å¦‚åŠå…¬åŒºéƒ¨ç½²Nagiosï¼Œä¸åŒç½‘ç»œç›‘æ§ä¹Ÿæ›´æ¥è¿‘ç”¨æˆ·çš„ç½‘ç»œæƒ…å†µï¼Œè¿™å¥—çŠ¶æ€ç›‘æ§å°±åŒºåˆ«äºæœºæˆ¿éƒ¨ç½²çš„èµ„æºå ç”¨ç›‘æ§äº†ï¼Œä¸»è¦ç”¨æ¥ç›‘æ§ä¸šåŠ¡çš„çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸Šè¾¹æåˆ°çš„URLå’Œæ¥å£çŠ¶æ€ã€‚</p>
<p><img alt="" loading="lazy" src="/static/images/2018/0918.00.jpg" /></p>
<p>æˆ‘ä»¬èƒ½ä¸èƒ½ç›´æ¥å°†ç›‘æ§éƒ¨ç½²åœ¨æœºæˆ¿å¤–çš„ç¯å¢ƒæ¥èŠ‚çœä¸€å¥—ç›‘æ§å‘¢ï¼Ÿä¾‹å¦‚å…¬å¸æˆ–è€…å…¶ä»–çš„æœºæˆ¿éƒ¨ç½²ç›‘æ§ã€‚è¿™æ ·ä¸æ˜¯ä¸ªå¥½æ–¹æ¡ˆï¼Œè·¨ç½‘ç»œçš„ç›‘æ§æ€§èƒ½å¤ªå·®äº†ï¼Œé¦–å…ˆç½‘ç»œä¹‹é—´çš„å»¶è¿Ÿéƒ½æ¯”åŒæœºæˆ¿å†…è¦å¤§çš„å¤šï¼Œå…¶æ¬¡å¤§é‡ç›‘æ§é¡¹é¢‘ç¹çš„æ•°æ®ä¼ è¾“å¯¹å¸¦å®½ä¹Ÿæ˜¯ä¸å°çš„å‹åŠ›</p>
<h1 id="nagios">Nagiosç›‘æ§</h1>
<p>æˆ‘ä»¬ä¸šåŠ¡çŠ¶æ€ç›‘æ§é‡‡ç”¨äº†Nagiosï¼ŒNagioséƒ¨ç½²ç®€å•é…ç½®çµæ´»ï¼Œè¿™ç§åœºæ™¯ä¸‹éå¸¸é€‚åˆã€‚</p>
<ul>
<li>ç³»ç»Ÿç¯å¢ƒï¼šDebian8</li>
<li>nginx + nagiosæ¶æ„</li>
</ul>
<h2 id="nagios_1">éƒ¨ç½²Nagios</h2>
<p>1.å®‰è£…åŸºç¡€ç¯å¢ƒ</p>
<pre class="codehilite"><code># apt-get update
# apt-get install -y build-essential libgd2-xpm-dev autoconf gcc libc6 make wget
# apt-get install -y nginx php5-fpm spawn-fcgi fcgiwrap</code></pre>


<p>2.ä¸‹è½½å¹¶è§£å‹nagios</p>
<pre class="codehilite"><code># wget https://assets.nagios.com/downloads/nagioscore/releases/nagios-4.0.8.tar.gz
# tar -zxvf nagios-4.0.8.tar.gz 
# cd nagios-4.0.8

# ./configure &amp;&amp; make all

# make install-groups-users
# usermod -a -G nagios www-data

# make install
# make install-init
# make install-config
# make install-commandmode
# cd ..</code></pre>


<ul>
<li>nagioså®‰è£…å®Œæˆåå°±å¯ä»¥å¯åŠ¨äº†ï¼Œä½†æ˜¯webé¡µé¢æ˜¯æ— æ³•è®¿é—®çš„ï¼ŒæŸ¥çœ‹æ—¥å¿—ä¼šæŠ¥é”™<code>(No output on stdout) stderr: execvp(/usr/local/nagios/libexec/check_ping, ...) failed. errno is 2: No such file or directory</code>ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬åªå®‰è£…äº†nagiosçš„coreï¼Œæ²¡æœ‰å®‰è£…nagiosçš„æ’ä»¶ï¼Œéœ€è¦å®‰è£…æ’ä»¶æ¥æ”¯æŒcoreå·¥ä½œ</li>
</ul>
<p>3.å®‰è£…nagios-plugins</p>
<pre class="codehilite"><code># wget https://nagios-plugins.org/download/nagios-plugins-2.2.1.tar.gz
# tar -zxvf nagios-plugins-2.2.1.tar.gz
# cd nagios-plugins-2.2.1
# ./configure
# make
# make install
# cd ..</code></pre>


<ul>
<li>nagiosçš„æ’ä»¶ä¸»è¦æ˜¯æ·»åŠ äº†check_pingã€checkhttpä¹‹ç±»çš„è¾…åŠ©æ£€æŸ¥çš„è„šæœ¬ï¼Œé»˜è®¤ä½äº<code>/usr/local/nagios/libexec/</code>ä¸‹ï¼Œå¯ä»¥å€ŸåŠ©è¿™äº›æ’ä»¶æ¥ç›‘æ§æˆ‘ä»¬çš„HTTPæ¥å£æˆ–ä¸»æœºã€æœåŠ¡çŠ¶æ€</li>
</ul>
<p>4.åˆ›å»ºnagios webè®¿é—®çš„è´¦å·å¯†ç </p>
<pre class="codehilite"><code># vi /usr/local/bin/htpasswd.pl
#!/usr/bin/perl

use strict;

if ( @ARGV != 2 ){
    print &quot;usage: /usr/local/bin/htpasswd.pl &lt;username&gt; &lt;password&gt;\n&quot;;
}
else {
    print $ARGV[0].&quot;:&quot;.crypt($ARGV[1],$ARGV[1]).&quot;\n&quot;;
}
# chmod +x /usr/local/bin/htpasswd.pl

#åˆ©ç”¨perlè„šæœ¬ç”Ÿæˆè´¦å·å¯†ç åˆ°htpasswd.usersæ–‡ä»¶ä¸­
# /usr/local/bin/htpasswd.pl nagiosadmin nagios@ops-coffee &gt; /usr/local/nagios/htpasswd.users</code></pre>


<ul>
<li>nagiosé»˜è®¤å¼€å¯äº†è´¦å·è®¤è¯ï¼Œè®¤è¯ç›¸å…³çš„é…ç½®åœ¨è¿™ä¸ªæ–‡ä»¶é‡Œ<code>/usr/local/nagios/etc/cgi.cfg</code></li>
<li>å¦‚æœå®‰è£…äº†httpdæœåŠ¡ï¼Œå¯ä»¥ç›´æ¥æ¥è§¦htpasswdå‘½ä»¤ç”Ÿæˆå¯†ç ï¼Œè¿™é‡Œæˆ‘ä»¬æ²¡æœ‰httpdæœåŠ¡ï¼Œæ‰€ä»¥å†™ä¸ªperlè„šæœ¬æ¥ç”Ÿæˆå¯†ç </li>
</ul>
<p>5.nginxæ·»åŠ serveré…ç½®ï¼Œè®©æµè§ˆå™¨å¯ä»¥è®¿é—®</p>
<pre class="codehilite"><code>server {
    listen       80;
    server_name  ngs.domain.com;

    access_log /var/log/nginx/nagios.access.log;
    error_log /var/log/nginx/nagios.error.log;

    auth_basic &quot;Private&quot;;
    auth_basic_user_file /usr/local/nagios/htpasswd.users;

    root /usr/local/nagios/share;
    index index.php index.html;

    location / {
        try_files $uri $uri/ index.php /nagios;
    }

    location /nagios {
        alias /usr/local/nagios/share;
    }

    location ~ \.php$ {
        include /etc/nginx/fastcgi_params;
        fastcgi_pass unix:/var/run/php5-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }

    location ~ ^/nagios/(.*\.php)$ {
        alias /usr/local/nagios/share/$1;
        include /etc/nginx/fastcgi_params;
        fastcgi_pass unix:/var/run/php5-fpm.sock;
    }

    location ~ \.cgi$ {
        root /usr/local/nagios/sbin/;
        rewrite ^/nagios/cgi-bin/(.*)\.cgi /$1.cgi break;
        fastcgi_param AUTH_USER $remote_user;
        fastcgi_param REMOTE_USER $remote_user;
        include /etc/nginx/fastcgi_params;
        fastcgi_pass unix:/var/run/fcgiwrap.socket;
    }
}</code></pre>


<p>6.æ£€æŸ¥é…ç½®æ–‡ä»¶å¹¶å¯åŠ¨</p>
<pre class="codehilite"><code>#æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯
# /usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg 

#å¯åŠ¨nagiosæœåŠ¡
# /usr/local/nagios/bin/nagios -d /usr/local/nagios/etc/nagios.cfg

#å¯åŠ¨fcgiwrapå’Œphp5-fpmæœåŠ¡
# service fcgiwrap restart
# service php5-fpm restart</code></pre>


<p>7.æµè§ˆå™¨è®¿é—®æœåŠ¡å™¨IPæˆ–åŸŸåå°±å¯ä»¥çœ‹åˆ°nagiosçš„é¡µé¢äº†ï¼Œé»˜è®¤æœ‰æœ¬æœºçš„ç›‘æ§æ•°æ®ï¼Œä¸éœ€è¦çš„è¯å¯ä»¥åœ¨é…ç½®æ–‡ä»¶<code>localhost.cfg</code>ä¸­åˆ é™¤
<img alt="" loading="lazy" src="/static/images/2018/0918.01.png" /></p>
<h2 id="nagios_2">Nagiosé…ç½®</h2>
<p>Nagiosçš„ä¸»é…ç½®æ–‡ä»¶è·¯å¾„ä¸º<code>/usr/local/nagios/etc/nagios.cfg</code>ï¼Œé‡Œè¾¹é»˜è®¤å·²ç»é…ç½®äº†ä¸€äº›é…ç½®æ–‡ä»¶çš„è·¯å¾„ï¼Œcfg_file=åè¾¹é…ç½®çš„éƒ½æ˜¯é…ç½®æ–‡ä»¶ï¼Œnagiosç¨‹åºä¼šæ¥è¿™é‡Œè¯»å–é…ç½®ï¼Œæˆ‘ä»¬å¯ä»¥æ–°æ·»åŠ ä¸€ä¸ªä¸“é—¨ç”¨æ¥ç›‘æ§HTTP APIçš„é…ç½®æ–‡ä»¶</p>
<pre class="codehilite"><code>cfg_file=/usr/local/nagios/etc/objects/check_api.cfg</code></pre>


<h5 id="check_apicfg">check_api.cfgé‡Œè¾¹çš„å†…å®¹å¦‚ä¸‹ï¼š</h5>
<pre class="codehilite"><code>define service{
    use                     generic-service
    host_name               localhost
    service_description     web_project_01
    check_command           check_http!ops-coffee.cn -S
}

define service{
    use                     generic-service
    host_name               localhost
    service_description     web_project_02
    check_command           check_http!ops-coffee.cn -S -u / -e 200
}

define service{
    use                     generic-service
    host_name               localhost
    service_description     web_project_03
    check_command           check_http!ops-coffee.cn -S -u /action/health -k &quot;sign:e5dhn&quot;
}</code></pre>


<ul>
<li><strong>define service</strong>ï¼šå®šä¹‰ä¸€ä¸ªæœåŠ¡ï¼Œæ¯ä¸€ä¸ªé¡µé¢æˆ–apiå±äºä¸€ä¸ªæœåŠ¡</li>
<li><strong>use</strong>ï¼šå®šä¹‰æœåŠ¡ä½¿ç”¨çš„æ¨¡æ¿ï¼Œæ¨¡æ¿é…ç½®æ–‡ä»¶åœ¨<code>/usr/local/nagios/etc/objects/templates.cfg</code></li>
<li><strong>host_name</strong>ï¼šå®šä¹‰æœåŠ¡æ‰€å±çš„ä¸»æœºï¼Œæˆ‘ä»¬è¿™é‡ŒåŒºåˆ«ä¸»æœºæ„ä¹‰ä¸å¤§ï¼Œç»Ÿä¸€éƒ½å±äºlocalhostå¥½äº†</li>
<li><strong>service_description</strong>ï¼šå®šä¹‰æœåŠ¡æè¿°ï¼Œè¿™ä¸ªå€¼ä¼šæœ€ç»ˆå±•ç¤ºåœ¨webé¡µé¢ä¸Šçš„serviceå­—æ®µï¼Œå®šä¹‰åº”ç®€å•æœ‰æ„ä¹‰</li>
<li><strong>check_command</strong>ï¼šå®šä¹‰æœåŠ¡æ£€æŸ¥ä½¿ç”¨çš„å‘½ä»¤ï¼Œå‘½ä»¤çš„é…ç½®æ–‡ä»¶åœ¨<code>/usr/local/nagios/etc/objects/commands.cfg</code></li>
<li>check_httpæ£€æµ‹httpsæ¥å£æ—¶å¯ä»¥ä½¿ç”¨-Så‚æ•°ï¼Œå¦‚æœæŠ¥é”™<code>SSL is not available</code>ï¼Œé‚£ä¹ˆä½ éœ€è¦å…ˆå®‰è£…libssl-devåŒ…ï¼Œç„¶åé‡æ–°ç¼–è¯‘ï¼ˆ<code>./configure --with-openssl=/usr/bin/openssl</code>ï¼‰éƒ¨ç½²nagios-pluginæ’ä»¶æ·»åŠ å¯¹sslçš„æ”¯æŒ</li>
</ul>
<h5 id="check_commandcheck_httpcommandscfgcheck_http"><strong>check_command</strong>æˆ‘ä»¬é…ç½®äº†check_httpï¼Œéœ€è¦ä¿®æ”¹commands.cfgæ–‡ä»¶ä¸­é»˜è®¤çš„check_httpé…ç½®å¦‚ä¸‹ï¼š</h5>
<pre class="codehilite"><code>define command {
    command_name    check_http
    command_line    $USER1$/check_http -H $ARG1$
}</code></pre>


<ul>
<li><strong>define command</strong>ï¼šå®šä¹‰ä¸€ä¸ªcommand</li>
<li><strong>command_name</strong>ï¼šå®šä¹‰commandçš„åå­—ï¼Œåœ¨ä¸»æœºæˆ–æœåŠ¡çš„é…ç½®æ–‡ä»¶ä¸­å¯ä»¥å¼•ç”¨</li>
<li><strong>command_line</strong>ï¼šå®šä¹‰å‘½ä»¤çš„è·¯å¾„å’Œæ‰§è¡Œæ–¹å¼ï¼Œè¿™ä¸ª<code>check_http</code>å°±æ˜¯æˆ‘ä»¬é€šè¿‡å®‰è£…nagios-pluginç”Ÿæˆçš„ï¼Œä½äº<code>/usr/local/nagios/libexec/</code>ä¸‹ï¼Œ<code>check_http</code>çš„è¯¦ç»†ç”¨æ³•å¯ä»¥é€šè¿‡<code>check_http -hæŸ¥çœ‹</code>ï¼Œæ”¯æŒæ¯”è¾ƒå¹¿æ³›</li>
</ul>
<h5 id="usegeneric-service"><strong>use</strong>æˆ‘ä»¬é…ç½®äº†generic-serviceï¼Œå¯ä»¥é€šè¿‡é…ç½®æœåŠ¡æ¨¡æ¿å®šä¹‰å¾ˆå¤šé»˜è®¤çš„é…ç½®å¦‚ä¸‹ï¼š</h5>
<pre class="codehilite"><code>define service {
    name                            generic-service         ; The 'name' of this service template
    active_checks_enabled           1                       ; Active service checks are enabled
    passive_checks_enabled          1                       ; Passive service checks are enabled/accepted
    parallelize_check               1                       ; Active service checks should be parallelized (disabling this can lead to major performance problems)
    obsess_over_service             1                       ; We should obsess over this service (if necessary)
    check_freshness                 0                       ; Default is to NOT check service 'freshness'
    notifications_enabled           1                       ; Service notifications are enabled
    event_handler_enabled           1                       ; Service event handler is enabled
    flap_detection_enabled          1                       ; Flap detection is enabled
    process_perf_data               1                       ; Process performance data
    retain_status_information       1                       ; Retain status information across program restarts
    retain_nonstatus_information    1                       ; Retain non-status information across program restarts
    is_volatile                     0                       ; The service is not volatile
    check_period                    24x7                    ; The service can be checked at any time of the day
    max_check_attempts              2                       ; Re-check the service up to 3 times in order to determine its final (hard) state
    check_interval                  1                      ; Check the service every 10 minutes under normal conditions
    retry_interval                  1                       ; Re-check the service every two minutes until a hard state can be determined
    contact_groups                  admins                  ; Notifications get sent out to everyone in the 'admins' group
    notification_options            w,u,c,r                 ; Send notifications about warning, unknown, critical, and recovery events
    notification_interval           60                      ; Re-notify about service problems every hour
    notification_period             24x7                    ; Notifications can be sent out at any time
    register                        0                       ; DON'T REGISTER THIS DEFINITION - ITS NOT A REAL SERVICE, JUST A TEMPLATE!
}</code></pre>


<p>é…ç½®å¤ªå¤šå°±ä¸ä¸€ä¸€è§£é‡Šäº†ï¼Œé…åˆåè¾¹çš„è‹±æ–‡æ³¨é‡Šåº”è¯¥çœ‹å¾—æ‡‚ï¼Œè¯´å‡ ä¸ªé‡è¦çš„</p>
<ul>
<li><strong>max_check_attempts</strong>ï¼šé‡è¯•å‡ æ¬¡æ¥æœ€ç»ˆç¡®å®šæœåŠ¡çš„çŠ¶æ€ï¼Œä¾‹å¦‚æˆ‘ä»¬ä¸€ä¸ªæœåŠ¡æŒ‚äº†ï¼Œéœ€è¦é‡è¯•3æ¬¡æ‰ä¼šç¡®å®šè¿™ä¸ªæœåŠ¡ç¡®å®æ˜¯æŒ‚äº†ï¼Œç„¶åå‘é‚®ä»¶æˆ–çŸ­ä¿¡é€šçŸ¥æˆ‘ä»¬</li>
<li><strong>check_interval</strong>ï¼šæ£€æŸ¥é¢‘ç‡é…ç½®ï¼Œåœ¨æœåŠ¡æ­£å¸¸çš„æƒ…å†µä¸‹å¤šé•¿æ—¶é—´è½®è®­æ£€æŸ¥ä¸€æ¬¡ï¼Œè¿™é‡Œä¸ºäº†æ›´åŠæ—¶çš„åé¦ˆç»“æœæˆ‘ä»¬é…ç½®ä¸€åˆ†é’Ÿä¸€æ¬¡</li>
<li><strong>retry_interval</strong>ï¼šå½“æœåŠ¡çŠ¶æ€å‘ç”Ÿå˜æ›´çš„æ—¶å€™å¤šé•¿æ—¶é—´è½®åºæ£€æŸ¥ä¸€æ¬¡ï¼Œæˆ‘ä»¬ä¹Ÿç»™é…ç½®ä¸€åˆ†é’Ÿä¸€æ¬¡</li>
<li><strong>contact_groups</strong>ï¼šå®šä¹‰è”ç³»äººç»„ï¼Œå½“å‘ç”Ÿæ•…éšœéœ€è¦æŠ¥è­¦æ—¶ï¼Œå‘é€æŠ¥è­¦ç»™å“ªä¸ªç»„ï¼Œè¿™ä¸ªç»„çš„é…ç½®æ–‡ä»¶åœ¨<code>/usr/local/nagios/etc/objects/contacts.cfg</code></li>
</ul>
<h5 id="contact_groupsadminscontactscfg"><strong>contact_groups</strong>æˆ‘ä»¬é…ç½®äº†adminsï¼Œæ¥ä¸‹æ¥çœ‹ä¸‹contacts.cfgçš„é…ç½®</h5>
<pre class="codehilite"><code>define contact{
    contact_name                    sa       ; Short name of user
    use                             generic-contact     ; Inherit default values from generic-contact template (defined above)
    alias                           Nagios Admin        ; Full name of user

    service_notification_period     24x7
    host_notification_period        24x7
    service_notification_options    w,u,c,r
    host_notification_options       d,u,r
    host_notification_commands      notify-host-by-email,notify-host-by-sms
    service_notification_commands   notify-service-by-email,notify-service-by-sms

    email                           ops-coffee@domain.com
    pager                           15821212121,15822222222
}

define contactgroup{
    contactgroup_name       admins
    alias                   Nagios Administrators
    members                 sa
}</code></pre>


<ul>
<li>contactgroupå°±æ˜¯æˆ‘ä»¬å®šä¹‰çš„è”ç³»äººç»„admins</li>
<li>adminsç»„ç®¡ç†äº†æˆå‘˜saè”ç³»äºº</li>
<li>saè”ç³»äººå®šä¹‰äº†ä¸»æœºå’ŒæœåŠ¡çš„å‘½ä»¤ï¼Œä¾‹å¦‚è¿™é‡Œæˆ‘ä»¬å®šä¹‰çš„notify-host-by-email,notify-host-by-smså‘é‚®ä»¶å’Œå‘çŸ­ä¿¡çš„å‘½ä»¤ï¼Œè¿™ä¸ªå‘½ä»¤çš„å®šä¹‰ä½ç½®è·Ÿæˆ‘ä»¬check_httpçš„å®šä¹‰éƒ½åœ¨æ–‡ä»¶<code>/usr/local/nagios/etc/objects/commands.cfg</code>æ–‡ä»¶å†…</li>
</ul>
<p>å…¨éƒ¨é…ç½®å®Œæˆåé‡å¯nagiosæœåŠ¡ï¼Œä¼šçœ‹åˆ°ç›‘æ§å·²ç»æ­£å¸¸
<img alt="" loading="lazy" src="/static/images/2018/0918.02.png" /></p>
<h2 id="nagstamon">Nagstamonæ’ä»¶</h2>
<p>ä»‹ç»ä¸€æ¬¾é…åˆnagiosç”¨èµ·æ¥éå¸¸æ£’çš„æ’ä»¶Nagstamonï¼ŒNagstamonæ˜¯ä¸€æ¬¾nagiosçš„æ¡Œé¢å°å·¥å…·ï¼ˆå®é™…ä¸Šç°åœ¨ä¸ä»…ä»…èƒ½é…åˆnagiosä½¿ç”¨ï¼Œè¿˜èƒ½é…åˆzabbixç­‰ä½¿ç”¨ï¼‰ï¼Œå¯åŠ¨åå¸¸é©»ç³»ç»Ÿæ‰˜ç›˜ï¼Œå½“nagiosç›‘æ§çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ä¼šåŠæ—¶çš„è·³å‡ºæ¥å¹¶å‘å‡ºå£°éŸ³è­¦å‘Šï¼Œèƒ½å¤Ÿæ›´åŠ åŠæ—¶çš„è·å–ä¸šåŠ¡çŠ¶æ€ã€‚</p>
<p>é…ç½®å¦‚ä¸‹ï¼š</p>
<p><img alt="" loading="lazy" src="/static/images/2018/0918.03.png" /></p>
<ul>
<li>Update intervalèƒ½å¤Ÿé…ç½®å¤šé•¿æ—¶é—´å–ä¸€æ¬¡nagiosçš„çŠ¶æ€ï¼Œæˆ‘ä»¬è¿™é‡Œè°ƒæ•´ä¸º1s</li>
<li>å½“å‡ºç°æŠ¥è­¦æ—¶æ¡Œé¢ç›´æ¥é£™çº¢ï¼Œç»™ä½ å¿ƒè·³åŠ é€Ÿçš„æ„Ÿè§‰</li>
</ul>
<p><img alt="" loading="lazy" src="/static/images/2018/0918.04.png" /></p>
<h1 id="_2">å†™åœ¨æœ€å</h1>
<ol>
<li>ä¸šåŠ¡çŠ¶æ€ç›‘æ§ä½œä¸ºZabbixä¹‹ç±»è¿‡ç¨‹ç›‘æ§çš„è¡¥å……ï¼Œå¹¶ä¸èƒ½æ›¿ä»£è¿‡ç¨‹ç›‘æ§ç³»ç»Ÿï¼Œåœ¨æˆ‘ä»¬è¿‡ç¨‹ç›‘æ§ä¸æ˜¯å¾ˆå®Œå–„çš„æƒ…å†µä¸‹å¾ˆæœ‰ç”¨ï¼Œç›®å‰æˆ‘ä»¬æœ‰ç›¸å½“ä¸€éƒ¨åˆ†çš„æŠ¥è­¦éƒ½é¦–å…ˆå‘ç°äºè¿™å¥—ä¸šåŠ¡çŠ¶æ€ç›‘æ§</li>
<li>é€‰æ‹©Nagiosä¸»è¦æ˜¯å¥¹æ¯”è¾ƒçº¯ç²¹ï¼Œä¸“æ³¨çŠ¶æ€ç›‘æ§ï¼ˆæœ‰æ’ä»¶å®ç°è¿‡ç¨‹è®°å½•ï¼‰ï¼Œä¸”å¯¹Nagiosæ¯”è¾ƒç†Ÿæ‚‰äº†ã€‚Nagiosçœ‹ä¼¼é…ç½®å¤æ‚ï¼Œå‡ ä¸ªé…ç½®æ–‡ä»¶ç¯ç¯ç›¸æ‰£ï¼Œå®é™…ä¸Šç†æ¸…æ¥šé…ç½®æ–‡ä»¶ä¹‹é—´çš„å…³ç³»å°±ä¼šå‘ç°é…ç½®åˆç†ä¸”ç®€å•</li>
<li>éƒ¨ç½²çš„çŠ¶æ€ç›‘æ§èŠ‚ç‚¹è¶Šå¤šè¦†ç›–åœ°åŒºè¶Šå¤šç”¨æˆ·çŠ¶æ€è·å–å°±è¶Šå‡†ç¡®ï¼Œä½†ç”±äºç½‘ç»œç¯å¢ƒå¤æ‚ï¼Œæˆ‘ä»¬ä¹Ÿä¸å¯èƒ½åœ¨æ¯ä¸ªçœå¸‚ã€èŠ‚ç‚¹éƒ¨ç½²ç›‘æ§ç³»ç»Ÿæ¥ç›‘æ§é¡¹ç›®çš„çŠ¶æ€ï¼Œå¦‚æœ‰å¿…è¦å¯ä»¥è€ƒè™‘ä¸€äº›å•†ä¸šç›‘æ§æ–¹æ¡ˆï¼Œèƒ½å¤Ÿåšåˆ°å…¨çƒèŠ‚ç‚¹ç›‘æ§ï¼Œä½†ç›¸åº”çš„æˆæœ¬å¯èƒ½å°±ä¼šå¢åŠ ï¼Œè¦ç»¼åˆæƒè¡¡</li>
</ol>

        <div>
          <ul style="display: inline-block;padding: 0;margin: 0 0 0.5em;color: #999;">
            <li style="display: inline-block;margin: 0 1em 0 0;"><a href="/s/sROfvo1y_76fi70nmAs-vg.html">ğŸ“… 2018-09-19</a></li>
<li style="display: inline-block;margin: 0 1em 0 0;"><a href="/tag/ç³»ç»Ÿè¿ç»´/">ğŸ·ï¸ ç³»ç»Ÿè¿ç»´</a></li><li style="display: inline-block;margin: 0 1em 0 0;"><a href="/tag/ç›‘æ§/">ğŸ·ï¸ ç›‘æ§</a></li><li style="display: inline-block;margin: 0 1em 0 0;"><a href="/tag/å…³äºæŠ€æœ¯/">ğŸ·ï¸ å…³äºæŠ€æœ¯</a></li>          </ul>
        </div>

        <hr>

        <div class="nav-cell">
            <script async src="https://giscus.app/client.js"
                    data-repo="ops-coffee/blog" data-repo-id="MDEwOlJlcG9zaXRvcnkxNDY4OTI0MTg="
                    data-category="Announcements" data-category-id="DIC_kwDOCMFmgs4CQar3"
                    data-mapping="pathname" data-strict="0" data-reactions-enabled="1"
                    data-emit-metadata="0" data-input-position="top" data-theme="light"
                    data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous">
            </script>
        </div>

        <div>
            <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
            <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8944257246828217"
                 data-ad-slot="6731434232" data-ad-format="auto" data-full-width-responsive="true"></ins>
            <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
        </div>

        <div class="nav-cell">
            <p class="nav-list-title">èƒ½çœ‹åˆ°è¿™é‡Œä¸€å®šæ˜¯çœŸçˆ±ï¼Œè®¢é˜…ä¸€ä¸‹å§</p>
            <img alt="" loading="lazy" src="/static/images/wx.sou1.png" />
        </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="copy"> Â© ops-coffee</div>

      <div class="link">
        <a href="/questions.html" title="æé—®" target="_blank">æé—®</a>
        <a href="/friends.html" title="å‹æƒ…é“¾æ¥" target="_blank">å‹é“¾</a>
      </div>
    </div>
  </footer>
  
  <!-- Umami Cloud -->
<script async src="https://umami.ops-coffee.cn/script.js" data-website-id="a4aabd8e-32c7-40e7-a81c-119b909f2d0f"></script>

<!-- Google Adsense -->
<script data-ad-client="ca-pub-8944257246828217" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</body>

</html>