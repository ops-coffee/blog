<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="applicable-device" content="pc,mobile">
  <meta name="keywords" content="10,Devops,ä»»åŠ¡ç³»ç»Ÿ,2,å…³äºæŠ€æœ¯,20,Django,Cache" />
  <meta name="description" content="20åˆ†é’Ÿçš„ä»»åŠ¡ä¼˜åŒ–åˆ°äº†2åˆ†é’Ÿ" />
  <link rel="alternate" type="application/rss+xml" title="è¿ç»´å’–å•¡å§" href="https://blog.ops-coffee.cn/feed.xml" />
  <link rel="stylesheet" href="https://blog.ops-coffee.cn/static/posts/css/ops-coffee.min.css" type="text/css" />

  <!-- Begin SEO tag -->
  <title>Djangoå¼€å‘ä¸­ä½¿ç”¨Cacheç¼“å­˜æå‡10å€æ•ˆç‡</title>
  <meta property="og:locale" content="zh_CN" />
  <meta property="og:site_name" content="è¿ç»´å’–å•¡å§" />
  <meta property="og:url" content="https://blog.ops-coffee.cn" />
  <meta property="og:title" content="Djangoå¼€å‘ä¸­ä½¿ç”¨Cacheç¼“å­˜æå‡10å€æ•ˆç‡" />
  <meta property="og:description" content="20åˆ†é’Ÿçš„ä»»åŠ¡ä¼˜åŒ–åˆ°äº†2åˆ†é’Ÿ" />
  <link rel="canonical" href="https://blog.ops-coffee.cn" />
  <!-- End SEO tag -->
</head>

<body>
  <div class="header">
    <div class="container no-sidebar">
      <nav class="header-site">
        <ul>
          <li><a href="/">é¦–é¡µ</a></li>
            <li class="has-submenu">
              <a href="#" target="_self">è¿ç»´</a>
              <ul class="sub-menu">
                <li><a href="/tag/ç³»ç»Ÿè¿ç»´/" target="_self">ç³»ç»Ÿè¿ç»´</a></li>
                <li><a href="/elk/index.html" target="_self">ELKç³»åˆ—</a></li>
                <li><a href="/ldap/index.html" target="_self">LDAPç³»åˆ—</a></li>
              </ul>
            </li>
            <li class="has-submenu">
              <a href="#" target="_self">å¼€å‘</a>
              <ul class="sub-menu">
                <li><a href="/tag/Devops/" target="_self">DevOps</a></li>
                <li><a href="/tag/Python/" target="_self">Python</a></li>
                <li><a href="/tag/Django/" target="_self">Django</a></li>
                <li><a href="/bpmn/index.html" target="_self">BPMNç³»åˆ—</a></li>
                <li><a href="/webssh/index.html" target="_self">WebSSHç³»åˆ—</a></li>
                <li><a href="/frontend/index.html" target="_self">å‰ç«¯å¼€å‘ç³»åˆ—</a></li>
              </ul>
            </li>
            <li><a href="/devops.html" target="_self">è¿ç»´å¹³å°</a></li>
            <li><a href="/tag/è¿™æ˜¯ç”Ÿæ´»/" target="_self">è¿™æ˜¯ç”Ÿæ´»</a></li>
            <li class="has-submenu">
              <a href="#" target="_self">æˆ¿è½¦æ—…è¡Œ</a>
              <ul class="sub-menu">
                <li><a href="/r/index.html" target="_self">æˆ¿è½¦ä½“éªŒ</a></li>
                <li><a href="/travels.html" target="_self">æ—…è¡Œæ¸¸è®°</a></li>
              </ul>
            </li>
            <li><a href="/tag/index.html" target="_self">æ ‡ç­¾</a></li>
            <li><a href="/archive.html" target="_self">å½’æ¡£</a></li>
        </ul>
      </nav>
    </div>
  </div>

  <header>
    <div class="container no-sidebar">
      <a href="/">
        <h1>è¿ç»´å’–å•¡å§</h1>
        <h2>äº«å—æŠ€æœ¯å¸¦æ¥çš„ä¹è¶£ï¼Œä½“éªŒç”Ÿæ´»ç»™äºˆçš„æ„ŸåŠ¨</h2>
      </a>
    </div>
  </header>

  <div id="content-wrap">
    <div class="container no-sidebar">
        <h1 id="art-title">Djangoå¼€å‘ä¸­ä½¿ç”¨Cacheç¼“å­˜æå‡10å€æ•ˆç‡</h1>

        <p><a href="https://blog.ops-coffee.cn/s/uXQbM4t11ICdzNofZyDeXA" target="_blank">è‡ªå®šä¹‰ä»»åŠ¡å¼•æ“Probius</a>ä¸Šçº¿è¿è¡Œä¸€æ®µæ—¶é—´åï¼Œå°ä¼™ä¼´è·Ÿæˆ‘åé¦ˆæœ‰éƒ¨åˆ†ä»»åŠ¡æ‰§è¡Œæ—¶é—´å¤ªé•¿ï¼Œç­‰çš„èŠ±å„¿éƒ½è°¢äº†ï¼Œä¾‹å¦‚ä¸‹è¾¹è¿™ä¸ªä»»åŠ¡ç«Ÿç„¶æ‰§è¡Œäº†è¶…è¿‡24åˆ†é’Ÿ</p>
<p><img alt="" loading="lazy" src="/static/images/2020/1026.01.png" /></p>
<p>æŸ¥çœ‹æ¯ä¸ªå­ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´ï¼Œå‘ç°å•å•æ¶ˆè€—åœ¨â€œYARNå®‰è£…æ¨¡å—â€è¿™ä¸ªå­ä»»åŠ¡çš„æ—¶é—´å°±è¶…è¿‡20åˆ†é’Ÿï¼Œæ£€æŸ¥è¿™ä¸ªå­ä»»åŠ¡çš„æ‰§è¡Œé€»è¾‘å‘ç°å¹¶æ²¡æœ‰å‘ç°é—®é¢˜ï¼ŒæŠ›å¼ƒProbiusï¼Œç›´æ¥åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œè¿™ä¸ªå­ä»»åŠ¡æƒŠå¥‡çš„å‘ç°æ‰§è¡Œæ—¶é—´åªæœ‰2åˆ†é’Ÿï¼Œç”±æ­¤æ–­å®šè‚¯å®šæ˜¯Probiusçš„é—®é¢˜äº†</p>
<p>åˆä¸€æ¬¡çœ‹äº†ä¸‹è¿™ä¸ªå­ä»»åŠ¡ï¼Œå‘ç°ä»»åŠ¡çš„è¾“å‡ºæ—¥å¿—è¶…è¿‡1wæ¡ï¼Œç¬é—´å°±çŸ¥æ™“äº†å…¶ä¸­çš„é—®é¢˜ï¼Œç»è¿‡ç®€å•ä¿®æ”¹å†æ¬¡æµ‹è¯•ï¼ŒåŸæœ¬æ‰§è¡Œ24åˆ†é’Ÿçš„ä»»åŠ¡æ‰§è¡Œæ—¶é—´ç¼©çŸ­è‡³3åˆ†é’Ÿä»¥å†…ï¼Œæ•ˆç‡æå‡ç›¸å½“æ˜æ˜¾</p>
<p><img alt="" loading="lazy" src="/static/images/2020/1026.02.png" /></p>
<p>ç©¶ç«Ÿæ”¹äº†ä»€ä¹ˆæ‹¥æœ‰å¦‚æ­¤é­”åŠ›å‘¢ï¼Ÿå…ˆæ¥çœ‹ä¸‹ä¸‹è¾¹è¿™æ®µä»£ç </p>
<pre class="codehilite"><code>class Logger:
    def __init__(self, tid, state=None):
        self.tid = tid
        self.state = state
        self.datetime = time.strftime('%Y-%m-%d %H:%M:%S', time.localtime(time.time()))

    def add(self, details):
        subtasklog = SubTaskLog.objects.get(id=self.tid)

        if details:
            details = details.replace('\n', ' ').replace('\r', ' ')
            newlog = self.datetime + ' ' + details + ';'

            if subtasklog.details:
                subtasklog.details += newlog
            else:
                subtasklog.details = newlog

        if self.state is not None:
            subtasklog.state = self.state
            subtasklog.save()</code></pre>


<p>ä»»åŠ¡æ‰§è¡Œä¼šä¸æ–­çš„è¾“å‡ºæ—¥å¿—ï¼Œè¿™äº›æ—¥å¿—å°±é€šè¿‡ä¸Šè¾¹çš„<code>Logger</code>ç±»å†™å…¥æ•°æ®åº“ï¼Œä»¥ä¾¿å‰ç«¯å¯ä»¥åŠæ—¶è¯»å–å®æ—¶å±•ç¤ºï¼Œä¹çœ‹ä¸Šå»å¹¶æ— ä¸å¦¥ï¼Œä½†å½“çŸ­æ—¶é—´å†…æ—¥å¿—äº§ç”Ÿé‡éå¸¸å¤§æ—¶ä¾¿ä¼šé¢‘ç¹è¯»å†™æ•°æ®åº“ï¼Œæ•°æ®åº“å‹åŠ›è¿‡å¤§ä»è€Œå½±å“æ•´ä¸ªç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ã€‚ç¼“è§£æ•°æ®åº“å‹åŠ›çš„æœ‰æ•ˆæ–¹æ³•å°±æ˜¯åŠ ç¼“å­˜</p>
<p>å…¶å®å½“åˆåœ¨å†™è¿™æ®µä»£ç çš„æ—¶å€™å°±è€ƒè™‘åˆ°äº†ç”¨ç¼“å­˜ï¼Œä¹‹æ‰€ä»¥æ²¡æœ‰ç”¨çš„ä¸»è¦æ˜¯å› ä¸ºï¼šåœ¨é¡¹ç›®è®¾è®¡çš„è¿‡ç¨‹ä¸­æˆ‘æå€¡å°½é‡å‡å°‘ä¾èµ–ï¼Œä¸è¿‡åº¦è®¾è®¡ï¼Œä»¥å®ç°éœ€æ±‚ä¸ºç›®æ ‡ï¼Œå°½é‡è®©é¡¹ç›®ç®€å•ï¼Œè¿™æ ·åä½œçš„å°ä¼™ä¼´çœ‹èµ·ä»£ç æ¥ä¸è´¹åŠ²ï¼Œå‡ºäº†é—®é¢˜è¿˜å®¹æ˜“æŸ¥æ‰¾åŸå› ã€‚æ­£å¸¸æƒ…å†µä¸‹ä»»åŠ¡çš„æ—¥è´¨é‡éƒ½ä¸å¤§ï¼Œæ•°æ®åº“å¤„ç†èµ·æ¥ä¹Ÿä¸è´¹åŠ²ï¼Œèƒ½æ»¡è¶³éœ€æ±‚ï¼Œå¼•å…¥ç¼“å­˜åŠ¿å¿…è¦å¢åŠ ä¾èµ–ï¼Œè®©é¡¹ç›®æ›´å¤æ‚ï¼Œæ‰€ä»¥å°±æ²¡æœ‰åŠ ã€‚ä½†ä»ä¸Šè¾¹çš„é—®é¢˜æ¥çœ‹ï¼Œæ•°æ®åº“å·²æ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œå¢åŠ ç¼“å­˜å°±å¾ˆæœ‰å¿…è¦äº†</p>
<h2 id="django-cache">Django Cache</h2>
<p>Djangoæœ¬èº«å°±å¸¦æœ‰ä¸€ä¸ªå¼ºå¤§çš„ç¼“å­˜ç³»ç»Ÿï¼Œæä¾›ä¸åŒçº§åˆ«çš„ç¼“å­˜ç²’åº¦ï¼šå¯ä»¥ç¼“å­˜ç‰¹å®šçš„è§†å›¾ï¼Œä¹Ÿå¯ä»¥åªç¼“å­˜éƒ¨åˆ†æ¨¡æ¿ç‰‡æ®µï¼Œè¿˜å¯ä»¥ç¼“å­˜æ•´ä¸ªç½‘ç«™ã€‚ä½†è¿™å‡ ç±»éƒ½ä¸æ˜¯æˆ‘æƒ³è¦çš„ï¼Œæœ¬ç¯‡æ–‡ç« ä¸ä¼šä»‹ç»ä»¥ä¸Šå‡ ç±»ç¼“å­˜çš„ä½¿ç”¨ï¼Œéœ€è¦çš„è¯å¯ä»¥å‚è€ƒå®˜ç½‘å†™çš„å¾ˆè¯¦ç»†</p>
<p>DjangoåŒæ—¶è¿˜æä¾›äº†åº•å±‚ç¼“å­˜APIï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªAPIä»¥ä»»æ„çº§åˆ«ç²’åº¦åœ¨ç¼“å­˜ä¸­å­˜å‚¨å¯¹è±¡ã€‚è¿™æ­£æ˜¯æˆ‘æ‰€éœ€è¦çš„ï¼Œæ¯æ¬¡äº§ç”Ÿçš„æ–°æ—¥å¿—éƒ½ä¸å†ç›´æ¥å†™å…¥æ•°æ®åº“ï¼Œè€Œæ˜¯å…ˆå†™å…¥ç¼“å­˜ä¸­ï¼Œå¾…ä»»åŠ¡æ‰§è¡Œå®Œæˆåä¸€æ¬¡å†™å…¥æ•°æ®åº“ï¼Œè¿™æ ·å°†å¤§å¤§é™ä½å¯¹æ•°æ®åº“çš„æ¶ˆè€—ï¼Œä¸”ç¼“å­˜å¤§éƒ½ä½¿ç”¨å†…å­˜æ¥å­˜å‚¨ï¼Œè¯»å†™æ•ˆç‡æé«˜</p>
<h3 id="_1">ç¼“å­˜é…ç½®</h3>
<p>Djangoçš„åº•å±‚ç¼“å­˜APIä½¿ç”¨éå¸¸ç®€å•ï¼Œé¦–å…ˆéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®å¯ç”¨ç¼“å­˜ï¼Œ<code>settings.py</code>æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹ä»£ç </p>
<pre class="codehilite"><code>CACHES = {
    'default': {
        'BACKEND': 'django.core.cache.backends.memcached.MemcachedCache',
        'LOCATION': '127.0.0.1:11211',
    }
}</code></pre>


<p>è¿™é‡Œä½¿ç”¨äº†<code>Memcached</code>ä½œä¸ºç¼“å­˜æœåŠ¡ï¼Œ<code>Memcached</code>æ˜¯ä¸€ä¸ªå®Œå…¨åŸºäºå†…å­˜çš„ç¼“å­˜æœåŠ¡å™¨ï¼Œæ˜¯<code>Django</code>åŸç”Ÿæ”¯æŒçš„æœ€å¿«ã€æœ€é«˜æ•ˆçš„ç¼“å­˜ç±»å‹ï¼Œå…¶ä»–è¿˜æ”¯æŒçš„ç¼“å­˜ç±»å‹æœ‰</p>
<ul>
<li>æ•°æ®åº“ç¼“å­˜ï¼šdjango.core.cache.backends.db.DatabaseCacheï¼Œ<code>LOCATION</code>ä¸ºè¡¨å</li>
<li>æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ï¼šdjango.core.cache.backends.filebased.FileBasedCacheï¼Œ<code>LOCATION</code>ä¸ºæ–‡ä»¶è·¯å¾„</li>
<li>æœ¬åœ°å†…å­˜ç¼“å­˜ï¼šdjango.core.cache.backends.locmem.LocMemCacheï¼Œ<code>LOCATION</code>è¢«ç”¨äºæ ‡è¯†å„ä¸ªå†…å­˜å­˜å‚¨</li>
<li>è™šæ‹Ÿç¼“å­˜ï¼šdjango.core.cache.backends.dummy.DummyCacheï¼Œä»…ç”¨äºå¼€å‘æ¨¡å¼ï¼Œåªæ˜¯å®ç°ç¼“å­˜æ¥å£ï¼Œå¹¶ä¸åšå…¶ä»–æ“ä½œ</li>
<li>è‡ªå®šä¹‰çš„ç¼“å­˜åå°ï¼Œä¾‹å¦‚redisç­‰</li>
</ul>
<p>æˆ‘åŸæœ¬æ˜¯æƒ³ç›´æ¥ä½¿ç”¨æœ¬åœ°å†…å­˜ç¼“å­˜çš„ï¼Œè¿™æ ·å°±æ— éœ€å†å®‰è£…<code>Memcached</code>æœåŠ¡äº†ï¼Œä½†æ˜¯æœ¬åœ°å†…å­˜ç¼“å­˜ä¸º<strong>è¿›ç¨‹ç§æœ‰</strong>ï¼Œä¸å¯è·¨è¿›ç¨‹è®¿é—®ï¼Œè¿™å°±äº§ç”Ÿäº†ä¸€ä¸ªé—®é¢˜å°±æ˜¯<code>Logger</code>è¿›ç¨‹å†™å…¥å†…å­˜ç¼“å­˜åï¼Œæˆ‘å‰ç«¯å±•ç¤ºçš„è¿›ç¨‹è¯»ä¸åˆ°ï¼Œå°±æ— æ³•å®æ—¶è¾“å‡ºæ—¥å¿—äº†ï¼Œé‚æ”¾å¼ƒå†…å­˜ç¼“å­˜ï¼Œæ”¹ç”¨Djangoæ”¯æŒæœ€å¥½çš„<code>Memcached</code></p>
<p>ä½¿ç”¨Memcachedå‰éœ€è¦å…ˆå®‰è£…memcachedæœåŠ¡ï¼Œä»¥åŠpythonè¿æ¥memcachedçš„åŒ…</p>
<pre class="codehilite"><code># debianç³»ç»Ÿå®‰è£…memcachedæœåŠ¡
apt-get install memcached

# å®‰è£…pythonè¿æ¥memcachedçš„åŒ…python-memcached
pip install python-memcached</code></pre>


<p>æ¯ä¸ªç¼“å­˜åç«¯éƒ½æ”¯æŒé…ç½®é¢å¤–çš„å‚æ•°ï¼Œä»è€Œæ¥æ§åˆ¶ç¼“å­˜çš„è¡Œä¸ºï¼Œæœ‰æ•ˆçš„å‚æ•°å¦‚ä¸‹ï¼š</p>
<p><strong>TIMEOUTï¼š</strong> ç”¨äºç¼“å­˜çš„é»˜è®¤è¶…æ—¶æ—¶é—´ï¼Œä»¥ç§’ä¸ºå•ä½ï¼Œé»˜è®¤ä¸º300ç§’ï¼Œå½“è®¾ç½®ä¸º<code>None</code>æ—¶è¡¨ç¤ºæ°¸ä¸è¿‡æ—¶ï¼Œè®¾ç½®ä¸º<code>0</code>è¡¨ç¤ºç«‹åˆ»è¿‡æœŸä¸ç¼“å­˜</p>
<p><strong>KEY_PREFIXï¼š</strong> ç¼“å­˜é”®å‰ç¼€ï¼Œå¦‚æœæœ‰è®¾ç½®ï¼Œåˆ™è¿™ä¸ªè®¾ç½®çš„å€¼å°†è‡ªåŠ¨æ·»åŠ åˆ°DjangoæœåŠ¡å™¨ä½¿ç”¨çš„æ‰€æœ‰ç¼“å­˜é”®ä¹‹å‰</p>
<p><strong>VERSIONï¼š</strong> é€šè¿‡DjangoæœåŠ¡å™¨ç”Ÿæˆçš„ç¼“å­˜é”®çš„é»˜è®¤ç‰ˆæœ¬å·ï¼Œæœ‰ç‚¹ç±»ä¼¼ä¸Redisçš„dbï¼Œä»¥ä¸‹ä¾‹å­èƒ½æ¸…æ™°å±•ç¤ºVERSIONçš„ä½œç”¨</p>
<pre class="codehilite"><code>&gt;&gt;&gt; from django.core.cache import cache
&gt;&gt;&gt;
&gt;&gt;&gt; cache.set('site', 'ops-coffee.cn', version=37)
&gt;&gt;&gt;
&gt;&gt;&gt; cache.get('site')
&gt;&gt;&gt;
&gt;&gt;&gt; cache.get('site', version=37)
'ops-coffee.cn'
&gt;&gt;&gt;</code></pre>


<p><strong>OPTIONSï¼š</strong> ä¼ é€’åˆ°ç¼“å­˜åç«¯æœåŠ¡çš„å‚æ•°ï¼Œä¾‹å¦‚æˆ‘è¦ä¼ é€’usernameã€passwordç­‰å‚æ•°åˆ°åç«¯çš„memcachedæœåŠ¡ï¼Œé‚£ä¹ˆå¯ä»¥è¿™æ ·å†™</p>
<pre class="codehilite"><code>CACHES = {
    'default': {
        'BACKEND': 'django.core.cache.backends.memcached.PyLibMCCache',
        'LOCATION': '127.0.0.1:11211',
        'OPTIONS': {
            'binary': True,
            'username': 'user',
            'password': 'pass',
            'behaviors': {
                'ketama': True,
            }
        }
    }
}</code></pre>


<h3 id="_2">ç¼“å­˜è®¿é—®</h3>
<p>å¼€å¯Django Cacheé…ç½®åï¼Œå°±å¯ä»¥ä½¿ç”¨ç¼“å­˜æœåŠ¡äº†ï¼ŒåŸºæœ¬ç”¨æ³•å¦‚ä¸‹</p>
<pre class="codehilite"><code>&gt;&gt;&gt; from django.core.cache import cache</code></pre>


<p><strong>cache.set(key, value, timeout=DEFAULT_TIMEOUT, version=None)</strong></p>
<p>å…¶ä¸­<code>key</code>æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œ<code>value</code>æ˜¯ä¸€ä¸ªè®¤å¯picklableå½¢å¼çš„pythonå¯¹è±¡ï¼Œ<code>timeout</code>å’Œ<code>version</code>å‚æ•°éƒ½æ˜¯å¯é€‰çš„ï¼Œ<code>timeout</code>é»˜è®¤ä¸º<code>CACHES</code>é…ç½®ä¸­ç›¸åº”åç«¯çš„<code>timeout</code>å‚æ•°ï¼Œ<code>version</code>ä¸ºå¯¹åº”çš„ç‰ˆæœ¬ï¼Œå‚è€ƒä¸Šè¾¹å…³äº<code>VERSION</code>çš„è§£é‡Š</p>
<pre class="codehilite"><code>&gt;&gt;&gt; cache.set('site', 'ops-coffee.cn')
&gt;&gt;&gt;
&gt;&gt;&gt; cache.get('site')
'ops-coffee.cn'
&gt;&gt;&gt;</code></pre>


<p><strong>cache.get(key, default=None, version=None)</strong></p>
<p>æ–°çš„å‚æ•°<code>default</code>çš„æ„æ€æ˜¯ï¼Œå½“è¯·æ±‚çš„keyä¸å­˜åœ¨æ—¶ï¼Œåˆ™è¿”å›<code>default</code>è®¾ç½®çš„è¿™ä¸ªå€¼ï¼Œè€Œä¸æ˜¯é»˜è®¤ä¸å­˜åœ¨è¿”å›çš„`None</p>
<pre class="codehilite"><code>&gt;&gt;&gt; cache.get('name')
&gt;&gt;&gt;
&gt;&gt;&gt; cache.get('name', 'has expired')
'has expired'</code></pre>


<p><strong>cache.add(key, value, timeout=DEFAULT_TIMEOUT, version=None)</strong></p>
<p>ä¸<code>cache.set</code>ç±»ä¼¼ï¼Œåªæ˜¯å½“addçš„keyä¸å­˜åœ¨æ—¶ï¼Œåˆ™æ–°å»ºkeyï¼Œå­˜åœ¨åˆ™ä¸åšä»»ä½•æ“ä½œ</p>
<pre class="codehilite"><code>&gt;&gt;&gt; cache.add('site', 'https://blog.ops-coffee.cn')
False
&gt;&gt;&gt; cache.get('site')
'https://ops-coffee.cn'
&gt;&gt;&gt;
&gt;&gt;&gt; cache.get('name')
&gt;&gt;&gt; cache.add('name', 'è¿ç»´å’–å•¡å§ åšå®¢')
True
&gt;&gt;&gt; cache.get('name')
'è¿ç»´å’–å•¡å§ åšå®¢'</code></pre>


<p>æ–°å»ºæˆåŠŸåˆ™ä¼šè¿”å›Trueï¼Œå¦åˆ™è¿”å›False</p>
<p><strong>cache.get_or_set(key, default, timeout=DEFAULT_TIMEOUT, version=None)</strong></p>
<p>éœ€è¦2ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªä¸ºkeyï¼Œç¬¬äºŒä¸ªä¸ºkeyä¸å­˜åœ¨æ—¶è®¾ç½®çš„å€¼ã€‚<code>get_or_set</code>æ„æ€æ˜¯å¦‚æœkeyå­˜åœ¨ï¼Œåˆ™è¿”å›keyçš„å€¼ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ç»™keyè®¾ç½®ä¸€ä¸ªå€¼</p>
<pre class="codehilite"><code>&gt;&gt;&gt; cache.get('name')
'è¿ç»´å’–å•¡å§ åšå®¢'
&gt;&gt;&gt; cache.get_or_set('name', 'å’–å•¡å§åšå®¢')
'è¿ç»´å’–å•¡å§ åšå®¢'
&gt;&gt;&gt;
&gt;&gt;&gt; cache.get('path')
&gt;&gt;&gt; cache.get_or_set('path', '/devops')
'/devops'
&gt;&gt;&gt; cache.get('path')
'/devops'</code></pre>


<p><strong>cache.get_many(keys, version=None)</strong></p>
<p>é€šè¿‡ä¼ å…¥ä¸€ä¸ªkeysåˆ—è¡¨ï¼Œä»¥å­—å…¸æ ¼å¼è¿”å›è¿™äº›åˆ—è¡¨ä¸­keyå­˜åœ¨çš„ç¼“å­˜å€¼</p>
<pre class="codehilite"><code>&gt;&gt;&gt; cache.add('name', 'è¿ç»´å’–å•¡å§ åšå®¢')
True
&gt;&gt;&gt; cache.set('site', 'https://ops-coffee.cn')
&gt;&gt;&gt; cache.get_many(['site','name','path'])
{'site': 'https://ops-coffee.cn', 'name': 'è¿ç»´å’–å•¡å§ åšå®¢'}</code></pre>


<p><strong>cache.set_many(dict, timeout)</strong></p>
<p>é€šè¿‡ä¼ å…¥å­—å…¸ï¼Œæ‰¹é‡è®¾ç½®ç¼“å­˜</p>
<pre class="codehilite"><code>&gt;&gt;&gt; cache.set_many({'site':'ops-coffee.cn','name':'è¿ç»´å’–å•¡å§'})</code></pre>


<p><strong>cache.delete(key, version=None)</strong></p>
<p>åˆ é™¤ä¸€ä¸ªkey</p>
<pre class="codehilite"><code>&gt;&gt;&gt; cache.delete('site')</code></pre>


<p><strong>cache.delete_many(keys, version=None)</strong></p>
<p>æ‰¹é‡åˆ é™¤key</p>
<pre class="codehilite"><code>&gt;&gt;&gt; cache.delete_many(['site','name'])</code></pre>


<p><strong>cache.clear()</strong></p>
<p>æ¸…ç©ºç¼“å­˜ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¼šåˆ é™¤ç¼“å­˜é‡Œçš„æ‰€æœ‰keyï¼Œå¯èƒ½åŒ…å«ä¸€äº›å¹¶ä¸æ˜¯ä½ è®¾ç½®çš„key</p>
<pre class="codehilite"><code>&gt;&gt;&gt; cache.clear()</code></pre>


<p><strong>cache.touch(key, timeout=DEFAULT_TIMEOUT, version=None)</strong></p>
<p>æ›´æ–°keyçš„è¿‡æœŸæ—¶é—´ä¸ºtimeoutè®¾ç½®çš„å€¼ï¼Œtimeoutæ˜¯å¯é€‰çš„ï¼Œå¦‚æœä¸å†™åˆ™é»˜è®¤ä¸º<code>CACHES</code>è®¾ç½®çš„<code>TIMEOUT</code>å€¼</p>
<pre class="codehilite"><code>&gt;&gt;&gt; cache.touch('site', 3)
True</code></pre>


<p>æ›´æ–°æˆåŠŸåˆ™è¿”å›Trueï¼Œå¦åˆ™è¿”å›False</p>
<p><strong>cache.incr(key, delta=1, version=None)</strong></p>
<p>incré€’å¢ä¸€ä¸ªå·²å­˜åœ¨çš„intç±»å‹çš„keyçš„å€¼ï¼Œé»˜è®¤æƒ…å†µä¸‹é€’å¢å¹…åº¦ä¸º1ï¼Œé€šè¿‡æŒ‡å®š<code>delta</code>å¯ä»¥è®¾ç½®é€’å¢çš„å¹…åº¦</p>
<pre class="codehilite"><code>&gt;&gt;&gt; cache.set('num', 1)
&gt;&gt;&gt; cache.incr('num')
2
&gt;&gt;&gt; cache.incr('num', 10)
12</code></pre>


<p><strong>cache.decr(key, delta=1, version=None)</strong></p>
<p>ä¸incré€’å¢ç±»ä¼¼ï¼Œdecrä¸ºé€’å‡</p>
<pre class="codehilite"><code>&gt;&gt;&gt; cache.decr('num')
11
&gt;&gt;&gt; cache.decr('num', 5)
6</code></pre>


<p><strong>cache.close()</strong></p>
<p>å¦‚æœç¼“å­˜åç«¯å·²ç»å®ç°äº†close()æ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡<code>cache.close()</code>å…³é—­å’Œç¼“å­˜çš„è¿æ¥</p>
<h2 id="_3">ä»£ç ä¼˜åŒ–</h2>
<p>çŸ¥é“äº†ä»£ç å­˜åœ¨çš„é—®é¢˜ï¼Œä¹Ÿäº†è§£äº†Djangoä¸­å¦‚ä½•æ“ä½œCacheï¼Œé‚£ä¹ˆå°±å¯ä»¥ç€æ‰‹ä¼˜åŒ–ä¸Šè¾¹çš„ä»£ç äº†ï¼Œä¼˜åŒ–åçš„ä»£ç å¦‚ä¸‹ï¼š</p>
<pre class="codehilite"><code>class Logger:
    def __init__(self, tid, state=None):
        self.tid = tid
        self.state = state
        self.datetime = time.strftime('%Y-%m-%d %H:%M:%S', time.localtime(time.time()))

        self.key = 'engine_subtasklog_%d' % self.tid

    def add(self, details, sync=False):
        subtasklog = SubTaskLog.objects.get(id=self.tid)

        if details:
            details = details.replace('\n', ' ').replace('\r', ' ')
            newlog = self.datetime + ' ' + details + ';'

            # å°†è¯¦æƒ…æ›´æ–°åˆ°ç¼“å­˜ä¸­
            old_log = cache.get(self.key, '')
            cache.set(self.key, old_log + newlog) if old_log else cache.set(self.key, newlog)

        if self.state is not None:
            subtasklog.state = self.state

            # å°†ç¼“å­˜å†™å…¥æ•°æ®åº“å¹¶ä¿å­˜
            subtasklog.details = cache.get(self.key)
            subtasklog.save()

            # åˆ é™¤ç¼“å­˜
            cache.delete(self.key)</code></pre>


<p>æ ¹æ®ä»»åŠ¡IDåˆ›å»ºç¼“å­˜keyï¼Œè¿™æ¡ä»»åŠ¡ä¸‹çš„æ‰€æœ‰Logéƒ½ä¼šå…ˆå†™å…¥ç¼“å­˜ä¸­ï¼Œå½“ä»»åŠ¡ç»“æŸæ—¶å†å°†ç¼“å­˜ä¸­çš„æ—¥å¿—ä¸€æŠŠå†™å…¥æ•°æ®åº“ï¼Œä»è€Œå‡è½»æ•°æ®åº“å‹åŠ›ï¼Œæ‰§è¡Œæ•ˆç‡å¾—åˆ°äº†æå¤§çš„æå‡</p>
<p><img alt="" loading="lazy" src="/static/images/2020/1026.03.png" /></p>

        <div>
          <ul style="display: inline-block;padding: 0;margin: 0 0 0.5em;color: #999;">
            <li style="display: inline-block;margin: 0 1em 0 0;"><a href="/s/JpnxTf-Z9vkKrwl8nXJljQ.html">ğŸ“… 2020-10-26</a></li>
<li style="display: inline-block;margin: 0 1em 0 0;"><a href="/tag/Devops/">ğŸ·ï¸ Devops</a></li><li style="display: inline-block;margin: 0 1em 0 0;"><a href="/tag/Django/">ğŸ·ï¸ Django</a></li><li style="display: inline-block;margin: 0 1em 0 0;"><a href="/tag/ä»»åŠ¡ç³»ç»Ÿ/">ğŸ·ï¸ ä»»åŠ¡ç³»ç»Ÿ</a></li><li style="display: inline-block;margin: 0 1em 0 0;"><a href="/tag/å…³äºæŠ€æœ¯/">ğŸ·ï¸ å…³äºæŠ€æœ¯</a></li>          </ul>
        </div>

        <hr>

        <div class="nav-cell">
            <script async src="https://giscus.app/client.js"
                    data-repo="ops-coffee/blog" data-repo-id="MDEwOlJlcG9zaXRvcnkxNDY4OTI0MTg="
                    data-category="Announcements" data-category-id="DIC_kwDOCMFmgs4CQar3"
                    data-mapping="pathname" data-strict="0" data-reactions-enabled="1"
                    data-emit-metadata="0" data-input-position="top" data-theme="light"
                    data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous">
            </script>
        </div>

        <div>
            <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
            <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8944257246828217"
                 data-ad-slot="6731434232" data-ad-format="auto" data-full-width-responsive="true"></ins>
            <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
        </div>

        <div class="nav-cell">
            <p class="nav-list-title">èƒ½çœ‹åˆ°è¿™é‡Œä¸€å®šæ˜¯çœŸçˆ±ï¼Œå…³æ³¨ä¸€ä¸‹å§</p>
            <img alt="" loading="lazy" src="/static/images/wx.sou1.png" />
        </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="copy"> Â© ops-coffee</div>

      <div class="link">
        <a href="/search.html" title="æœç´¢" target="_blank">æœç´¢</a>
        <a href="/questions.html" title="æé—®" target="_blank">æé—®</a>
        <a href="/friends.html" title="å‹æƒ…é“¾æ¥" target="_blank">å‹é“¾</a>
      </div>
    </div>
  </footer>
  
  <!-- Umami Cloud -->
<script async src="https://umami.ops-coffee.cn/script.js" data-website-id="a4aabd8e-32c7-40e7-a81c-119b909f2d0f"></script>

<!-- Google Adsense -->
<script data-ad-client="ca-pub-8944257246828217" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</body>

</html>